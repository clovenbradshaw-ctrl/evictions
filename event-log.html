<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Log - Nashville Eviction Tracker</title>
    <link rel="icon" type="image/png" href="https://storage.googleapis.com/intelechia-content/im/eviction%20prevention%20logo.png">
    <link rel="stylesheet" href="dist/output.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary: #4f46e5;
            --secondary: #06b6d4;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f9fafb;
            line-height: 1.6;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            height: 40px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .page-intro {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #86efac;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .page-intro h2 {
            font-size: 24px;
            font-weight: 700;
            color: #166534;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-intro p {
            color: #374151;
            font-size: 15px;
        }

        .privacy-notice {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .privacy-notice h3 {
            font-size: 14px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .privacy-notice p {
            font-size: 13px;
            color: #78350f;
        }

        .controls-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .control-input {
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            color: #374151;
            background: white;
            transition: all 0.2s;
        }

        .control-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .stats-bar {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 14px 18px;
            min-width: 120px;
        }

        .stat-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
            margin-top: 2px;
        }

        .event-op {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-block;
        }

        .op-INS { background: #dcfce7; color: #166534; }
        .op-ALT { background: #dbeafe; color: #1e40af; }
        .op-NUL { background: #fee2e2; color: #991b1b; }
        .op-CON { background: #fae8ff; color: #86198f; }
        .op-SYN { background: #e0e7ff; color: #3730a3; }
        .op-SEG { background: #fef3c7; color: #92400e; }
        .op-SUP { background: #ccfbf1; color: #0f766e; }
        .op-DES { background: #f3f4f6; color: #374151; }
        .op-REC { background: #fce7f3; color: #9d174d; }

        .table-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }

        .table-header {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .event-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .event-table thead {
            background: #f9fafb;
            position: sticky;
            top: 0;
        }

        .event-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
        }

        .event-table td {
            padding: 10px 16px;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
            vertical-align: top;
        }

        .event-table tbody tr:hover {
            background: #f9fafb;
        }

        .entity-id {
            font-family: 'Monaco', 'Consolas', monospace;
            font-weight: 600;
            color: #111827;
            font-size: 12px;
        }

        .timestamp {
            font-size: 12px;
            color: #6b7280;
            white-space: nowrap;
        }

        .redacted {
            background: #fee2e2;
            color: #991b1b;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-style: italic;
        }

        .details-cell {
            max-width: 400px;
        }

        .detail-row {
            display: flex;
            gap: 6px;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .detail-row:last-child {
            margin-bottom: 0;
        }

        .detail-key {
            font-weight: 600;
            color: #6b7280;
            min-width: 80px;
        }

        .detail-value {
            color: #374151;
            word-break: break-word;
        }

        .change-old {
            color: #991b1b;
            text-decoration: line-through;
        }

        .change-new {
            color: #166534;
        }

        .change-arrow {
            color: #9ca3af;
        }

        .source-badge {
            font-size: 10px;
            padding: 2px 6px;
            background: #f3f4f6;
            color: #6b7280;
            border-radius: 4px;
        }

        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .loading-state .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .pagination-btn {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            color: #374151;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 13px;
            color: #6b7280;
            margin: 0 12px;
        }

        .per-page-select {
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            margin-left: 12px;
        }

        .footer {
            background: #1f2937;
            color: #9ca3af;
            padding: 24px;
            margin-top: 48px;
            text-align: center;
        }

        .footer a {
            color: #60a5fa;
        }

        .legend {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
        }

        .legend-title {
            font-size: 13px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 10px;
        }

        .legend-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #6b7280;
        }

        .progress-bar {
            width: 200px;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 12px;
                padding: 12px 16px;
            }

            .header h1 {
                font-size: 16px;
            }

            .main-container {
                padding: 16px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                flex-direction: column;
            }

            .stat-card {
                width: 100%;
            }

            .event-table {
                font-size: 11px;
            }

            .event-table th, .event-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <img src="https://storage.googleapis.com/intelechia-content/im/eviction%20prevention%20logo.png" alt="Logo" class="logo">
            <div>
                <h1>Event Sourcing Log</h1>
                <div style="font-size: 12px; color: #6b7280;">Transparent data change history</div>
            </div>
        </div>
        <div class="header-right">
            <a href="index.html" class="btn btn-secondary">
                <span>‚Üê</span> Dashboard
            </a>
            <a href="provenance.html" class="btn btn-secondary">
                <span>üìã</span> Provenance
            </a>
            <a href="cm-rankings.html" class="btn btn-secondary">
                <span>üìä</span> Rankings
            </a>
        </div>
    </header>

    <main class="main-container">
        <!-- Page Introduction -->
        <div class="page-intro">
            <h2>üìú Event Sourcing Transparency</h2>
            <p>
                This page shows the complete audit trail of all data changes in the Nashville Eviction Tracker.
                Every insert, update, and deletion is recorded as an immutable event, providing full transparency
                into how the data has evolved over time. This append-only log ensures accountability and traceability.
            </p>
            <div class="privacy-notice">
                <h3>üîí Privacy Protection</h3>
                <p>
                    Tenant names (defendants) and property addresses are automatically redacted in this view to protect
                    the privacy of individuals facing eviction proceedings. Only aggregate and anonymized data is shown.
                </p>
            </div>
        </div>

        <!-- Operator Legend -->
        <div class="legend">
            <div class="legend-title">Event Operators</div>
            <div class="legend-grid">
                <div class="legend-item"><span class="event-op op-INS">INS</span><span>New case filed</span></div>
                <div class="legend-item"><span class="event-op op-ALT">ALT</span><span>Case updated</span></div>
                <div class="legend-item"><span class="event-op op-NUL">NUL</span><span>Deleted/archived</span></div>
                <div class="legend-item"><span class="event-op op-CON">CON</span><span>Cases linked</span></div>
                <div class="legend-item"><span class="event-op op-SYN">SYN</span><span>Cases merged</span></div>
                <div class="legend-item"><span class="event-op op-SEG">SEG</span><span>Categorized</span></div>
                <div class="legend-item"><span class="event-op op-SUP">SUP</span><span>Context added</span></div>
                <div class="legend-item"><span class="event-op op-DES">DES</span><span>Defined</span></div>
                <div class="legend-item"><span class="event-op op-REC">REC</span><span>Reconfigured</span></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-section">
            <div class="controls-grid">
                <div class="control-group">
                    <label class="control-label">Filter by Operator</label>
                    <select id="opFilter" class="control-input">
                        <option value="">All Operators</option>
                        <option value="INS">INS - New Cases</option>
                        <option value="ALT">ALT - Updates</option>
                        <option value="NUL">NUL - Deletions</option>
                        <option value="CON">CON - Connections</option>
                        <option value="SYN">SYN - Merges</option>
                        <option value="SEG">SEG - Categories</option>
                        <option value="SUP">SUP - Context</option>
                        <option value="DES">DES - Definitions</option>
                        <option value="REC">REC - Reconfigurations</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">Search Entity ID</label>
                    <input type="text" id="entitySearch" class="control-input" placeholder="e.g., 24GC1234">
                </div>
                <div class="control-group">
                    <label class="control-label">Date Start</label>
                    <input type="date" id="dateStart" class="control-input">
                </div>
                <div class="control-group">
                    <label class="control-label">Date End</label>
                    <input type="date" id="dateEnd" class="control-input">
                </div>
                <div class="control-group" style="justify-content: flex-end;">
                    <button id="refreshBtn" class="btn btn-primary">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Total Events</div>
                <div class="stat-value" id="totalEvents">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Inserts (INS)</div>
                <div class="stat-value" id="insertCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Updates (ALT)</div>
                <div class="stat-value" id="updateCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Unique Entities</div>
                <div class="stat-value" id="entityCount">-</div>
            </div>
        </div>

        <!-- Event Table -->
        <div class="table-container">
            <div class="table-header">
                <div class="table-title">
                    <span>üìã</span>
                    Event History
                </div>
                <div style="font-size: 13px; color: #6b7280;">
                    Showing <span id="showingCount">0</span> events
                </div>
            </div>

            <div id="tableWrapper" style="overflow-x: auto;">
                <table class="event-table" id="eventTable">
                    <thead>
                        <tr>
                            <th style="width: 70px;">Op</th>
                            <th style="width: 120px;">Entity ID</th>
                            <th style="width: 160px;">Timestamp</th>
                            <th style="width: 180px;">Description</th>
                            <th>Details</th>
                            <th style="width: 80px;">Source</th>
                        </tr>
                    </thead>
                    <tbody id="eventTableBody">
                        <tr>
                            <td colspan="6">
                                <div class="loading-state">
                                    <div class="spinner"></div>
                                    <div>Loading all events...</div>
                                    <div class="progress-bar" id="loadProgressBar" style="display: none; margin: 12px auto 0;">
                                        <div class="progress-fill" id="loadProgressFill" style="width: 0%"></div>
                                    </div>
                                    <div id="loadProgressText" style="font-size: 12px; margin-top: 8px;"></div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="pagination" style="display: none;">
                <button class="pagination-btn" id="firstBtn">¬´ First</button>
                <button class="pagination-btn" id="prevBtn">‚Üê Prev</button>
                <span class="pagination-info">
                    Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                </span>
                <button class="pagination-btn" id="nextBtn">Next ‚Üí</button>
                <button class="pagination-btn" id="lastBtn">Last ¬ª</button>
                <select class="per-page-select" id="perPageSelect">
                    <option value="50">50 / page</option>
                    <option value="100" selected>100 / page</option>
                    <option value="250">250 / page</option>
                    <option value="500">500 / page</option>
                </select>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p style="font-size: 14px; margin-bottom: 8px;">
            <strong>Nashville Eviction Tracker</strong> ‚Äî Community Project (UNOFFICIAL)
        </p>
        <p style="font-size: 13px;">
            Event sourcing powered by <a href="provenance.html">Epistemic Operators</a> |
            <a href="provenance.html">Data Provenance</a>
        </p>
        <p style="font-size: 12px; margin-top: 12px; color: #6b7280;">
            Last updated: <span id="last-updated"></span>
        </p>
    </footer>

    <!-- Load EO Migration Library -->
    <script src="eo-migration.js"></script>

    <script>
        // =============================================================================
        // REDACTION UTILITIES
        // =============================================================================

        const SENSITIVE_FIELDS = [
            'Defendant_Respondent', 'defendant_respondent', 'defendant', 'Defendant',
            'Address_1', 'Address_2', 'address_1', 'address_2', 'address', 'Address',
            'address_formatted', 'city_state_zip'
        ];

        function scrambleName(name) {
            if (!name || typeof name !== 'string') return '[REDACTED]';
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = ((hash << 5) - hash) + name.charCodeAt(i);
                hash = hash & hash;
            }
            const firstNames = ['J.', 'M.', 'R.', 'S.', 'A.', 'D.', 'K.', 'T.', 'L.', 'C.'];
            const lastParts = ['***', '****', '*****', '******'];
            return `${firstNames[Math.abs(hash) % firstNames.length]} ${lastParts[Math.abs(hash >> 4) % lastParts.length]}`;
        }

        function redactAddress(address) {
            if (!address || typeof address !== 'string') return '[ADDRESS REDACTED]';
            const parts = address.split(',');
            if (parts.length > 1) {
                return `[REDACTED], ${parts[parts.length - 1].trim()}`;
            }
            return '[ADDRESS REDACTED]';
        }

        function isSensitiveField(fieldName) {
            const normalized = fieldName.toLowerCase();
            return SENSITIVE_FIELDS.some(f => f.toLowerCase() === normalized) ||
                   normalized.includes('defendant') ||
                   normalized.includes('address') ||
                   normalized.includes('tenant');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =============================================================================
        // EVENT DISPLAY
        // =============================================================================

        const OPERATOR_MEANINGS = {
            INS: 'New case filed',
            ALT: 'Case updated',
            NUL: 'Case deleted',
            CON: 'Cases linked',
            SYN: 'Cases merged',
            SEG: 'Case categorized',
            SUP: 'Context added',
            DES: 'Entity defined',
            REC: 'Reconfigured'
        };

        let allEvents = [];
        let filteredEvents = [];
        let currentPage = 1;
        let eventsPerPage = 100;

        function renderEventRow(event) {
            const timestamp = new Date(event.ts).toLocaleString();
            const meaning = OPERATOR_MEANINGS[event.op] || event.op;
            const entityId = event.entity_id || event.target?.id || 'N/A';
            const source = event.frame?.source || '-';

            let details = '';

            if (event.op === 'INS' && event.context?.data) {
                details = renderInsertDetails(event.context.data);
            } else if (event.op === 'ALT' && event.context) {
                if (event.context.changes) {
                    details = renderChangeDetails(event.context.changes);
                } else if (event.target?.field) {
                    details = renderSingleChange(event.target.field, event.context.old, event.context.new);
                }
            } else if (event.op === 'NUL') {
                details = `Reason: ${escapeHtml(event.context?.reason || 'deleted')}`;
            } else if (event.op === 'CON') {
                details = `Linked to: ${escapeHtml(event.context?.related || 'N/A')}`;
            } else if (event.op === 'SYN' && event.context?.merged) {
                details = `Merged: ${escapeHtml(event.context.merged.join(', '))}`;
            }

            return `
                <tr>
                    <td><span class="event-op op-${event.op}">${event.op}</span></td>
                    <td><span class="entity-id">${escapeHtml(entityId)}</span></td>
                    <td><span class="timestamp">${timestamp}</span></td>
                    <td>${meaning}</td>
                    <td class="details-cell">${details}</td>
                    <td><span class="source-badge">${escapeHtml(source)}</span></td>
                </tr>
            `;
        }

        function renderInsertDetails(data) {
            const fields = ['Docket_Number', 'File_Date', 'Status', 'Plaintiff_Petitioner', 'Defendant_Respondent', 'council_district'];
            let html = '';

            for (const field of fields) {
                if (data[field] !== undefined && data[field] !== null) {
                    const key = field.replace(/_/g, ' ');
                    let value;

                    if (isSensitiveField(field)) {
                        if (field.toLowerCase().includes('defendant')) {
                            value = `<span class="redacted">${escapeHtml(scrambleName(data[field]))}</span>`;
                        } else {
                            value = `<span class="redacted">${escapeHtml(redactAddress(data[field]))}</span>`;
                        }
                    } else {
                        value = escapeHtml(String(data[field]));
                    }

                    html += `<div class="detail-row"><span class="detail-key">${escapeHtml(key)}:</span><span class="detail-value">${value}</span></div>`;
                }
            }

            return html;
        }

        function renderChangeDetails(changes) {
            let html = '';

            for (const [field, change] of Object.entries(changes)) {
                const key = field.replace(/_/g, ' ');
                let oldVal, newVal;

                if (isSensitiveField(field)) {
                    if (field.toLowerCase().includes('defendant')) {
                        oldVal = `<span class="redacted">${escapeHtml(scrambleName(change.old))}</span>`;
                        newVal = `<span class="redacted">${escapeHtml(scrambleName(change.new))}</span>`;
                    } else {
                        oldVal = `<span class="redacted">[REDACTED]</span>`;
                        newVal = `<span class="redacted">[REDACTED]</span>`;
                    }
                } else {
                    oldVal = `<span class="change-old">${escapeHtml(String(change.old ?? '(empty)'))}</span>`;
                    newVal = `<span class="change-new">${escapeHtml(String(change.new ?? '(empty)'))}</span>`;
                }

                html += `<div class="detail-row">
                    <span class="detail-key">${escapeHtml(key)}:</span>
                    <span class="detail-value">${oldVal} <span class="change-arrow">‚Üí</span> ${newVal}</span>
                </div>`;
            }

            return html;
        }

        function renderSingleChange(field, oldVal, newVal) {
            const key = field.replace(/_/g, ' ');

            if (isSensitiveField(field)) {
                return `<div class="detail-row">
                    <span class="detail-key">${escapeHtml(key)}:</span>
                    <span class="detail-value"><span class="redacted">[REDACTED]</span> <span class="change-arrow">‚Üí</span> <span class="redacted">[REDACTED]</span></span>
                </div>`;
            }

            return `<div class="detail-row">
                <span class="detail-key">${escapeHtml(key)}:</span>
                <span class="detail-value">
                    <span class="change-old">${escapeHtml(String(oldVal ?? '(empty)'))}</span>
                    <span class="change-arrow">‚Üí</span>
                    <span class="change-new">${escapeHtml(String(newVal ?? '(empty)'))}</span>
                </span>
            </div>`;
        }

        // =============================================================================
        // DATA LOADING
        // =============================================================================

        async function loadAllEvents() {
            const tbody = document.getElementById('eventTableBody');
            const progressBar = document.getElementById('loadProgressBar');
            const progressFill = document.getElementById('loadProgressFill');
            const progressText = document.getElementById('loadProgressText');

            tbody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <div>Loading all events...</div>
                            <div class="progress-bar" style="margin: 12px auto 0; width: 200px;">
                                <div class="progress-fill" id="loadProgressFill" style="width: 0%"></div>
                            </div>
                            <div id="loadProgressText" style="font-size: 12px; margin-top: 8px;">Fetching page 1...</div>
                        </div>
                    </td>
                </tr>
            `;

            document.getElementById('pagination').style.display = 'none';
            allEvents = [];

            try {
                let page = 1;
                let hasMore = true;
                const perPage = 1000;

                while (hasMore) {
                    document.getElementById('loadProgressText').textContent = `Fetching page ${page}... (${allEvents.length} events loaded)`;

                    const response = await EOMigration.fetchEvents({
                        per_page: perPage,
                        page: page
                    });

                    const events = Array.isArray(response) ? response : (response.items || response.data || []);

                    if (events.length === 0) {
                        hasMore = false;
                    } else {
                        allEvents = allEvents.concat(events);
                        page++;

                        // Update progress (estimate based on typical dataset)
                        const estimatedTotal = Math.max(allEvents.length * 1.1, 10000);
                        const progress = Math.min(95, (allEvents.length / estimatedTotal) * 100);
                        document.getElementById('loadProgressFill').style.width = `${progress}%`;

                        // Safety limit
                        if (page > 100) {
                            console.warn('Reached page limit');
                            hasMore = false;
                        }

                        // Small delay to avoid rate limiting
                        if (hasMore) {
                            await new Promise(r => setTimeout(r, 50));
                        }
                    }
                }

                document.getElementById('loadProgressFill').style.width = '100%';
                document.getElementById('loadProgressText').textContent = `Loaded ${allEvents.length} events`;

                // Sort by timestamp descending
                allEvents.sort((a, b) => b.ts - a.ts);

                applyFilters();
                updateStats();

            } catch (error) {
                console.error('Failed to load events:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Failed to Load Events</div>
                                <div>${escapeHtml(error.message)}</div>
                                <button class="btn btn-primary" style="margin-top: 16px;" onclick="loadAllEvents()">Try Again</button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function applyFilters() {
            const opFilter = document.getElementById('opFilter').value;
            const entitySearch = document.getElementById('entitySearch').value.trim().toLowerCase();
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;

            filteredEvents = allEvents.filter(event => {
                if (opFilter && event.op !== opFilter) return false;

                if (entitySearch) {
                    const entityId = (event.entity_id || event.target?.id || '').toLowerCase();
                    if (!entityId.includes(entitySearch)) return false;
                }

                if (dateStart) {
                    const startTs = new Date(dateStart).getTime();
                    if (event.ts < startTs) return false;
                }

                if (dateEnd) {
                    const endTs = new Date(dateEnd).setHours(23, 59, 59, 999);
                    if (event.ts > endTs) return false;
                }

                return true;
            });

            currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('eventTableBody');
            const pagination = document.getElementById('pagination');

            if (filteredEvents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No Events Found</div>
                                <div>Try adjusting your filters.</div>
                            </div>
                        </td>
                    </tr>
                `;
                pagination.style.display = 'none';
                document.getElementById('showingCount').textContent = '0';
                return;
            }

            const totalPages = Math.ceil(filteredEvents.length / eventsPerPage);
            const startIdx = (currentPage - 1) * eventsPerPage;
            const endIdx = Math.min(startIdx + eventsPerPage, filteredEvents.length);
            const pageEvents = filteredEvents.slice(startIdx, endIdx);

            tbody.innerHTML = pageEvents.map(renderEventRow).join('');

            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('firstBtn').disabled = currentPage === 1;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
            document.getElementById('lastBtn').disabled = currentPage >= totalPages;
            pagination.style.display = 'flex';

            document.getElementById('showingCount').textContent =
                `${startIdx + 1}-${endIdx} of ${filteredEvents.length.toLocaleString()}`;
        }

        function updateStats() {
            const total = allEvents.length;
            const inserts = allEvents.filter(e => e.op === 'INS').length;
            const updates = allEvents.filter(e => e.op === 'ALT').length;
            const entities = new Set(allEvents.map(e => e.entity_id || e.target?.id)).size;

            document.getElementById('totalEvents').textContent = total.toLocaleString();
            document.getElementById('insertCount').textContent = inserts.toLocaleString();
            document.getElementById('updateCount').textContent = updates.toLocaleString();
            document.getElementById('entityCount').textContent = entities.toLocaleString();
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredEvents.length / eventsPerPage);
            currentPage = Math.max(1, Math.min(page, totalPages));
            renderTable();
            document.querySelector('.table-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // =============================================================================
        // EVENT LISTENERS
        // =============================================================================

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('last-updated').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            loadAllEvents();

            // Filters
            document.getElementById('opFilter').addEventListener('change', applyFilters);
            document.getElementById('entitySearch').addEventListener('input', debounce(applyFilters, 300));
            document.getElementById('dateStart').addEventListener('change', applyFilters);
            document.getElementById('dateEnd').addEventListener('change', applyFilters);
            document.getElementById('refreshBtn').addEventListener('click', loadAllEvents);

            // Pagination
            document.getElementById('firstBtn').addEventListener('click', () => goToPage(1));
            document.getElementById('prevBtn').addEventListener('click', () => goToPage(currentPage - 1));
            document.getElementById('nextBtn').addEventListener('click', () => goToPage(currentPage + 1));
            document.getElementById('lastBtn').addEventListener('click', () => goToPage(Math.ceil(filteredEvents.length / eventsPerPage)));

            document.getElementById('perPageSelect').addEventListener('change', function() {
                eventsPerPage = parseInt(this.value);
                currentPage = 1;
                renderTable();
            });
        });

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }
    </script>
</body>
</html>
