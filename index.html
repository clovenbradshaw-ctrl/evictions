<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nashville Eviction Tracker (Community Project - UNOFFICIAL)</title>
    <link rel="icon" type="image/png" href="https://storage.googleapis.com/intelechia-content/im/eviction%20prevention%20logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/styles/ag-theme-alpine.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #4f46e5;
            --secondary: #06b6d4;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
        }
        
        body { 
            font-family: 'Inter', sans-serif;a
            background: #f9fafb;
        }
        
        .unofficial-banner {
            background: #fef3c7;
            border-bottom: 2px solid #f59e0b;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            color: #92400e;
        }
        
        .data-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        
        .trend-up { color: var(--danger); }
        .trend-down { color: var(--success); }
        
        .district-cell {
            border: 1px solid #e5e7eb;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            font-weight: 600;
            border-radius: 4px;
            position: relative;
        }
        
        .district-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .heat-0 { background: #f3f4f6; color: #9ca3af; }
        .heat-1 { background: #dbeafe; color: #1e40af; }
        .heat-2 { background: #fef3c7; color: #92400e; }
        .heat-3 { background: #fed7aa; color: #9a3412; }
        .heat-4 { background: #fca5a5; color: #991b1b; }
        .heat-5 { background: #ef4444; color: white; }
        
        .activity-dots {
            font-size: 16px;
            line-height: 1;
            letter-spacing: -2px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            font-weight: 500;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .search-input {
            background: white;
            border: 2px solid #e5e7eb;
            padding: 10px 16px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .view-toggle {
            padding: 6px 16px;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            color: #4b5563;
            background: #f9fafb;
            transition: all 0.2s ease;
        }

        .view-toggle.active {
            background: var(--primary);
            color: #ffffff;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        .pivot-option {
            padding: 4px 14px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            color: #4b5563;
            background: #ffffff;
            transition: all 0.2s ease;
        }

        .pivot-option.active {
            background: #dbeafe;
            color: #1d4ed8;
            border-color: #bfdbfe;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.15);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #4338ca;
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }
        
        #dataGrid {
            height: 600px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .ag-theme-alpine {
            --ag-header-background-color: #f9fafb;
            --ag-header-foreground-color: #111827;
            --ag-header-height: 48px;
            --ag-row-hover-color: #f3f4f6;
        }

        .ag-theme-alpine .ag-cell,
        .ag-theme-alpine .ag-header-cell,
        .ag-theme-alpine .ag-header-cell-label {
            -webkit-user-select: text;
            user-select: text;
        }
        
        .chart-container {
            position: relative;
            height: 320px;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-weight: 500;
        }
        
        .status-loading {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .fuzzy-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
        }
        
        .fuzzy-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }
        
        .confidence-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .confidence-high { background: #10b981; color: white; }
        .confidence-med { background: #f59e0b; color: white; }
        .confidence-low { background: #ef4444; color: white; }

        .bulk-results-header {
            padding: 12px 16px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
        }

        .bulk-results-table-wrapper {
            overflow-x: auto;
        }

        .bulk-results-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 720px;
        }

        .bulk-results-table th {
            background: #f3f4f6;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #4b5563;
        }

        .bulk-results-table th,
        .bulk-results-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
            font-size: 13px;
        }

        .bulk-results-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        /* Bulk Upload Modal Styles */
        .upload-modal {
            transition: opacity 0.2s ease-out;
        }

        .upload-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .upload-step {
            display: none;
        }

        .upload-step.active {
            display: block;
        }

        .mapping-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 12px;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .mapping-row:last-child {
            border-bottom: none;
        }

        .mapping-arrow {
            color: #9ca3af;
            font-size: 18px;
        }

        .csv-field {
            background: #f3f4f6;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
        }

        .target-field-select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            font-size: 13px;
            cursor: pointer;
        }

        .target-field-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .upload-preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .upload-preview-table th,
        .upload-preview-table td {
            padding: 8px 10px;
            border: 1px solid #e5e7eb;
            text-align: left;
        }

        .upload-preview-table th {
            background: #f9fafb;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.05em;
        }

        .upload-preview-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        .upload-progress {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .upload-progress-bar {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .upload-status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
        }

        .upload-status-item.success { color: #059669; }
        .upload-status-item.error { color: #dc2626; }
        .upload-status-item.pending { color: #6b7280; }

        .drop-zone {
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }

        .paste-area {
            min-height: 200px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <!-- Unofficial Notice Banner -->
    <div class="unofficial-banner">
        ‚ö†Ô∏è UNOFFICIAL COMMUNITY PROJECT - Not affiliated with Metro Nashville or any government agency
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4">
        <div class="max-w-screen-2xl mx-auto">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">
                        Nashville Eviction Tracker
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">
                        Community-maintained analysis of public court records ‚Ä¢ Data sourced from Sessions Court
                    </p>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-500">Last Updated: <span id="lastUpdate">Loading...</span></span>
                    <button onclick="loadData()" class="btn btn-secondary">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-screen-2xl mx-auto p-6">
        <!-- Status Message -->
        <div id="statusMessage" class="status-message status-loading">
            ‚è≥ Loading data from public records API...
        </div>


        <!-- Key Metrics -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="data-card p-6">
                <div class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Records</div>
                <div id="totalRecords" class="metric-value text-gray-900">-</div>
                <div id="totalChange" class="text-sm mt-2"></div>
            </div>
            <div class="data-card p-6">
                <div class="text-sm font-semibold text-gray-500 uppercase tracking-wide">This Month</div>
                <div id="thisMonth" class="metric-value text-gray-900">-</div>
                <div id="monthChange" class="text-sm mt-2"></div>
            </div>
            <div class="data-card p-6">
                <div class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Last 30 Days</div>
                <div id="last30Days" class="metric-value text-gray-900">-</div>
                <div id="thirtyChange" class="text-sm mt-2"></div>
            </div>
            <div class="data-card p-6">
                <div class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Status: Pending</div>
                <div id="pendingCount" class="metric-value text-orange-600">-</div>
                <div class="text-sm mt-2 text-gray-500">Active cases</div>
            </div>
            <div class="data-card p-6">
                <div class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Individual LL</div>
                <div id="individualLL" class="metric-value text-blue-600">-</div>
                <div class="text-sm mt-2 text-gray-500">vs Corporate</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 gap-6 mb-6">
            <!-- Monthly Trend Chart -->
            <div class="data-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold text-gray-900">Eviction Filings by Month</h2>
                        <span id="chartFilterIndicator" class="hidden"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">Click a point to filter table</span>
                        <button onclick="downloadChart('monthly')" class="text-gray-500 hover:text-gray-700">
                            üìä Export
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- District Heat Map - Hidden (address/district data uncertain) -->
            <div class="data-card p-6 hidden">
                <h2 class="text-xl font-bold text-gray-900 mb-4">District Activity Patterns*</h2>
                <div class="grid grid-cols-7 gap-1" id="districtGrid">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="mt-4 flex items-center justify-between text-xs">
                    <span class="text-gray-500">Lower activity</span>
                    <div class="flex gap-1 items-center">
                        <span class="text-gray-400">‚óã</span>
                        <div class="w-4 h-4 heat-1 rounded"></div>
                        <div class="w-4 h-4 heat-2 rounded"></div>
                        <div class="w-4 h-4 heat-3 rounded"></div>
                        <div class="w-4 h-4 heat-4 rounded"></div>
                        <div class="w-4 h-4 heat-5 rounded"></div>
                        <span class="text-gray-700">‚óè‚óè‚óè</span>
                    </div>
                    <span class="text-gray-500">Higher activity</span>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">Relative distribution based on available data*</p>
            </div>
        </div>

        <!-- Search Section -->
        <div class="data-card p-6 mb-6">
            <div class="border-b border-gray-200 mb-4">
                <div class="flex gap-2">
                    <button onclick="setSearchTab('quick')" class="tab-btn active" id="quickTab">Quick Search</button>
                    <button onclick="setSearchTab('bulk')" class="tab-btn" id="bulkTab">Bulk Search</button>
                    <button onclick="setSearchTab('filter')" class="tab-btn" id="filterTab">Advanced Filters</button>
                </div>
            </div>

            <!-- Quick Search -->
            <div id="quickSearch" class="search-panel">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="searchInput" placeholder="Search any field..." 
                           class="search-input md:col-span-2" onkeyup="quickSearch()">
                    <button onclick="clearSearch()" class="btn btn-secondary">Clear</button>
                </div>
            </div>

            <!-- Bulk Search -->
            <div id="bulkSearch" class="search-panel hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Paste Names (one per line or comma-separated)
                        </label>
                        <textarea id="bulkNames" rows="6" 
                                  placeholder="John Smith&#10;Jane Doe&#10;ABC Properties LLC"
                                  class="search-input w-full font-mono text-sm"></textarea>
                        <div class="mt-3 flex items-center gap-4">
                            <label class="text-sm text-gray-600">Match Threshold:</label>
                            <input type="range" id="fuzzyThreshold" min="0.5" max="1" step="0.05" value="0.8"
                                   class="fuzzy-slider flex-1" oninput="updateThreshold()">
                            <span id="thresholdValue" class="text-sm font-semibold">80%</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Or Upload CSV File
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                            <input type="file" id="csvFile" class="hidden" accept=".csv" onchange="handleCSV(event)">
                            <label for="csvFile" class="cursor-pointer">
                                <div class="text-3xl mb-2">üìÅ</div>
                                <p class="text-sm text-gray-600">Click to upload CSV</p>
                                <p class="text-xs text-gray-400 mt-1">First column should contain names</p>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex gap-2">
                    <button onclick="runBulkSearch()" class="btn btn-primary">Run Fuzzy Match</button>
                    <button onclick="exportMatches()" class="btn btn-secondary">Export Matches</button>
                </div>
                <div id="bulkResults" class="mt-4 hidden max-h-96 overflow-y-auto border rounded-lg"></div>
            </div>

            <!-- Advanced Filters -->
            <div id="filterSearch" class="search-panel hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Status</label>
                        <select id="statusFilter" class="search-input w-full" onchange="applyFilters()">
                            <option value="">All</option>
                            <option value="PENDING">Pending</option>
                            <option value="CLOSED">Closed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Date From</label>
                        <input type="date" id="dateFrom" class="search-input w-full" onchange="applyFilters()">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Date To</label>
                        <input type="date" id="dateTo" class="search-input w-full" onchange="applyFilters()">
                    </div>
                </div>
                <div class="mt-4 flex gap-2">
                    <button onclick="setDateRange(30)" class="btn btn-secondary">Last 30 Days</button>
                    <button onclick="setDateRange(90)" class="btn btn-secondary">Last 90 Days</button>
                    <button onclick="setDateRange(365)" class="btn btn-secondary">Last Year</button>
                    <button onclick="clearFilters()" class="btn btn-secondary">Clear All</button>
                </div>
            </div>
        </div>

        <!-- Data Grid -->
        <div class="data-card p-6">
            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">
                        Eviction Records
                        <span id="recordCount" class="text-sm font-normal text-gray-500"></span>
                    </h2>
                </div>
                <div class="flex flex-wrap items-center gap-2 justify-end">
                    <div class="flex items-center gap-2 bg-gray-100 rounded-full p-1">
                        <button id="recordModeBtn" class="view-toggle active" onclick="setViewMode('records')">Records</button>
                        <button id="pivotModeBtn" class="view-toggle" onclick="setViewMode('pivot')">Summary</button>
                    </div>
                    <div id="pivotDimensionControls" class="flex flex-wrap items-center gap-2 hidden">
                        <span class="text-xs font-semibold tracking-wide text-gray-500 uppercase">Group by</span>
                        <button class="pivot-option active" data-pivot-dimension="plaintiff" onclick="setPivotDimension('plaintiff')">Landlord</button>
                        <button class="pivot-option" data-pivot-dimension="attorney" onclick="setPivotDimension('attorney')">Attorney</button>
                    </div>
                    <div>
                        <button onclick="exportCSV()" class="btn btn-primary">
                            üì• Export CSV
                        </button>
                    </div>
                </div>
            </div>
            <div id="dataGrid" class="ag-theme-alpine"></div>
        </div>
    </div>

    <!-- Case Detail Modal -->
    <div id="caseModal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-start md:items-center justify-center px-4 py-10 z-50 hidden" onclick="if (event.target === this) hideCaseModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden transform transition-all">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Case Detail</p>
                    <h3 id="caseModalTitle" class="text-xl font-bold text-gray-900">Docket #</h3>
                </div>
                <button class="text-gray-400 hover:text-gray-600 text-xl leading-none" onclick="hideCaseModal()" aria-label="Close case detail">
                    &times;
                </button>
            </div>
            <div id="caseModalContent" class="p-6">
                <div id="caseModalMeta" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
                <div>
                    <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Parties &amp; Details</h4>
                    <div id="caseModalDetails" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal (Secret: ESC x3 + "detainer") -->
    <div id="bulkUploadModal" class="upload-modal fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center px-4 py-6 z-[60] hidden" onclick="if (event.target === this) hideBulkUploadModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Admin Tool</p>
                    <h3 class="text-xl font-bold text-gray-900">Bulk Upload Detainer Cases</h3>
                </div>
                <button class="text-gray-400 hover:text-gray-600 text-2xl leading-none" onclick="hideBulkUploadModal()" aria-label="Close upload modal">
                    &times;
                </button>
            </div>

            <!-- Step Indicator -->
            <div class="px-6 py-3 bg-gray-50 border-b border-gray-200">
                <div class="flex items-center justify-center gap-2">
                    <div id="stepIndicator1" class="flex items-center gap-2">
                        <span class="w-7 h-7 rounded-full bg-indigo-600 text-white text-sm font-bold flex items-center justify-center">1</span>
                        <span class="text-sm font-medium text-gray-700">Import Data</span>
                    </div>
                    <div class="w-8 h-0.5 bg-gray-300"></div>
                    <div id="stepIndicator2" class="flex items-center gap-2 opacity-50">
                        <span class="w-7 h-7 rounded-full bg-gray-300 text-gray-600 text-sm font-bold flex items-center justify-center">2</span>
                        <span class="text-sm font-medium text-gray-500">Map Fields</span>
                    </div>
                    <div class="w-8 h-0.5 bg-gray-300"></div>
                    <div id="stepIndicator3" class="flex items-center gap-2 opacity-50">
                        <span class="w-7 h-7 rounded-full bg-gray-300 text-gray-600 text-sm font-bold flex items-center justify-center">3</span>
                        <span class="text-sm font-medium text-gray-500">Preview & Upload</span>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Step 1: Import Data -->
                <div id="uploadStep1" class="upload-step active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- File Upload -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Upload CSV File</label>
                            <div id="uploadDropZone" class="drop-zone" onclick="document.getElementById('bulkUploadFile').click()">
                                <input type="file" id="bulkUploadFile" class="hidden" accept=".csv" onchange="handleBulkUploadFile(event)">
                                <div class="text-4xl mb-3">üìÑ</div>
                                <p class="text-gray-700 font-medium">Drop CSV file here or click to browse</p>
                                <p class="text-sm text-gray-500 mt-2">Supports .csv files</p>
                            </div>
                        </div>

                        <!-- Paste CSV -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Or Paste CSV Data</label>
                            <textarea id="bulkUploadPaste"
                                class="search-input w-full paste-area"
                                placeholder="Paste CSV data here...&#10;&#10;Example:&#10;Office,Docket_Number,Status,File_Date,Plaintiff_Petitioner,Defendant_Respondent&#10;1,24GT12345,PENDING,2024-01-15,Property LLC,John Doe"></textarea>
                        </div>
                    </div>

                    <div id="uploadFileInfo" class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg hidden">
                        <div class="flex items-center gap-2 text-green-700">
                            <span>‚úì</span>
                            <span id="uploadFileName" class="font-medium"></span>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Field Mapping -->
                <div id="uploadStep2" class="upload-step">
                    <div class="mb-4">
                        <p class="text-gray-600">Map your CSV columns to the database fields. Auto-mapping has been applied where possible.</p>
                    </div>
                    <div id="fieldMappingContainer" class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                        <!-- Mapping rows will be inserted here -->
                    </div>
                </div>

                <!-- Step 3: Preview & Upload -->
                <div id="uploadStep3" class="upload-step">
                    <div class="mb-4 flex items-center justify-between">
                        <p class="text-gray-600">Review the data before uploading. Showing first 10 rows.</p>
                        <span id="uploadRowCount" class="text-sm font-medium text-gray-500"></span>
                    </div>

                    <div class="overflow-x-auto border rounded-lg mb-4" style="max-height: 300px; overflow-y: auto;">
                        <table id="uploadPreviewTable" class="upload-preview-table">
                            <thead id="uploadPreviewHead"></thead>
                            <tbody id="uploadPreviewBody"></tbody>
                        </table>
                    </div>

                    <!-- Upload Progress -->
                    <div id="uploadProgressSection" class="hidden">
                        <div class="mb-2 flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">Uploading...</span>
                            <span id="uploadProgressText" class="text-sm text-gray-500">0%</span>
                        </div>
                        <div class="upload-progress mb-4">
                            <div id="uploadProgressBar" class="upload-progress-bar" style="width: 0%"></div>
                        </div>
                        <div id="uploadStatusLog" class="max-h-40 overflow-y-auto bg-gray-50 rounded-lg p-3">
                            <!-- Status items will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-between">
                <button id="uploadBackBtn" class="btn btn-secondary hidden" onclick="uploadPrevStep()">
                    ‚Üê Back
                </button>
                <div class="flex-1"></div>
                <button id="uploadNextBtn" class="btn btn-primary" onclick="uploadNextStep()">
                    Next ‚Üí
                </button>
                <button id="uploadSubmitBtn" class="btn btn-primary hidden" onclick="submitBulkUpload()">
                    Upload Data
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allData = [];
        let filteredData = [];
        let gridApi;
        let monthlyChart;
        let searchMatches = [];
        let pivotData = [];
        let viewMode = 'records';
        let pivotDimension = 'plaintiff';

        const pivotFieldMap = {
            plaintiff: 'Plaintiff',
            attorney: 'Attorney',
            district: 'District'
        };

        const pivotDimensionLabels = {
            plaintiff: 'Landlord',
            attorney: 'Attorney',
            district: 'District*'
        };

        const recordColumnDefs = [
            { field: 'File_Date', headerName: 'File Date', width: 110,
              valueFormatter: params => new Date(params.value).toLocaleDateString() },
            { field: 'Case_Number', headerName: 'Docket #', width: 120 },
            { field: 'Plaintiff', headerName: 'Plaintiff/Landlord', width: 250 },
            { field: 'Defendant', headerName: 'Defendant/Tenant', width: 250 },
            { field: 'Attorney', headerName: 'Attorney', width: 200 },
            { field: 'Status', headerName: 'Status', width: 100,
              cellStyle: params => {
                  if (params.value === 'PENDING') return { color: '#f59e0b', fontWeight: 'bold' };
                  if (params.value === 'CLOSED') return { color: '#6b7280' };
                  return null;
              }
            }
        ];

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            initCharts();
            updatePivotControls();
        });

        function cleanAttorney(attorney) {
            if (!attorney) return '';

            const proSeTokens = new Set([
                'PRO SE',
                'PRO-SE',
                'PROSE',
                'PRO SE LITIGANT',
                'PRS'
            ]);

            const segments = String(attorney)
                .replace(/\s+/g, ' ')
                .replace(/\s*,\s*/g, ', ')
                .trim()
                .split(',')
                .map(segment => segment.replace(/\s+/g, ' ').trim())
                .filter(Boolean);

            const normalizedSegments = [];
            const seen = new Set();

            for (const segment of segments) {
                const cleanedSegment = segment
                    .replace(/^[^A-Za-z0-9'&.-]+/, '')
                    .replace(/[^A-Za-z0-9'&.-]+$/, '')
                    .trim();

                if (!cleanedSegment) continue;

                const comparisonValue = cleanedSegment.replace(/\./g, '').toUpperCase();
                if (proSeTokens.has(comparisonValue)) {
                    continue;
                }

                if (seen.has(comparisonValue)) continue;
                seen.add(comparisonValue);
                normalizedSegments.push(cleanedSegment);
            }

            if (normalizedSegments.length === 0) {
                return 'Pro Se';
            }

            return normalizedSegments.join(', ');
        }

        async function loadData() {
            try {
                updateStatus('Loading data from public records API...', 'loading');
                
                const response = await fetch('https://xvkq-pq7i-idtl.n7d.xano.io/api:gx-QnxD1/detainers');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Handle different response formats
                let data;
                if (Array.isArray(result)) {
                    data = result;
                } else if (result?.items) {
                    data = result.items;
                } else if (result?.data) {
                    data = result.data;
                } else {
                    data = [result];
                }
                
                allData = data.map(normalizeRecord);
                filteredData = allData;
                
                updateStatus(`Loaded ${allData.length} records from public court data`, 'success');
                updateMetrics();
                updateCharts();
                createDistrictMap();
                initGrid();
                
                // Update last update time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                
            } catch (error) {
                console.error('Error loading data:', error);
                updateStatus(`Error loading data: ${error.message}`, 'error');
            }
        }

        function normalizeRecord(record) {
            const normalized = {
                ...record,
                File_Date: record.File_Date || record.file_date,
                Status: record.Status || record.status || 'UNKNOWN',
                Plaintiff: record.Plaintiff_Petitioner || record.Plaintiff || record.plaintiff || '',
                Defendant: record.Defendant_Respondent || record.Defendant || record.defendant || '',
                Address: record.address_formatted || record.formatted_address || record.address || '',
                District: record.council_district_number || record.council_district || 'Unknown',
                Case_Number: record.Docket_Number || record.Case_Number || record.case_number || record.id || '',
                Attorney: cleanAttorney(record.Attorney || record.attorney || ''),
                CouncilMember: record.council_member || '',
                individual_ll: record.individual_ll === "1" || record.individual_ll === true || record.individual_ll === 'true'
            };
            
            // Only mark as unknown for TRULY generic addresses
            const addressLower = normalized.Address.toLowerCase().trim();
            
            // Check if this is JUST a generic address (not part of a real address)
            const isGenericAddress = 
                // Exactly "Nashville, TN, USA" or similar (no street info)
                /^nashville,?\s*(tn|tennessee)?,?\s*(usa)?$/i.test(addressLower) ||
                // Just "1 Public Square" (individual landlord placeholder)
                addressLower.includes('1 public square') ||
                // Just an apartment number with no street
                /^#\d+,?\s*nashville/i.test(addressLower) ||
                // Empty or missing
                addressLower === '' ||
                addressLower === 'unknown';
            
            if (isGenericAddress) {
                normalized.District = 'Unknown';
                normalized.CouncilMember = 'Unknown';
            }
            
            // Also mark as unknown if district is 0 or invalid
            if (normalized.District === 0 || normalized.District === '0' || normalized.District === null) {
                normalized.District = 'Unknown';
            }
            
            // Mark individual landlords as unknown district (they're all at city hall)
            if (normalized.individual_ll === true || normalized.individual_ll === "1") {
                normalized.District = 'Unknown';
                if (!normalized.CouncilMember || normalized.CouncilMember === 'unknown') {
                    normalized.CouncilMember = 'Individual Landlord';
                }
            }
            
            return normalized;
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            
            // Hide after success
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        function updateMetrics() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            // Total records
            document.getElementById('totalRecords').textContent = allData.length.toLocaleString();
            
            // This month
            const thisMonthCount = allData.filter(d => {
                const date = new Date(d.File_Date);
                return date >= thisMonthStart;
            }).length;
            document.getElementById('thisMonth').textContent = thisMonthCount.toLocaleString();
            
            // Last 30 days
            const last30Count = allData.filter(d => {
                const date = new Date(d.File_Date);
                return date >= thirtyDaysAgo;
            }).length;
            document.getElementById('last30Days').textContent = last30Count.toLocaleString();
            
            // Pending
            const pendingCount = allData.filter(d => d.Status === 'PENDING').length;
            document.getElementById('pendingCount').textContent = pendingCount.toLocaleString();
            
            // Individual landlords
            const individualCount = allData.filter(d => d.individual_ll === true || d.individual_ll === "1").length;

            document.getElementById('individualLL').textContent = individualCount.toLocaleString();
        }

        // Track active chart filter for month/year
        let chartFilter = null;

        function initCharts() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'point',
                        intersect: true
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} filings`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Filings'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const element = elements[0];
                            const datasetIndex = element.datasetIndex;
                            const monthIndex = element.index;
                            const year = monthlyChart.data.datasets[datasetIndex].label;
                            const month = monthIndex + 1;
                            filterByChartClick(year, month);
                        }
                    },
                    onHover: function(event, elements) {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
        }

        function updateCharts() {
            // Group data by year and month
            const yearMonthCounts = {};

            allData.forEach(record => {
                const date = new Date(record.File_Date);
                if (isNaN(date.getTime())) return;

                const year = date.getFullYear();
                const month = date.getMonth(); // 0-11

                if (!yearMonthCounts[year]) {
                    yearMonthCounts[year] = new Array(12).fill(0);
                }
                yearMonthCounts[year][month]++;
            });

            // Get sorted years
            const years = Object.keys(yearMonthCounts).sort();

            // Color palette for different years
            const colors = [
                { bg: 'rgba(79, 70, 229, 0.2)', border: '#4f46e5' },   // Indigo
                { bg: 'rgba(16, 185, 129, 0.2)', border: '#10b981' },  // Emerald
                { bg: 'rgba(245, 158, 11, 0.2)', border: '#f59e0b' },  // Amber
                { bg: 'rgba(239, 68, 68, 0.2)', border: '#ef4444' },   // Red
                { bg: 'rgba(6, 182, 212, 0.2)', border: '#06b6d4' },   // Cyan
                { bg: 'rgba(168, 85, 247, 0.2)', border: '#a855f7' },  // Purple
                { bg: 'rgba(236, 72, 153, 0.2)', border: '#ec4899' },  // Pink
                { bg: 'rgba(34, 197, 94, 0.2)', border: '#22c55e' }    // Green
            ];

            // Create datasets for each year
            const datasets = years.map((year, index) => ({
                label: year,
                data: yearMonthCounts[year],
                backgroundColor: colors[index % colors.length].bg,
                borderColor: colors[index % colors.length].border,
                borderWidth: 2,
                fill: false,
                tension: 0.3,
                pointRadius: 4,
                pointHoverRadius: 7,
                pointBackgroundColor: colors[index % colors.length].border
            }));

            monthlyChart.data.datasets = datasets;
            monthlyChart.update();
        }

        function filterByChartClick(year, month) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];

            chartFilter = { year: parseInt(year), month: month };

            filteredData = allData.filter(record => {
                const date = new Date(record.File_Date);
                if (isNaN(date.getTime())) return false;
                return date.getFullYear() === chartFilter.year &&
                       (date.getMonth() + 1) === chartFilter.month;
            });

            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }

            if (gridApi) {
                if (viewMode === 'pivot') {
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setRowData(filteredData);
                }
            }

            updateRecordCount();
            updateChartFilterIndicator();
            updateStatus(`Filtered to ${monthNames[month - 1]} ${year} - ${filteredData.length} records`, 'success');
        }

        function clearChartFilter() {
            chartFilter = null;
            filteredData = allData;

            // Re-apply any existing filters from the filter panel
            const status = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            if (status || dateFrom || dateTo) {
                applyFilters();
            } else {
                if (viewMode === 'pivot') {
                    pivotData = buildPivotData(pivotDimension);
                }

                if (gridApi) {
                    if (viewMode === 'pivot') {
                        gridApi.setRowData(pivotData);
                    } else {
                        gridApi.setRowData(filteredData);
                    }
                }
            }

            updateRecordCount();
            updateChartFilterIndicator();
            updateStatus(`Showing all ${allData.length} records`, 'success');
        }

        function updateChartFilterIndicator() {
            const indicator = document.getElementById('chartFilterIndicator');
            if (!indicator) return;

            if (chartFilter) {
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                indicator.innerHTML = `
                    <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium">
                        Filtered: ${monthNames[chartFilter.month - 1]} ${chartFilter.year}
                        <button onclick="clearChartFilter()" class="ml-2 text-indigo-600 hover:text-indigo-800 font-bold">&times;</button>
                    </span>
                `;
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        function createDistrictMap() {
            const districtCounts = {};
            let unknownCount = 0;
            
            filteredData.forEach(record => {
                const district = record.District;
                if (district === 'Unknown' || district === 'unknown') {
                    unknownCount++;
                } else if (district && !isNaN(district)) {
                    districtCounts[district] = (districtCounts[district] || 0) + 1;
                }
            });
            
            const maxCount = Math.max(...Object.values(districtCounts), 1);
            const grid = document.getElementById('districtGrid');
            
            let html = '';
            for (let i = 1; i <= 35; i++) {
                const count = districtCounts[i] || 0;
                const intensity = count / maxCount;
                let heatClass = 'heat-0';
                let descriptor = '';
                
                if (intensity > 0.8) {
                    heatClass = 'heat-5';
                    descriptor = '‚óè‚óè‚óè';
                } else if (intensity > 0.6) {
                    heatClass = 'heat-4';
                    descriptor = '‚óè‚óè‚óè';
                } else if (intensity > 0.4) {
                    heatClass = 'heat-3';
                    descriptor = '‚óè‚óè';
                } else if (intensity > 0.2) {
                    heatClass = 'heat-2';
                    descriptor = '‚óè‚óè';
                } else if (intensity > 0) {
                    heatClass = 'heat-1';
                    descriptor = '‚óè';
                } else {
                    descriptor = '‚óã';
                }
                
                html += `
                    <div class="district-cell ${heatClass}"
                         onclick="filterByDistrict(${i})"
                         title="District ${i}*">
                        <div class="text-center">
                            <div class="text-sm font-bold opacity-80">${i}</div>
                            <div class="activity-dots mt-1">${descriptor}</div>
                        </div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
            
            // Add unknown count below the grid if there are any
            if (unknownCount > 0) {
                const existingUnknown = grid.parentElement.querySelector('.unknown-district-info');
                if (existingUnknown) {
                    existingUnknown.remove();
                }
                
                const unknownDiv = document.createElement('div');
                unknownDiv.className = 'unknown-district-info mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm cursor-pointer hover:bg-yellow-100 transition';
                unknownDiv.innerHTML = `
                    <span class="text-gray-700">Additional records with unverified district information available*</span>
                    <span class="text-xs text-gray-600 ml-2">(click to view)</span>
                `;
                unknownDiv.onclick = () => filterByDistrict('Unknown');
                grid.parentElement.appendChild(unknownDiv);
            }
        }

        function initGrid() {
            const gridOptions = {
                columnDefs: recordColumnDefs,
                rowData: filteredData,
                defaultColDef: {
                    sortable: true,
                    filter: true,
                    resizable: true
                },
                enableCellTextSelection: true,
                ensureDomOrder: true,
                pagination: true,
                paginationPageSize: 20,
                animateRows: true,
                onRowClicked: event => {
                    if (viewMode !== 'records') return;
                    showCaseModal(event.data);
                },
                onGridReady: params => {
                    gridApi = params.api;
                    if (viewMode === 'pivot') {
                        pivotData = buildPivotData(pivotDimension);
                        gridApi.setColumnDefs(getPivotColumnDefs());
                        gridApi.setRowData(pivotData);
                    }
                    updateRecordCount();
                }
            };

            const gridDiv = document.querySelector('#dataGrid');
            if (gridApi) {
                if (viewMode === 'pivot') {
                    pivotData = buildPivotData(pivotDimension);
                    gridApi.setColumnDefs(getPivotColumnDefs());
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setColumnDefs(recordColumnDefs);
                    gridApi.setRowData(filteredData);
                }
            } else {
                new agGrid.Grid(gridDiv, gridOptions);
            }
        }

        function updateRecordCount() {
            const count = document.getElementById('recordCount');
            if (!count) return;

            const displayedRows = gridApi ? gridApi.getDisplayedRowCount() : 0;

            if (viewMode === 'pivot') {
                const totalGroups = pivotData.length;
                if (displayedRows && displayedRows !== totalGroups) {
                    count.textContent = `(${displayedRows} of ${totalGroups} summary groups)`;
                } else {
                    count.textContent = `(${totalGroups} summary groups)`;
                }
            } else {
                const totalRecords = filteredData.length;
                if (displayedRows && displayedRows !== totalRecords) {
                    count.textContent = `(${displayedRows} of ${totalRecords} records)`;
                } else {
                    count.textContent = `(${totalRecords} records)`;
                }
            }
        }

        function formatModalValue(value, { fallback = 'Not available', transform } = {}) {
            if (value === null || value === undefined) return fallback;
            let output = typeof transform === 'function' ? transform(value) : value;
            if (typeof output === 'string') {
                const trimmed = output.trim();
                return trimmed.length > 0 ? trimmed : fallback;
            }
            if (Number.isFinite(output)) {
                return output.toLocaleString();
            }
            return output || fallback;
        }

        function showCaseModal(record) {
            if (!record) return;

            const modal = document.getElementById('caseModal');
            if (!modal) return;

            const title = document.getElementById('caseModalTitle');
            const metaContainer = document.getElementById('caseModalMeta');
            const detailContainer = document.getElementById('caseModalDetails');

            const formatDate = value => {
                if (!value) return 'Not available';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return formatModalValue(value);
                return date.toLocaleDateString();
            };

            title.textContent = record.Case_Number ? `Docket #${record.Case_Number}` : 'Case Detail';

            const statusValue = formatModalValue(record.Status || record.status || 'Unknown', {
                transform: value => String(value).toUpperCase()
            });
            const statusClass = statusValue === 'PENDING'
                ? 'text-orange-600'
                : statusValue === 'CLOSED'
                    ? 'text-gray-600'
                    : 'text-gray-900';

            const metaEntries = [
                {
                    label: 'Filed',
                    value: formatDate(record.File_Date)
                },
                {
                    label: 'Status',
                    value: statusValue,
                    className: statusClass
                }
            ];

            metaContainer.innerHTML = '';
            metaEntries.forEach(entry => {
                const card = document.createElement('div');
                card.className = 'p-4 bg-gray-50 rounded-lg border border-gray-100';

                const labelEl = document.createElement('p');
                labelEl.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wide';
                labelEl.textContent = entry.label;

                const valueEl = document.createElement('p');
                valueEl.className = `mt-1 text-base font-semibold ${entry.className || 'text-gray-900'}`;
                valueEl.textContent = entry.value;

                card.appendChild(labelEl);
                card.appendChild(valueEl);
                metaContainer.appendChild(card);
            });

            const details = [
                { label: 'Docket #', value: record.Case_Number || record.case_number || record.id },
                { label: 'Plaintiff / Landlord', value: record.Plaintiff || record.plaintiff },
                { label: 'Defendant / Tenant', value: record.Defendant || record.defendant },
                { label: 'Attorney of Record', value: record.Attorney || record.attorney },
                { label: 'Case Notes', value: record.Notes || record.notes }
            ];

            const supplementalFields = [
                { key: 'Disposition', label: 'Disposition' },
                { key: 'Disposition_Date', label: 'Disposition Date', formatter: formatDate },
                { key: 'Hearing_Date', label: 'Hearing Date', formatter: formatDate },
                {
                    key: 'Amount_Claimed',
                    label: 'Amount Claimed',
                    formatter: value => {
                        const numeric = Number(value);
                        return Number.isFinite(numeric) ? `$${numeric.toLocaleString()}` : formatModalValue(value);
                    }
                },
                {
                    key: 'Amount_Judgment',
                    label: 'Judgment Amount',
                    formatter: value => {
                        const numeric = Number(value);
                        return Number.isFinite(numeric) ? `$${numeric.toLocaleString()}` : formatModalValue(value);
                    }
                },
                {
                    key: 'individual_ll',
                    label: 'Individual Landlord',
                    formatter: value => (value === true || value === '1' || value === 1 ? 'Yes' : 'No')
                }
            ];

            supplementalFields.forEach(field => {
                const possibleKeys = typeof field.key === 'string'
                    ? [field.key, field.key.toLowerCase()]
                    : [field.key];

                let fieldValue;
                for (const key of possibleKeys) {
                    if (key in record && record[key] !== undefined && record[key] !== null) {
                        fieldValue = record[key];
                        break;
                    }
                }

                if (fieldValue !== undefined && fieldValue !== null && String(fieldValue).trim() !== '') {
                    details.push({
                        label: field.label,
                        value: typeof field.formatter === 'function' ? field.formatter(fieldValue) : fieldValue
                    });
                }
            });

            detailContainer.innerHTML = '';
            details
                .filter(detail => detail.value !== undefined && detail.value !== null && String(detail.value).trim() !== '')
                .forEach(detail => {
                    const row = document.createElement('div');
                    row.className = 'border border-gray-100 rounded-lg p-4';

                    const labelEl = document.createElement('p');
                    labelEl.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wide';
                    labelEl.textContent = detail.label;

                    const valueEl = document.createElement('p');
                    valueEl.className = 'mt-2 text-sm text-gray-900 leading-relaxed break-words';
                    valueEl.textContent = typeof detail.value === 'string' ? detail.value.trim() : detail.value;

                    row.appendChild(labelEl);
                    row.appendChild(valueEl);
                    detailContainer.appendChild(row);
                });

            if (!detailContainer.childElementCount) {
                const emptyEl = document.createElement('p');
                emptyEl.className = 'text-sm text-gray-500';
                emptyEl.textContent = 'No additional details available for this record.';
                detailContainer.appendChild(emptyEl);
            }

            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function hideCaseModal() {
            const modal = document.getElementById('caseModal');
            if (!modal) return;
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        document.addEventListener('keydown', event => {
            if (event.key === 'Escape') {
                const modal = document.getElementById('caseModal');
                if (modal && !modal.classList.contains('hidden')) {
                    hideCaseModal();
                }
            }
        });

        function setSearchTab(tab) {
            // Update tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tab}Tab`).classList.add('active');
            
            // Show/hide panels
            document.getElementById('quickSearch').classList.toggle('hidden', tab !== 'quick');
            document.getElementById('bulkSearch').classList.toggle('hidden', tab !== 'bulk');
            document.getElementById('filterSearch').classList.toggle('hidden', tab !== 'filter');
        }

        function quickSearch() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            if (!gridApi) return;
            
            gridApi.setQuickFilter(searchText);
            updateRecordCount();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            if (gridApi) {
                gridApi.setQuickFilter('');
                updateRecordCount();
            }
        }

        function runBulkSearch() {
            const input = document.getElementById('bulkNames').value;
            const threshold = parseFloat(document.getElementById('fuzzyThreshold').value);
            const searchTerms = input.split(/[,\n]/).map(t => t.trim()).filter(t => t);
            
            if (searchTerms.length === 0) return;
            
            searchMatches = [];
            
            searchTerms.forEach(term => {
                filteredData.forEach(record => {
                    const fields = [record.Plaintiff, record.Defendant];
                    fields.forEach(field => {
                        if (field) {
                            const similarity = calculateSimilarity(term.toLowerCase(), field.toLowerCase());
                            if (similarity >= threshold) {
                                searchMatches.push({
                                    searchTerm: term,
                                    match: field,
                                    record: record,
                                    confidence: similarity
                                });
                            }
                        }
                    });
                });
            });
            
            displayBulkResults(searchMatches);
        }

        function calculateSimilarity(str1, str2) {
            // Levenshtein distance implementation
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            const longerLength = longer.length;
            
            if (longerLength === 0) return 1.0;
            
            const editDistance = levenshtein(longer, shorter);
            return (longerLength - editDistance) / parseFloat(longerLength);
        }

        function levenshtein(s1, s2) {
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }

            return value
                .toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function displayBulkResults(results) {
            const resultsDiv = document.getElementById('bulkResults');

            if (!resultsDiv) return;

            if (results.length === 0) {
                resultsDiv.innerHTML = '<p class="p-4 text-gray-500">No matches found</p>';
            } else {
                const rows = results.map(r => {
                    const confClass = r.confidence > 0.9 ? 'confidence-high' :
                                     r.confidence > 0.8 ? 'confidence-med' : 'confidence-low';
                    const fileDate = r.record.File_Date ? new Date(r.record.File_Date).toLocaleDateString() : '‚Äî';

                    return `
                        <tr>
                            <td>${escapeHtml(r.searchTerm)}</td>
                            <td>${escapeHtml(r.match)}</td>
                            <td><span class="confidence-badge ${confClass}">${(r.confidence * 100).toFixed(0)}%</span></td>
                            <td>${escapeHtml(fileDate)}</td>
                            <td>${escapeHtml(r.record.Attorney || 'Unavailable')}</td>
                            <td>${escapeHtml(r.record.Status || 'Unavailable')}</td>
                        </tr>
                    `;
                }).join('');

                resultsDiv.innerHTML = `
                    <div class="bulk-results-header">Found ${results.length} matches</div>
                    <div class="bulk-results-table-wrapper">
                        <table class="bulk-results-table">
                            <thead>
                                <tr>
                                    <th>Search Term</th>
                                    <th>Matched Name</th>
                                    <th>Confidence</th>
                                    <th>File Date</th>
                                    <th>Attorney</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            resultsDiv.classList.remove('hidden');
            resultsDiv.scrollTop = 0;
        }

        function updateThreshold() {
            const value = document.getElementById('fuzzyThreshold').value;
            document.getElementById('thresholdValue').textContent = `${Math.round(value * 100)}%`;
        }

        function setDateRange(days) {
            const now = new Date();
            const past = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
            
            document.getElementById('dateFrom').value = past.toISOString().split('T')[0];
            document.getElementById('dateTo').value = now.toISOString().split('T')[0];
            
            applyFilters();
        }

        function applyFilters() {
            // Clear chart filter when applying advanced filters
            chartFilter = null;
            updateChartFilterIndicator();

            const status = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            filteredData = allData.filter(record => {
                // Status filter
                if (status && record.Status !== status) return false;

                // Date filter
                if (dateFrom || dateTo) {
                    const recordDate = new Date(record.File_Date);
                    if (dateFrom && recordDate < new Date(dateFrom)) return false;
                    if (dateTo && recordDate > new Date(dateTo)) return false;
                }

                return true;
            });

            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }

            if (gridApi) {
                if (viewMode === 'pivot') {
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setRowData(filteredData);
                }
            }
            updateRecordCount();
            createDistrictMap();
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';

            // Also clear chart filter
            chartFilter = null;
            updateChartFilterIndicator();

            filteredData = allData;
            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }
            if (gridApi) {
                if (viewMode === 'pivot') {
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setRowData(filteredData);
                }
            }
            updateRecordCount();
            createDistrictMap();
        }

        function buildPivotData(dimension) {
            const field = pivotFieldMap[dimension] || pivotFieldMap.plaintiff;
            const summaries = new Map();

            filteredData.forEach(record => {
                const rawKey = record[field];
                const key = rawKey && String(rawKey).trim() !== '' ? String(rawKey).trim() : 'Unknown';

                if (!summaries.has(key)) {
                    summaries.set(key, {
                        groupKey: key,
                        totalFilings: 0,
                        pending: 0,
                        closed: 0,
                        other: 0,
                        lastFiled: null,
                        properties: new Set()
                    });
                }

                const summary = summaries.get(key);
                summary.totalFilings += 1;

                if (record.Status === 'PENDING') {
                    summary.pending += 1;
                } else if (record.Status === 'CLOSED') {
                    summary.closed += 1;
                } else {
                    summary.other += 1;
                }

                if (record.File_Date) {
                    const fileDate = new Date(record.File_Date);
                    if (!isNaN(fileDate)) {
                        if (!summary.lastFiled || fileDate > summary.lastFiled) {
                            summary.lastFiled = fileDate;
                        }
                    }
                }

                if (record.Address) {
                    summary.properties.add(String(record.Address).trim().toLowerCase());
                }
            });

            return Array.from(summaries.values())
                .map(summary => ({
                    groupKey: summary.groupKey,
                    totalFilings: summary.totalFilings,
                    pending: summary.pending,
                    closed: summary.closed,
                    other: summary.other,
                    lastFiled: summary.lastFiled ? summary.lastFiled.toISOString() : '',
                    uniqueProperties: summary.properties.size
                }))
                .sort((a, b) => b.totalFilings - a.totalFilings);
        }

        function filterByDistrict(district) {
            // Clear chart filter when filtering by district
            chartFilter = null;
            updateChartFilterIndicator();

            if (district === 'Unknown' || district === 'unknown') {
                filteredData = allData.filter(r => r.District === 'Unknown' || r.District === 'unknown');
            } else {
                filteredData = allData.filter(r => r.District == district);
            }

            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }

            if (gridApi) {
                if (viewMode === 'pivot') {
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setRowData(filteredData);
                }
            }
            updateRecordCount();

            // Update status message without exact counts
            const filterMsg = district === 'Unknown' ? 'unverified districts*' : `District ${district}*`;
            updateStatus(`Showing records for ${filterMsg}`, 'success');
        }

        function getPivotColumnDefs() {
            const label = pivotDimensionLabels[pivotDimension] || 'Group';

            return [
                { field: 'groupKey', headerName: label, flex: 2, minWidth: 160 },
                { field: 'totalFilings', headerName: 'Total Filings', width: 140, sort: 'desc', sortIndex: 0 },
                { field: 'pending', headerName: 'Pending', width: 120 },
                { field: 'closed', headerName: 'Closed', width: 120 },
                { field: 'other', headerName: 'Other Status', width: 140 },
                { field: 'lastFiled', headerName: 'Last Filing', width: 140,
                  valueFormatter: params => params.value ? new Date(params.value).toLocaleDateString() : '' }
            ];
        }

        function setViewMode(mode) {
            const nextMode = mode === 'pivot' ? 'pivot' : 'records';
            if (viewMode === nextMode) {
                updatePivotControls();
                updateRecordCount();
                return;
            }

            viewMode = nextMode;

            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }

            if (gridApi) {
                if (viewMode === 'pivot') {
                    gridApi.setColumnDefs(getPivotColumnDefs());
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setColumnDefs(recordColumnDefs);
                    gridApi.setRowData(filteredData);
                }
            }

            updatePivotControls();
            updateRecordCount();
        }

        function setPivotDimension(dimension) {
            if (!pivotFieldMap[dimension]) {
                dimension = 'plaintiff';
            }

            if (pivotDimension === dimension) {
                updatePivotControls();
                return;
            }

            pivotDimension = dimension;

            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }

            if (viewMode === 'pivot' && gridApi) {
                gridApi.setColumnDefs(getPivotColumnDefs());
                gridApi.setRowData(pivotData);
            }

            updatePivotControls();
            updateRecordCount();
        }

        function updatePivotControls() {
            const recordBtn = document.getElementById('recordModeBtn');
            const pivotBtn = document.getElementById('pivotModeBtn');
            const pivotControls = document.getElementById('pivotDimensionControls');

            if (recordBtn) {
                recordBtn.classList.toggle('active', viewMode !== 'pivot');
            }

            if (pivotBtn) {
                pivotBtn.classList.toggle('active', viewMode === 'pivot');
            }

            if (pivotControls) {
                pivotControls.classList.toggle('hidden', viewMode !== 'pivot');
            }

            document.querySelectorAll('.pivot-option').forEach(button => {
                const isActive = button.dataset.pivotDimension === pivotDimension;
                button.classList.toggle('active', isActive);
            });
        }

        function exportCSV() {
            let csv = 'File Date,Docket Number,Plaintiff,Defendant,Attorney,Status\n';

            filteredData.forEach(row => {
                csv += `"${new Date(row.File_Date).toLocaleDateString()}","${row.Case_Number}","${row.Plaintiff}","${row.Defendant}","${row.Attorney}","${row.Status}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eviction_data_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function exportMatches() {
            if (searchMatches.length === 0) {
                alert('No matches to export. Run a bulk search first.');
                return;
            }

            let csv = 'Search Term,Matched Name,Confidence,File Date,Attorney,Status\n';

            searchMatches.forEach(match => {
                csv += `"${match.searchTerm}","${match.match}","${(match.confidence * 100).toFixed(1)}%","${new Date(match.record.File_Date).toLocaleDateString()}","${match.record.Attorney}","${match.record.Status}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fuzzy_matches_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ============================================
        // BULK UPLOAD TOOL (Secret: ESC x3 + "detainer")
        // ============================================

        // Secret key combo state
        let escPressCount = 0;
        let escPressTimer = null;
        let secretInputBuffer = '';
        let secretInputTimer = null;
        let secretModeActive = false;

        // Bulk upload state
        let bulkUploadStep = 1;
        let bulkUploadData = [];
        let bulkUploadHeaders = [];
        let bulkUploadFieldMapping = {};

        // Target schema fields for the API
        const targetSchemaFields = [
            { key: 'id', label: 'ID', type: 'integer' },
            { key: 'Office', label: 'Office', type: 'text' },
            { key: 'Docket_Number', label: 'Docket Number', type: 'text' },
            { key: 'Status', label: 'Status', type: 'text' },
            { key: 'File_Date', label: 'File Date', type: 'text' },
            { key: 'Description', label: 'Description', type: 'text' },
            { key: 'Plaintiff_Petitioner', label: 'Plaintiff/Petitioner', type: 'text' },
            { key: 'Defendant_Respondent', label: 'Defendant/Respondent', type: 'text' },
            { key: 'Attorney', label: 'Attorney', type: 'text' },
            { key: 'address_formatted', label: 'Address (Formatted)', type: 'text' },
            { key: 'council_member', label: 'Council Member', type: 'text' },
            { key: 'longitude', label: 'Longitude', type: 'text' },
            { key: 'latitude', label: 'Latitude', type: 'text' },
            { key: 'council_district', label: 'Council District', type: 'text' },
            { key: 'council_district_number', label: 'Council District Number', type: 'integer' },
            { key: 'individual_ll', label: 'Individual Landlord', type: 'text' }
        ];

        // Auto-mapping rules (CSV header -> target field)
        const autoMappingRules = {
            'id': 'id',
            'office': 'Office',
            'docket_number': 'Docket_Number',
            'docket': 'Docket_Number',
            'case_number': 'Docket_Number',
            'case': 'Docket_Number',
            'status': 'Status',
            'file_date': 'File_Date',
            'filedate': 'File_Date',
            'date': 'File_Date',
            'filed': 'File_Date',
            'description': 'Description',
            'plaintiff_petitioner': 'Plaintiff_Petitioner',
            'plaintiff': 'Plaintiff_Petitioner',
            'petitioner': 'Plaintiff_Petitioner',
            'landlord': 'Plaintiff_Petitioner',
            'defendant_respondent': 'Defendant_Respondent',
            'defendant': 'Defendant_Respondent',
            'respondent': 'Defendant_Respondent',
            'tenant': 'Defendant_Respondent',
            'attorney': 'Attorney',
            'lawyer': 'Attorney',
            'address_formatted': 'address_formatted',
            'address': 'address_formatted',
            'property_address': 'address_formatted',
            'council_member': 'council_member',
            'councilmember': 'council_member',
            'council': 'council_member',
            'longitude': 'longitude',
            'lng': 'longitude',
            'lon': 'longitude',
            'latitude': 'latitude',
            'lat': 'latitude',
            'council_district': 'council_district',
            'district': 'council_district',
            'council_district_number': 'council_district_number',
            'district_number': 'council_district_number',
            'individual_ll': 'individual_ll',
            'individual_landlord': 'individual_ll',
            'individual': 'individual_ll'
        };

        // Secret key combo detection
        document.addEventListener('keydown', function(event) {
            // If bulk upload modal is open and ESC is pressed, close it
            const uploadModal = document.getElementById('bulkUploadModal');
            if (uploadModal && !uploadModal.classList.contains('hidden') && event.key === 'Escape') {
                hideBulkUploadModal();
                return;
            }

            // If we're in secret input mode, capture alphanumeric keys
            if (secretModeActive) {
                if (event.key.length === 1 && /[a-zA-Z]/.test(event.key)) {
                    event.preventDefault();
                    secretInputBuffer += event.key.toLowerCase();

                    // Reset timer
                    if (secretInputTimer) clearTimeout(secretInputTimer);
                    secretInputTimer = setTimeout(() => {
                        secretInputBuffer = '';
                        secretModeActive = false;
                    }, 3000);

                    // Check if "detainer" was typed
                    if (secretInputBuffer === 'detainer') {
                        secretInputBuffer = '';
                        secretModeActive = false;
                        showBulkUploadModal();
                    }
                }
                return;
            }

            // Track ESC presses
            if (event.key === 'Escape') {
                // Don't trigger if case modal is open
                const caseModal = document.getElementById('caseModal');
                if (caseModal && !caseModal.classList.contains('hidden')) {
                    return;
                }

                escPressCount++;

                // Reset timer
                if (escPressTimer) clearTimeout(escPressTimer);
                escPressTimer = setTimeout(() => {
                    escPressCount = 0;
                }, 1500);

                // After 3 ESC presses, enter secret input mode
                if (escPressCount >= 3) {
                    escPressCount = 0;
                    secretModeActive = true;
                    secretInputBuffer = '';

                    // Auto-reset after 5 seconds
                    if (secretInputTimer) clearTimeout(secretInputTimer);
                    secretInputTimer = setTimeout(() => {
                        secretInputBuffer = '';
                        secretModeActive = false;
                    }, 5000);
                }
            }
        });

        // Bulk Upload Modal Functions
        function showBulkUploadModal() {
            const modal = document.getElementById('bulkUploadModal');
            if (!modal) return;

            // Reset state
            bulkUploadStep = 1;
            bulkUploadData = [];
            bulkUploadHeaders = [];
            bulkUploadFieldMapping = {};

            // Reset UI
            document.getElementById('bulkUploadFile').value = '';
            document.getElementById('bulkUploadPaste').value = '';
            document.getElementById('uploadFileInfo').classList.add('hidden');
            document.getElementById('uploadProgressSection').classList.add('hidden');

            updateUploadStep();
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');

            // Setup drag and drop
            setupDropZone();
        }

        function hideBulkUploadModal() {
            const modal = document.getElementById('bulkUploadModal');
            if (!modal) return;
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        function setupDropZone() {
            const dropZone = document.getElementById('uploadDropZone');
            if (!dropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('dragover');
                }, false);
            });

            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.csv')) {
                    handleBulkUploadFileFromDrop(files[0]);
                }
            }, false);
        }

        function handleBulkUploadFile(event) {
            const file = event.target.files[0];
            if (file) {
                handleBulkUploadFileFromDrop(file);
            }
        }

        function handleBulkUploadFileFromDrop(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseCSVContent(content);

                // Show file info
                document.getElementById('uploadFileName').textContent = `${file.name} (${bulkUploadData.length} rows)`;
                document.getElementById('uploadFileInfo').classList.remove('hidden');
            };
            reader.readAsText(file);
        }

        function parseCSVContent(content) {
            const lines = content.trim().split(/\r?\n/);
            if (lines.length < 2) {
                alert('CSV must have at least a header row and one data row.');
                return;
            }

            // Parse header
            bulkUploadHeaders = parseCSVLine(lines[0]);

            // Parse data rows
            bulkUploadData = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    const row = {};
                    bulkUploadHeaders.forEach((header, idx) => {
                        row[header] = values[idx] || '';
                    });
                    bulkUploadData.push(row);
                }
            }

            // Auto-map fields
            autoMapFields();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (inQuotes) {
                    if (char === '"' && nextChar === '"') {
                        current += '"';
                        i++; // Skip next quote
                    } else if (char === '"') {
                        inQuotes = false;
                    } else {
                        current += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
            }
            result.push(current.trim());
            return result;
        }

        function autoMapFields() {
            bulkUploadFieldMapping = {};

            bulkUploadHeaders.forEach(header => {
                const normalizedHeader = header.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');

                // Check for exact or close matches
                if (autoMappingRules[normalizedHeader]) {
                    bulkUploadFieldMapping[header] = autoMappingRules[normalizedHeader];
                } else {
                    // Try partial matching
                    for (const [key, value] of Object.entries(autoMappingRules)) {
                        if (normalizedHeader.includes(key) || key.includes(normalizedHeader)) {
                            bulkUploadFieldMapping[header] = value;
                            break;
                        }
                    }
                }

                // Default to unmapped
                if (!bulkUploadFieldMapping[header]) {
                    bulkUploadFieldMapping[header] = '';
                }
            });
        }

        function updateUploadStep() {
            // Update step visibility
            for (let i = 1; i <= 3; i++) {
                const stepDiv = document.getElementById(`uploadStep${i}`);
                const indicator = document.getElementById(`stepIndicator${i}`);

                if (stepDiv) {
                    stepDiv.classList.toggle('active', i === bulkUploadStep);
                }

                if (indicator) {
                    indicator.classList.toggle('opacity-50', i > bulkUploadStep);
                    const circle = indicator.querySelector('span:first-child');
                    const label = indicator.querySelector('span:last-child');

                    if (i <= bulkUploadStep) {
                        circle.className = 'w-7 h-7 rounded-full bg-indigo-600 text-white text-sm font-bold flex items-center justify-center';
                        label.className = 'text-sm font-medium text-gray-700';
                    } else {
                        circle.className = 'w-7 h-7 rounded-full bg-gray-300 text-gray-600 text-sm font-bold flex items-center justify-center';
                        label.className = 'text-sm font-medium text-gray-500';
                    }
                }
            }

            // Update buttons
            const backBtn = document.getElementById('uploadBackBtn');
            const nextBtn = document.getElementById('uploadNextBtn');
            const submitBtn = document.getElementById('uploadSubmitBtn');

            backBtn.classList.toggle('hidden', bulkUploadStep === 1);
            nextBtn.classList.toggle('hidden', bulkUploadStep === 3);
            submitBtn.classList.toggle('hidden', bulkUploadStep !== 3);

            // Populate step content
            if (bulkUploadStep === 2) {
                renderFieldMapping();
            } else if (bulkUploadStep === 3) {
                renderPreview();
            }
        }

        function uploadNextStep() {
            if (bulkUploadStep === 1) {
                // Validate that we have data
                const pasteContent = document.getElementById('bulkUploadPaste').value.trim();
                if (pasteContent && bulkUploadData.length === 0) {
                    parseCSVContent(pasteContent);
                }

                if (bulkUploadData.length === 0) {
                    alert('Please upload a CSV file or paste CSV data first.');
                    return;
                }
            }

            if (bulkUploadStep < 3) {
                bulkUploadStep++;
                updateUploadStep();
            }
        }

        function uploadPrevStep() {
            if (bulkUploadStep > 1) {
                bulkUploadStep--;
                updateUploadStep();
            }
        }

        function renderFieldMapping() {
            const container = document.getElementById('fieldMappingContainer');
            if (!container) return;

            let html = '';

            bulkUploadHeaders.forEach(header => {
                const currentMapping = bulkUploadFieldMapping[header] || '';

                html += `
                    <div class="mapping-row">
                        <div class="csv-field">${escapeHtml(header)}</div>
                        <div class="mapping-arrow">‚Üí</div>
                        <select class="target-field-select" data-csv-field="${escapeHtml(header)}" onchange="updateFieldMapping(this)">
                            <option value="">(Skip this field)</option>
                            ${targetSchemaFields.map(field => `
                                <option value="${field.key}" ${currentMapping === field.key ? 'selected' : ''}>
                                    ${field.label}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateFieldMapping(selectEl) {
            const csvField = selectEl.dataset.csvField;
            const targetField = selectEl.value;
            bulkUploadFieldMapping[csvField] = targetField;
        }

        function renderPreview() {
            const headContainer = document.getElementById('uploadPreviewHead');
            const bodyContainer = document.getElementById('uploadPreviewBody');
            const rowCountEl = document.getElementById('uploadRowCount');

            if (!headContainer || !bodyContainer) return;

            // Get mapped fields (non-empty mappings)
            const mappedFields = [];
            for (const [csvField, targetField] of Object.entries(bulkUploadFieldMapping)) {
                if (targetField) {
                    mappedFields.push({ csvField, targetField });
                }
            }

            if (mappedFields.length === 0) {
                headContainer.innerHTML = '<tr><th>No fields mapped</th></tr>';
                bodyContainer.innerHTML = '<tr><td>Please go back and map at least one field.</td></tr>';
                return;
            }

            // Render header
            headContainer.innerHTML = '<tr>' + mappedFields.map(f => `<th>${escapeHtml(f.targetField)}</th>`).join('') + '</tr>';

            // Render body (first 10 rows)
            const previewRows = bulkUploadData.slice(0, 10);
            bodyContainer.innerHTML = previewRows.map(row => {
                return '<tr>' + mappedFields.map(f => `<td>${escapeHtml(row[f.csvField] || '')}</td>`).join('') + '</tr>';
            }).join('');

            // Update row count
            if (rowCountEl) {
                rowCountEl.textContent = `Total: ${bulkUploadData.length} rows`;
            }
        }

        async function submitBulkUpload() {
            const progressSection = document.getElementById('uploadProgressSection');
            const progressBar = document.getElementById('uploadProgressBar');
            const progressText = document.getElementById('uploadProgressText');
            const statusLog = document.getElementById('uploadStatusLog');
            const submitBtn = document.getElementById('uploadSubmitBtn');

            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            // Show progress section
            progressSection.classList.remove('hidden');
            statusLog.innerHTML = '';

            // Get mapped fields
            const mappedFields = [];
            for (const [csvField, targetField] of Object.entries(bulkUploadFieldMapping)) {
                if (targetField) {
                    mappedFields.push({ csvField, targetField });
                }
            }

            // Transform data to target format
            const transformedData = bulkUploadData.map(row => {
                const transformed = {};
                mappedFields.forEach(({ csvField, targetField }) => {
                    let value = row[csvField] || '';

                    // Type conversion
                    const fieldDef = targetSchemaFields.find(f => f.key === targetField);
                    if (fieldDef && fieldDef.type === 'integer') {
                        value = parseInt(value, 10) || 0;
                    }

                    transformed[targetField] = value;
                });
                return transformed;
            });

            const total = transformedData.length;
            let success = 0;
            let failed = 0;

            // Upload endpoint
            const apiUrl = 'https://xvkq-pq7i-idtl.n7d.xano.io/api:gx-QnxD1/nashville_detainer_cases';

            // Upload each record
            for (let i = 0; i < transformedData.length; i++) {
                const record = transformedData[i];
                const progress = Math.round(((i + 1) / total) * 100);

                try {
                    const response = await fetch(apiUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(record)
                    });

                    if (response.ok) {
                        success++;
                        addUploadStatusItem(statusLog, `Row ${i + 1}: Success`, 'success');
                    } else {
                        failed++;
                        const errorText = await response.text();
                        addUploadStatusItem(statusLog, `Row ${i + 1}: Failed - ${response.status}`, 'error');
                    }
                } catch (error) {
                    failed++;
                    addUploadStatusItem(statusLog, `Row ${i + 1}: Error - ${error.message}`, 'error');
                }

                // Update progress
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${progress}% (${i + 1}/${total})`;

                // Scroll status log to bottom
                statusLog.scrollTop = statusLog.scrollHeight;
            }

            // Final status
            const finalMessage = `Upload complete: ${success} succeeded, ${failed} failed`;
            addUploadStatusItem(statusLog, finalMessage, failed > 0 ? 'error' : 'success');

            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.textContent = 'Upload Complete';

            // Refresh data if any succeeded
            if (success > 0) {
                setTimeout(() => {
                    loadData();
                }, 2000);
            }
        }

        function addUploadStatusItem(container, message, status) {
            const item = document.createElement('div');
            item.className = `upload-status-item ${status}`;
            item.innerHTML = `
                <span>${status === 'success' ? '‚úì' : status === 'error' ? '‚úó' : '‚óã'}</span>
                <span>${escapeHtml(message)}</span>
            `;
            container.appendChild(item);
        }
    </script>
</body>
</html>
