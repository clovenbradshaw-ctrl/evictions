<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nashville Eviction Tracker (Community Project - UNOFFICIAL)</title>
    <link rel="icon" type="image/png" href="https://storage.googleapis.com/intelechia-content/im/eviction%20prevention%20logo.png">
    <link rel="stylesheet" href="dist/output.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
    <script src="eo-migration.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/styles/ag-theme-alpine.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #4f46e5;
            --secondary: #06b6d4;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
        }
        
        body { 
            font-family: 'Inter', sans-serif;a
            background: #f9fafb;
        }
        
        .unofficial-banner {
            background: #fef3c7;
            border-bottom: 2px solid #f59e0b;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            color: #92400e;
        }

        /* URL Filter Banner - Shows when viewing filtered data */
        .url-filter-banner {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-bottom: 2px solid #3b82f6;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .url-filter-banner.hidden {
            display: none;
        }

        .url-filter-banner-icon {
            font-size: 20px;
        }

        .url-filter-banner-text {
            font-weight: 600;
            color: #1e40af;
        }

        .url-filter-banner-count {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 700;
        }

        .url-filter-banner-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .url-filter-banner-btn {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
        }

        .url-filter-banner-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .url-filter-banner-btn.primary:hover {
            background: #2563eb;
        }

        .url-filter-banner-btn.secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .url-filter-banner-btn.secondary:hover {
            background: #f3f4f6;
        }

        .url-filter-banner-btn.danger {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .url-filter-banner-btn.danger:hover {
            background: #fee2e2;
        }

        .copy-success {
            animation: copyPulse 0.3s ease;
        }

        @keyframes copyPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: #22c55e; }
            100% { transform: scale(1); }
        }
        
        .data-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        /* Clickable metric styling */
        .metric-clickable {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .metric-clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
            border-color: var(--primary);
        }

        .metric-clickable:hover .metric-value {
            color: var(--primary);
        }

        .metric-clickable::after {
            content: "Click to filter";
            position: absolute;
            bottom: 4px;
            right: 8px;
            font-size: 10px;
            color: #9ca3af;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            z-index: 1;
        }

        .metric-clickable:hover::after {
            opacity: 1;
        }

        .metric-clickable.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        }

        .metric-source-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s ease;
            position: relative;
            z-index: 10;
        }

        .metric-source-link:hover {
            color: var(--primary);
        }

        .metric-source-link .source-icon {
            font-size: 12px;
        }

        .source-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border: 1px solid #c4b5fd;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .source-btn:hover {
            background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.2);
        }

        /* General th-clickable styles for benchmark table headers */
        th.th-clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        th.th-clickable:hover {
            color: #7c3aed;
            background: #ede9fe;
        }

        th.th-clickable .th-info {
            font-size: 10px;
            opacity: 0.6;
            margin-left: 2px;
        }

        th.th-clickable:hover .th-info {
            opacity: 1;
        }

        .county-stat.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
        }

        .county-stat.clickable:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
        }

        .trend-up { color: var(--danger); }
        .trend-down { color: var(--success); }
        
        .district-cell {
            border: 1px solid #e5e7eb;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            font-weight: 600;
            border-radius: 4px;
            position: relative;
        }
        
        .district-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .heat-0 { background: #f3f4f6; color: #9ca3af; }
        .heat-1 { background: #dbeafe; color: #1e40af; }
        .heat-2 { background: #fef3c7; color: #92400e; }
        .heat-3 { background: #fed7aa; color: #9a3412; }
        .heat-4 { background: #fca5a5; color: #991b1b; }
        .heat-5 { background: #ef4444; color: white; }
        
        .activity-dots {
            font-size: 16px;
            line-height: 1;
            letter-spacing: -2px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            font-weight: 500;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .demographics-tab-btn {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white !important;
            border-radius: 6px;
            border-bottom: none !important;
        }

        .demographics-tab-btn:hover {
            background: linear-gradient(135deg, #2d5a87 0%, #3d6a97 100%);
        }

        .demographics-tab-btn.active {
            box-shadow: 0 0 0 3px rgba(45, 90, 135, 0.3);
        }

        .benchmark-metric-btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            border: 2px solid #a855f7;
            background: white;
            color: #7c3aed;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .benchmark-metric-btn:hover {
            background: #f3e8ff;
        }

        .benchmark-metric-btn.active {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            color: white;
            border-color: transparent;
        }

        /* Export dropdown styles */
        .export-dropdown-btn {
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
        }

        .export-dropdown-btn:hover {
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3);
        }

        .export-dropdown-menu {
            animation: dropdownFadeIn 0.15s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .export-menu-item:hover {
            background: #f9fafb;
        }

        .export-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .export-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        /* Export loading overlay */
        .export-loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .export-loading-content {
            background: white;
            padding: 2rem 3rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        .export-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Export format button styles */
        .export-format-btn {
            min-width: 80px;
        }

        .export-format-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .export-format-btn:active {
            transform: translateY(0);
        }

        .benchmarks-overview {
            padding: 0.5rem;
        }

        .search-input {
            background: white;
            border: 2px solid #e5e7eb;
            padding: 10px 16px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .view-toggle {
            padding: 6px 16px;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            color: #4b5563;
            background: #f9fafb;
            transition: all 0.2s ease;
        }

        .view-toggle.active {
            background: var(--primary);
            color: #ffffff;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        .pivot-option {
            padding: 4px 14px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            color: #4b5563;
            background: #ffffff;
            transition: all 0.2s ease;
        }

        .pivot-option.active {
            background: #dbeafe;
            color: #1d4ed8;
            border-color: #bfdbfe;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.15);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #4338ca;
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .nav-link {
            text-decoration: none;
        }

        /* Professional Navigation Styles */
        .main-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-group {
            display: flex;
            align-items: center;
            background: #f8fafc;
            border-radius: 10px;
            padding: 4px;
            gap: 2px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #475569;
            text-decoration: none;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .nav-item:hover {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .nav-item.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.15);
        }

        .nav-item-icon {
            font-size: 14px;
            opacity: 0.9;
        }

        .nav-divider {
            width: 1px;
            height: 28px;
            background: #e2e8f0;
            margin: 0 8px;
        }

        .nav-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 14px;
            background: #f8fafc;
            border-radius: 10px;
            font-size: 12px;
            color: #64748b;
        }

        .nav-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            box-shadow: 0 0 6px #10b981;
            animation: pulse-dot 2s infinite;
        }

        .nav-status-dot.offline {
            background: #f59e0b;
            box-shadow: 0 0 6px #f59e0b;
            animation: none;
        }

        .nav-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .nav-btn-refresh {
            background: #f0fdf4;
            color: #15803d;
            border: 1px solid #bbf7d0;
        }

        .nav-btn-refresh:hover {
            background: #dcfce7;
            box-shadow: 0 2px 8px rgba(21, 128, 61, 0.15);
        }

        .nav-btn-download {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            color: white;
        }

        .nav-btn-download:hover {
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.35);
            transform: translateY(-1px);
        }

        .nav-btn-login {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
        }

        .nav-btn-login:hover {
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.35);
            transform: translateY(-1px);
        }

        .nav-btn-logout {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .nav-btn-logout:hover {
            background: #e2e8f0;
        }

        /* Download dropdown menu */
        .download-dropdown {
            position: relative;
        }

        .download-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid #e2e8f0;
            min-width: 220px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s ease;
        }

        .download-dropdown-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .download-dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .download-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
            color: #334155;
        }

        .download-dropdown-item:hover {
            background: #f8fafc;
        }

        .download-dropdown-item:first-of-type {
            border-radius: 0;
        }

        .download-dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }

        .download-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .download-item-icon.csv {
            background: #dcfce7;
        }

        .download-item-icon.json {
            background: #fef3c7;
        }

        .download-item-icon.pdf {
            background: #fee2e2;
        }

        .download-item-icon.excel {
            background: #dbeafe;
        }

        .download-item-details {
            flex: 1;
        }

        .download-item-title {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
        }

        .download-item-desc {
            font-size: 11px;
            color: #94a3b8;
        }

        /* Download Modal Styles */
        .download-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem 1rem;
        }

        .download-modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .download-modal {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .download-modal-header {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px 16px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .download-modal-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .download-modal-header .subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
            color: white;
        }

        .download-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: background 0.15s;
        }

        .download-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .download-modal-body {
            padding: 1.5rem;
        }

        .download-preview-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .download-preview-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }

        .download-preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .download-preview-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #334155;
        }

        .download-preview-item .icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .download-preview-item .check {
            color: #10b981;
        }

        .download-format-section {
            margin-bottom: 1.5rem;
        }

        .download-format-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.75rem;
        }

        .download-format-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .download-format-option {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.15s ease;
            background: white;
        }

        .download-format-option:hover {
            border-color: #cbd5e1;
            background: #f8fafc;
        }

        .download-format-option.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .download-format-option .format-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .download-format-option .format-icon.csv { background: #dcfce7; }
        .download-format-option .format-icon.json { background: #fef3c7; }
        .download-format-option .format-icon.pdf { background: #fee2e2; }
        .download-format-option .format-icon.excel { background: #dbeafe; }

        .download-format-option .format-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .download-format-option .format-desc {
            font-size: 0.75rem;
            color: #64748b;
        }

        .download-file-preview {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .download-file-preview .file-icon {
            font-size: 1.25rem;
        }

        .download-file-preview .file-info {
            flex: 1;
        }

        .download-file-preview .file-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: #1e293b;
            font-family: monospace;
        }

        .download-file-preview .file-size {
            font-size: 0.75rem;
            color: #64748b;
        }

        .download-modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .download-btn-cancel {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            background: white;
            border: 1px solid #e2e8f0;
            color: #64748b;
        }

        .download-btn-cancel:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .download-btn-confirm {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .download-btn-confirm:hover {
            background: linear-gradient(135deg, #047857 0%, #059669 100%);
        }

        @media (max-width: 480px) {
            .download-preview-grid,
            .download-format-grid {
                grid-template-columns: 1fr;
            }
        }

        #dataGrid {
            height: 800px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .ag-theme-alpine {
            --ag-header-background-color: #f9fafb;
            --ag-header-foreground-color: #111827;
            --ag-header-height: 48px;
            --ag-row-hover-color: #f3f4f6;
        }

        .ag-theme-alpine .ag-cell,
        .ag-theme-alpine .ag-header-cell,
        .ag-theme-alpine .ag-header-cell-label {
            -webkit-user-select: text;
            user-select: text;
        }
        
        .chart-container {
            position: relative;
            height: 320px;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-weight: 500;
        }
        
        .status-loading {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Polling status indicator */
        .poll-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .poll-status-dot.active {
            background: #10b981;
            box-shadow: 0 0 6px #10b981;
            animation: pulse-dot 2s infinite;
        }

        .poll-status-dot.paused {
            background: #9ca3af;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        /* Animate spin for refresh button */
        .animate-spin {
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        .fuzzy-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
        }
        
        .fuzzy-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }
        
        .confidence-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .confidence-high { background: #10b981; color: white; }
        .confidence-med { background: #f59e0b; color: white; }
        .confidence-low { background: #ef4444; color: white; }

        .bulk-results-header {
            padding: 12px 16px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
        }

        .bulk-results-table-wrapper {
            overflow-x: auto;
        }

        .bulk-results-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 720px;
        }

        .bulk-results-table th {
            background: #f3f4f6;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #4b5563;
        }

        .bulk-results-table th,
        .bulk-results-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
            font-size: 13px;
        }

        .bulk-results-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        /* Bulk Upload Modal Styles */
        .upload-modal {
            transition: opacity 0.2s ease-out;
        }

        .upload-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .upload-step {
            display: none;
        }

        .upload-step.active {
            display: block;
        }

        .mapping-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 12px;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .mapping-row:last-child {
            border-bottom: none;
        }

        .mapping-arrow {
            color: #9ca3af;
            font-size: 18px;
        }

        .csv-field {
            background: #f3f4f6;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
        }

        .target-field-select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            font-size: 13px;
            cursor: pointer;
        }

        .target-field-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .upload-preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .upload-preview-table th,
        .upload-preview-table td {
            padding: 8px 10px;
            border: 1px solid #e5e7eb;
            text-align: left;
        }

        .upload-preview-table th {
            background: #f9fafb;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.05em;
        }

        .upload-preview-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        .upload-progress {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .upload-progress-bar {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .upload-status-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px 0;
            font-size: 13px;
            border-bottom: 1px solid #f3f4f6;
        }

        .upload-status-item:last-child {
            border-bottom: none;
        }

        .upload-status-item .status-main {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-status-item .status-icon {
            flex-shrink: 0;
            width: 18px;
            text-align: center;
        }

        .upload-status-item .status-record {
            font-weight: 500;
            color: #374151;
        }

        .upload-status-item .status-message {
            color: inherit;
        }

        .upload-status-item.success { color: #059669; }
        .upload-status-item.error { color: #dc2626; }
        .upload-status-item.pending { color: #6b7280; }
        .upload-status-item.warning { color: #d97706; }

        .upload-status-item .error-details {
            margin-left: 26px;
            padding: 8px 12px;
            background: #fef2f2;
            border-radius: 6px;
            font-size: 12px;
            color: #991b1b;
            border-left: 3px solid #dc2626;
        }

        .upload-status-item .error-details-toggle {
            margin-left: 26px;
            background: none;
            border: none;
            color: #6b7280;
            font-size: 11px;
            cursor: pointer;
            padding: 2px 0;
            text-decoration: underline;
        }

        .upload-status-item .error-details-toggle:hover {
            color: #374151;
        }

        .upload-status-item .error-details code {
            display: block;
            margin-top: 4px;
            padding: 6px 8px;
            background: #fee2e2;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 120px;
            overflow-y: auto;
        }

        .upload-status-item .error-type {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #fee2e2;
            color: #991b1b;
        }

        .upload-status-item.success .error-type {
            background: #d1fae5;
            color: #065f46;
        }

        .drop-zone {
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }

        .paste-area {
            min-height: 200px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }

        /* Advanced Filter Builder Styles */
        .filter-builder {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
        }

        .filter-group {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
        }

        .filter-group.and-group {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.03) 0%, white 100%);
        }

        .filter-group.or-group {
            border-color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.03) 0%, white 100%);
        }

        .filter-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .filter-group-logic {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logic-toggle {
            display: flex;
            background: #f3f4f6;
            border-radius: 6px;
            padding: 2px;
        }

        .logic-toggle button {
            padding: 4px 12px;
            border: none;
            background: transparent;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .logic-toggle button.active-and {
            background: #10b981;
            color: white;
        }

        .logic-toggle button.active-or {
            background: #f59e0b;
            color: white;
        }

        .filter-condition {
            display: grid;
            grid-template-columns: 1fr 140px 1fr auto;
            gap: 8px;
            align-items: center;
            padding: 8px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .filter-condition:last-child {
            margin-bottom: 0;
        }

        .filter-condition select,
        .filter-condition input {
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }

        .filter-condition select:focus,
        .filter-condition input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
        }

        .filter-condition .remove-condition {
            width: 28px;
            height: 28px;
            border: none;
            background: #fee2e2;
            color: #dc2626;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .filter-condition .remove-condition:hover {
            background: #fecaca;
        }

        .add-condition-btn {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            border: 1px dashed #d1d5db;
            background: transparent;
            color: #6b7280;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .add-condition-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }

        .filter-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        .filter-loading-indicator {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            background: #dbeafe;
            color: #1d4ed8;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .filter-loading-indicator.hidden {
            display: none;
        }

        .filter-builder.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn.loading::before {
            content: '‚è≥ ';
        }

        .filter-preset-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #dbeafe;
            color: #1d4ed8;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-preset-badge:hover {
            background: #bfdbfe;
        }

        .filter-preset-badge .delete-preset {
            color: #6b7280;
            margin-left: 4px;
        }

        .filter-preset-badge .delete-preset:hover {
            color: #dc2626;
        }

        .presets-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .custom-grouping-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .grouping-field-select {
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .grouping-field-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .aggregation-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .aggregation-option {
            padding: 6px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
            background: white;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.15s;
        }

        .aggregation-option.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .nested-group {
            margin-left: 20px;
            padding-left: 16px;
            border-left: 3px solid #e5e7eb;
        }

        .nested-group.and-group {
            border-left-color: #10b981;
        }

        .nested-group.or-group {
            border-left-color: #f59e0b;
        }

        .active-filter-summary {
            background: linear-gradient(135deg, #dbeafe 0%, #ede9fe 100%);
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .active-filter-summary code {
            background: rgba(255,255,255,0.7);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        /* District Info Modal Styles */
        .district-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem 1rem;
        }

        .district-modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .district-modal {
            background: white;
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .district-modal-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px 16px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .district-modal-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .district-modal-header .subtitle {
            font-size: 0.85rem;
            opacity: 0.8;
            color: white;
        }

        .district-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: background 0.15s;
        }

        .district-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .district-modal-body {
            padding: 1.5rem;
        }

        /* Attorney Modal Styles */
        .attorney-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem 1rem;
        }

        .attorney-modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .attorney-modal {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .attorney-modal-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px 16px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .attorney-modal-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .attorney-modal-header .subtitle {
            font-size: 0.85rem;
            opacity: 0.8;
            color: white;
        }

        .attorney-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: background 0.15s;
        }

        .attorney-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .attorney-modal-body {
            padding: 1.5rem;
        }

        .attorney-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .attorney-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            color: #374151;
            white-space: nowrap;
        }

        .attorney-table th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .attorney-table th.sortable:hover {
            background: #f3f4f6;
        }

        .attorney-table th .sort-indicator {
            margin-left: 4px;
            opacity: 0.4;
        }

        .attorney-table th.sorted .sort-indicator {
            opacity: 1;
        }

        .attorney-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            color: #4b5563;
        }

        .attorney-table tr:hover td {
            background: #f9fafb;
        }

        .attorney-table .attorney-name {
            font-weight: 500;
            color: #4f46e5;
            cursor: pointer;
        }

        .attorney-table .attorney-name:hover {
            text-decoration: underline;
        }

        .attorney-table .num-col {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .attorney-table .pct-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .attorney-table .pct-bar-fill {
            height: 6px;
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
            border-radius: 3px;
            min-width: 2px;
        }

        .attorney-modal-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 12px;
        }

        .attorney-modal-stat {
            text-align: center;
        }

        .attorney-modal-stat .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4f46e5;
        }

        .attorney-modal-stat .label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .attorney-search {
            margin-bottom: 1rem;
        }

        .attorney-search input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .attorney-search input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        @media (max-width: 768px) {
            .attorney-modal {
                max-width: 100%;
                margin: 0;
                border-radius: 12px;
            }

            .attorney-modal-summary {
                grid-template-columns: repeat(2, 1fr);
            }

            .attorney-table {
                font-size: 0.8rem;
            }

            .attorney-table th,
            .attorney-table td {
                padding: 0.5rem;
            }
        }

        .demo-section {
            margin-bottom: 1.5rem;
        }

        .demo-section:last-child {
            margin-bottom: 0;
        }

        .demo-section-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: #1e3a5f;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        @media (min-width: 500px) {
            .demo-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .demo-item {
            background: #f9fafb;
            border-radius: 8px;
            padding: 0.75rem;
        }

        .demo-item .label {
            font-size: 0.7rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 0.25rem;
        }

        .demo-item .value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #111827;
        }

        .demo-item .value.highlight {
            color: #dc2626;
        }

        .demo-item .value.positive {
            color: #059669;
        }

        .demo-item.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .demo-item.clickable:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .demo-item.clickable::after {
            content: '‚ÑπÔ∏è';
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 0.65rem;
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }

        .demo-item.clickable:hover::after {
            opacity: 1;
        }

        .modal-source {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            font-size: 0.75rem;
            color: #6b7280;
            text-align: center;
        }

        .modal-source a {
            color: #4f46e5;
        }

        /* Modal overlay and container styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 1rem;
        }

        .modal-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            line-height: 1;
            padding: 0.25rem;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: #1f2937;
        }

        .compare-county {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .compare-county .arrow-up {
            color: #dc2626;
        }

        .compare-county .arrow-down {
            color: #059669;
        }

        .district-link {
            color: #4f46e5;
            cursor: pointer;
            font-weight: 600;
        }

        .district-link:hover {
            color: #4338ca;
            text-decoration: underline;
        }

        /* Demographics Overview Panel Styles */
        .demographics-overview {
            padding: 0.5rem 0;
        }

        .county-summary-card {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            border-radius: 12px;
            padding: 1.25rem;
            color: white;
        }

        .county-summary-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .county-summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        @media (min-width: 640px) {
            .county-summary-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .county-stat {
            text-align: center;
        }

        .county-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .county-stat-label {
            font-size: 0.7rem;
            opacity: 0.85;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-top: 0.25rem;
        }

        .demographics-table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .demographics-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .demographics-table thead {
            background: #f9fafb;
            position: sticky;
            top: 0;
        }

        .demographics-table th {
            padding: 0.75rem 0.5rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: #6b7280;
            border-bottom: 2px solid #e5e7eb;
        }

        .demographics-table th.th-clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .demographics-table th.th-clickable:hover {
            color: var(--primary);
            background: #ede9fe;
        }

        .demographics-table th .th-info {
            font-size: 10px;
            opacity: 0.6;
            margin-left: 2px;
        }

        .demographics-table th.th-clickable:hover .th-info {
            opacity: 1;
        }

        .demographics-table td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }

        .demographics-table tbody tr {
            cursor: pointer;
            transition: background 0.15s;
        }

        .demographics-table tbody tr:hover {
            background: #f3f4f6;
        }

        .demographics-table tbody tr:last-child td {
            border-bottom: none;
        }

        .district-num-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.875rem;
            background: #dbeafe;
            color: #1e40af;
        }

        .district-num-badge.high-evictions {
            background: #fecaca;
            color: #991b1b;
        }

        .value-highlight {
            color: #dc2626;
            font-weight: 600;
        }

        .value-positive {
            color: #059669;
            font-weight: 600;
        }

        .demographics-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .demographics-card-grid.hidden {
            display: none;
        }

        .demo-card {
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .demo-card:hover {
            border-color: #4f46e5;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
            transform: translateY(-2px);
        }

        .demo-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .demo-card-title {
            font-weight: 700;
            font-size: 1rem;
            color: #111827;
        }

        .demo-card-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            margin-bottom: 0.35rem;
        }

        .demo-card-stat-label {
            color: #6b7280;
        }

        .demo-card-stat-value {
            font-weight: 600;
            color: #111827;
        }

        .demo-card-stat-value.highlight {
            color: #dc2626;
        }

        /* Demographics Visualization Styles */
        .demo-viz-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .demo-viz-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            .scatter-chart-container {
                height: 350px;
            }

            .demo-viz-controls {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
            }

            .demo-viz-select {
                width: 100%;
                min-width: unset;
            }

            .demo-viz-toggle {
                justify-content: center;
            }

            .demo-viz-toggle button {
                flex: 1;
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        .demo-viz-controls {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .demo-viz-select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            min-width: 180px;
        }

        .demo-viz-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .demo-viz-toggle {
            display: flex;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 4px;
        }

        .demo-viz-toggle button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .demo-viz-toggle button.active {
            background: white;
            color: #111827;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Demographics Section Collapsible Styles */
        .demographics-header {
            user-select: none;
        }

        .demographics-header:hover {
            background: rgba(0, 0, 0, 0.02);
            margin: -1rem;
            padding: 1rem;
            border-radius: 8px;
        }

        .collapse-icon {
            font-size: 12px;
            display: inline-block;
            width: 16px;
            text-align: center;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .demographics-collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 2000px;
            opacity: 1;
        }

        .demographics-collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0 !important;
        }

        .demo-filter-badge {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .scatter-chart-container {
            position: relative;
            height: 400px;
        }

        /* Variable Labels Overlay */
        .chart-variable-labels {
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 6px;
            pointer-events: none;
        }

        .variable-label {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.95);
            padding: 6px 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            font-weight: 500;
            max-width: 180px;
        }

        .variable-label .variable-icon {
            font-size: 14px;
            color: #6b7280;
            flex-shrink: 0;
        }

        .variable-label .variable-name {
            color: #374151;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .variable-label.y-label {
            border-left: 3px solid #4f46e5;
        }

        .variable-label.x-label {
            border-left: 3px solid #10b981;
        }

        @media (max-width: 640px) {
            .chart-variable-labels {
                position: static;
                flex-direction: row;
                flex-wrap: wrap;
                margin-bottom: 8px;
                justify-content: center;
            }

            .variable-label {
                max-width: none;
                font-size: 11px;
                padding: 4px 8px;
            }
        }

        .bar-chart-container {
            position: relative;
            height: 800px;
            overflow-y: auto;
        }

        .demo-insight-box {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 12px;
        }

        .demo-insight-box.warning {
            background: #fefce8;
            border-color: #fde047;
        }

        .demo-insight-box .insight-title {
            font-weight: 600;
            color: #166534;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .demo-insight-box.warning .insight-title {
            color: #854d0e;
        }

        .demo-insight-box .insight-text {
            font-size: 13px;
            color: #15803d;
        }

        .demo-insight-box.warning .insight-text {
            color: #a16207;
        }

        .correlation-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }

        .correlation-strong {
            background: #fee2e2;
            color: #991b1b;
        }

        .correlation-moderate {
            background: #fef3c7;
            color: #92400e;
        }

        .correlation-weak {
            background: #d1fae5;
            color: #065f46;
        }

        /* District Location Mini-Map Styles */
        .district-location-map {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

        .district-location-map-lg {
            width: 48px;
            height: 48px;
        }

        .location-grid-cell {
            fill: #e5e7eb;
            stroke: #d1d5db;
            stroke-width: 0.5;
        }

        .location-grid-cell.highlighted {
            fill: #4f46e5;
            stroke: #4338ca;
        }

        .location-grid-cell.county-shape {
            fill: #f3f4f6;
        }

        /* =============================================
           COMPREHENSIVE MOBILE RESPONSIVE STYLES
           ============================================= */

        /* Mobile hamburger menu */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            padding: 8px;
            font-size: 24px;
            cursor: pointer;
            color: #374151;
        }

        /* Extra small phones (320px) */
        @media (max-width: 360px) {
            .metric-value {
                font-size: 22px !important;
            }

            .data-card {
                padding: 12px;
                margin-bottom: 12px;
            }

            .tab-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .btn {
                padding: 8px 14px;
                font-size: 12px;
            }

            .search-input {
                padding: 8px 12px;
                font-size: 13px;
            }

            .district-cell {
                font-size: 11px;
            }

            .view-toggle, .pivot-option {
                padding: 4px 10px;
                font-size: 11px;
            }

            .benchmark-metric-btn {
                padding: 6px 12px;
                font-size: 11px;
            }

            h1, .text-2xl {
                font-size: 1.25rem !important;
            }
        }

        /* Small phones (up to 480px) */
        @media (max-width: 480px) {
            /* Header mobile adjustments */
            header .flex {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 12px;
            }

            header .flex.items-center.gap-4 {
                width: 100%;
                flex-wrap: wrap;
                gap: 8px;
            }

            header h1, header .text-2xl {
                font-size: 1.3rem !important;
            }

            header .text-sm {
                font-size: 0.75rem;
            }

            header .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            /* Main container */
            .p-6 {
                padding: 12px !important;
            }

            /* Metric cards */
            .metric-value {
                font-size: 24px !important;
            }

            .data-card {
                padding: 14px;
                border-radius: 10px;
            }

            /* Tab buttons */
            .tab-btn {
                padding: 8px 14px;
                font-size: 13px;
            }

            /* District grid */
            .district-cell {
                font-size: 12px;
                border-radius: 3px;
            }

            /* Data grid container */
            #dataGrid {
                height: 500px !important;
            }

            /* Charts */
            .chart-container {
                height: 250px;
            }

            /* Buttons */
            .btn {
                padding: 10px 16px;
            }

            .btn-primary, .btn-secondary {
                width: 100%;
                text-align: center;
            }

            /* View toggles */
            .view-toggle, .pivot-option {
                padding: 6px 12px;
                font-size: 12px;
            }

            /* Filter builder */
            .filter-condition {
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .filter-condition select,
            .filter-condition input {
                width: 100%;
            }

            /* Custom grouping */
            .custom-grouping-config {
                grid-template-columns: 1fr;
            }

            /* Benchmark buttons */
            .benchmark-metric-btn {
                padding: 6px 12px;
                font-size: 12px;
                flex: 1;
                min-width: 0;
            }

            /* Modal adjustments */
            .modal-container,
            .district-modal {
                margin: 10px;
                padding: 16px;
                max-width: calc(100% - 20px);
                border-radius: 12px;
            }

            .modal-overlay,
            .district-modal-overlay {
                padding: 10px;
            }

            .district-modal-header {
                padding: 1rem;
                border-radius: 12px 12px 0 0;
            }

            .district-modal-header h2 {
                font-size: 1.1rem;
            }

            .district-modal-body {
                padding: 1rem;
            }

            .demo-grid {
                grid-template-columns: 1fr !important;
            }

            .demo-section-title {
                font-size: 0.8rem;
            }

            .demo-item {
                padding: 0.6rem;
            }

            .demo-item .value {
                font-size: 0.95rem;
            }

            .demo-item .label {
                font-size: 0.65rem;
            }

            /* Bulk upload */
            .bulk-results-table {
                min-width: 600px;
            }

            .mapping-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .mapping-arrow {
                transform: rotate(90deg);
                justify-self: center;
            }

            .drop-zone {
                padding: 24px;
            }

            .paste-area {
                min-height: 150px;
            }

            /* Demographics cards */
            .demographics-card-grid {
                grid-template-columns: 1fr;
            }

            /* County summary */
            .county-summary-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem;
            }

            .county-stat-value {
                font-size: 1.25rem;
            }

            .county-stat-label {
                font-size: 0.65rem;
            }

            /* Aggregation options */
            .aggregation-options {
                flex-direction: column;
            }

            .aggregation-option {
                width: 100%;
                text-align: center;
            }

            /* Demo viz */
            .demo-viz-controls {
                flex-direction: column;
                width: 100%;
            }

            .demo-viz-select {
                width: 100%;
                min-width: unset;
            }

            .demo-viz-toggle {
                width: 100%;
            }

            .demo-viz-toggle button {
                flex: 1;
            }

            .scatter-chart-container {
                height: 300px;
            }

            .bar-chart-container {
                height: 500px;
            }

            /* Correlation badge */
            .correlation-badge {
                font-size: 11px;
                padding: 3px 8px;
            }
        }

        /* Standard mobile (up to 640px) */
        @media (max-width: 640px) {
            /* Header layout */
            .mobile-menu-toggle {
                display: block;
            }

            header .flex.items-center.gap-4 {
                flex-wrap: wrap;
            }

            /* Grid layouts become single column */
            .grid.grid-cols-2,
            .grid.grid-cols-3,
            .grid.grid-cols-4 {
                grid-template-columns: 1fr !important;
            }

            /* Make district heatmap grid smaller */
            [style*="grid-template-columns: repeat(7"] {
                grid-template-columns: repeat(5, 1fr) !important;
            }

            /* Data grid */
            #dataGrid {
                height: 450px !important;
            }

            /* Benchmarks table scroll */
            .bulk-results-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Demographics table scroll */
            .demographics-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .demographics-table {
                min-width: 600px;
            }
        }

        /* Tablet (up to 768px) */
        @media (max-width: 768px) {
            /* Two column grids become single */
            .grid.md\\:grid-cols-2 {
                grid-template-columns: 1fr !important;
            }

            /* Header stacking */
            header > div > div.flex {
                flex-direction: column;
                gap: 12px;
            }

            header .flex.items-center.gap-4 {
                width: 100%;
                justify-content: space-between;
            }

            /* Tab row scrolling */
            .flex.border-b {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 2px;
            }

            .tab-btn {
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* District modal */
            .district-modal {
                max-width: calc(100% - 2rem);
                margin: 1rem;
            }

            /* Demo viz container */
            .demo-viz-container {
                grid-template-columns: 1fr !important;
            }
        }

        /* Tablet landscape (up to 1024px) */
        @media (max-width: 1024px) {
            /* Four column grids become two */
            .grid.lg\\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Three column grids become two */
            .grid.lg\\:grid-cols-3 {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Data grid height */
            #dataGrid {
                height: 600px !important;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
            }

            .tab-btn {
                min-height: 44px;
                padding: 12px 16px;
            }

            .district-cell {
                min-height: 40px;
            }

            .search-input {
                min-height: 44px;
            }

            .filter-select,
            .target-field-select,
            .grouping-field-select {
                min-height: 44px;
            }

            .benchmark-metric-btn {
                min-height: 40px;
            }

            .view-toggle,
            .pivot-option,
            .aggregation-option {
                min-height: 40px;
            }

            .modal-close,
            .district-modal-close {
                width: 40px;
                height: 40px;
                font-size: 1.5rem;
            }

            .source-btn {
                width: 36px;
                height: 36px;
            }
        }

        /* Landscape phone */
        @media (max-width: 900px) and (orientation: landscape) {
            .district-modal,
            .modal-container {
                max-height: 100vh;
            }

            .district-modal-body,
            .modal-body {
                max-height: calc(100vh - 80px);
                overflow-y: auto;
            }

            #dataGrid {
                height: 350px !important;
            }

            .chart-container {
                height: 200px;
            }
        }

        /* Print adjustments */
        @media print {
            header .btn,
            #loginBtn,
            #logoutBtn {
                display: none !important;
            }

            .tab-btn:not(.active) {
                display: none;
            }

            #dataGrid {
                height: auto !important;
            }
        }

        /* High DPI screens */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .district-cell {
                border-width: 0.5px;
            }
        }
    </style>
</head>
<body>
    <!-- Unofficial Notice Banner -->
    <div class="unofficial-banner">
        ‚ö†Ô∏è UNOFFICIAL COMMUNITY PROJECT - Not affiliated with Metro Nashville or any government agency
    </div>

    <!-- URL Filter Banner - Shows when viewing filtered data via URL -->
    <div id="urlFilterBanner" class="url-filter-banner hidden">
        <span class="url-filter-banner-icon">üîç</span>
        <span class="url-filter-banner-text">Viewing Filtered Data</span>
        <span id="urlFilterCount" class="url-filter-banner-count">0 of 0 records</span>
        <div class="url-filter-banner-actions">
            <button onclick="copyFilterUrl()" class="url-filter-banner-btn secondary" id="copyUrlBtn" title="Copy link to share this filtered view">
                üìã Copy Link
            </button>
            <button onclick="clearAllFiltersAndUrl()" class="url-filter-banner-btn danger" title="Clear all filters and show all data">
                ‚úï Clear Filters
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4">
        <div class="max-w-screen-2xl mx-auto">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">
                        Nashville Eviction Tracker
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">
                        Community-maintained analysis of public court records ‚Ä¢ Data sourced from Sessions Court
                    </p>
                </div>

                <!-- Improved Navigation -->
                <nav class="main-nav">
                    <!-- Navigation Links Group -->
                    <div class="nav-group">
                        <a href="cm-rankings.html" class="nav-item">
                            <span class="nav-item-icon">üìä</span>
                            <span>CM Rankings</span>
                        </a>
                        <a href="provenance.html" class="nav-item">
                            <span class="nav-item-icon">üìã</span>
                            <span>Methodology</span>
                        </a>
                        <a href="event-log.html" class="nav-item">
                            <span class="nav-item-icon">üìú</span>
                            <span>Event Log</span>
                        </a>
                    </div>

                    <div class="nav-divider"></div>

                    <!-- Status Indicator -->
                    <div class="nav-status">
                        <span id="pollStatusDot" class="nav-status-dot" title="Auto-refresh active"></span>
                        <span>Updated: <span id="lastUpdate">Loading...</span></span>
                        <span id="pollCountdown" class="text-xs text-gray-400"></span>
                    </div>

                    <!-- Action Buttons -->
                    <button id="refreshBtn" onclick="manualRefresh()" class="nav-action-btn nav-btn-refresh" title="Refresh data">
                        <span>Refresh</span>
                    </button>

                    <!-- Download Benchmark Data Button -->
                    <button onclick="openDownloadModal()" class="nav-action-btn nav-btn-download" title="Download benchmark data">
                        <span>Download Data</span>
                    </button>

                    <div class="nav-divider"></div>

                    <!-- Auth Buttons -->
                    <button id="loginBtn" onclick="showLoginModal()" class="nav-action-btn nav-btn-login">
                        <span>Login to View Tenant Names</span>
                    </button>
                    <button id="logoutBtn" onclick="logout()" class="nav-action-btn nav-btn-logout hidden">
                        <span>Logout</span>
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <div class="max-w-screen-2xl mx-auto p-6">
        <!-- Status Message -->
        <div id="statusMessage" class="status-message status-loading">
            ‚è≥ Loading data from public records API...
        </div>


        <!-- Key Metrics -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div id="metricTotal" class="data-card p-6 metric-clickable" onclick="filterByMetric('total')" title="Click to view all records">
                <div class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Records</div>
                <div id="totalRecords" class="metric-value text-gray-900">-</div>
                <div id="totalChange" class="text-sm mt-2"></div>
                <div class="metric-source-link" onclick="event.stopPropagation(); showMetricSource('total')">
                    <span class="source-icon">‚ÑπÔ∏è</span>
                    <span class="text-xs">Source</span>
                </div>
            </div>
            <div id="metricMonth" class="data-card p-6 metric-clickable" onclick="filterByMetric('thisMonth')" title="Click to view this month's records">
                <div class="text-sm font-semibold text-gray-500 uppercase tracking-wide">This Month</div>
                <div id="thisMonth" class="metric-value text-gray-900">-</div>
                <div id="monthChange" class="text-sm mt-2"></div>
                <div class="metric-source-link" onclick="event.stopPropagation(); showMetricSource('thisMonth')">
                    <span class="source-icon">‚ÑπÔ∏è</span>
                    <span class="text-xs">Source</span>
                </div>
            </div>
            <div id="metricThirty" class="data-card p-6 metric-clickable" onclick="filterByMetric('last30Days')" title="Click to view last 30 days">
                <div class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Last 30 Days</div>
                <div id="last30Days" class="metric-value text-gray-900">-</div>
                <div id="thirtyChange" class="text-sm mt-2"></div>
                <div class="metric-source-link" onclick="event.stopPropagation(); showMetricSource('last30Days')">
                    <span class="source-icon">‚ÑπÔ∏è</span>
                    <span class="text-xs">Source</span>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 gap-6 mb-6">
            <!-- Monthly Trend Chart -->
            <div class="data-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold text-gray-900">Eviction Filings by Month</h2>
                        <span id="chartFilterIndicator" class="hidden"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">Click a point to filter table</span>
                        <button onclick="downloadChart('monthly')" class="text-gray-500 hover:text-gray-700">
                            üìä Export
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- District Heat Map - Hidden (address/district data uncertain) -->
            <div class="data-card p-6 hidden">
                <h2 class="text-xl font-bold text-gray-900 mb-4">District Activity Patterns*</h2>
                <div class="grid grid-cols-7 gap-1" id="districtGrid">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="mt-4 flex items-center justify-between text-xs">
                    <span class="text-gray-500">Lower activity</span>
                    <div class="flex gap-1 items-center">
                        <span class="text-gray-400">‚óã</span>
                        <div class="w-4 h-4 heat-1 rounded"></div>
                        <div class="w-4 h-4 heat-2 rounded"></div>
                        <div class="w-4 h-4 heat-3 rounded"></div>
                        <div class="w-4 h-4 heat-4 rounded"></div>
                        <div class="w-4 h-4 heat-5 rounded"></div>
                        <span class="text-gray-700">‚óè‚óè‚óè</span>
                    </div>
                    <span class="text-gray-500">Higher activity</span>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">Relative distribution based on available data*</p>
            </div>
        </div>

        <!-- Advanced Filters Section -->
        <div class="data-card p-6 mb-6" id="advancedFiltersSection">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Advanced Filters</h3>
                <div id="filterLoadingIndicator" class="filter-loading-indicator hidden">
                    <span class="animate-spin inline-block mr-2">‚è≥</span>
                    <span>Applying filters...</span>
                </div>
            </div>

            <!-- Active Filter Summary -->
            <div id="activeFilterSummary" class="active-filter-summary hidden">
                <div class="flex items-center justify-between">
                    <div>
                        <span class="font-semibold text-gray-700">Active Filter:</span>
                        <span id="filterSummaryText" class="ml-2 text-gray-600"></span>
                    </div>
                    <button onclick="clearAdvancedFilters()" class="text-sm text-red-600 hover:text-red-800 font-medium">Clear Filter</button>
                </div>
            </div>

            <!-- Saved Presets -->
            <div id="savedPresetsSection" class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-semibold text-gray-700">Saved Filters</span>
                </div>
                <div id="presetsList" class="presets-list">
                    <!-- Presets will be loaded here -->
                </div>
            </div>

            <!-- Filter Builder -->
            <div class="filter-builder" id="filterBuilderContainer">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-gray-700">Build Your Filter</span>
                    <div class="flex gap-2">
                        <button onclick="addFilterGroup()" class="add-condition-btn">+ Add Group</button>
                    </div>
                </div>

                <!-- Root Filter Groups Container -->
                <div id="filterGroupsContainer">
                    <!-- Filter groups will be added here -->
                </div>

                <!-- Quick Date Filters -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Quick Filters</span>
                    <div class="mt-2 flex flex-wrap gap-2">
                        <button onclick="applyQuickFilter('last30')" class="add-condition-btn">Last 30 Days</button>
                        <button onclick="applyQuickFilter('last90')" class="add-condition-btn">Last 90 Days</button>
                        <button onclick="applyQuickFilter('lastYear')" class="add-condition-btn">Last Year</button>
                    </div>
                </div>
            </div>

            <!-- Filter Actions -->
            <div class="filter-actions">
                <button id="applyFilterBtn" onclick="applyAdvancedFilters()" class="btn btn-primary">Apply Filter</button>
                <button onclick="saveFilterPreset()" class="btn btn-secondary">Save as Preset</button>
                <button onclick="clearAdvancedFilters()" class="btn btn-secondary">Clear All</button>
            </div>

            <!-- Hidden legacy inputs for compatibility -->
            <input type="date" id="dateFrom" class="hidden">
            <input type="date" id="dateTo" class="hidden">
        </div>

        <!-- Demographics Visualization Section -->
        <div class="data-card p-6 mb-6" id="demographicsVizSection">
            <!-- Collapsible Header -->
            <div class="demographics-header cursor-pointer" onclick="toggleDemographicsSection()">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="flex items-center gap-3">
                        <span id="demographicsCollapseIcon" class="collapse-icon text-gray-400 transition-transform duration-200">‚ñº</span>
                        <div>
                            <div class="flex items-center gap-2">
                                <h2 class="text-xl font-bold text-gray-900">Eviction Rate & Demographics</h2>
                                <span id="demoFilterIndicator" class="demo-filter-badge hidden">Filtered</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">Explore how eviction rates correlate with community demographics across Nashville's 35 council districts</p>
                        </div>
                    </div>
                    <div class="demo-viz-controls" onclick="event.stopPropagation()">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">NORMALIZE BY</label>
                            <div class="demo-viz-toggle">
                                <button id="normPop" class="active" onclick="setNormalization('population')">Per 1k Renters</button>
                                <button id="normHousing" onclick="setNormalization('housing')">Per 100 Units</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collapsible Content -->
            <div id="demographicsContent" class="demographics-collapsible-content mt-6">
            <div class="demo-viz-container">
                <!-- Scatter Plot -->
                <div>
                    <div class="mb-3">
                        <label class="block text-xs font-semibold text-gray-500 mb-1">COMPARE AGAINST</label>
                        <select id="demoXAxis" class="demo-viz-select w-full" onchange="updateDemographicsCharts()">
                            <option value="unemployment">Unemployment Rate (%)</option>
                            <option value="medianRent">Median Monthly Rent ($)</option>
                            <option value="pctLessThanHS">% Less Than High School</option>
                            <option value="childPoverty">Child Poverty Rate (%)</option>
                            <option value="pctSenior">% Senior Population (65+)</option>
                            <option value="renterCostBurden">Renter Cost Burden (%)</option>
                            <option value="povertyRate">Poverty Rate (%)</option>
                            <option value="pctBlack">% Black Population</option>
                            <option value="pctHispanic">% Hispanic Population</option>
                            <option value="medianIncome">Median Income ($)</option>
                            <option value="unitsPerPopulation">Housing Units per 1k Pop</option>
                        </select>
                    </div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold text-gray-700">Correlation Analysis</h3>
                        <span id="correlationBadge" class="correlation-badge correlation-weak">Loading...</span>
                    </div>
                    <div class="scatter-chart-container">
                        <div id="chartVariableLabels" class="chart-variable-labels">
                            <div class="variable-label y-label">
                                <span class="variable-icon">‚Üï</span>
                                <span id="yVarLabel" class="variable-name">Eviction Rate</span>
                            </div>
                            <div class="variable-label x-label">
                                <span class="variable-icon">‚Üî</span>
                                <span id="xVarLabel" class="variable-name">Demographic Factor</span>
                            </div>
                        </div>
                        <canvas id="scatterChart"></canvas>
                    </div>
                    <div id="scatterInsight" class="demo-insight-box">
                        <div class="insight-title">Key Insight</div>
                        <div class="insight-text">Select a demographic factor to see correlation analysis.</div>
                    </div>
                </div>

                <!-- Ranked Bar Chart -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold text-gray-700">Districts Ranked by Eviction Rate</h3>
                        <span class="text-xs text-gray-500">Click bar for details</span>
                    </div>
                    <div class="bar-chart-container">
                        <canvas id="rankedBarChart"></canvas>
                    </div>
                    <div id="barInsight" class="demo-insight-box warning">
                        <div class="insight-title">Top Districts</div>
                        <div class="insight-text">Loading district rankings...</div>
                    </div>
                </div>
            </div>
            </div> <!-- End demographicsContent -->
        </div>

        <!-- Search Section -->
        <div class="data-card p-6 mb-6">
            <div class="border-b border-gray-200 mb-4">
                <div class="flex gap-2 flex-wrap">
                    <button onclick="setSearchTab('quick')" class="tab-btn active" id="quickTab">Quick Search</button>
                    <button onclick="setSearchTab('bulk')" class="tab-btn" id="bulkTab">Bulk Search</button>
                    <button onclick="setSearchTab('grouping')" class="tab-btn" id="groupingTab">Custom Grouping</button>
                    <button onclick="setSearchTab('demographics')" class="tab-btn demographics-tab-btn" id="demographicsTab">üìä District Demographics</button>
                    <button onclick="setSearchTab('benchmarks')" class="tab-btn" id="benchmarksTab" style="background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); color: white; border-radius: 6px;">üèôÔ∏è Metro Benchmarks</button>
                </div>
            </div>

            <!-- Quick Search -->
            <div id="quickSearch" class="search-panel">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="searchInput" placeholder="Search any field..." 
                           class="search-input md:col-span-2" onkeyup="quickSearch()">
                    <button onclick="clearSearch()" class="btn btn-secondary">Clear</button>
                </div>
            </div>

            <!-- Bulk Search -->
            <div id="bulkSearch" class="search-panel hidden">
                <!-- Login Required State -->
                <div id="bulkSearchLocked" class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 mb-4">
                        <span class="text-3xl">üîí</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Login Required</h3>
                    <p class="text-gray-600 mb-4 max-w-md mx-auto">
                        Bulk search functionality is restricted to authorized users to protect the privacy of individuals in eviction records.
                    </p>
                    <button onclick="showLoginModal()" class="btn btn-primary" style="background: #dc2626;">
                        üîì Login to Access Bulk Search
                    </button>
                </div>
                <!-- Actual Bulk Search Content (hidden until logged in) -->
                <div id="bulkSearchContent" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Paste Search Terms (one per line or comma-separated)
                            </label>
                            <textarea id="bulkNames" rows="6"
                                      placeholder="ABC Properties LLC&#10;123 Main Street&#10;John Smith"
                                      class="search-input w-full font-mono text-sm"></textarea>
                            <div class="mt-3 flex items-center gap-4">
                                <label class="text-sm text-gray-600">Search In:</label>
                                <select id="bulkSearchField" class="search-input text-sm" style="width: auto; padding: 4px 8px;">
                                    <option value="landlord">Landlord</option>
                                    <option value="address">Address</option>
                                    <option value="both">Both</option>
                                </select>
                            </div>
                            <div class="mt-3 flex items-center gap-4">
                                <label class="text-sm text-gray-600">Match Threshold:</label>
                                <input type="range" id="fuzzyThreshold" min="0.5" max="1" step="0.05" value="0.8"
                                       class="fuzzy-slider flex-1" oninput="updateThreshold()">
                                <span id="thresholdValue" class="text-sm font-semibold">80%</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Or Upload CSV File
                            </label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                                <input type="file" id="csvFile" class="hidden" accept=".csv" onchange="handleCSV(event)">
                                <label for="csvFile" class="cursor-pointer">
                                    <div class="text-3xl mb-2">üìÅ</div>
                                    <p class="text-sm text-gray-600">Click to upload CSV</p>
                                    <p class="text-xs text-gray-400 mt-1">First column should contain names</p>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button onclick="runBulkSearch()" class="btn btn-primary">Run Fuzzy Match</button>
                        <button onclick="exportMatches()" class="btn btn-secondary">Export Matches</button>
                    </div>
                    <div id="bulkResults" class="mt-4 hidden max-h-96 overflow-y-auto border rounded-lg"></div>
                </div>
            </div>

            <!-- Custom Grouping Tab -->
            <div id="groupingSearch" class="search-panel hidden">
                <div class="mb-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">Create Custom Data Grouping</h3>
                    <div class="custom-grouping-config">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-2">Group By Field</label>
                            <select id="customGroupField" class="grouping-field-select w-full" onchange="updateCustomGroupPreview()">
                                <option value="">Select a field...</option>
                                <option value="Plaintiff">Plaintiff/Landlord</option>
                                <option value="Defendant">Defendant/Tenant</option>
                                <option value="Attorney">Attorney</option>
                                <option value="District">Council District</option>
                                <option value="File_Date_Month">Month Filed</option>
                                <option value="File_Date_Year">Year Filed</option>
                                <option value="File_Date_Quarter">Quarter Filed</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-2">Secondary Group (Optional)</label>
                            <select id="customGroupField2" class="grouping-field-select w-full" onchange="updateCustomGroupPreview()">
                                <option value="">None</option>
                                <option value="Plaintiff">Plaintiff/Landlord</option>
                                <option value="Defendant">Defendant/Tenant</option>
                                <option value="Attorney">Attorney</option>
                                <option value="District">Council District</option>
                                <option value="File_Date_Month">Month Filed</option>
                                <option value="File_Date_Year">Year Filed</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs font-semibold text-gray-600 mb-2">Aggregations to Show</label>
                        <div class="aggregation-options">
                            <button class="aggregation-option active" data-agg="count" onclick="toggleAggregation(this)">Count</button>
                            <button class="aggregation-option" data-agg="firstDate" onclick="toggleAggregation(this)">First Filing</button>
                            <button class="aggregation-option active" data-agg="lastDate" onclick="toggleAggregation(this)">Last Filing</button>
                            <button class="aggregation-option" data-agg="uniqueAddresses" onclick="toggleAggregation(this)">Unique Addresses</button>
                        </div>
                    </div>

                    <!-- Saved Groupings -->
                    <div class="mb-4">
                        <label class="block text-xs font-semibold text-gray-600 mb-2">Saved Groupings</label>
                        <div id="savedGroupingsList" class="presets-list">
                            <!-- Saved groupings will appear here -->
                        </div>
                    </div>
                </div>

                <div class="filter-actions">
                    <button onclick="applyCustomGrouping()" class="btn btn-primary">Apply Grouping</button>
                    <button onclick="saveCustomGrouping()" class="btn btn-secondary">Save Grouping</button>
                    <button onclick="resetToDefaultGrouping()" class="btn btn-secondary">Reset to Default</button>
                </div>
            </div>

            <!-- Demographics Panel -->
            <div id="demographicsSearch" class="search-panel hidden">
                <div class="demographics-overview">
                    <!-- Header with intro and controls -->
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-3">
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">Nashville Council District Demographics</h3>
                            <p class="text-sm text-gray-600">Click any district to view full demographic profile. Data from American Community Survey 2017-2021.</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-semibold text-gray-600">Sort by:</label>
                            <select id="demographicsSortField" class="grouping-field-select text-sm" onchange="renderDemographicsTable()">
                                <option value="district">District Number</option>
                                <option value="evictionsPerMonth">Avg Evictions/Month</option>
                                <option value="evictionRate">Evictions per 1,000 Renters</option>
                                <option value="population">Population</option>
                                <option value="medianIncome">Median Income</option>
                                <option value="povertyRate">Poverty Rate</option>
                                <option value="renterCostBurden">Renter Cost Burden</option>
                                <option value="unemployment">Unemployment Rate</option>
                            </select>
                            <select id="demographicsSortOrder" class="grouping-field-select text-sm" onchange="renderDemographicsTable()">
                                <option value="asc">Low to High</option>
                                <option value="desc">High to Low</option>
                            </select>
                        </div>
                    </div>

                    <!-- County Summary Card -->
                    <div class="county-summary-card mb-4">
                        <div class="county-summary-title">Davidson County Overview</div>
                        <div class="county-summary-grid">
                            <div class="county-stat clickable" onclick="showCountyStatSource('evictions')" title="Click for source">
                                <div class="county-stat-value" id="countyTotalEvictions">-</div>
                                <div class="county-stat-label">Evictions/Year</div>
                            </div>
                            <div class="county-stat clickable" onclick="showCountyStatSource('population')" title="Click for source">
                                <div class="county-stat-value" id="countyPopulation">-</div>
                                <div class="county-stat-label">Population</div>
                            </div>
                            <div class="county-stat clickable" onclick="showCountyStatSource('income')" title="Click for source">
                                <div class="county-stat-value" id="countyMedianIncome">-</div>
                                <div class="county-stat-label">Median Income</div>
                            </div>
                            <div class="county-stat clickable" onclick="showCountyStatSource('poverty')" title="Click for source">
                                <div class="county-stat-value" id="countyPovertyRate">-</div>
                                <div class="county-stat-label">Poverty Rate</div>
                            </div>
                        </div>
                    </div>

                    <!-- District Grid/Table -->
                    <div class="demographics-table-container">
                        <div id="demographicsDataRange" class="text-xs text-gray-500 mb-2" style="display: none;"></div>
                        <table class="demographics-table" id="demographicsTable">
                            <thead>
                                <tr>
                                    <th>District</th>
                                    <th class="th-clickable" onclick="showDemographicMetricSource('avgPerMonth')" title="Click for source: Average eviction filings per month">Avg/Mo <span class="th-info">‚ÑπÔ∏è</span></th>
                                    <th id="perCapitaHeader" class="th-clickable" onclick="showDemographicMetricSource('perCapita')" title="Click for source: Evictions per 1,000 renter households">Per 1K Renters <span class="th-info">‚ÑπÔ∏è</span></th>
                                    <th class="th-clickable" onclick="showDemographicMetricSource('population')" title="Click for source">Population <span class="th-info">‚ÑπÔ∏è</span></th>
                                    <th class="th-clickable" onclick="showDemographicMetricSource('income')" title="Click for source">Med. Income <span class="th-info">‚ÑπÔ∏è</span></th>
                                    <th class="th-clickable" onclick="showDemographicMetricSource('poverty')" title="Click for source">Poverty <span class="th-info">‚ÑπÔ∏è</span></th>
                                    <th class="th-clickable" onclick="showDemographicMetricSource('rentBurden')" title="Click for source">Rent Burden <span class="th-info">‚ÑπÔ∏è</span></th>
                                    <th class="th-clickable" onclick="showDemographicMetricSource('unemployment')" title="Click for source">Unemploy. <span class="th-info">‚ÑπÔ∏è</span></th>
                                </tr>
                            </thead>
                            <tbody id="demographicsTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Visual District Cards (Alternative View) -->
                    <div class="mt-4">
                        <button id="demographicsViewToggleBtn" onclick="toggleDemographicsView()" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                            Show Card View
                        </button>
                    </div>
                    <div id="demographicsCardView" class="demographics-card-grid hidden mt-4">
                        <!-- Populated by JavaScript -->
                    </div>

                    <!-- Source -->
                    <div class="mt-4 text-xs text-gray-500 text-center">
                        Source: <a href="https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf" target="_blank" class="text-indigo-600 hover:underline">Metropolitan Social Services Know Your Community 2023</a>
                    </div>
                </div>
            </div>

            <!-- Metro Benchmarks Panel -->
            <div id="benchmarksSearch" class="search-panel hidden">
                <div class="benchmarks-overview">
                    <!-- PROMINENT EXPORT SECTION - TOP OF PANEL -->
                    <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 rounded-xl p-5 mb-6 shadow-lg">
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                            <div class="text-white">
                                <div class="flex items-center gap-2 mb-1">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    <h3 class="text-xl font-bold">Export Benchmark Reports</h3>
                                </div>
                                <p class="text-indigo-100 text-sm">Download comprehensive benchmark data in multiple formats</p>
                            </div>

                            <!-- Export Format Buttons Grid -->
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                <button onclick="exportBenchmarkPDF()" class="export-format-btn flex flex-col items-center gap-1 px-4 py-3 bg-white/10 hover:bg-white/20 border border-white/30 rounded-lg transition-all text-white group">
                                    <svg class="w-6 h-6 text-red-300 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M10.92,12.31C10.68,11.54 10.15,9.08 11.55,9.04C12.95,9 12.03,12.16 12.03,12.16C12.42,13.65 14.05,14.72 14.05,14.72C14.55,14.57 17.4,14.24 17,15.72C16.57,17.2 13.5,15.81 13.5,15.81C11.55,15.95 10.09,16.47 10.09,16.47C8.96,18.58 7.64,19.5 7.1,18.61C6.43,17.5 9.23,16.07 9.23,16.07C10.68,13.72 10.9,12.35 10.92,12.31Z"/></svg>
                                    <span class="text-xs font-semibold">PDF</span>
                                    <span class="text-[10px] text-indigo-200">Visual Report</span>
                                </button>
                                <button onclick="exportBenchmarkCSV()" class="export-format-btn flex flex-col items-center gap-1 px-4 py-3 bg-white/10 hover:bg-white/20 border border-white/30 rounded-lg transition-all text-white group">
                                    <svg class="w-6 h-6 text-green-300 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M10,19L12,15H9V10H15V15L13,19H10Z"/></svg>
                                    <span class="text-xs font-semibold">CSV</span>
                                    <span class="text-[10px] text-indigo-200">Spreadsheet</span>
                                </button>
                                <button onclick="exportBenchmarkJSON()" class="export-format-btn flex flex-col items-center gap-1 px-4 py-3 bg-white/10 hover:bg-white/20 border border-white/30 rounded-lg transition-all text-white group">
                                    <svg class="w-6 h-6 text-blue-300 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 24 24"><path d="M5,3H7V5H5V10A2,2 0 0,1 3,12A2,2 0 0,1 5,14V19H7V21H5C3.93,20.73 3,20.1 3,19V15A2,2 0 0,0 1,13H0V11H1A2,2 0 0,0 3,9V5A2,2 0 0,1 5,3M19,3A2,2 0 0,1 21,5V9A2,2 0 0,0 23,11H24V13H23A2,2 0 0,0 21,15V19A2,2 0 0,1 19,21H17V19H19V14A2,2 0 0,1 21,12A2,2 0 0,1 19,10V5H17V3H19Z"/></svg>
                                    <span class="text-xs font-semibold">JSON</span>
                                    <span class="text-[10px] text-indigo-200">Raw Data</span>
                                </button>
                                <button onclick="exportBenchmarkExcel()" class="export-format-btn flex flex-col items-center gap-1 px-4 py-3 bg-white/10 hover:bg-white/20 border border-white/30 rounded-lg transition-all text-white group">
                                    <svg class="w-6 h-6 text-emerald-300 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 24 24"><path d="M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V17H2.83Q2.5 17 2.24 16.76 2 16.5 2 16.17V7.83Q2 7.5 2.24 7.24 2.5 7 2.83 7H7V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25M7 13.06L8.18 15.28H9.97L8 12.06L9.93 8.89H8.22L7.13 10.9L7.09 10.96L7.06 11.03Q6.8 10.5 6.5 9.96 6.25 9.43 5.97 8.89H4.16L6.05 12.08L4 15.28H5.78M13.88 19.5V17H8.25V19.5M13.88 15.75V12.63H12V15.75M13.88 11.38V8.25H12V11.38M13.88 7V4.5H8.25V7M20.75 19.5V17H15.13V19.5M20.75 15.75V12.63H15.13V15.75M20.75 11.38V8.25H15.13V11.38M20.75 7V4.5H15.13V7Z"/></svg>
                                    <span class="text-xs font-semibold">Excel</span>
                                    <span class="text-[10px] text-indigo-200">Full Workbook</span>
                                </button>
                            </div>
                        </div>

                        <!-- Privacy/Redaction Notice -->
                        <div class="mt-4 flex items-start gap-2 bg-white/10 rounded-lg px-3 py-2 border border-white/20">
                            <svg class="w-4 h-4 text-green-300 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                            <div class="text-xs text-indigo-100">
                                <span class="font-semibold text-white">Privacy Protected:</span> All exports contain aggregate statistical data only. Individual tenant names and specific addresses are automatically redacted to protect privacy. Benchmark data includes metro-level comparisons and anonymized demographic patterns.
                            </div>
                        </div>
                    </div>

                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-3">
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">Nashville vs. Comparable Metro Areas</h3>
                            <p class="text-sm text-gray-600">How Nashville's eviction rates compare to similar Sunbelt metros and national averages</p>
                        </div>
                    </div>

                    <!-- Nashville Summary Card -->
                    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-5 mb-6 border border-purple-200">
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-sm font-bold text-purple-800 uppercase tracking-wide">Nashville At A Glance (2024)</div>
                            <button onclick="showBenchmarkSource('nashville')" class="text-xs text-purple-600 hover:text-purple-800 underline" title="View Nashville data sources">View Sources</button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center cursor-pointer hover:bg-purple-100 rounded-lg p-2 transition-colors" onclick="showBenchmarkMetricSource('filing_rate')" title="Click for source info">
                                <div class="text-2xl font-bold text-purple-900" id="nashFilingRate">9.8%</div>
                                <div class="text-xs text-purple-600">Filing Rate <span class="opacity-60">‚ÑπÔ∏è</span></div>
                                <div class="text-xs text-gray-500">+26% above national avg</div>
                            </div>
                            <div class="text-center cursor-pointer hover:bg-purple-100 rounded-lg p-2 transition-colors" onclick="showBenchmarkMetricSource('judgment_rate')" title="Click for source info">
                                <div class="text-2xl font-bold text-purple-900" id="nashJudgmentRate">67%</div>
                                <div class="text-xs text-purple-600">Judgment Rate <span class="opacity-60">‚ÑπÔ∏è</span></div>
                                <div class="text-xs text-gray-500">cases ‚Üí eviction order</div>
                            </div>
                            <div class="text-center cursor-pointer hover:bg-purple-100 rounded-lg p-2 transition-colors" onclick="showBenchmarkMetricSource('eviction_rate')" title="Click for source info">
                                <div class="text-2xl font-bold text-purple-900" id="nashEvictionRate">6.5%</div>
                                <div class="text-xs text-purple-600">Eviction Rate <span class="opacity-60">‚ÑπÔ∏è</span></div>
                                <div class="text-xs text-gray-500">2.6x national avg</div>
                            </div>
                            <div class="text-center cursor-pointer hover:bg-purple-100 rounded-lg p-2 transition-colors" onclick="showBenchmarkSource('nashville')" title="Click for source info">
                                <div class="text-2xl font-bold text-purple-900" id="nashTotalFilings">14,346</div>
                                <div class="text-xs text-purple-600">Total Filings <span class="opacity-60">‚ÑπÔ∏è</span></div>
                                <div class="text-xs text-gray-500">25% above pre-pandemic</div>
                            </div>
                        </div>
                    </div>

                    <!-- Metric Selector -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="setBenchmarkMetric('filing_rate')" class="benchmark-metric-btn active" id="metricFilingRate">Filing Rate</button>
                        <button onclick="setBenchmarkMetric('judgment_rate')" class="benchmark-metric-btn" id="metricJudgmentRate">Judgment Rate</button>
                        <button onclick="setBenchmarkMetric('eviction_rate')" class="benchmark-metric-btn" id="metricEvictionRate">Eviction Rate</button>
                    </div>

                    <!-- Metric Explanation -->
                    <div id="metricExplanation" class="bg-gray-50 rounded-lg p-3 mb-4 text-sm">
                        <strong>Filing Rate:</strong> Eviction filings (detainer warrants) √∑ renter households. Measures threat of eviction.
                    </div>

                    <!-- Comparison Chart Container -->
                    <div class="bg-white rounded-xl border border-gray-200 p-4 mb-6">
                        <canvas id="metroBenchmarkChart" height="300"></canvas>
                    </div>

                    <!-- Metro Comparison Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm" id="benchmarkTable">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-2 text-left font-semibold text-gray-700">Metro Area</th>
                                    <th class="px-4 py-2 text-right font-semibold text-gray-700 th-clickable" onclick="showBenchmarkMetricSource('filing_rate')" title="Click for source info">Filing Rate <span class="th-info">‚ÑπÔ∏è</span></th>
                                    <th class="px-4 py-2 text-right font-semibold text-gray-700 th-clickable" onclick="showBenchmarkMetricSource('judgment_rate')" title="Click for source info">Judgment Rate <span class="th-info">‚ÑπÔ∏è</span></th>
                                    <th class="px-4 py-2 text-right font-semibold text-gray-700 th-clickable" onclick="showBenchmarkMetricSource('eviction_rate')" title="Click for source info">Eviction Rate <span class="th-info">‚ÑπÔ∏è</span></th>
                                    <th class="px-4 py-2 text-right font-semibold text-gray-700 th-clickable" onclick="showBenchmarkMetricSource('vs_prepandemic')" title="Click for source info">vs Pre-Pandemic <span class="th-info">‚ÑπÔ∏è</span></th>
                                    <th class="px-4 py-2 text-center font-semibold text-gray-700">Source</th>
                                </tr>
                            </thead>
                            <tbody id="benchmarkTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Methodology Note -->
                    <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                        <div class="text-sm font-bold text-amber-800 mb-2">Understanding the Metrics</div>
                        <div class="text-xs text-amber-700 space-y-1">
                            <p><strong>Filing Rate</strong> = (eviction filings √∑ renter households) √ó 100. Counts all cases including serial filings.</p>
                            <p><strong>Judgment Rate</strong> = (eviction judgments √∑ eviction filings) √ó 100. What % of cases result in eviction orders. National avg ~50%.</p>
                            <p><strong>Eviction Rate</strong> = (eviction judgments √∑ renter households) √ó 100. Actual displacement rate. National avg ~2.5%.</p>
                            <p class="italic mt-2">Note: These are formal court evictions only. Informal evictions (threats, lockouts) estimated 2-5.5x more common.</p>
                        </div>
                    </div>

                    <!-- Sources -->
                    <div class="mt-4 text-xs text-gray-500 text-center">
                        Sources: <a href="https://evictionlab.org" target="_blank" class="text-indigo-600 hover:underline">Princeton Eviction Lab</a>,
                        <a href="https://evictionlab.org/eviction-tracking" target="_blank" class="text-indigo-600 hover:underline">Eviction Tracking System 2024</a>,
                        Collinson et al. QJE 2024
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Grid -->
        <div class="data-card p-6">
            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">
                        Eviction Records
                        <span id="recordCount" class="text-sm font-normal text-gray-500"></span>
                    </h2>
                    <div class="flex flex-wrap gap-2 mt-1">
                        <span id="nameFilterIndicator" class="hidden"></span>
                        <span id="districtFilterIndicator" class="hidden"></span>
                    </div>
                </div>
                <div class="flex flex-wrap items-center gap-2 justify-end">
                    <div class="flex items-center gap-2 bg-gray-100 rounded-full p-1">
                        <button id="recordModeBtn" class="view-toggle active" onclick="setViewMode('records')">Records</button>
                        <button id="pivotModeBtn" class="view-toggle" onclick="setViewMode('pivot')">Summary</button>
                    </div>
                    <div id="pivotDimensionControls" class="flex flex-wrap items-center gap-2 hidden">
                        <span class="text-xs font-semibold tracking-wide text-gray-500 uppercase">Group by</span>
                        <button class="pivot-option active" data-pivot-dimension="plaintiff" onclick="setPivotDimension('plaintiff')">Landlord</button>
                        <button class="pivot-option" data-pivot-dimension="defendant" onclick="setPivotDimension('defendant')">Tenant</button>
                        <button class="pivot-option" data-pivot-dimension="attorney" onclick="setPivotDimension('attorney')">Landlord Attorney</button>
                        <button class="pivot-option" data-pivot-dimension="defenseAttorney" onclick="setPivotDimension('defenseAttorney')">Defense Attorney</button>
                        <button class="pivot-option" data-pivot-dimension="district" onclick="setPivotDimension('district')">Council District</button>
                        <button class="pivot-option" data-pivot-dimension="fileMonth" onclick="setPivotDimension('fileMonth')">Date</button>
                        <button id="attorneyModalBtn" onclick="openAttorneyModal()" class="ml-2 px-3 py-1 text-xs font-semibold bg-purple-100 text-purple-700 rounded-full border border-purple-200 hover:bg-purple-200 transition-colors" title="View attorney breakdown">
                            View All Attorneys
                        </button>
                    </div>
                    <div>
                        <button onclick="exportCSV()" class="btn btn-primary">
                            üì• Export CSV
                        </button>
                    </div>
                </div>
            </div>
            <div id="dataGrid" class="ag-theme-alpine"></div>
        </div>
    </div>

    <!-- Case Detail Modal -->
    <div id="caseModal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-start justify-center px-4 py-6 z-50 hidden overflow-y-auto" onclick="if (event.target === this) hideCaseModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden transform transition-all my-auto">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50 sticky top-0 z-10">
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Full Case Record</p>
                    <h3 id="caseModalTitle" class="text-xl font-bold text-gray-900">Docket #</h3>
                </div>
                <button class="text-gray-400 hover:text-gray-600 text-2xl leading-none p-2" onclick="hideCaseModal()" aria-label="Close case detail">
                    &times;
                </button>
            </div>
            <div id="caseModalContent" class="p-6 max-h-[80vh] overflow-y-auto">
                <!-- Case Overview Meta Cards -->
                <div id="caseModalMeta" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6"></div>

                <!-- Sections Container -->
                <div id="caseModalSections" class="space-y-6"></div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center px-4 py-10 z-[70] hidden" onclick="if (event.target === this) hideLoginModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all" style="max-width: 28rem;">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-red-50">
                <div>
                    <p class="text-xs font-semibold text-red-600 uppercase tracking-wide">Privacy Protected</p>
                    <h3 class="text-xl font-bold text-gray-900">Login Required</h3>
                </div>
                <button class="text-gray-400 hover:text-gray-600 text-2xl leading-none" onclick="hideLoginModal()" aria-label="Close login modal">
                    &times;
                </button>
            </div>
            <div class="p-6">
                <div class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                    <p class="text-sm text-amber-800">
                        <strong>Privacy Notice:</strong> Defendant names are protected to respect the privacy of individuals facing eviction proceedings. Authorized users can login to view full names.
                    </p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="loginPassword" class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                        <input
                            type="password"
                            id="loginPassword"
                            class="search-input w-full"
                            placeholder="Enter access password"
                            onkeypress="if(event.key === 'Enter') attemptLogin()"
                        >
                    </div>
                    <div id="loginError" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-sm text-red-700">Incorrect password. Please try again.</p>
                    </div>
                    <button onclick="attemptLogin()" class="btn btn-primary w-full" style="background: #dc2626;">
                        üîì Login
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- District Info Modal -->
    <div class="district-modal-overlay" id="districtModal" onclick="closeDistrictModal(event)">
        <div class="district-modal" onclick="event.stopPropagation()">
            <div class="district-modal-header">
                <button class="district-modal-close" onclick="closeDistrictModal()">&times;</button>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div id="districtModalLocation"></div>
                    <div>
                        <h2 id="districtModalTitle">District Demographics</h2>
                        <p class="subtitle" id="districtModalSubtitle">Community Profile</p>
                    </div>
                </div>
            </div>
            <div class="district-modal-body" id="districtModalBody">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Attorney Rollup Modal -->
    <div class="attorney-modal-overlay" id="attorneyModal" onclick="closeAttorneyModal(event)">
        <div class="attorney-modal" onclick="event.stopPropagation()">
            <div class="attorney-modal-header">
                <button class="attorney-modal-close" onclick="closeAttorneyModal()">&times;</button>
                <div>
                    <h2 id="attorneyModalTitle">Attorney Summary</h2>
                    <p class="subtitle" id="attorneyModalSubtitle">Eviction filing representation breakdown</p>
                </div>
            </div>
            <div class="attorney-modal-body">
                <div class="attorney-modal-summary" id="attorneyModalSummary">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Tabs for Plaintiff vs Defense Attorneys -->
                <div style="display: flex; gap: 8px; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0;">
                    <button id="plaintiffAttorneyTab" class="attorney-tab active" onclick="setAttorneyTab('plaintiff')" style="padding: 8px 16px; font-size: 0.875rem; font-weight: 600; border: none; background: none; cursor: pointer; border-bottom: 2px solid #4f46e5; margin-bottom: -2px; color: #4f46e5;">
                        Landlord Attorneys
                    </button>
                    <button id="defenseAttorneyTab" class="attorney-tab" onclick="setAttorneyTab('defense')" style="padding: 8px 16px; font-size: 0.875rem; font-weight: 600; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; color: #6b7280;">
                        Tenant Defense Attorneys
                    </button>
                </div>

                <div class="attorney-search">
                    <input type="text" id="attorneySearchInput" placeholder="Search attorneys..." oninput="filterAttorneyTable(this.value)">
                </div>
                <div style="overflow-x: auto;">
                    <table class="attorney-table" id="attorneyTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name" onclick="sortAttorneyTable('name')">Attorney <span class="sort-indicator">‚Üï</span></th>
                                <th class="sortable sorted num-col" data-sort="filings" onclick="sortAttorneyTable('filings')">Cases <span class="sort-indicator">‚Üì</span></th>
                                <th class="sortable num-col" data-sort="percent" onclick="sortAttorneyTable('percent')">% of Total <span class="sort-indicator">‚Üï</span></th>
                                <th class="sortable" data-sort="lastFiled" onclick="sortAttorneyTable('lastFiled')">Last Filing <span class="sort-indicator">‚Üï</span></th>
                                <th class="sortable num-col" data-sort="properties" onclick="sortAttorneyTable('properties')">Properties <span class="sort-indicator">‚Üï</span></th>
                            </tr>
                        </thead>
                        <tbody id="attorneyTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div class="download-modal-overlay" id="downloadModal" onclick="closeDownloadModal(event)">
        <div class="download-modal" onclick="event.stopPropagation()">
            <div class="download-modal-header">
                <button class="download-modal-close" onclick="closeDownloadModal()">&times;</button>
                <div>
                    <h2>Export Benchmark Data</h2>
                    <p class="subtitle">Download Nashville eviction benchmarks and comparisons</p>
                </div>
            </div>
            <div class="download-modal-body">
                <!-- Data Preview Section -->
                <div class="download-preview-section">
                    <div class="download-preview-title">Data Included in Export</div>
                    <div class="download-preview-grid">
                        <div class="download-preview-item">
                            <span class="icon check">&#10003;</span>
                            <span>8 Metro Area Comparisons</span>
                        </div>
                        <div class="download-preview-item">
                            <span class="icon check">&#10003;</span>
                            <span>Filing & Eviction Rates</span>
                        </div>
                        <div class="download-preview-item">
                            <span class="icon check">&#10003;</span>
                            <span>National Benchmarks</span>
                        </div>
                        <div class="download-preview-item">
                            <span class="icon check">&#10003;</span>
                            <span>Demographic Disparities</span>
                        </div>
                        <div class="download-preview-item">
                            <span class="icon check">&#10003;</span>
                            <span>Historical Rankings</span>
                        </div>
                        <div class="download-preview-item">
                            <span class="icon check">&#10003;</span>
                            <span>Metric Definitions</span>
                        </div>
                    </div>
                </div>

                <!-- Format Selection -->
                <div class="download-format-section">
                    <div class="download-format-title">Select Export Format</div>
                    <div class="download-format-grid">
                        <div class="download-format-option selected" data-format="csv" onclick="selectDownloadFormat('csv')">
                            <div class="format-icon csv">&#128196;</div>
                            <div class="format-name">CSV</div>
                            <div class="format-desc">Spreadsheet-ready data</div>
                        </div>
                        <div class="download-format-option" data-format="json" onclick="selectDownloadFormat('json')">
                            <div class="format-icon json">{ }</div>
                            <div class="format-name">JSON</div>
                            <div class="format-desc">Raw structured data</div>
                        </div>
                        <div class="download-format-option" data-format="pdf" onclick="selectDownloadFormat('pdf')">
                            <div class="format-icon pdf">&#128209;</div>
                            <div class="format-name">PDF Report</div>
                            <div class="format-desc">Professional format</div>
                        </div>
                        <div class="download-format-option" data-format="excel" onclick="selectDownloadFormat('excel')">
                            <div class="format-icon excel">&#128202;</div>
                            <div class="format-name">Excel</div>
                            <div class="format-desc">Multi-sheet workbook</div>
                        </div>
                    </div>
                </div>

                <!-- File Preview -->
                <div class="download-file-preview">
                    <span class="file-icon">&#128196;</span>
                    <div class="file-info">
                        <div class="file-name" id="downloadFileName">nashville_eviction_benchmarks_2026-02-02.csv</div>
                        <div class="file-size">Estimated size: ~15 KB</div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="download-modal-actions">
                    <button class="download-btn-cancel" onclick="closeDownloadModal()">Cancel</button>
                    <button class="download-btn-confirm" onclick="confirmDownload()">
                        <span>&#8595;</span>
                        <span>Download</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal (Secret: ESC x3 + "detainer") -->
    <div id="bulkUploadModal" class="upload-modal fixed inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center px-4 py-6 z-[60] hidden" onclick="if (event.target === this) hideBulkUploadModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
                <div>
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Admin Tool</p>
                    <h3 class="text-xl font-bold text-gray-900">Bulk Upload Eviction Filings</h3>
                </div>
                <button class="text-gray-400 hover:text-gray-600 text-2xl leading-none" onclick="hideBulkUploadModal()" aria-label="Close upload modal">
                    &times;
                </button>
            </div>

            <!-- Step Indicator -->
            <div class="px-6 py-3 bg-gray-50 border-b border-gray-200">
                <div class="flex items-center justify-center gap-2">
                    <div id="stepIndicator1" class="flex items-center gap-2">
                        <span class="w-7 h-7 rounded-full bg-indigo-600 text-white text-sm font-bold flex items-center justify-center">1</span>
                        <span class="text-sm font-medium text-gray-700">Import Data</span>
                    </div>
                    <div class="w-8 h-0.5 bg-gray-300"></div>
                    <div id="stepIndicator2" class="flex items-center gap-2 opacity-50">
                        <span class="w-7 h-7 rounded-full bg-gray-300 text-gray-600 text-sm font-bold flex items-center justify-center">2</span>
                        <span class="text-sm font-medium text-gray-500">Map Fields</span>
                    </div>
                    <div class="w-8 h-0.5 bg-gray-300"></div>
                    <div id="stepIndicator3" class="flex items-center gap-2 opacity-50">
                        <span class="w-7 h-7 rounded-full bg-gray-300 text-gray-600 text-sm font-bold flex items-center justify-center">3</span>
                        <span class="text-sm font-medium text-gray-500">Preview & Upload</span>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Step 1: Import Data -->
                <div id="uploadStep1" class="upload-step active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- File Upload -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Upload CSV File</label>
                            <div id="uploadDropZone" class="drop-zone" onclick="document.getElementById('bulkUploadFile').click()">
                                <input type="file" id="bulkUploadFile" class="hidden" accept=".csv" onchange="handleBulkUploadFile(event)">
                                <div class="text-4xl mb-3">üìÑ</div>
                                <p class="text-gray-700 font-medium">Drop CSV file here or click to browse</p>
                                <p class="text-sm text-gray-500 mt-2">Supports .csv files</p>
                            </div>
                        </div>

                        <!-- Paste CSV -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Or Paste CSV Data</label>
                            <textarea id="bulkUploadPaste"
                                class="search-input w-full paste-area"
                                placeholder="Paste CSV data here...&#10;&#10;Example:&#10;Office,Docket_Number,File_Date,Plaintiff_Petitioner,Defendant_Respondent&#10;1,24GT12345,2024-01-15,Property LLC,John Doe"></textarea>
                        </div>
                    </div>

                    <div id="uploadFileInfo" class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg hidden">
                        <div class="flex items-center gap-2 text-green-700">
                            <span>‚úì</span>
                            <span id="uploadFileName" class="font-medium"></span>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Field Mapping -->
                <div id="uploadStep2" class="upload-step">
                    <div class="mb-4">
                        <p class="text-gray-600">Map your CSV columns to the database fields. Auto-mapping has been applied where possible.</p>
                    </div>
                    <div id="fieldMappingContainer" class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                        <!-- Mapping rows will be inserted here -->
                    </div>
                </div>

                <!-- Step 3: Preview & Upload -->
                <div id="uploadStep3" class="upload-step">
                    <div class="mb-4 flex items-center justify-between">
                        <p class="text-gray-600">Review the data before uploading. Showing first 10 rows.</p>
                        <span id="uploadRowCount" class="text-sm font-medium text-gray-500"></span>
                    </div>

                    <div class="overflow-x-auto border rounded-lg mb-4" style="max-height: 300px; overflow-y: auto;">
                        <table id="uploadPreviewTable" class="upload-preview-table">
                            <thead id="uploadPreviewHead"></thead>
                            <tbody id="uploadPreviewBody"></tbody>
                        </table>
                    </div>

                    <!-- Upload Progress -->
                    <div id="uploadProgressSection" class="hidden">
                        <div class="mb-2 flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">Uploading...</span>
                            <span id="uploadProgressText" class="text-sm text-gray-500">0%</span>
                        </div>
                        <div class="upload-progress mb-4">
                            <div id="uploadProgressBar" class="upload-progress-bar" style="width: 0%"></div>
                        </div>
                        <div id="uploadStatusLog" class="max-h-40 overflow-y-auto bg-gray-50 rounded-lg p-3">
                            <!-- Status items will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-between">
                <button id="uploadBackBtn" class="btn btn-secondary hidden" onclick="uploadPrevStep()">
                    ‚Üê Back
                </button>
                <div class="flex-1"></div>
                <button id="uploadNextBtn" class="btn btn-primary" onclick="uploadNextStep()">
                    Next ‚Üí
                </button>
                <button id="uploadSubmitBtn" class="btn btn-primary hidden" onclick="submitBulkUpload()">
                    Upload Data
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allData = [];
        let filteredData = [];
        let gridApi;

        // Track dynamic case_data keys that appear in the Xano payload
        // These will be used to generate additional table columns and CSV export fields
        let dynamicCaseDataKeys = new Set();
        let monthlyChart;
        let searchMatches = [];
        let pivotData = [];
        let viewMode = 'records';
        let pivotDimension = 'plaintiff';
        let activeDistrictFilter = null; // Track active district filter for persistence

        // Data date range for pro-rating per capita calculations to full year
        let globalDataRange = {
            earliest: null,
            latest: null,
            days: 0,
            annualizationFactor: 1
        };

        // Login state for defendant privacy protection
        let isLoggedIn = false;
        // SHA-256 hash of the password (hashed in lowercase)
        const LOGIN_PASSWORD_HASH = 'fac97e07e2a67586b26047d8862db7306133ca2e1d033013fea044177d584404';

        // Encrypted POST endpoint (AES-GCM, decrypted on login)
        const ENCRYPTED_POST_ENDPOINT = 'tRfLwLSLvPZ9HGJXfB8xR7xBMoawRXcN3L+0Y1K/yFaF3HhKPiAI5n4RIHMpqZVN38uaSxp3e3uTsChVBF2XZLQV8WfNJNqwmm+8oCRvIHqw94mTbfE8gQ==';
        let decryptedPostEndpoint = null;

        // Hash function using Web Crypto API
        async function hashPassword(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text.toLowerCase().trim());
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // AES-GCM encryption using password-derived key (for generating encrypted values)
        async function encryptEndpoint(plaintext, password) {
            try {
                const encoder = new TextEncoder();
                const keyData = encoder.encode(password.toLowerCase().trim());
                const keyHash = await crypto.subtle.digest('SHA-256', keyData);

                const key = await crypto.subtle.importKey(
                    'raw', keyHash, { name: 'AES-GCM' }, false, ['encrypt']
                );

                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    encoder.encode(plaintext)
                );

                const combined = new Uint8Array(iv.length + encrypted.byteLength);
                combined.set(iv);
                combined.set(new Uint8Array(encrypted), iv.length);

                return btoa(String.fromCharCode(...combined));
            } catch (e) {
                console.error('Encryption failed:', e);
                return null;
            }
        }

        // AES-GCM decryption using password-derived key
        async function decryptEndpoint(encryptedBase64, password) {
            try {
                const encoder = new TextEncoder();
                const keyData = encoder.encode(password.toLowerCase().trim());
                const keyHash = await crypto.subtle.digest('SHA-256', keyData);

                const key = await crypto.subtle.importKey(
                    'raw', keyHash, { name: 'AES-GCM' }, false, ['decrypt']
                );

                const encryptedData = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
                const iv = encryptedData.slice(0, 12);
                const ciphertext = encryptedData.slice(12);

                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    ciphertext
                );

                return new TextDecoder().decode(decrypted);
            } catch (e) {
                return null;
            }
        }

        // ============================================
        // DISTRICT LOCATION MAPPING
        // ============================================
        // Maps each district to approximate position in Davidson County
        // Grid is 5x5, coordinates are [row, col] where:
        // row 0 = north, row 4 = south
        // col 0 = west, col 4 = east
        // Based on Nashville Metro Council district geographic locations
        const districtLocations = {
            1:  [0, 2],  // North Nashville - north center
            2:  [0, 1],  // North Nashville - northwest
            3:  [1, 1],  // North Nashville - west-center
            4:  [1, 2],  // Germantown/Downtown North
            5:  [1, 3],  // East Nashville
            6:  [2, 3],  // East Nashville/Lockeland
            7:  [1, 4],  // Inglewood/East
            8:  [2, 4],  // East Nashville/Madison border
            9:  [0, 3],  // Madison
            10: [1, 4],  // Donelson
            11: [0, 4],  // Hermitage
            12: [0, 4],  // Old Hickory
            13: [3, 2],  // South Nashville/Woodbine
            14: [2, 3],  // East/Rosebank
            15: [2, 4],  // Donelson/Airport
            16: [3, 2],  // Berry Hill/Melrose
            17: [2, 2],  // Downtown Nashville - center
            18: [2, 2],  // West End/Vanderbilt
            19: [2, 2],  // Downtown/SoBro
            20: [2, 1],  // Sylvan Park/West
            21: [2, 1],  // Fisk/TSU area
            22: [3, 0],  // West Nashville
            23: [4, 0],  // Bellevue
            24: [3, 1],  // West Meade/Belle Meade
            25: [3, 1],  // Green Hills
            26: [3, 1],  // Southwest
            27: [2, 1],  // Hillwood/West
            28: [4, 2],  // South Nashville
            29: [4, 3],  // South Nashville
            30: [4, 2],  // Nolensville Road area
            31: [4, 3],  // Antioch
            32: [3, 4],  // Antioch/Southeast
            33: [4, 4],  // Southeast
            34: [4, 1],  // Forest Hills/Oak Hill
            35: [3, 0]   // Southwest/Bellevue border
        };

        // Generate a mini-map SVG showing district location in county
        function getDistrictLocationSVG(districtNum, size = 'sm') {
            const location = districtLocations[districtNum];
            if (!location) return '';

            const [row, col] = location;
            const sizeClass = size === 'lg' ? 'district-location-map-lg' : 'district-location-map';

            // Define which cells are part of the county shape (simplified Davidson County outline)
            // The county is roughly blob-shaped, narrower at edges
            const countyShape = [
                [0, 1, 1, 1, 1],  // Row 0: north - skip far west
                [1, 1, 1, 1, 1],  // Row 1: full width
                [1, 1, 1, 1, 1],  // Row 2: full width (downtown area)
                [1, 1, 1, 1, 1],  // Row 3: full width
                [0, 1, 1, 1, 1]   // Row 4: south - skip far west corner
            ];

            let cells = '';
            for (let r = 0; r < 5; r++) {
                for (let c = 0; c < 5; c++) {
                    const isHighlighted = r === row && c === col;
                    const isInCounty = countyShape[r][c] === 1;

                    if (isInCounty) {
                        const cellClass = isHighlighted ? 'location-grid-cell highlighted' : 'location-grid-cell county-shape';
                        cells += `<rect x="${c * 6 + 1}" y="${r * 6 + 1}" width="5" height="5" class="${cellClass}" rx="0.5"/>`;
                    }
                }
            }

            return `<svg class="${sizeClass}" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                <title>District ${districtNum} location in Davidson County</title>
                ${cells}
            </svg>`;
        }

        // ============================================
        // DATA PERSISTENCE & CACHING SYSTEM
        // ============================================

        // Storage keys for UI state persistence
        const STORAGE_KEYS = {
            VIEW_MODE: 'eviction_view_mode',
            PIVOT_DIMENSION: 'eviction_pivot_dimension',
            NAME_FILTER: 'eviction_name_filter',
            DISTRICT_FILTER: 'eviction_district_filter',
            CHART_FILTER: 'eviction_chart_filter',
            SCROLL_POSITION: 'eviction_scroll_position',
            FILTER_GROUPS: 'eviction_active_filter_groups',
            LAST_SESSION: 'eviction_last_session'
        };

        // ============================================
        // URL-BASED FILTER SYSTEM
        // ============================================

        // Track if filters were loaded from URL (to show banner)
        let filtersLoadedFromUrl = false;

        // URL parameter keys for different filter types
        const URL_FILTER_KEYS = {
            DISTRICT: 'd',           // District filter: ?d=5
            CHART: 'c',              // Chart filter: ?c=2024-01 (year-month)
            NAME: 'n',               // Name filter: ?n=Smith
            FILTERS: 'f'             // Advanced filters: ?f=base64encoded
        };

        // Serialize current filter state to URL
        function serializeFiltersToUrl() {
            const params = new URLSearchParams();

            // District filter
            if (activeDistrictFilter !== null && activeDistrictFilter !== undefined) {
                params.set(URL_FILTER_KEYS.DISTRICT, activeDistrictFilter);
            }

            // Chart filter (year-month)
            if (chartFilter && chartFilter.year && chartFilter.month) {
                params.set(URL_FILTER_KEYS.CHART, `${chartFilter.year}-${String(chartFilter.month).padStart(2, '0')}`);
            }

            // Name filter
            const nameInput = document.getElementById('nameFilter');
            if (nameInput && nameInput.value && nameInput.value.trim()) {
                params.set(URL_FILTER_KEYS.NAME, nameInput.value.trim());
            }

            // Advanced filter groups - serialize to base64 for compactness
            if (filterGroups && filterGroups.length > 0) {
                const hasConditions = filterGroups.some(g =>
                    (g.conditions && g.conditions.length > 0 && g.conditions.some(c => c.value || c.operator === 'is_empty' || c.operator === 'is_not_empty')) ||
                    (g.nestedGroups && g.nestedGroups.length > 0)
                );
                if (hasConditions) {
                    try {
                        // Compact the filter groups for URL
                        const compactGroups = filterGroups.map(g => compactFilterGroup(g)).filter(Boolean);
                        if (compactGroups.length > 0) {
                            const encoded = btoa(JSON.stringify(compactGroups));
                            params.set(URL_FILTER_KEYS.FILTERS, encoded);
                        }
                    } catch (e) {
                        console.warn('Failed to serialize filters to URL:', e);
                    }
                }
            }

            return params;
        }

        // Compact a filter group for URL (remove empty conditions, shorten keys)
        function compactFilterGroup(group) {
            const validConditions = (group.conditions || []).filter(c =>
                c.value || c.operator === 'is_empty' || c.operator === 'is_not_empty'
            ).map(c => ({
                f: c.field,        // field
                o: c.operator,     // operator
                v: c.value,        // value
                v2: c.value2       // value2 (for between)
            })).filter(c => c.f && c.o);

            const nestedGroups = (group.nestedGroups || [])
                .map(ng => compactFilterGroup(ng))
                .filter(Boolean);

            if (validConditions.length === 0 && nestedGroups.length === 0) {
                return null;
            }

            return {
                l: group.logic,    // logic (AND/OR)
                c: validConditions,
                n: nestedGroups
            };
        }

        // Expand a compact filter group back to full form
        function expandFilterGroup(compact, parentId = null) {
            const groupId = ++filterGroupIdCounter;
            return {
                id: groupId,
                logic: compact.l || 'AND',
                conditions: (compact.c || []).map(c => ({
                    id: Date.now() + Math.random(),
                    field: c.f,
                    operator: c.o,
                    value: c.v || '',
                    value2: c.v2 || ''
                })),
                nestedGroups: (compact.n || []).map(ng => expandFilterGroup(ng, groupId)),
                parentId: parentId
            };
        }

        // Parse URL and extract filter state
        function parseFiltersFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const filters = {
                district: null,
                chart: null,
                name: null,
                advancedGroups: null,
                hasFilters: false
            };

            // District filter
            if (params.has(URL_FILTER_KEYS.DISTRICT)) {
                const d = params.get(URL_FILTER_KEYS.DISTRICT);
                filters.district = d === 'Unknown' ? 'Unknown' : (isNaN(parseInt(d)) ? d : parseInt(d));
                filters.hasFilters = true;
            }

            // Chart filter
            if (params.has(URL_FILTER_KEYS.CHART)) {
                const chartValue = params.get(URL_FILTER_KEYS.CHART);
                const match = chartValue.match(/^(\d{4})-(\d{2})$/);
                if (match) {
                    filters.chart = {
                        year: parseInt(match[1]),
                        month: parseInt(match[2])
                    };
                    filters.hasFilters = true;
                }
            }

            // Name filter
            if (params.has(URL_FILTER_KEYS.NAME)) {
                filters.name = params.get(URL_FILTER_KEYS.NAME);
                filters.hasFilters = true;
            }

            // Advanced filters
            if (params.has(URL_FILTER_KEYS.FILTERS)) {
                try {
                    const encoded = params.get(URL_FILTER_KEYS.FILTERS);
                    const compactGroups = JSON.parse(atob(encoded));
                    filterGroupIdCounter = 0; // Reset counter before expanding
                    filters.advancedGroups = compactGroups.map(cg => expandFilterGroup(cg));
                    filters.hasFilters = true;
                } catch (e) {
                    console.warn('Failed to parse URL filters:', e);
                }
            }

            return filters;
        }

        // Check if we're in an iframe/embedded context
        function isEmbedded() {
            try {
                return window.self !== window.top;
            } catch (e) {
                return true; // If we can't access window.top, we're likely in a cross-origin iframe
            }
        }

        // Update browser URL with current filter state (without page reload)
        function updateUrlWithFilters() {
            const params = serializeFiltersToUrl();
            const newUrl = params.toString()
                ? `${window.location.pathname}?${params.toString()}`
                : window.location.pathname;

            // Try to update URL - may fail in some embedded contexts
            try {
                window.history.replaceState({}, '', newUrl);
            } catch (e) {
                console.warn('Could not update URL (embedded mode):', e);
            }

            // Update the filter banner
            updateUrlFilterBanner();

            // If embedded, notify parent window of filter change
            if (isEmbedded()) {
                try {
                    window.parent.postMessage({
                        type: 'eviction-tracker-filters',
                        url: window.location.origin + newUrl,
                        filterCount: filteredData.length,
                        totalCount: allData.length
                    }, '*');
                } catch (e) {
                    // Ignore errors when posting to parent
                }
            }
        }

        // Clear all URL parameters
        function clearUrlFilters() {
            try {
                window.history.replaceState({}, '', window.location.pathname);
            } catch (e) {
                console.warn('Could not clear URL (embedded mode):', e);
            }
            filtersLoadedFromUrl = false;
            updateUrlFilterBanner();
        }

        // Update the URL filter banner visibility and content
        function updateUrlFilterBanner() {
            const banner = document.getElementById('urlFilterBanner');
            const countSpan = document.getElementById('urlFilterCount');
            if (!banner || !countSpan) return;

            // Check if any filters are active
            const hasDistrictFilter = activeDistrictFilter !== null && activeDistrictFilter !== undefined;
            const hasChartFilter = chartFilter && chartFilter.year && chartFilter.month;
            // Check both the input element and the nameFilter variable
            const nameInput = document.getElementById('nameFilter');
            const hasNameFilterInput = nameInput && nameInput.value && nameInput.value.trim();
            const hasNameFilterVar = nameFilter && nameFilter.name;
            const hasNameFilter = hasNameFilterInput || hasNameFilterVar;
            const hasAdvancedFilter = activeAdvancedFilter && activeAdvancedFilter.length > 0;

            const hasAnyFilter = hasDistrictFilter || hasChartFilter || hasNameFilter || hasAdvancedFilter;
            const isFiltered = hasAnyFilter && filteredData.length !== allData.length;

            if (isFiltered && allData.length > 0) {
                banner.classList.remove('hidden');
                countSpan.textContent = `${filteredData.length.toLocaleString()} of ${allData.length.toLocaleString()} records`;
            } else {
                banner.classList.add('hidden');
            }
        }

        // Copy the current filter URL to clipboard
        function copyFilterUrl() {
            const params = serializeFiltersToUrl();
            const url = params.toString()
                ? `${window.location.origin}${window.location.pathname}?${params.toString()}`
                : `${window.location.origin}${window.location.pathname}`;

            navigator.clipboard.writeText(url).then(() => {
                const btn = document.getElementById('copyUrlBtn');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '‚úì Copied!';
                    btn.classList.add('copy-success');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('copy-success');
                    }, 2000);
                }
            }).catch(err => {
                console.error('Failed to copy URL:', err);
                // Fallback: show the URL in an alert
                alert(`Copy this URL to share:\n${url}`);
            });
        }

        // Clear all filters and URL parameters
        function clearAllFiltersAndUrl() {
            // Clear district filter
            activeDistrictFilter = null;
            updateDistrictFilterIndicator();

            // Clear chart filter
            chartFilter = null;
            updateChartFilterIndicator();

            // Clear name filter
            const nameInput = document.getElementById('nameFilter');
            if (nameInput) nameInput.value = '';
            nameFilter = null;
            updateNameFilterIndicator();

            // Clear advanced filters
            filterGroups = [];
            filterGroupIdCounter = 0;
            activeAdvancedFilter = null;
            addFilterGroup(); // Add empty group
            updateFilterSummary();

            // Reset to all data
            filteredData = allData;

            // Update grid
            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }
            if (gridApi) {
                gridApi.setRowData(viewMode === 'pivot' ? pivotData : filteredData);
            }

            updateRecordCount();
            createDistrictMap();
            updateDemographicsCharts();
            updateDemoFilterIndicator();

            // Clear URL
            clearUrlFilters();

            // Clear localStorage filter state
            localStorage.removeItem(STORAGE_KEYS.NAME_FILTER);
            localStorage.removeItem(STORAGE_KEYS.CHART_FILTER);
            localStorage.removeItem(STORAGE_KEYS.DISTRICT_FILTER);
            localStorage.removeItem(STORAGE_KEYS.FILTER_GROUPS);

            updateStatus(`Filters cleared - showing all ${allData.length.toLocaleString()} records`, 'success');
        }

        // Apply filters from URL parameters (called after data loads)
        function applyFiltersFromUrl() {
            const urlFilters = parseFiltersFromUrl();

            if (!urlFilters.hasFilters) {
                return false;
            }

            console.log('Applying filters from URL:', urlFilters);
            filtersLoadedFromUrl = true;
            let filtersApplied = false;

            // Apply chart filter (mutually exclusive priority)
            if (urlFilters.chart) {
                chartFilter = urlFilters.chart;
                filteredData = allData.filter(record => {
                    const date = new Date(record.File_Date);
                    if (isNaN(date.getTime())) return false;
                    return date.getFullYear() === chartFilter.year &&
                           (date.getMonth() + 1) === chartFilter.month;
                });
                updateChartFilterIndicator();
                filtersApplied = true;
            }

            // Apply district filter
            if (!filtersApplied && urlFilters.district !== null) {
                activeDistrictFilter = urlFilters.district;
                if (activeDistrictFilter === 'Unknown' || activeDistrictFilter === 'unknown') {
                    filteredData = allData.filter(r => r.District === 'Unknown' || r.District === 'unknown');
                } else {
                    filteredData = allData.filter(r => r.District == activeDistrictFilter);
                }
                updateDistrictFilterIndicator();
                filtersApplied = true;
            }

            // Apply advanced filters
            if (!filtersApplied && urlFilters.advancedGroups && urlFilters.advancedGroups.length > 0) {
                filterGroups = urlFilters.advancedGroups;
                activeAdvancedFilter = JSON.parse(JSON.stringify(filterGroups));

                filteredData = allData.filter(record => {
                    return filterGroups.every(group =>
                        typeof evaluateGroup === 'function' ? evaluateGroup(record, group) : true
                    );
                });

                renderFilterGroups();
                updateFilterSummary();
                filtersApplied = true;
            }

            // Apply name filter (can combine with advanced filters)
            if (urlFilters.name) {
                const nameInput = document.getElementById('nameFilter');
                if (nameInput) {
                    nameInput.value = urlFilters.name;
                }
                // If no other filter applied yet, filter from allData
                const sourceData = filtersApplied ? filteredData : allData;
                const searchTerm = urlFilters.name.toLowerCase();
                filteredData = sourceData.filter(record => {
                    const plaintiff = (record.Plaintiff || '').toLowerCase();
                    const defendant = (record.Defendant || '').toLowerCase();
                    const attorney = (record.Attorney || '').toLowerCase();
                    return plaintiff.includes(searchTerm) ||
                           defendant.includes(searchTerm) ||
                           attorney.includes(searchTerm);
                });
                updateNameFilterIndicator();
                filtersApplied = true;
            }

            // Update grid and visuals
            if (filtersApplied && gridApi) {
                if (viewMode === 'pivot') {
                    pivotData = buildPivotData(pivotDimension);
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setRowData(filteredData);
                }
                updateRecordCount();
                createDistrictMap();
                updateDemographicsCharts();
                updateUrlFilterBanner();
                updateStatus(`URL filters applied - showing ${filteredData.length.toLocaleString()} records`, 'success');
            }

            return filtersApplied;
        }

        // In-memory cache for computed data with TTL
        const dataCache = {
            _cache: new Map(),
            _timestamps: new Map(),
            _defaultTTL: 5 * 60 * 1000, // 5 minutes default TTL

            set(key, data, ttl = this._defaultTTL) {
                this._cache.set(key, data);
                this._timestamps.set(key, { created: Date.now(), ttl });
                // Also persist to sessionStorage for tab persistence
                try {
                    sessionStorage.setItem(`cache_${key}`, JSON.stringify(data));
                    sessionStorage.setItem(`cache_${key}_ts`, JSON.stringify({ created: Date.now(), ttl }));
                } catch (e) {
                    console.warn('SessionStorage cache failed:', e);
                }
            },

            get(key) {
                // Check in-memory first
                const timestamp = this._timestamps.get(key);
                if (timestamp && (Date.now() - timestamp.created) < timestamp.ttl) {
                    return this._cache.get(key);
                }

                // Fallback to sessionStorage
                try {
                    const cached = sessionStorage.getItem(`cache_${key}`);
                    const cachedTs = sessionStorage.getItem(`cache_${key}_ts`);
                    if (cached && cachedTs) {
                        const ts = JSON.parse(cachedTs);
                        if ((Date.now() - ts.created) < ts.ttl) {
                            const data = JSON.parse(cached);
                            // Restore to in-memory cache
                            this._cache.set(key, data);
                            this._timestamps.set(key, ts);
                            return data;
                        }
                    }
                } catch (e) {
                    console.warn('SessionStorage read failed:', e);
                }

                return null;
            },

            invalidate(key) {
                this._cache.delete(key);
                this._timestamps.delete(key);
                try {
                    sessionStorage.removeItem(`cache_${key}`);
                    sessionStorage.removeItem(`cache_${key}_ts`);
                } catch (e) {}
            },

            invalidateAll() {
                this._cache.clear();
                this._timestamps.clear();
                // Clear all cache entries from sessionStorage
                try {
                    Object.keys(sessionStorage)
                        .filter(k => k.startsWith('cache_'))
                        .forEach(k => sessionStorage.removeItem(k));
                } catch (e) {}
            },

            has(key) {
                return this.get(key) !== null;
            }
        };

        // IndexedDB helper for large data storage (localStorage has ~5MB limit)
        // This stores FULL records (not compressed) for instant loading
        const evictionDB = {
            DB_NAME: 'evictionTrackerDB',
            DB_VERSION: 2,
            STORE_NAME: 'evictionData',

            async open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.STORE_NAME)) {
                            db.createObjectStore(this.STORE_NAME, { keyPath: 'id' });
                        }
                    };
                });
            },

            async save(data, timestamp) {
                try {
                    const db = await this.open();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(this.STORE_NAME, 'readwrite');
                        const store = tx.objectStore(this.STORE_NAME);
                        store.put({ id: 'evictionData', data, timestamp });
                        tx.oncomplete = () => {
                            db.close();
                            resolve(true);
                        };
                        tx.onerror = () => {
                            db.close();
                            reject(tx.error);
                        };
                    });
                } catch (e) {
                    console.error('IndexedDB save failed:', e);
                    return false;
                }
            },

            async load() {
                try {
                    const db = await this.open();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(this.STORE_NAME, 'readonly');
                        const store = tx.objectStore(this.STORE_NAME);
                        const request = store.get('evictionData');
                        request.onsuccess = () => {
                            db.close();
                            resolve(request.result || null);
                        };
                        request.onerror = () => {
                            db.close();
                            reject(request.error);
                        };
                    });
                } catch (e) {
                    console.error('IndexedDB load failed:', e);
                    return null;
                }
            },

            // Save full records (no compression) for fast loading
            async saveFull(records, timestamp) {
                try {
                    const db = await this.open();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(this.STORE_NAME, 'readwrite');
                        const store = tx.objectStore(this.STORE_NAME);
                        store.put({ id: 'fullEvictionData', data: records, timestamp });
                        tx.oncomplete = () => {
                            db.close();
                            console.log('üíæ Saved', records.length, 'full records to IndexedDB');
                            resolve(true);
                        };
                        tx.onerror = () => {
                            db.close();
                            reject(tx.error);
                        };
                    });
                } catch (e) {
                    console.error('IndexedDB saveFull failed:', e);
                    return false;
                }
            },

            // Load full records
            async loadFull() {
                try {
                    const db = await this.open();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(this.STORE_NAME, 'readonly');
                        const store = tx.objectStore(this.STORE_NAME);
                        const request = store.get('fullEvictionData');
                        request.onsuccess = () => {
                            db.close();
                            resolve(request.result || null);
                        };
                        request.onerror = () => {
                            db.close();
                            reject(request.error);
                        };
                    });
                } catch (e) {
                    console.error('IndexedDB loadFull failed:', e);
                    return null;
                }
            }
        };

        // Compress eviction data to essential fields for cross-page storage
        function compressEvictionData(records) {
            return records.map(r => ({
                // Essential fields for CM rankings and deduplication
                id: r.Case_Number || r.case_number || r.Docket_Number || '',
                d: r.District || null,  // District number
                fd: r.File_Date || r.file_date || '',  // File date
                p: r.Plaintiff_Petitioner || r.plaintiff_petitioner || r.Plaintiff || ''  // Plaintiff/Landlord
            }));
        }

        // Decompress eviction data back to expected format
        function decompressEvictionData(compressed) {
            if (!compressed || !Array.isArray(compressed)) {
                console.warn('‚ö†Ô∏è decompressEvictionData received invalid input:', typeof compressed);
                return [];
            }
            return compressed.map(r => ({
                Case_Number: r.id,
                District: r.d,
                File_Date: r.fd,
                Plaintiff_Petitioner: r.p
            }));
        }

        // UI state persistence functions
        function saveUIState() {
            try {
                localStorage.setItem(STORAGE_KEYS.VIEW_MODE, viewMode);
                localStorage.setItem(STORAGE_KEYS.PIVOT_DIMENSION, pivotDimension);
                localStorage.setItem(STORAGE_KEYS.LAST_SESSION, Date.now().toString());

                // Save name filter if active
                const nameInput = document.getElementById('nameFilter');
                if (nameInput && nameInput.value) {
                    localStorage.setItem(STORAGE_KEYS.NAME_FILTER, nameInput.value);
                } else {
                    localStorage.removeItem(STORAGE_KEYS.NAME_FILTER);
                }

                // Save chart filter
                if (chartFilter) {
                    localStorage.setItem(STORAGE_KEYS.CHART_FILTER, JSON.stringify(chartFilter));
                } else {
                    localStorage.removeItem(STORAGE_KEYS.CHART_FILTER);
                }

                // Save district filter
                if (activeDistrictFilter !== null) {
                    localStorage.setItem(STORAGE_KEYS.DISTRICT_FILTER, JSON.stringify(activeDistrictFilter));
                } else {
                    localStorage.removeItem(STORAGE_KEYS.DISTRICT_FILTER);
                }

                // Save active filter groups (advanced filters)
                if (filterGroups && filterGroups.length > 0 && filterGroups.some(g => g.conditions.length > 0 || g.nestedGroups.length > 0)) {
                    localStorage.setItem(STORAGE_KEYS.FILTER_GROUPS, JSON.stringify(filterGroups));
                } else {
                    localStorage.removeItem(STORAGE_KEYS.FILTER_GROUPS);
                }
            } catch (e) {
                console.warn('Failed to save UI state:', e);
            }
        }

        function loadUIState() {
            try {
                // Check if there's a recent session (within last 24 hours)
                const lastSession = localStorage.getItem(STORAGE_KEYS.LAST_SESSION);
                const sessionAge = lastSession ? Date.now() - parseInt(lastSession) : Infinity;
                const isRecentSession = sessionAge < 24 * 60 * 60 * 1000; // 24 hours

                if (!isRecentSession) {
                    // Clear stale state
                    clearUIState();
                    return null;
                }

                return {
                    viewMode: localStorage.getItem(STORAGE_KEYS.VIEW_MODE) || 'records',
                    pivotDimension: localStorage.getItem(STORAGE_KEYS.PIVOT_DIMENSION) || 'plaintiff',
                    nameFilter: localStorage.getItem(STORAGE_KEYS.NAME_FILTER) || '',
                    chartFilter: JSON.parse(localStorage.getItem(STORAGE_KEYS.CHART_FILTER) || 'null'),
                    districtFilter: JSON.parse(localStorage.getItem(STORAGE_KEYS.DISTRICT_FILTER) || 'null'),
                    filterGroups: JSON.parse(localStorage.getItem(STORAGE_KEYS.FILTER_GROUPS) || 'null')
                };
            } catch (e) {
                console.warn('Failed to load UI state:', e);
                return null;
            }
        }

        function clearUIState() {
            Object.values(STORAGE_KEYS).forEach(key => {
                try { localStorage.removeItem(key); } catch (e) {}
            });
        }

        // Save state periodically and on visibility change
        let uiStateSaveTimeout = null;
        function debouncedSaveUIState() {
            if (uiStateSaveTimeout) clearTimeout(uiStateSaveTimeout);
            uiStateSaveTimeout = setTimeout(saveUIState, 500);
        }

        // Save state when user leaves page
        window.addEventListener('beforeunload', saveUIState);
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                saveUIState();
            }
        });

        // Restore persisted filters after data loads
        function restorePersistedFilters() {
            // Priority: URL params > localStorage
            // Check if URL has filters first
            const urlFilters = parseFiltersFromUrl();
            if (urlFilters.hasFilters) {
                console.log('URL filters detected - applying from URL instead of localStorage');
                applyFiltersFromUrl();
                return;
            }

            const savedState = loadUIState();
            if (!savedState) return;

            let filtersApplied = false;

            // Restore chart filter
            if (savedState.chartFilter && savedState.chartFilter.year && savedState.chartFilter.month) {
                chartFilter = savedState.chartFilter;
                filteredData = allData.filter(record => {
                    const date = new Date(record.File_Date);
                    if (isNaN(date.getTime())) return false;
                    return date.getFullYear() === chartFilter.year &&
                           (date.getMonth() + 1) === chartFilter.month;
                });
                updateChartFilterIndicator();
                filtersApplied = true;
                console.log('Restored chart filter from previous session');
            }

            // Restore district filter (mutually exclusive with chart filter)
            if (!filtersApplied && savedState.districtFilter !== null && savedState.districtFilter !== undefined) {
                activeDistrictFilter = savedState.districtFilter;
                if (activeDistrictFilter === 'Unknown' || activeDistrictFilter === 'unknown') {
                    filteredData = allData.filter(r => r.District === 'Unknown' || r.District === 'unknown');
                } else {
                    filteredData = allData.filter(r => r.District == activeDistrictFilter);
                }
                updateDistrictFilterIndicator();
                filtersApplied = true;
                console.log('Restored district filter from previous session:', activeDistrictFilter);
            }

            // Restore advanced filter groups and apply
            if (savedState.filterGroups && Array.isArray(savedState.filterGroups) &&
                savedState.filterGroups.some(g => g.conditions?.length > 0 || g.nestedGroups?.length > 0)) {
                filterGroups = savedState.filterGroups;

                // Recalculate max ID to avoid collisions
                filterGroupIdCounter = 0;
                function findMaxId(groups) {
                    for (const group of groups) {
                        if (group.id > filterGroupIdCounter) filterGroupIdCounter = group.id;
                        findMaxId(group.nestedGroups || []);
                    }
                }
                findMaxId(filterGroups);

                // Render the filter groups UI
                if (typeof renderFilterGroups === 'function') {
                    renderFilterGroups();
                }

                // Apply the filters
                if (!filtersApplied) {
                    activeAdvancedFilter = JSON.parse(JSON.stringify(filterGroups));
                    filteredData = allData.filter(record => {
                        return filterGroups.every(group =>
                            typeof evaluateGroup === 'function' ? evaluateGroup(record, group) : true
                        );
                    });
                }
                filtersApplied = true;
                console.log('Restored advanced filters from previous session');
            }

            // Update the grid with filtered data
            if (filtersApplied && gridApi) {
                if (viewMode === 'pivot') {
                    pivotData = buildPivotData(pivotDimension);
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setRowData(filteredData);
                }
                updateRecordCount();
                createDistrictMap();
                // Sync URL with restored filters
                updateUrlWithFilters();
                updateStatus(`Session restored with ${filteredData.length} filtered records`, 'success');
            }
        }

        // Scramble a name for privacy (consistent scrambling per name)
        function scrambleName(name) {
            if (!name) return '';
            // Use a simple hash-based approach for consistent scrambling
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = ((hash << 5) - hash) + name.charCodeAt(i);
                hash = hash & hash;
            }
            // Generate scrambled name parts
            const firstNames = ['J.', 'M.', 'R.', 'S.', 'A.', 'D.', 'K.', 'T.', 'L.', 'C.'];
            const lastParts = ['***', '****', '*****', '******'];
            const firstIdx = Math.abs(hash) % firstNames.length;
            const lastIdx = Math.abs(hash >> 4) % lastParts.length;
            return `${firstNames[firstIdx]} ${lastParts[lastIdx]}`;
        }

        // Get display name for defendant (scrambled unless logged in)
        function getDefendantDisplayName(name) {
            if (isLoggedIn) return name;
            return scrambleName(name);
        }

        // Login functions
        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('loginPassword').focus();
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
        }

        async function attemptLogin() {
            const password = document.getElementById('loginPassword').value;
            const inputHash = await hashPassword(password);
            if (inputHash === LOGIN_PASSWORD_HASH) {
                isLoggedIn = true;
                // Decrypt the POST endpoint on successful login
                decryptedPostEndpoint = await decryptEndpoint(ENCRYPTED_POST_ENDPOINT, password);
                // Also set it in EOMigration module if available
                if (typeof EOMigration !== 'undefined' && decryptedPostEndpoint) {
                    EOMigration.setPostEndpoint(decryptedPostEndpoint);
                }
                hideLoginModal();
                updateLoginButton();
                updateBulkSearchState();
                // Refresh grid to show real names
                if (gridApi) {
                    gridApi.refreshCells({ force: true });
                }
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            isLoggedIn = false;
            // Clear decrypted endpoint on logout
            decryptedPostEndpoint = null;
            // Also clear in EOMigration module if available
            if (typeof EOMigration !== 'undefined') {
                EOMigration.setPostEndpoint(null);
            }
            updateLoginButton();
            updateBulkSearchState();
            // Refresh grid to scramble names again
            if (gridApi) {
                gridApi.refreshCells({ force: true });
            }
        }

        function updateLoginButton() {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            if (isLoggedIn) {
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        // Update bulk search state based on login
        function updateBulkSearchState() {
            const locked = document.getElementById('bulkSearchLocked');
            const content = document.getElementById('bulkSearchContent');
            if (isLoggedIn) {
                locked.classList.add('hidden');
                content.classList.remove('hidden');
            } else {
                locked.classList.remove('hidden');
                content.classList.add('hidden');
            }
        }

        const pivotFieldMap = {
            plaintiff: 'Plaintiff',
            defendant: 'Defendant',
            attorney: 'Attorney',
            defenseAttorney: 'Defense_Attorney',
            district: 'District',
            fileMonth: 'File_Date_Month'
        };

        const pivotDimensionLabels = {
            plaintiff: 'Landlord',
            defendant: 'Tenant',
            attorney: 'Landlord Attorney',
            defenseAttorney: 'Defense Attorney',
            district: 'Council District',
            fileMonth: 'Date'
        };

        // Track active name filter
        let nameFilter = null;

        const recordColumnDefs = [
            { field: 'File_Date', headerName: 'File Date', width: 110,
              valueFormatter: params => new Date(params.value).toLocaleDateString(),
              comparator: (valueA, valueB) => {
                  const dateA = valueA ? new Date(valueA).getTime() : 0;
                  const dateB = valueB ? new Date(valueB).getTime() : 0;
                  return dateA - dateB;
              },
              sort: 'desc', sortIndex: 0 },
            { field: 'Case_Number', headerName: 'Docket #', width: 120 },
            { field: 'Plaintiff', headerName: 'Plaintiff/Landlord', width: 250,
              cellRenderer: params => {
                  if (!params.value) return '';
                  const escapedValue = String(params.value).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                  return `<span class="text-indigo-600 hover:text-indigo-800 hover:underline cursor-pointer" onclick="event.stopPropagation(); filterByName('${escapedValue}', 'plaintiff');">${params.value}</span>`;
              }
            },
            { field: 'Defendant', headerName: 'Defendant/Tenant', width: 250,
              cellRenderer: params => {
                  if (!params.value) return '';
                  const displayName = getDefendantDisplayName(params.value);
                  if (!isLoggedIn) {
                      return `<span class="text-gray-500 cursor-default" title="Login to view tenant name">${displayName}</span>`;
                  }
                  return `<span class="text-indigo-600 hover:text-indigo-800 hover:underline cursor-pointer">${displayName}</span>`;
              },
              onCellClicked: params => {
                  if (params.value && params.event && isLoggedIn) {
                      params.event.stopPropagation();
                      filterByName(params.value, 'defendant');
                  }
              }
            },
            { field: 'Attorney', headerName: 'Landlord Attorney', width: 200,
              cellRenderer: params => {
                  if (!params.value) return '<span class="text-gray-400">‚Äî</span>';
                  const escapedValue = String(params.value).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                  return `<span class="text-indigo-600 hover:text-indigo-800 hover:underline cursor-pointer" onclick="event.stopPropagation(); filterByName('${escapedValue}', 'attorney');">${params.value}</span>`;
              }
            },
            { field: 'Defense_Attorney', headerName: 'Defense Attorney', width: 200,
              cellRenderer: params => {
                  if (!params.value) return '<span class="text-gray-400">‚Äî</span>';
                  const escapedValue = String(params.value).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                  return `<span class="text-indigo-600 hover:text-indigo-800 hover:underline cursor-pointer" onclick="event.stopPropagation(); filterByName('${escapedValue}', 'defenseAttorney');">${params.value}</span>`;
              }
            },
            { field: 'Address', headerName: 'Address', width: 250,
              cellRenderer: params => {
                  if (!params.value) return '<span class="text-gray-400">‚Äî</span>';
                  return `<span>${params.value}</span>`;
              }
            },
            { field: 'District', headerName: 'Council District', width: 140,
              cellRenderer: params => {
                  if (!params.value || params.value === 'Unknown') return '<span class="text-gray-400">‚Äî</span>';
                  return `<span class="text-indigo-600 hover:text-indigo-800 hover:underline cursor-pointer" onclick="event.stopPropagation(); filterByDistrict('${params.value}');">District ${params.value}</span>`;
              },
              comparator: (valueA, valueB) => {
                  const numA = valueA && valueA !== 'Unknown' ? parseInt(valueA, 10) : Infinity;
                  const numB = valueB && valueB !== 'Unknown' ? parseInt(valueB, 10) : Infinity;
                  return numA - numB;
              }
            },
            // Backfill data columns
            { field: 'Status', headerName: 'Status', width: 100,
              cellRenderer: params => {
                  if (!params.value) return '<span class="text-gray-400">‚Äî</span>';
                  const statusColors = {
                      'PENDING': 'bg-yellow-100 text-yellow-800',
                      'CLOSED': 'bg-gray-100 text-gray-800',
                      'DISMISSED': 'bg-green-100 text-green-800',
                      'JUDGMENT': 'bg-red-100 text-red-800'
                  };
                  const colorClass = statusColors[params.value.toUpperCase()] || 'bg-blue-100 text-blue-800';
                  return `<span class="px-2 py-0.5 rounded text-xs font-medium ${colorClass}">${params.value}</span>`;
              }
            },
            { field: 'pleadings', headerName: 'Pleadings', width: 100,
              cellRenderer: params => {
                  if (!params.value || !Array.isArray(params.value) || params.value.length === 0) {
                      return '<span class="text-gray-400">‚Äî</span>';
                  }
                  const count = params.value.length;
                  const latest = params.value[params.value.length - 1];
                  const tooltip = params.value.map(p => `${p.date || ''}: ${p.description || p.code || ''}`).join('&#10;');
                  return `<span class="text-indigo-600 cursor-help" title="${tooltip}">${count} filing${count > 1 ? 's' : ''}</span>`;
              }
            },
            { field: 'judgments', headerName: 'Judgments', width: 100,
              cellRenderer: params => {
                  if (!params.value || !Array.isArray(params.value) || params.value.length === 0) {
                      return '<span class="text-gray-400">‚Äî</span>';
                  }
                  const count = params.value.length;
                  const tooltip = params.value.map(j => `${j.date || ''}: ${j.type || ''} ${j.for || ''}`).join('&#10;');
                  return `<span class="text-red-600 cursor-help" title="${tooltip}">${count}</span>`;
              }
            },
            { field: 'service_date', headerName: 'Service Date', width: 110,
              valueFormatter: params => params.value ? new Date(params.value).toLocaleDateString() : '',
              cellRenderer: params => {
                  if (!params.value) return '<span class="text-gray-400">‚Äî</span>';
                  return new Date(params.value).toLocaleDateString();
              }
            },
            { field: 'paper_writ_date', headerName: 'Paper Writ Date', width: 120,
              valueFormatter: params => params.value ? new Date(params.value).toLocaleDateString() : '',
              cellRenderer: params => {
                  if (!params.value) return '<span class="text-gray-400">‚Äî</span>';
                  return `<span class="text-red-600 font-medium">${new Date(params.value).toLocaleDateString()}</span>`;
              },
              comparator: (valueA, valueB) => {
                  const dateA = valueA ? new Date(valueA).getTime() : 0;
                  const dateB = valueB ? new Date(valueB).getTime() : 0;
                  return dateA - dateB;
              }
            },
            { field: 'judgment_date', headerName: 'Judgment Date', width: 120,
              valueFormatter: params => params.value ? new Date(params.value).toLocaleDateString() : '',
              cellRenderer: params => {
                  if (!params.value) return '<span class="text-gray-400">‚Äî</span>';
                  return new Date(params.value).toLocaleDateString();
              }
            },
            { field: 'judgment_for', headerName: 'Judgment For', width: 110,
              cellRenderer: params => {
                  if (!params.value) return '<span class="text-gray-400">‚Äî</span>';
                  const colorClass = params.value.toLowerCase().includes('plaintiff') ? 'text-red-600' : 'text-green-600';
                  return `<span class="${colorClass}">${params.value}</span>`;
              }
            },
            { field: 'case_dismissed', headerName: 'Dismissed', width: 90,
              cellRenderer: params => {
                  if (params.value === true) return '<span class="text-green-600 font-medium">Yes</span>';
                  if (params.value === false) return '<span class="text-gray-400">No</span>';
                  return '<span class="text-gray-400">‚Äî</span>';
              }
            },
            { field: 'eviction_probability', headerName: 'Eviction Prob.', width: 120,
              cellRenderer: params => {
                  if (params.value === null || params.value === undefined) {
                      return '<span class="text-gray-400">‚Äî</span>';
                  }
                  const pct = (params.value * 100).toFixed(0);
                  const tier = params.data?.eviction_outcome_tier || '';
                  const description = params.data?.eviction_tier_description || '';
                  // Color based on probability
                  let colorClass = 'text-gray-600';
                  if (params.value >= 0.85) colorClass = 'text-red-700 font-bold';
                  else if (params.value >= 0.65) colorClass = 'text-red-600 font-semibold';
                  else if (params.value >= 0.45) colorClass = 'text-orange-600';
                  else if (params.value >= 0.25) colorClass = 'text-yellow-600';
                  else if (params.value < 0.15) colorClass = 'text-green-600';
                  // Add indicator for averaged values
                  const avgIndicator = tier === 'AVG' ? ' *' : '';
                  return `<span class="${colorClass} cursor-help" title="${description}">${pct}%${avgIndicator}</span>`;
              },
              comparator: (valueA, valueB) => {
                  const a = valueA === null || valueA === undefined ? -1 : valueA;
                  const b = valueB === null || valueB === undefined ? -1 : valueB;
                  return a - b;
              }
            },
            { field: 'eviction_outcome_tier', headerName: 'Outcome Tier', width: 180,
              cellRenderer: params => {
                  if (!params.value || params.value === 'UNKNOWN') {
                      return '<span class="text-gray-400">‚Äî</span>';
                  }
                  const description = params.data?.eviction_tier_description || params.value;
                  // Color based on tier
                  const tierColors = {
                      'TIER_1': 'bg-red-100 text-red-800',
                      'TIER_2': 'bg-red-50 text-red-700',
                      'TIER_3': 'bg-orange-100 text-orange-800',
                      'TIER_4': 'bg-orange-50 text-orange-700',
                      'TIER_5A': 'bg-yellow-100 text-yellow-800',
                      'TIER_5B': 'bg-yellow-50 text-yellow-700',
                      'TIER_5C': 'bg-gray-100 text-gray-700',
                      'TIER_6': 'bg-green-100 text-green-800',
                      'AVG': 'bg-blue-50 text-blue-700'
                  };
                  const colorClass = tierColors[params.value] || 'bg-gray-100 text-gray-600';
                  return `<span class="px-2 py-0.5 rounded text-xs font-medium ${colorClass}" title="${description}">${description}</span>`;
              }
            },
            // eviction_executed, eviction_date, eviction_method removed - these were derived/interpreted fields
            // Raw data is in pleadings[] and writ_issued_date/writ_served_date
            { field: 'judge', headerName: 'Judge', width: 150,
              cellRenderer: params => {
                  if (!params.value) return '<span class="text-gray-400">‚Äî</span>';
                  return params.value;
              }
            }
        ];

        // Generate dynamic column definitions for any new case_data keys
        // Converts snake_case or camelCase to Title Case for display
        function formatDynamicColumnHeader(key) {
            return key
                .replace(/_/g, ' ')
                .replace(/([a-z])([A-Z])/g, '$1 $2')
                .replace(/\b\w/g, c => c.toUpperCase());
        }

        // Get dynamic column definitions based on discovered case_data keys
        function getDynamicColumnDefs() {
            const dynamicCols = [];
            // Sort keys alphabetically for consistent column order
            const sortedKeys = Array.from(dynamicCaseDataKeys).sort();

            for (const key of sortedKeys) {
                dynamicCols.push({
                    field: key,
                    headerName: formatDynamicColumnHeader(key),
                    width: 150,
                    cellRenderer: params => {
                        if (params.value === null || params.value === undefined || params.value === '') {
                            return '<span class="text-gray-400">‚Äî</span>';
                        }
                        // Handle boolean values
                        if (typeof params.value === 'boolean') {
                            return params.value ? 'Yes' : 'No';
                        }
                        // Handle objects/arrays - display as JSON
                        if (typeof params.value === 'object') {
                            return `<span title="${JSON.stringify(params.value).replace(/"/g, '&quot;')}">[Object]</span>`;
                        }
                        return String(params.value);
                    }
                });
            }
            return dynamicCols;
        }

        // Get full column definitions (base + dynamic)
        function getFullRecordColumnDefs() {
            return [...recordColumnDefs, ...getDynamicColumnDefs()];
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', async function() {
            // Restore saved UI state first
            const savedState = loadUIState();
            if (savedState) {
                viewMode = savedState.viewMode || 'records';
                pivotDimension = savedState.pivotDimension || 'plaintiff';
                chartFilter = savedState.chartFilter;

                // Restore filter groups if saved
                if (savedState.filterGroups && Array.isArray(savedState.filterGroups)) {
                    filterGroups = savedState.filterGroups;
                }

                console.log('Restored UI state from previous session');
            }

            initCharts();  // Initialize charts before loading data
            await loadData();
            updatePivotControls();
            initializeFilterBuilder();  // Initialize filter builder since it's always visible

            // Start auto-refresh polling (every 5 minutes)
            startPolling();

            // Pause polling when tab is hidden, resume when visible
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('üëÅÔ∏è Tab hidden - pausing poll timer');
                } else {
                    console.log('üëÅÔ∏è Tab visible - resuming poll timer');
                    // If enough time has passed while hidden, refresh now
                    if (lastPollTime && (Date.now() - lastPollTime) >= POLL_INTERVAL_MS) {
                        console.log('‚è∞ Catching up on missed refresh');
                        manualRefresh();
                    }
                }
            });

            // Restore name filter after a short delay to ensure elements exist
            if (savedState && savedState.nameFilter) {
                setTimeout(() => {
                    const nameInput = document.getElementById('nameFilter');
                    if (nameInput) {
                        nameInput.value = savedState.nameFilter;
                    }
                }, 100);
            }
        });

        function cleanAttorney(attorney) {
            if (!attorney) return '';

            const proSeTokens = new Set([
                'PRO SE',
                'PRO-SE',
                'PROSE',
                'PRO SE LITIGANT',
                'PRS'
            ]);

            const segments = String(attorney)
                .replace(/\s+/g, ' ')
                .replace(/\s*,\s*/g, ', ')
                .trim()
                .split(',')
                .map(segment => segment.replace(/\s+/g, ' ').trim())
                .filter(Boolean);

            const normalizedSegments = [];
            const seen = new Set();

            for (const segment of segments) {
                const cleanedSegment = segment
                    .replace(/^[^A-Za-z0-9'&.-]+/, '')
                    .replace(/[^A-Za-z0-9'&.-]+$/, '')
                    .trim();

                if (!cleanedSegment) continue;

                const comparisonValue = cleanedSegment.replace(/\./g, '').toUpperCase();
                if (proSeTokens.has(comparisonValue)) {
                    continue;
                }

                if (seen.has(comparisonValue)) continue;
                seen.add(comparisonValue);
                normalizedSegments.push(cleanedSegment);
            }

            if (normalizedSegments.length === 0) {
                return 'Pro Se';
            }

            return normalizedSegments.join(', ');
        }

        // Calculate the date range of the eviction data and annualization factor
        function calculateGlobalDataRange(data) {
            if (!data || data.length === 0) {
                globalDataRange = { earliest: null, latest: null, days: 0, annualizationFactor: 1 };
                return;
            }

            let earliest = null;
            let latest = null;

            for (const record of data) {
                if (record.File_Date) {
                    const date = new Date(record.File_Date);
                    if (!isNaN(date.getTime())) {
                        if (earliest === null || date < earliest) earliest = date;
                        if (latest === null || date > latest) latest = date;
                    }
                }
            }

            if (earliest && latest) {
                const days = Math.ceil((latest - earliest) / (1000 * 60 * 60 * 24));
                // Annualization factor: how much to multiply to get full year estimate
                const annualizationFactor = days > 0 ? 365 / days : 1;

                globalDataRange = {
                    earliest,
                    latest,
                    days,
                    annualizationFactor
                };

                console.log(`Data spans ${days} days (${earliest.toLocaleDateString()} to ${latest.toLocaleDateString()}). Annualization factor: ${annualizationFactor.toFixed(2)}x`);
            } else {
                globalDataRange = { earliest: null, latest: null, days: 0, annualizationFactor: 1 };
            }
        }

        function parseDate(dateValue) {
            if (!dateValue) return null;

            // If already a Date object
            if (dateValue instanceof Date) {
                return isNaN(dateValue.getTime()) ? null : dateValue.toISOString().split('T')[0];
            }

            const dateStr = String(dateValue).trim();
            if (!dateStr) return null;

            // Try parsing as ISO format first (YYYY-MM-DD)
            if (/^\d{4}-\d{2}-\d{2}/.test(dateStr)) {
                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? null : dateStr.split('T')[0];
            }

            // Handle MM/DD/YYYY or M/D/YYYY format
            const slashMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (slashMatch) {
                const [, month, day, year] = slashMatch;
                const isoDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                const date = new Date(isoDate);
                return isNaN(date.getTime()) ? null : isoDate;
            }

            // Handle MM-DD-YYYY format
            const dashMatch = dateStr.match(/^(\d{1,2})-(\d{1,2})-(\d{4})/);
            if (dashMatch) {
                const [, month, day, year] = dashMatch;
                const isoDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                const date = new Date(isoDate);
                return isNaN(date.getTime()) ? null : isoDate;
            }

            // Fallback: try native parsing
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date.toISOString().split('T')[0];
        }

        // Cache staleness threshold: 24 hours in milliseconds
        const CACHE_MAX_AGE_MS = 24 * 60 * 60 * 1000;

        // Polling configuration
        const POLL_INTERVAL_MS = 5 * 60 * 1000; // 5 minutes
        let pollIntervalId = null;
        let lastPollTime = null;
        let isPollingEnabled = true;
        let isLoadingData = false;

        // Smart query: track the most recent logged_at timestamp for incremental fetches
        function getLastLoggedAt() {
            return localStorage.getItem('evictionLastLoggedAt');
        }

        function setLastLoggedAt(timestamp) {
            if (timestamp) {
                localStorage.setItem('evictionLastLoggedAt', timestamp);
            }
        }

        // Get countdown until next poll in seconds
        function getNextPollCountdown() {
            if (!lastPollTime || !isPollingEnabled) return null;
            const elapsed = Date.now() - lastPollTime;
            const remaining = Math.max(0, POLL_INTERVAL_MS - elapsed);
            return Math.ceil(remaining / 1000);
        }

        // Format seconds to mm:ss
        function formatCountdown(seconds) {
            if (seconds === null) return '--:--';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Update the refresh button and status indicators
        function updateRefreshUI() {
            const refreshBtn = document.getElementById('refreshBtn');
            const countdownEl = document.getElementById('pollCountdown');
            const statusDot = document.getElementById('pollStatusDot');

            if (refreshBtn) {
                if (isLoadingData) {
                    refreshBtn.disabled = true;
                    refreshBtn.innerHTML = '<span class="animate-spin inline-block">‚Üª</span> Loading...';
                } else {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = 'üîÑ Refresh';
                }
            }

            if (countdownEl) {
                const countdown = getNextPollCountdown();
                countdownEl.textContent = countdown !== null ? `Next sync: ${formatCountdown(countdown)}` : '';
            }

            if (statusDot) {
                statusDot.className = isPollingEnabled ? 'poll-status-dot active' : 'poll-status-dot paused';
                statusDot.title = isPollingEnabled ? 'Auto-refresh active' : 'Auto-refresh paused';
            }
        }

        // Start polling for new data
        function startPolling() {
            if (pollIntervalId) return; // Already polling

            isPollingEnabled = true;
            lastPollTime = Date.now();

            pollIntervalId = setInterval(async () => {
                if (!isPollingEnabled || isLoadingData) return;

                console.log('‚è∞ Auto-refresh triggered');
                await loadDataIncremental();
                lastPollTime = Date.now();
            }, POLL_INTERVAL_MS);

            // Start countdown timer update
            setInterval(updateRefreshUI, 1000);

            console.log(`‚úÖ Polling started (every ${POLL_INTERVAL_MS / 1000 / 60} minutes)`);
            updateRefreshUI();
        }

        // Stop polling
        function stopPolling() {
            if (pollIntervalId) {
                clearInterval(pollIntervalId);
                pollIntervalId = null;
            }
            isPollingEnabled = false;
            updateRefreshUI();
            console.log('‚èπÔ∏è Polling stopped');
        }

        // Toggle polling on/off
        function togglePolling() {
            if (isPollingEnabled) {
                stopPolling();
            } else {
                startPolling();
            }
        }

        // Manual refresh - resets the poll timer
        async function manualRefresh() {
            if (isLoadingData) return;

            console.log('üîÑ Manual refresh triggered');
            lastPollTime = Date.now(); // Reset poll timer
            await loadDataIncremental();
        }

        // Helper to check if cache is fresh (less than 24 hours old)
        function isCacheFresh() {
            const storedTimestamp = localStorage.getItem('evictionDataTimestamp');
            if (!storedTimestamp) return false;
            const cacheAge = Date.now() - parseInt(storedTimestamp);
            return cacheAge < CACHE_MAX_AGE_MS;
        }

        // Helper to get cache age in hours
        function getCacheAgeHours() {
            const storedTimestamp = localStorage.getItem('evictionDataTimestamp');
            if (!storedTimestamp) return null;
            return Math.round((Date.now() - parseInt(storedTimestamp)) / (1000 * 60 * 60));
        }

        // Helper to load cached data from IndexedDB (full records) or localStorage (compressed)
        async function loadCachedData() {
            let cachedData = null;

            // Try IndexedDB full records first (best option - all fields preserved)
            try {
                const idbResult = await evictionDB.loadFull();
                // Handle both new format { data: [...] } and legacy format (direct array)
                if (idbResult) {
                    if (Array.isArray(idbResult.data) && idbResult.data.length > 0) {
                        cachedData = idbResult.data;
                        console.log('üì¶ Loaded', cachedData.length, 'full records from IndexedDB');
                        return cachedData;
                    } else if (Array.isArray(idbResult) && idbResult.length > 0) {
                        // Legacy format: data stored directly as array
                        cachedData = idbResult;
                        console.log('üì¶ Loaded', cachedData.length, 'full records from IndexedDB (legacy format)');
                        return cachedData;
                    }
                }
            } catch (e) {
                console.warn('IndexedDB full load failed:', e);
            }

            // Fallback: Try compressed localStorage
            const compressedData = localStorage.getItem('evictionDataCompressed');
            if (compressedData) {
                try {
                    const parsed = JSON.parse(compressedData);
                    cachedData = decompressEvictionData(parsed);
                    if (cachedData && cachedData.length > 0) {
                        console.log('üì¶ Loaded compressed data from localStorage');
                        return cachedData;
                    }
                } catch (e) {
                    console.warn('Failed to parse compressed localStorage data:', e);
                }
            }

            // Fallback: Try legacy uncompressed localStorage
            const legacyData = localStorage.getItem('evictionData');
            if (legacyData) {
                try {
                    cachedData = JSON.parse(legacyData);
                    if (Array.isArray(cachedData) && cachedData.length > 0) {
                        console.log('üì¶ Loaded legacy data from localStorage');
                        return cachedData;
                    }
                } catch (e) {
                    console.warn('Failed to parse legacy localStorage data:', e);
                }
            }

            // Fallback: Try old IndexedDB compressed format
            const storageType = localStorage.getItem('evictionDataStorage');
            if (storageType === 'indexedDB') {
                try {
                    const idbResult = await evictionDB.load();
                    if (idbResult) {
                        // Handle both formats
                        const dataToDecompress = Array.isArray(idbResult.data) ? idbResult.data :
                                                  Array.isArray(idbResult) ? idbResult : null;
                        if (dataToDecompress) {
                            cachedData = decompressEvictionData(dataToDecompress);
                            if (cachedData && cachedData.length > 0) {
                                console.log('üì¶ Loaded compressed data from IndexedDB');
                                return cachedData;
                            }
                        }
                    }
                } catch (e) {
                    console.warn('IndexedDB compressed load failed:', e);
                }
            }

            return null;
        }

        // API query builder for EO eviction_operations endpoint with pagination and filtering
        // Uses event sourcing - fetches events and reconstructs state
        function buildEOApiUrl(options = {}) {
            const API_BASE = 'https://xvkq-pq7i-idtl.n7d.xano.io/api:3CsVHkZK/eviction_operations';
            const params = new URLSearchParams();

            // Pagination parameters
            if (options.page !== undefined && options.page !== null) {
                params.append('page', options.page);
            }
            if (options.per_page !== undefined && options.per_page !== null) {
                params.append('per_page', options.per_page);
            }

            // Filter by entity (docket number)
            if (options.entity_id) {
                params.append('entity_id', options.entity_id);
            }

            // Filter by operator type
            if (options.op) {
                params.append('op', options.op);
            }

            // Filter by timestamp (for incremental sync)
            if (options.ts_gt) {
                params.append('ts_gt', options.ts_gt);
            }
            if (options.ts_gte) {
                params.append('ts_gte', options.ts_gte);
            }

            // Filter by source table
            if (options.source_table) {
                params.append('source_table', options.source_table);
            }

            const queryString = params.toString();
            return queryString ? `${API_BASE}?${queryString}` : API_BASE;
        }

        // State for server-side pagination/filtering
        let serverPaginationState = {
            page: 1,
            per_page: 100,  // Fetch more records per page for client-side filtering
            total: 0,
            has_more: false,
            filters: {}
        };

        // Helper function to apply new events incrementally to existing state
        function applyEventsToState(existingRecords, newEvents) {
            // Create a map of existing records by entity ID for fast lookup
            const stateMap = new Map();
            for (const record of existingRecords) {
                const entityId = record.Docket_Number || record._entity_id;
                if (entityId) {
                    stateMap.set(entityId, { ...record });
                }
            }

            // Sort new events by timestamp to apply in order
            const sortedEvents = [...newEvents].sort((a, b) => a.ts - b.ts);

            // Apply each event
            for (const event of sortedEvents) {
                const entityId = event.target?.id;
                if (!entityId) continue;

                const op = event.op;
                let state = stateMap.get(entityId);

                switch (op) {
                    case 'INS':
                        // New entity - create from event data
                        state = { ...event.context?.data };
                        state._entity_id = entityId;
                        state._last_updated = event.ts;
                        state._event_count = 1;
                        stateMap.set(entityId, state);
                        break;

                    case 'ALT':
                        // ALT with context.data = upsert (create if not exists, update if exists)
                        if (event.context?.data) {
                            if (state) {
                                // Merge new data into existing state
                                Object.assign(state, event.context.data);
                            } else {
                                // Create new entity from ALT data
                                state = { ...event.context.data };
                                state.Docket_Number = entityId;
                            }
                            state._entity_id = entityId;
                            state._last_updated = event.ts;
                            state._event_count = (state._event_count || 0) + 1;
                            stateMap.set(entityId, state);
                        } else if (state) {
                            // ALT with changes or single field update (only if state exists)
                            if (event.context?.changes) {
                                for (const [field, change] of Object.entries(event.context.changes)) {
                                    state[field] = change.new;
                                }
                            } else if (event.target?.field && event.context?.new !== undefined) {
                                state[event.target.field] = event.context.new;
                            }
                            state._last_updated = event.ts;
                            state._event_count = (state._event_count || 0) + 1;
                        }
                        break;

                    case 'NUL':
                        // Delete - remove from state
                        stateMap.delete(entityId);
                        break;

                    case 'SYN':
                        // Merge - mark absorbed entities
                        if (event.context?.merged && state) {
                            state._merged_into = event.target.id;
                        }
                        break;
                }
            }

            // Convert back to array
            return Array.from(stateMap.values());
        }

        async function loadData() {
            isLoadingData = true;
            updateRefreshUI();

            try {
                console.group('üîÑ Data Loading (EO Event Sourcing)');
                console.log('Timestamp:', new Date().toISOString());

                // Check cache status
                const cacheAgeHours = getCacheAgeHours();
                const cacheFresh = isCacheFresh();
                console.log('üìä Cache status:', { ageHours: cacheAgeHours, fresh: cacheFresh });

                // Always try to load cached data first
                updateStatus('Loading cached data...', 'loading');
                const cachedData = await loadCachedData();
                const lastSyncTs = localStorage.getItem('eo_last_sync_ts');

                // If we have cached data and a last sync timestamp, do incremental sync
                if (cachedData && cachedData.length > 0 && lastSyncTs) {
                    console.log('üì¶ Found cached data:', cachedData.length, 'records');
                    console.log('üìå Last sync timestamp:', lastSyncTs, '(' + new Date(parseInt(lastSyncTs)).toISOString() + ')');

                    // Fetch only new events since last sync
                    const incrementalUrl = buildEOApiUrl({ ts_gt: lastSyncTs });
                    console.log('üîÑ Incremental sync URL:', incrementalUrl);
                    updateStatus('Fetching new events since last sync...', 'loading');

                    try {
                        const response = await fetch(incrementalUrl);
                        if (response.ok) {
                            const result = await response.json();
                            let newEvents = Array.isArray(result) ? result : (result?.items || result?.data || []);

                            // Parse events from Xano format
                            if (newEvents.length > 0 && typeof EOMigration !== 'undefined') {
                                newEvents = newEvents.map(e => EOMigration.fromXanoFormat(e));
                            }

                            console.log('üì• Fetched', newEvents.length, 'new events');

                            if (newEvents.length === 0) {
                                // No new events - use cached data as-is
                                allData = cachedData;
                                filteredData = allData;
                                calculateGlobalDataRange(allData);

                                const storedTimestamp = localStorage.getItem('evictionDataTimestamp');
                                console.log('‚úÖ Cache is current, no new events');
                                console.groupEnd();

                                updateStatus(`Loaded ${allData.length} records (already up to date)`, 'success');
                                updateMetrics();
                                updateCharts();
                                createDistrictMap();
                                await loadDistrictDemographics();
                                initDemographicsCharts();
                                initGrid();
                                document.getElementById('lastUpdate').textContent = storedTimestamp
                                    ? new Date(parseInt(storedTimestamp)).toLocaleString()
                                    : 'Cached data';
                                restorePersistedFilters();
                                return;
                            }

                            // Apply new events to cached state (incremental replay)
                            console.log('üîÑ Applying', newEvents.length, 'new events to cached state...');
                            const updatedRecords = applyEventsToState(cachedData, newEvents);

                            // Track newest timestamp for next sync
                            let newestTs = parseInt(lastSyncTs);
                            for (const event of newEvents) {
                                if (event.ts && event.ts > newestTs) {
                                    newestTs = event.ts;
                                }
                            }
                            localStorage.setItem('eo_last_sync_ts', newestTs.toString());
                            console.log('üìå Updated sync timestamp:', newestTs);

                            // Normalize and dedupe
                            const normalizedData = updatedRecords.map(normalizeRecord);
                            allData = dedupeByDocketNumber(normalizedData);
                            allData = fillMissingEvictionProbabilities(allData);
                            filteredData = allData;
                            calculateGlobalDataRange(allData);

                            // Invalidate caches and save
                            dataCache.invalidateAll();
                            const timestamp = Date.now();

                            evictionDB.saveFull(allData, timestamp).then(success => {
                                if (success) {
                                    localStorage.setItem('evictionDataTimestamp', timestamp.toString());
                                }
                            });

                            const compressed = compressEvictionData(allData);
                            try {
                                localStorage.setItem('evictionDataCompressed', JSON.stringify(compressed));
                            } catch (e) {
                                console.warn('‚ö†Ô∏è localStorage quota exceeded:', e.message);
                            }

                            console.log('‚úÖ Incremental sync complete:', allData.length, 'total records');
                            console.groupEnd();

                            updateStatus(`Synced ${newEvents.length} new events (${allData.length} total records)`, 'success');
                            updateMetrics();
                            updateCharts();
                            createDistrictMap();
                            await loadDistrictDemographics();
                            initDemographicsCharts();
                            initGrid();
                            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                            restorePersistedFilters();
                            return;
                        }
                    } catch (incrementalError) {
                        console.warn('‚ö†Ô∏è Incremental sync failed, falling back to full sync:', incrementalError.message);
                    }
                }

                // No cached data or incremental sync failed - do full sync
                const API_URL = buildEOApiUrl();
                updateStatus(cachedData && cachedData.length > 0
                    ? 'Incremental sync failed, loading all data...'
                    : 'Loading data from public records API...', 'loading');
                console.log('API URL (full sync):', API_URL);

                let result = null;
                let lastError = null;

                // First, try direct API call (works if CORS is enabled in Xano)
                try {
                    console.log('Trying direct API call...');
                    const response = await fetch(API_URL);

                    console.log('üì° API Response:', {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok,
                        headers: Object.fromEntries([...response.headers.entries()]),
                        url: response.url
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                    }

                    result = await response.json();
                    console.log('‚úÖ Successfully fetched data directly from API');
                    console.log('üìä Response structure:', {
                        type: typeof result,
                        isArray: Array.isArray(result),
                        keys: result && typeof result === 'object' ? Object.keys(result) : 'N/A',
                        length: Array.isArray(result) ? result.length : (result?.items?.length || result?.data?.length || 'N/A'),
                        sample: Array.isArray(result) ? result[0] : (result?.items?.[0] || result?.data?.[0] || result)
                    });
                } catch (directError) {
                    console.error('‚ùå Direct API call failed:', {
                        message: directError.message,
                        name: directError.name,
                        stack: directError.stack
                    });
                    lastError = directError;
                }

                // If direct API call failed, try cache fallback (localStorage or IndexedDB)
                if (result === null) {
                    console.log('API call failed, checking cache for fallback...');
                    const cachedData = await loadCachedData();
                    const storedTimestamp = localStorage.getItem('evictionDataTimestamp');

                    if (cachedData && cachedData.length > 0) {
                        allData = cachedData;
                        filteredData = allData;
                        calculateGlobalDataRange(allData);

                        const cacheAge = getCacheAgeHours();
                        const ageText = cacheAge !== null ? `${cacheAge} hours` : 'unknown time';

                        console.log('‚ö†Ô∏è Using stale cache as fallback:', allData.length, 'records, cached', ageText, 'ago');
                        console.groupEnd();

                        updateStatus(`Loaded ${allData.length} cached records (cached ${ageText} ago). Live API unavailable.`, 'success');
                        updateMetrics();
                        updateCharts();
                        createDistrictMap();
                        await loadDistrictDemographics();
                        initDemographicsCharts();
                        initGrid();
                        document.getElementById('lastUpdate').textContent = storedTimestamp
                            ? new Date(parseInt(storedTimestamp)).toLocaleString() + ' (cached)'
                            : 'Cached data';

                        // Re-apply persisted filters after data loads
                        restorePersistedFilters();
                        return;
                    }

                    // No cache available, throw the last error
                    throw lastError || new Error('Unable to fetch data from API');
                }

                // Handle different response formats
                let data;
                let responseMeta = null;
                if (Array.isArray(result)) {
                    data = result;
                    console.log('üì¶ Data format: Direct array');
                } else if (result?.items && Array.isArray(result.items)) {
                    data = result.items;
                    console.log('üì¶ Data format: {items: [...]}');
                } else if (result?.data && Array.isArray(result.data)) {
                    data = result.data;
                    responseMeta = result.meta || null;
                    console.log('üì¶ Data format: {data: [...], meta: {...}}');
                    if (responseMeta) {
                        console.log('üìä Response metadata:', responseMeta);
                        // Update server pagination state from response metadata
                        serverPaginationState.total = responseMeta.total || 0;
                        serverPaginationState.page = responseMeta.page || 1;
                        serverPaginationState.per_page = responseMeta.limit || serverPaginationState.per_page;
                        serverPaginationState.has_more = responseMeta.has_more || false;
                        console.log('üìÑ Server pagination state updated:', serverPaginationState);
                    }
                } else {
                    data = [result];
                    console.log('üì¶ Data format: Single object wrapped in array');
                }

                console.log('üî¢ Raw event count:', data.length);

                // Debug: log first event structure
                if (data.length > 0) {
                    console.log('üîç First event keys:', Object.keys(data[0]));
                    console.log('üîç First event sample:', JSON.stringify(data[0], null, 2).substring(0, 1000));
                }

                // Detect if this is EO events format (has op, target, context fields)
                const isEOFormat = data.length > 0 && data[0].op !== undefined && data[0].target !== undefined;

                // Track the newest timestamp for incremental sync
                let newestTs = null;
                for (const record of data) {
                    if (record.ts && (!newestTs || record.ts > newestTs)) {
                        newestTs = record.ts;
                    }
                }
                if (newestTs) {
                    localStorage.setItem('eo_last_sync_ts', newestTs.toString());
                    console.log('üìå Saved newest ts for incremental sync:', newestTs);
                }

                let flattenedData;
                if (isEOFormat && typeof EOMigration !== 'undefined') {
                    console.log('üìä Detected EO event format, reconstructing state from', data.length, 'events...');
                    // Parse events from Xano format (stringified JSON fields)
                    const events = data.map(e => EOMigration.fromXanoFormat(e));
                    // Reconstruct current state from events
                    flattenedData = EOMigration.reconstructAllStates(events);
                    console.log('üìä Reconstructed', flattenedData.length, 'unique cases from', events.length, 'events');
                } else {
                    // Fallback for non-EO data formats (backwards compatibility)
                    console.log('üìä Using direct data format (no EO reconstruction)');
                    flattenedData = data;
                }

                const normalizedData = flattenedData.map(normalizeRecord);
                allData = dedupeByDocketNumber(normalizedData);

                // Fill in missing eviction probabilities with the average
                // This ensures cases without sufficient outcome data still get a probability estimate
                allData = fillMissingEvictionProbabilities(allData);

                // Log eviction probability statistics
                const probStats = allData.reduce((acc, r) => {
                    if (r.eviction_outcome_tier === 'AVG') acc.averaged++;
                    else if (r.eviction_outcome_tier && r.eviction_outcome_tier !== 'UNKNOWN') acc.classified++;
                    else acc.unknown++;
                    return acc;
                }, { classified: 0, averaged: 0, unknown: 0 });
                console.log('üìä Eviction probability stats:', probStats);

                filteredData = allData;
                calculateGlobalDataRange(allData);

                // Log district distribution
                const districtCounts = {};
                allData.forEach(r => {
                    const d = r.District || 'Unknown';
                    districtCounts[d] = (districtCounts[d] || 0) + 1;
                });
                console.log('üó∫Ô∏è District distribution:', districtCounts);
                console.log('üìà Records with valid district:', Object.entries(districtCounts).filter(([k]) => k !== 'Unknown').reduce((s, [,v]) => s + v, 0));
                console.log('‚ùì Records without district:', districtCounts['Unknown'] || 0);

                // Invalidate computed data caches since we have new data
                dataCache.invalidateAll();
                console.log('üßπ Cleared computed data caches for new data');

                // Store eviction data: full records in IndexedDB, compressed in localStorage
                const timestamp = Date.now();

                // Always save FULL records to IndexedDB (instant loading on next visit)
                evictionDB.saveFull(allData, timestamp).then(success => {
                    if (success) {
                        localStorage.setItem('evictionDataTimestamp', timestamp.toString());
                    }
                });

                // Also save compressed to localStorage for CM rankings page compatibility
                const compressed = compressEvictionData(allData);
                try {
                    localStorage.setItem('evictionDataCompressed', JSON.stringify(compressed));
                    localStorage.removeItem('evictionData'); // Remove old uncompressed data
                    console.log('üíæ Stored compressed data in localStorage for CM rankings');
                } catch (e) {
                    console.warn('‚ö†Ô∏è localStorage quota exceeded for compressed data:', e.message);
                }

                const dupeCount = normalizedData.length - allData.length;
                const dupeMsg = dupeCount > 0 ? ` (${dupeCount} duplicates removed)` : '';
                console.log('‚úÖ Final record count:', allData.length, dupeMsg);

                // Log any dynamic case_data fields discovered
                if (dynamicCaseDataKeys.size > 0) {
                    console.log('üìã Dynamic case_data columns discovered:', Array.from(dynamicCaseDataKeys).sort());
                }
                console.groupEnd();

                updateStatus(`Loaded ${allData.length} records from public court data${dupeMsg}`, 'success');
                updateMetrics();
                updateCharts();
                createDistrictMap();
                await loadDistrictDemographics();
                initDemographicsCharts();
                initGrid();

                // Update last update time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();

                // Re-apply persisted filters after data loads
                restorePersistedFilters();

            } catch (error) {
                console.groupEnd();
                console.error('‚ùå Error loading data:', {
                    message: error.message,
                    name: error.name,
                    stack: error.stack
                });
                updateStatus(`Error loading data: ${error.message}. Please try refreshing the page.`, 'error');
            } finally {
                isLoadingData = false;
                updateRefreshUI();
            }
        }

        // Incremental data loading - fetch only new records since last sync
        // This is the "smart query" approach for fast refreshes
        async function loadDataIncremental() {
            // If no data loaded yet, do a full load
            if (!allData || allData.length === 0) {
                return loadData();
            }

            isLoadingData = true;
            updateRefreshUI();

            try {
                console.group('üîÑ Incremental Data Sync');
                console.log('Timestamp:', new Date().toISOString());

                // Get the last sync timestamp to query only newer records
                const lastSyncTs = localStorage.getItem('eo_last_sync_ts');

                // Build URL using the EO query builder
                const queryOptions = {};
                if (lastSyncTs) {
                    queryOptions.ts_gt = lastSyncTs;
                    console.log('üìä Smart query: fetching events after ts', lastSyncTs);
                } else {
                    console.log('üìä No previous timestamp, doing full fetch');
                }

                const url = buildEOApiUrl(queryOptions);

                updateStatus('Checking for new records...', 'loading');

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                // Handle different response formats
                let newData;
                if (Array.isArray(result)) {
                    newData = result;
                } else if (result?.items && Array.isArray(result.items)) {
                    newData = result.items;
                } else if (result?.data && Array.isArray(result.data)) {
                    newData = result.data;
                } else {
                    newData = [result];
                }

                console.log('üî¢ New records received:', newData.length);

                if (newData.length === 0) {
                    console.log('‚úÖ No new records found');
                    console.groupEnd();
                    updateStatus(`Data is up to date (${allData.length} records)`, 'success');
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleString() + ' (no changes)';
                    return;
                }

                // Track the newest timestamp from new events
                let newestTs = lastSyncTs ? parseInt(lastSyncTs) : 0;
                for (const record of newData) {
                    if (record.ts && record.ts > newestTs) {
                        newestTs = record.ts;
                    }
                }

                // Process new records - detect EO format vs legacy format
                const isEOFormat = newData.length > 0 && newData[0].op !== undefined && newData[0].target !== undefined;
                const isActivityStream = newData.length > 0 && newData[0].logged_at !== undefined && newData[0].case_data !== undefined;
                const hasActivityMetadata = newData.length > 0 && newData[0].logged_at !== undefined;

                let processedNewData;
                if (isEOFormat && typeof EOMigration !== 'undefined') {
                    // Process EO format events - parse from Xano and apply to state
                    console.log('üìä Processing EO format events');
                    const events = newData.map(e => EOMigration.fromXanoFormat(e));
                    processedNewData = applyEventsToState(allData, events);
                } else if (isActivityStream) {
                    processedNewData = reduceActivityStream(newData);
                } else if (hasActivityMetadata) {
                    processedNewData = reduceActivityStreamFlat(newData);
                } else {
                    processedNewData = newData;
                }

                const normalizedNewData = processedNewData.map(normalizeRecord);

                // Merge new data with existing data
                // Use a Map for efficient deduplication by Case_Number
                const dataMap = new Map();

                // Add existing data first
                for (const record of allData) {
                    const key = (record.Case_Number || '').trim();
                    if (key) {
                        dataMap.set(key, record);
                    }
                }

                // Add/update with new data (new data takes precedence)
                let updatedCount = 0;
                let addedCount = 0;
                for (const record of normalizedNewData) {
                    const key = (record.Case_Number || '').trim();
                    if (key) {
                        if (dataMap.has(key)) {
                            // Merge fields, preferring new record values
                            const existing = dataMap.get(key);
                            const merged = { ...existing };
                            for (const [field, value] of Object.entries(record)) {
                                if (hasValue(value)) {
                                    merged[field] = value;
                                }
                            }
                            dataMap.set(key, merged);
                            updatedCount++;
                        } else {
                            dataMap.set(key, record);
                            addedCount++;
                        }
                    }
                }

                // Convert back to array
                allData = Array.from(dataMap.values());
                filteredData = allData;
                calculateGlobalDataRange(allData);

                // Update the last sync timestamp
                if (newestTs) {
                    localStorage.setItem('eo_last_sync_ts', newestTs.toString());
                }

                // Invalidate computed data caches
                dataCache.invalidateAll();

                // Persist updated data: full records to IndexedDB
                const timestamp = Date.now();
                await evictionDB.saveFull(allData, timestamp);
                localStorage.setItem('evictionDataTimestamp', timestamp.toString());

                // Also update compressed localStorage for compatibility
                const compressed = compressEvictionData(allData);
                try {
                    localStorage.setItem('evictionDataCompressed', JSON.stringify(compressed));
                } catch (e) {
                    console.warn('‚ö†Ô∏è localStorage quota exceeded for compressed data');
                }

                console.log(`‚úÖ Sync complete: ${addedCount} new, ${updatedCount} updated, ${allData.length} total`);
                console.groupEnd();

                // Update UI
                const changeMsg = addedCount > 0 || updatedCount > 0
                    ? `Synced: +${addedCount} new, ${updatedCount} updated`
                    : 'No changes';
                updateStatus(`${allData.length} records (${changeMsg})`, 'success');
                updateMetrics();
                updateCharts();
                createDistrictMap();

                // Refresh grid if initialized
                if (gridApi) {
                    gridApi.setRowData(filteredData);
                }

                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();

                // Re-apply filters
                restorePersistedFilters();

            } catch (error) {
                console.groupEnd();
                console.error('‚ùå Incremental sync error:', error);
                updateStatus(`Sync failed: ${error.message}`, 'error');
            } finally {
                isLoadingData = false;
                updateRefreshUI();
            }
        }

        // Fetch all pages of data from the paginated EO API
        // Useful when you need complete data but the API returns paginated results
        async function fetchAllDetainerCases(options = {}) {
            const allRecords = [];
            let currentPage = 1;
            let hasMore = true;
            const perPage = options.per_page || 100;

            console.group('üì• Fetching all EO events');
            console.log('Options:', options);

            while (hasMore) {
                const url = buildEOApiUrl({
                    ...options,
                    page: currentPage,
                    per_page: perPage
                });

                console.log(`üìÑ Fetching page ${currentPage}...`);
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                // Handle different response formats
                let pageData;
                let meta = null;

                if (Array.isArray(result)) {
                    pageData = result;
                    // No pagination metadata, assume this is all the data
                    hasMore = false;
                } else if (result?.data && Array.isArray(result.data)) {
                    pageData = result.data;
                    meta = result.meta;
                    hasMore = meta?.has_more || false;
                } else if (result?.items && Array.isArray(result.items)) {
                    pageData = result.items;
                    hasMore = false;
                } else {
                    pageData = [result];
                    hasMore = false;
                }

                allRecords.push(...pageData);
                console.log(`üìä Page ${currentPage}: ${pageData.length} records (total so far: ${allRecords.length})`);

                if (meta) {
                    console.log(`üìà Progress: ${allRecords.length} of ${meta.total} (has_more: ${meta.has_more})`);
                }

                currentPage++;

                // Safety limit to prevent infinite loops
                if (currentPage > 1000) {
                    console.warn('‚ö†Ô∏è Reached page limit (1000), stopping fetch');
                    break;
                }
            }

            console.log(`‚úÖ Fetched all ${allRecords.length} records`);
            console.groupEnd();

            return allRecords;
        }

        // Fetch EO events with specific filters (server-side filtering)
        // Returns { data: [...], meta: {...} } with pagination info
        async function fetchDetainerCasesFiltered(options = {}) {
            const url = buildEOApiUrl(options);
            console.log('üîç Fetching filtered EO events:', url);

            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();

            // Normalize response to always return { data, meta }
            if (Array.isArray(result)) {
                return {
                    data: result,
                    meta: {
                        total: result.length,
                        page: 1,
                        limit: result.length,
                        offset: 0,
                        has_more: false
                    }
                };
            } else if (result?.data && Array.isArray(result.data)) {
                return {
                    data: result.data,
                    meta: result.meta || {
                        total: result.data.length,
                        page: 1,
                        limit: result.data.length,
                        offset: 0,
                        has_more: false
                    }
                };
            } else if (result?.items && Array.isArray(result.items)) {
                return {
                    data: result.items,
                    meta: {
                        total: result.items.length,
                        page: 1,
                        limit: result.items.length,
                        offset: 0,
                        has_more: false
                    }
                };
            } else {
                return {
                    data: [result],
                    meta: {
                        total: 1,
                        page: 1,
                        limit: 1,
                        offset: 0,
                        has_more: false
                    }
                };
            }
        }

        // Reduce activity stream records to get current state per docket
        // The activity stream contains multiple records per case (new_case, address_update, etc.)
        // We need the latest record per docket_number to get current state
        // Helper function to check if a value is meaningful (not null, undefined, or empty string)
        function hasValue(val) {
            return val !== null && val !== undefined && val !== '';
        }

        // Parse case_data from JSON string if needed
        function parseCaseData(caseData) {
            if (!caseData) return {};
            if (typeof caseData === 'string') {
                try {
                    return JSON.parse(caseData);
                } catch (e) {
                    console.warn('Failed to parse case_data JSON:', e.message);
                    return {};
                }
            }
            return caseData;
        }

        /**
         * Calculate eviction probability based on court outcome tiers
         *
         * Tier system based on legal research:
         * - Tier 1: Sheriff executed writ (100% - physically evicted)
         * - Tier 2: Writ issued, no sheriff return (85% - likely displaced voluntarily)
         * - Tier 3: Judgment for possession, no writ (65%)
         * - Tier 4: Default judgment (70%)
         * - Tier 5: Dismissed with settlement (55%), nonsuit (45%), unspecified (25%)
         * - Tier 6: Judgment for defendant/tenant (7.5%)
         * - No data: null (will be filled with average later)
         *
         * @param {Object} record - Case record with pleadings, judgments, and other fields
         * @returns {Object} { probability: number|null, tier: string, tierDescription: string }
         */
        function calculateEvictionProbability(record) {
            const pleadings = record.pleadings || [];
            const judgments = record.judgments || [];

            // Helper to check if any pleading matches a pattern
            const hasMatchingPleading = (patterns) => {
                return pleadings.some(p => {
                    const desc = (p.description || '').toUpperCase();
                    const code = (p.code || '').toUpperCase();
                    return patterns.some(pattern => desc.includes(pattern) || code.includes(pattern));
                });
            };

            // Helper to check judgment details
            const hasJudgmentFor = (party) => {
                if (record.judgment_for) {
                    return record.judgment_for.toUpperCase().includes(party.toUpperCase());
                }
                return judgments.some(j => (j.for || '').toUpperCase().includes(party.toUpperCase()));
            };

            // TIER 1: Definitive Physical Eviction (100%)
            // Look for DC SHERIFF PAPER RETURN WRIT or executed writ evidence
            if (record.paper_writ_date || record.writ_served_date ||
                hasMatchingPleading(['SHERIFF', 'PAPER RETURN', 'EXECUTED WRIT', 'WRIT EXECUTED', 'PRA'])) {
                return {
                    probability: 1.0,
                    tier: 'TIER_1',
                    tierDescription: 'Physically Evicted (Sheriff Executed Writ)'
                };
            }

            // TIER 2: Eviction Authorized, Execution Unclear (85%)
            // Writ issued but no sheriff return
            const hasWritIssued = record.writ_issued_date ||
                hasMatchingPleading(['WRIT OF RESTITUTION', 'WRIT OF POSSESSION', 'WRIT RESTITUTION', 'WRIT POSSESSION']);

            if (hasWritIssued) {
                return {
                    probability: 0.85,
                    tier: 'TIER_2',
                    tierDescription: 'Eviction Authorized (Writ Issued)'
                };
            }

            // TIER 6: Tenant Won (7.5%) - Check early to avoid false positives
            if (hasJudgmentFor('DEFENDANT') || hasJudgmentFor('TENANT')) {
                return {
                    probability: 0.075,
                    tier: 'TIER_6',
                    tierDescription: 'Judgment for Tenant'
                };
            }

            // TIER 4: Default Judgment (70%)
            if (hasMatchingPleading(['DEFAULT JUDGMENT', 'JUDGMENT DEFAULT', 'DEFAULT'])) {
                return {
                    probability: 0.70,
                    tier: 'TIER_4',
                    tierDescription: 'Default Judgment (Tenant Did Not Appear)'
                };
            }

            // TIER 3: Court Ordered Possession, No Writ (65%)
            if (hasJudgmentFor('PLAINTIFF') || hasJudgmentFor('LANDLORD') ||
                hasMatchingPleading(['JUDGMENT', 'POSSESSION']) && !record.case_dismissed) {
                return {
                    probability: 0.65,
                    tier: 'TIER_3',
                    tierDescription: 'Court-Ordered Eviction (Judgment for Plaintiff)'
                };
            }

            // TIER 5: Dismissed - Ambiguous outcomes
            if (record.case_dismissed || hasMatchingPleading(['DISMISS', 'NON SUIT', 'NONSUIT'])) {
                // Check for settlement language - higher probability of displacement
                if (hasMatchingPleading(['SETTLEMENT', 'AGREED', 'CONSENT'])) {
                    return {
                        probability: 0.55,
                        tier: 'TIER_5A',
                        tierDescription: 'Dismissed - Settlement (Displacement Possible)'
                    };
                }

                // Voluntary dismissal (nonsuit) - moderate probability
                if (hasMatchingPleading(['NON SUIT', 'NONSUIT', 'VOLUNTARY'])) {
                    return {
                        probability: 0.45,
                        tier: 'TIER_5B',
                        tierDescription: 'Dismissed - Nonsuit (Displacement Possible)'
                    };
                }

                // General dismissal - lower probability
                return {
                    probability: 0.25,
                    tier: 'TIER_5C',
                    tierDescription: 'Dismissed - Unspecified (Outcome Unclear)'
                };
            }

            // No sufficient data to classify
            return {
                probability: null,
                tier: 'UNKNOWN',
                tierDescription: 'Pending/Insufficient Data'
            };
        }

        /**
         * Calculate average eviction probability from cases with known probabilities
         * Used to fill in cases without sufficient data
         *
         * @param {Array} records - Array of case records with eviction_probability field
         * @returns {number} Average probability (0-1)
         */
        function calculateAverageEvictionProbability(records) {
            const known = records.filter(r => r.eviction_probability !== null && r.eviction_probability !== undefined);
            if (known.length === 0) return 0.5; // Default to 50% if no data

            const sum = known.reduce((acc, r) => acc + r.eviction_probability, 0);
            return sum / known.length;
        }

        /**
         * Apply average probability to cases without data
         *
         * @param {Array} records - Array of case records
         * @returns {Array} Records with eviction_probability filled in
         */
        function fillMissingEvictionProbabilities(records) {
            const avgProbability = calculateAverageEvictionProbability(records);

            return records.map(record => {
                if (record.eviction_probability === null || record.eviction_probability === undefined) {
                    return {
                        ...record,
                        eviction_probability: avgProbability,
                        eviction_outcome_tier: 'AVG',
                        eviction_tier_description: `Average (Insufficient Data) - ${(avgProbability * 100).toFixed(1)}%`
                    };
                }
                return record;
            });
        }

        // Deep merge two case_data objects, keeping richest data (all non-null values)
        // Arrays like pleadings and judgments are concatenated and deduped by key fields
        function mergeCaseData(existing, newer) {
            const existingData = parseCaseData(existing);
            const newerData = parseCaseData(newer);

            // Start with all keys from both objects
            const allKeys = new Set([...Object.keys(existingData), ...Object.keys(newerData)]);
            const merged = {};

            // Fields that should be concatenated as arrays (not overwritten)
            const arrayMergeFields = new Set(['pleadings', 'judgments']);

            for (const key of allKeys) {
                const existingVal = existingData[key];
                const newerVal = newerData[key];

                // Special handling for array fields - concatenate and dedupe
                if (arrayMergeFields.has(key)) {
                    const existingArr = Array.isArray(existingVal) ? existingVal : [];
                    const newerArr = Array.isArray(newerVal) ? newerVal : [];

                    if (existingArr.length === 0 && newerArr.length === 0) {
                        continue; // Skip empty arrays
                    }

                    // Concatenate and dedupe by creating a unique key for each item
                    const seen = new Map();
                    const combined = [...existingArr, ...newerArr];

                    for (const item of combined) {
                        // Create unique key based on code+date+detail for pleadings, or relevant fields for judgments
                        const itemKey = key === 'pleadings'
                            ? `${item.code || ''}|${item.date || ''}|${item.detail || ''}|${item.description || ''}`
                            : `${item.date || ''}|${item.type || ''}|${item.amount || ''}`;

                        // Keep the most recent version (last occurrence)
                        seen.set(itemKey, item);
                    }

                    merged[key] = Array.from(seen.values());
                } else if (hasValue(newerVal)) {
                    // Prefer newer value if it has content
                    merged[key] = newerVal;
                } else if (hasValue(existingVal)) {
                    merged[key] = existingVal;
                }
                // If neither has value, field is omitted (keeps object clean)
            }

            return merged;
        }

        // Merge two records, preferring non-null/non-empty values
        // When both have values for a field, prefer the newer record's value
        // Special handling for case_data to deep merge its contents
        // Special handling for array fields (pleadings, judgments) to concatenate and dedupe
        function mergeRecordFields(existing, newer) {
            const merged = { ...newer };

            // Deep merge case_data field to preserve richest data
            if (existing.case_data || newer.case_data) {
                merged.case_data = mergeCaseData(existing.case_data, newer.case_data);
            }

            // Fields that should be concatenated as arrays (not overwritten)
            const arrayMergeFields = new Set(['pleadings', 'judgments']);

            for (const key of Object.keys(existing)) {
                // Skip case_data since we handled it specially above
                if (key === 'case_data') continue;

                // Special handling for array fields - concatenate and dedupe
                if (arrayMergeFields.has(key)) {
                    const existingArr = Array.isArray(existing[key]) ? existing[key] : [];
                    const newerArr = Array.isArray(merged[key]) ? merged[key] : [];

                    if (existingArr.length > 0 || newerArr.length > 0) {
                        const seen = new Map();
                        const combined = [...existingArr, ...newerArr];

                        for (const item of combined) {
                            const itemKey = key === 'pleadings'
                                ? `${item.code || ''}|${item.date || ''}|${item.detail || ''}|${item.description || ''}`
                                : `${item.date || ''}|${item.type || ''}|${item.amount || ''}`;
                            seen.set(itemKey, item);
                        }

                        merged[key] = Array.from(seen.values());
                    }
                    continue;
                }

                // If newer record has no value but existing does, use existing value
                if (!hasValue(merged[key]) && hasValue(existing[key])) {
                    merged[key] = existing[key];
                }
            }
            return merged;
        }

        function reduceActivityStream(activityRecords) {
            const byDocket = new Map();

            for (const record of activityRecords) {
                const docket = record.docket_number;
                if (!docket) continue;

                const existing = byDocket.get(docket);
                if (!existing) {
                    byDocket.set(docket, record);
                } else if (record.logged_at > existing.logged_at) {
                    // Merge: newer record wins for timestamp, but preserve existing non-null values
                    byDocket.set(docket, mergeRecordFields(existing, record));
                } else {
                    // Existing is newer, but still merge in any non-null values from this record
                    byDocket.set(docket, mergeRecordFields(record, existing));
                }
            }

            // Debug: log sample record structure
            const sampleRecords = Array.from(byDocket.values()).slice(0, 2);
            if (sampleRecords.length > 0) {
                console.log('üîç Sample activity record structure:', JSON.stringify(sampleRecords[0], null, 2));
                const sampleCaseData = sampleRecords[0].case_data;
                if (sampleCaseData) {
                    if (typeof sampleCaseData === 'string') {
                        console.log('üîç case_data is JSON string, parsing...');
                        try {
                            const parsed = JSON.parse(sampleCaseData);
                            console.log('üîç case_data fields:', Object.keys(parsed));
                            console.log('üîç File_Date from JSON:', parsed.File_Date || parsed.file_date || 'NOT FOUND');
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Failed to parse case_data JSON string:', e.message);
                        }
                    } else {
                        console.log('üîç case_data fields:', Object.keys(sampleCaseData));
                        console.log('üîç File_Date:', sampleCaseData.File_Date || sampleCaseData.file_date || 'NOT FOUND');
                    }
                } else {
                    console.log('‚ö†Ô∏è case_data is missing or empty in first record');
                }
            }

            // Flatten the activity stream records to flat case records
            return Array.from(byDocket.values()).map(record => {
                // Merge case_data fields to top level for compatibility with existing code
                // Handle both PascalCase and snake_case field names from API
                // Parse case_data if it's a JSON string (database stores JSON as string)
                let caseData = record.case_data || {};
                if (typeof caseData === 'string') {
                    try {
                        caseData = JSON.parse(caseData);
                    } catch (e) {
                        console.warn('Failed to parse case_data JSON string:', e.message);
                        caseData = {};
                    }
                }

                // Known fields that we map explicitly (normalized field names)
                const knownFields = new Set([
                    'Docket_Number', 'docket_number', 'File_Date', 'file_date', 'Status', 'status',
                    'Office', 'office', 'Description', 'description', 'Plaintiff_Petitioner',
                    'plaintiff_petitioner', 'plaintiff', 'Defendant_Respondent', 'defendant_respondent',
                    'defendant', 'Attorney', 'attorney', 'plaintiff_attorney', 'defendant_attorney',
                    'Defendant_Attorney', 'defense_attorney', 'Address_1', 'address_1', 'address',
                    'Address_2', 'address_2', 'city_state_zip', 'City_State_Zip', 'address_formatted',
                    'formatted_address', 'latitude', 'lat', 'longitude', 'lng', 'lon',
                    'council_district', 'Council_District', 'council_district_number',
                    'Council_District_Number', 'council_member', 'Council_Member',
                    'individual_ll', 'Individual_LL', 'id',
                    // Backfill data fields
                    'judge', 'pleadings', 'judgments', 'filing_date', 'service_date',
                    'judgment_for', 'judgment_date', 'judgment_type', 'case_dismissed',
                    'dismissal_date', 'eviction_date', 'eviction_method', 'eviction_executed',
                    'writ_issued_date', 'writ_served_date', 'paper_writ_date',
                    // Eviction probability fields (computed)
                    'eviction_probability', 'eviction_outcome_tier', 'eviction_tier_description'
                ]);

                // Track any dynamic keys from case_data that are not in our known fields
                for (const key of Object.keys(caseData)) {
                    if (!knownFields.has(key)) {
                        dynamicCaseDataKeys.add(key);
                    }
                }

                // Build base record with known fields
                const flatRecord = {
                    // Activity stream metadata
                    _logged_at: record.logged_at,
                    _action: record.action,
                    _activity_id: record.id,
                    // Case data fields (flattened from case_data)
                    // Support both PascalCase and snake_case field names
                    Docket_Number: record.docket_number || caseData.Docket_Number || caseData.docket_number,
                    File_Date: caseData.File_Date || caseData.file_date,
                    Status: caseData.Status || caseData.status,
                    Office: caseData.Office || caseData.office,
                    Description: caseData.Description || caseData.description,
                    Plaintiff_Petitioner: caseData.Plaintiff_Petitioner || caseData.plaintiff_petitioner || caseData.plaintiff,
                    Defendant_Respondent: caseData.Defendant_Respondent || caseData.defendant_respondent || caseData.defendant,
                    Attorney: caseData.Attorney || caseData.attorney || caseData.plaintiff_attorney,
                    Defendant_Attorney: caseData.defendant_attorney || caseData.Defendant_Attorney || caseData.defense_attorney,
                    Address_1: caseData.Address_1 || caseData.address_1 || caseData.address,
                    Address_2: caseData.Address_2 || caseData.address_2,
                    city_state_zip: caseData.city_state_zip || caseData.City_State_Zip,
                    address_formatted: caseData.address_formatted || caseData.formatted_address,
                    formatted_address: caseData.formatted_address || caseData.address_formatted,
                    latitude: caseData.latitude || caseData.lat,
                    longitude: caseData.longitude || caseData.lng || caseData.lon,
                    council_district: caseData.council_district || caseData.Council_District,
                    council_district_number: caseData.council_district_number || caseData.Council_District_Number,
                    council_member: caseData.council_member || caseData.Council_Member,
                    individual_ll: caseData.individual_ll || caseData.Individual_LL,
                    // Backfill data fields
                    judge: caseData.judge,
                    pleadings: caseData.pleadings || [],
                    judgments: caseData.judgments || [],
                    filing_date: caseData.filing_date,
                    service_date: caseData.service_date,
                    judgment_for: caseData.judgment_for,
                    judgment_date: caseData.judgment_date,
                    judgment_type: caseData.judgment_type,
                    case_dismissed: caseData.case_dismissed,
                    dismissal_date: caseData.dismissal_date,
                    eviction_date: caseData.eviction_date,
                    eviction_method: caseData.eviction_method,
                    eviction_executed: caseData.eviction_executed,
                    writ_issued_date: caseData.writ_issued_date,
                    writ_served_date: caseData.writ_served_date,
                    paper_writ_date: caseData.paper_writ_date
                };

                // Extract paper_writ_date from pleadings if not already set
                // Look for pleadings with code "PRA" (DC SHERIFF PAPER RETURN)
                if (!flatRecord.paper_writ_date && Array.isArray(flatRecord.pleadings)) {
                    const paperWritPleading = flatRecord.pleadings.find(p =>
                        p.code === 'PRA' ||
                        (p.description && p.description.toUpperCase().includes('PAPER RETURN'))
                    );
                    if (paperWritPleading && paperWritPleading.date) {
                        flatRecord.paper_writ_date = paperWritPleading.date;
                    }
                }

                // Calculate eviction probability based on case outcome
                const probabilityResult = calculateEvictionProbability(flatRecord);
                flatRecord.eviction_probability = probabilityResult.probability;
                flatRecord.eviction_outcome_tier = probabilityResult.tier;
                flatRecord.eviction_tier_description = probabilityResult.tierDescription;

                // Copy all dynamic fields from case_data to the flat record
                for (const key of Object.keys(caseData)) {
                    if (!knownFields.has(key) && caseData[key] !== undefined && caseData[key] !== null) {
                        flatRecord[key] = caseData[key];
                    }
                }

                return flatRecord;
            });
        }

        // Reduce activity stream records when data fields are at top level (no case_data wrapper)
        function reduceActivityStreamFlat(activityRecords) {
            const byDocket = new Map();

            for (const record of activityRecords) {
                const docket = record.docket_number;
                if (!docket) continue;

                const existing = byDocket.get(docket);
                if (!existing) {
                    byDocket.set(docket, record);
                } else if (record.logged_at > existing.logged_at) {
                    // Merge: newer record wins for timestamp, but preserve existing non-null values
                    byDocket.set(docket, mergeRecordFields(existing, record));
                } else {
                    // Existing is newer, but still merge in any non-null values from this record
                    byDocket.set(docket, mergeRecordFields(record, existing));
                }
            }

            // Debug: log sample record structure
            const sampleRecords = Array.from(byDocket.values()).slice(0, 2);
            if (sampleRecords.length > 0) {
                console.log('üîç Sample flat activity record keys:', Object.keys(sampleRecords[0]));
            }

            // Known fields that we map explicitly (normalized field names)
            const knownFields = new Set([
                'Docket_Number', 'docket_number', 'File_Date', 'file_date', 'Status', 'status',
                'Office', 'office', 'Description', 'description', 'Plaintiff_Petitioner',
                'plaintiff_petitioner', 'plaintiff', 'Defendant_Respondent', 'defendant_respondent',
                'defendant', 'Attorney', 'attorney', 'plaintiff_attorney', 'defendant_attorney',
                'Defendant_Attorney', 'defense_attorney', 'Address_1', 'address_1', 'address',
                'Address_2', 'address_2', 'city_state_zip', 'City_State_Zip', 'address_formatted',
                'formatted_address', 'latitude', 'lat', 'longitude', 'lng', 'lon',
                'council_district', 'Council_District', 'council_district_number',
                'Council_District_Number', 'council_member', 'Council_Member',
                'individual_ll', 'Individual_LL', 'id', 'logged_at', 'action',
                // Backfill data fields
                'judge', 'pleadings', 'judgments', 'filing_date', 'service_date',
                'judgment_for', 'judgment_date', 'judgment_type', 'case_dismissed',
                'dismissal_date', 'eviction_date', 'eviction_method', 'eviction_executed',
                'writ_issued_date', 'writ_served_date', 'paper_writ_date',
                // Eviction probability fields (computed)
                'eviction_probability', 'eviction_outcome_tier', 'eviction_tier_description'
            ]);

            // Map flat records with field name fallbacks
            return Array.from(byDocket.values()).map(record => {
                // Track any dynamic keys that are not in our known fields
                for (const key of Object.keys(record)) {
                    if (!knownFields.has(key) && !key.startsWith('_')) {
                        dynamicCaseDataKeys.add(key);
                    }
                }

                // Build base record with known fields
                const flatRecord = {
                    // Activity stream metadata
                    _logged_at: record.logged_at,
                    _action: record.action,
                    _activity_id: record.id,
                    // Case data fields at top level - support both PascalCase and snake_case
                    Docket_Number: record.docket_number || record.Docket_Number,
                    File_Date: record.File_Date || record.file_date,
                    Status: record.Status || record.status,
                    Office: record.Office || record.office,
                    Description: record.Description || record.description,
                    Plaintiff_Petitioner: record.Plaintiff_Petitioner || record.plaintiff_petitioner || record.plaintiff,
                    Defendant_Respondent: record.Defendant_Respondent || record.defendant_respondent || record.defendant,
                    Attorney: record.Attorney || record.attorney || record.plaintiff_attorney,
                    Defendant_Attorney: record.defendant_attorney || record.Defendant_Attorney || record.defense_attorney,
                    Address_1: record.Address_1 || record.address_1 || record.address,
                    Address_2: record.Address_2 || record.address_2,
                    city_state_zip: record.city_state_zip || record.City_State_Zip,
                    address_formatted: record.address_formatted || record.formatted_address,
                    formatted_address: record.formatted_address || record.address_formatted,
                    latitude: record.latitude || record.lat,
                    longitude: record.longitude || record.lng || record.lon,
                    council_district: record.council_district || record.Council_District,
                    council_district_number: record.council_district_number || record.Council_District_Number,
                    council_member: record.council_member || record.Council_Member,
                    individual_ll: record.individual_ll || record.Individual_LL,
                    // Backfill data fields
                    judge: record.judge,
                    pleadings: record.pleadings || [],
                    judgments: record.judgments || [],
                    filing_date: record.filing_date,
                    service_date: record.service_date,
                    judgment_for: record.judgment_for,
                    judgment_date: record.judgment_date,
                    judgment_type: record.judgment_type,
                    case_dismissed: record.case_dismissed,
                    dismissal_date: record.dismissal_date,
                    eviction_date: record.eviction_date,
                    eviction_method: record.eviction_method,
                    eviction_executed: record.eviction_executed,
                    writ_issued_date: record.writ_issued_date,
                    writ_served_date: record.writ_served_date,
                    paper_writ_date: record.paper_writ_date
                };

                // Extract paper_writ_date from pleadings if not already set
                // Look for pleadings with code "PRA" (DC SHERIFF PAPER RETURN)
                if (!flatRecord.paper_writ_date && Array.isArray(flatRecord.pleadings)) {
                    const paperWritPleading = flatRecord.pleadings.find(p =>
                        p.code === 'PRA' ||
                        (p.description && p.description.toUpperCase().includes('PAPER RETURN'))
                    );
                    if (paperWritPleading && paperWritPleading.date) {
                        flatRecord.paper_writ_date = paperWritPleading.date;
                    }
                }

                // Calculate eviction probability based on case outcome
                const probabilityResult = calculateEvictionProbability(flatRecord);
                flatRecord.eviction_probability = probabilityResult.probability;
                flatRecord.eviction_outcome_tier = probabilityResult.tier;
                flatRecord.eviction_tier_description = probabilityResult.tierDescription;

                // Copy all dynamic fields from record to the flat record
                for (const key of Object.keys(record)) {
                    if (!knownFields.has(key) && !key.startsWith('_') && record[key] !== undefined && record[key] !== null) {
                        flatRecord[key] = record[key];
                    }
                }

                return flatRecord;
            });
        }

        // Deduplicate records by docket number (Case_Number), merging fields to preserve non-null values
        // Uses _logged_at (activity stream timestamp) if available, otherwise falls back to File_Date
        function dedupeByDocketNumber(records) {
            const seen = new Map();

            for (const record of records) {
                const docketNumber = (record.Case_Number || '').trim();

                // Skip records with empty docket numbers
                if (!docketNumber) {
                    continue;
                }

                if (!seen.has(docketNumber)) {
                    seen.set(docketNumber, record);
                } else {
                    // Merge records, preferring non-null values from either
                    const existing = seen.get(docketNumber);
                    let newerRecord, olderRecord;

                    // Determine which record is newer
                    if (record._logged_at !== undefined && existing._logged_at !== undefined) {
                        if (record._logged_at > existing._logged_at) {
                            newerRecord = record;
                            olderRecord = existing;
                        } else {
                            newerRecord = existing;
                            olderRecord = record;
                        }
                    } else {
                        // Fall back to File_Date comparison for legacy data
                        const existingDate = new Date(existing.File_Date || 0);
                        const currentDate = new Date(record.File_Date || 0);

                        if (currentDate > existingDate) {
                            newerRecord = record;
                            olderRecord = existing;
                        } else {
                            newerRecord = existing;
                            olderRecord = record;
                        }
                    }

                    // Merge: newer record is base, but preserve non-null values from older
                    seen.set(docketNumber, mergeRecordFields(olderRecord, newerRecord));
                }
            }

            return Array.from(seen.values());
        }

        function normalizeRecord(record) {
            // Extract council district - prefer council_district_number if it's a valid number
            let district = 'Unknown';
            if (record.council_district_number && typeof record.council_district_number === 'number' && record.council_district_number > 0) {
                district = record.council_district_number;
            } else if (record.council_district) {
                // Extract number from strings like "Council District 8"
                const match = String(record.council_district).match(/(\d+)/);
                if (match) {
                    district = parseInt(match[1], 10);
                }
            }

            // Parse attorney field - split by semicolon to get plaintiff and defense attorneys
            const rawAttorney = record.Attorney || record.attorney || '';
            const attorneyParts = String(rawAttorney).split(/[;]/).map(a => a.trim());
            const plaintiffAttorney = cleanAttorney(attorneyParts[0]) || '';
            // Prefer explicit Defendant_Attorney field from activity stream, otherwise parse from semicolon-separated Attorney field
            const defenseAttorney = record.Defendant_Attorney
                ? cleanAttorney(record.Defendant_Attorney)
                : (attorneyParts.length > 1 ? cleanAttorney(attorneyParts[1]) : '');

            const normalized = {
                ...record,
                File_Date: parseDate(record.File_Date || record.file_date),
                Plaintiff: record.Plaintiff_Petitioner || record.Plaintiff || record.plaintiff || '',
                Defendant: record.Defendant_Respondent || record.Defendant || record.defendant || '',
                Address: record.address_formatted || record.formatted_address || record.Address_1 || record.address || '',
                District: district,
                Case_Number: record.Docket_Number || record.Case_Number || record.case_number || record.id || '',
                Attorney: plaintiffAttorney,
                Defense_Attorney: defenseAttorney,
                CouncilMember: record.council_member || '',
                individual_ll: record.individual_ll === "1" || record.individual_ll === true || record.individual_ll === 'true',
                // Preserve activity stream metadata if present
                _logged_at: record._logged_at,
                _action: record._action
            };

            return normalized;
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            
            // Hide after success
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        function updateMetrics() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);

            // Total records
            document.getElementById('totalRecords').textContent = allData.length.toLocaleString();

            // This month
            const thisMonthCount = allData.filter(d => {
                const date = new Date(d.File_Date);
                return date >= thisMonthStart;
            }).length;
            document.getElementById('thisMonth').textContent = thisMonthCount.toLocaleString();

            // Last 30 days
            const last30Count = allData.filter(d => {
                const date = new Date(d.File_Date);
                return date >= thirtyDaysAgo;
            }).length;
            document.getElementById('last30Days').textContent = last30Count.toLocaleString();

            // Calculate 30-day average based on entire dataset
            const thirtyChangeEl = document.getElementById('thirtyChange');
            if (allData.length > 0) {
                // Find earliest and latest filing dates
                let earliestDate = null;
                let latestDate = null;
                allData.forEach(d => {
                    const date = new Date(d.File_Date);
                    if (!isNaN(date.getTime())) {
                        if (!earliestDate || date < earliestDate) earliestDate = date;
                        if (!latestDate || date > latestDate) latestDate = date;
                    }
                });

                if (earliestDate && latestDate) {
                    const totalDays = Math.ceil((latestDate - earliestDate) / (1000 * 60 * 60 * 24)) + 1;
                    const dailyAverage = allData.length / totalDays;
                    const avg30Day = Math.round(dailyAverage * 30);

                    const diff = last30Count - avg30Day;
                    const percentDiff = avg30Day > 0 ? Math.round((diff / avg30Day) * 100) : 0;

                    if (diff > 0) {
                        thirtyChangeEl.innerHTML = `<span class="text-red-600">‚Üë ${Math.abs(percentDiff)}% above avg (${avg30Day.toLocaleString()})</span>`;
                    } else if (diff < 0) {
                        thirtyChangeEl.innerHTML = `<span class="text-green-600">‚Üì ${Math.abs(percentDiff)}% below avg (${avg30Day.toLocaleString()})</span>`;
                    } else {
                        thirtyChangeEl.innerHTML = `<span class="text-gray-500">At average (${avg30Day.toLocaleString()})</span>`;
                    }
                } else {
                    thirtyChangeEl.innerHTML = '';
                }
            } else {
                thirtyChangeEl.innerHTML = '';
            }
        }

        // Track active metric filter
        let activeMetricFilter = null;

        function filterByMetric(metricType) {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);

            // Clear previous metric filter styling
            document.querySelectorAll('.metric-clickable').forEach(el => el.classList.remove('active'));

            // Clear chart filter if any
            if (chartFilter) {
                clearChartFilter();
            }

            // If clicking the same filter, toggle it off
            if (activeMetricFilter === metricType) {
                activeMetricFilter = null;
                filteredData = [...allData];
                if (gridApi) {
                    gridApi.setRowData(filteredData);
                }
                updateRecordCount();
                createDistrictMap();
                updateDemographicsCharts();
                updateDemoFilterIndicator();
                return;
            }

            activeMetricFilter = metricType;

            // Apply the appropriate filter
            switch(metricType) {
                case 'total':
                    document.getElementById('metricTotal').classList.add('active');
                    filteredData = [...allData];
                    break;
                case 'thisMonth':
                    document.getElementById('metricMonth').classList.add('active');
                    filteredData = allData.filter(d => {
                        const date = new Date(d.File_Date);
                        return date >= thisMonthStart;
                    });
                    break;
                case 'last30Days':
                    document.getElementById('metricThirty').classList.add('active');
                    filteredData = allData.filter(d => {
                        const date = new Date(d.File_Date);
                        return date >= thirtyDaysAgo;
                    });
                    break;
            }

            if (gridApi) {
                gridApi.setRowData(filteredData);
            }
            updateRecordCount();
            createDistrictMap();
            updateDemographicsCharts();
            updateDemoFilterIndicator();

            // Scroll to the grid
            document.getElementById('dataGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showMetricSource(metricType) {
            const sourceInfo = {
                total: {
                    title: 'Total Records',
                    description: 'Total number of eviction filings in the dataset.',
                    source: 'Davidson County Sessions Court',
                    sourceUrl: 'https://caselink.nashville.gov/',
                    methodology: 'Records are collected from public court filings. This count represents all eviction filings (detainer warrants) in Davidson County that are available in the public records system.'
                },
                thisMonth: {
                    title: 'This Month',
                    description: 'Eviction filings from the first day of the current month to today.',
                    source: 'Davidson County Sessions Court',
                    sourceUrl: 'https://caselink.nashville.gov/',
                    methodology: 'Calculated by filtering records where the filing date is on or after the first day of the current calendar month.'
                },
                last30Days: {
                    title: 'Last 30 Days',
                    description: 'Eviction filings from the past 30 calendar days.',
                    source: 'Davidson County Sessions Court',
                    sourceUrl: 'https://caselink.nashville.gov/',
                    methodology: 'Calculated by filtering records where the filing date is within the last 30 days from today.'
                }
            };

            const info = sourceInfo[metricType];
            if (!info) return;

            // Create modal content
            const modalHtml = `
                <div class="modal-overlay" onclick="closeMetricSourceModal(event)">
                    <div class="modal-container" style="max-width: 500px;" onclick="event.stopPropagation()">
                        <button class="modal-close" onclick="closeMetricSourceModal()">&times;</button>
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e3a5f; margin-bottom: 1rem;">${info.title}</h2>
                        <div style="margin-bottom: 1rem;">
                            <p style="color: #374151; margin-bottom: 0.5rem;">${info.description}</p>
                        </div>
                        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.5rem;">Methodology</div>
                            <p style="color: #374151; font-size: 0.875rem;">${info.methodology}</p>
                        </div>
                        <div class="modal-source">
                            Source: <a href="${info.sourceUrl}" target="_blank">${info.source}</a>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to body
            const modalWrapper = document.createElement('div');
            modalWrapper.id = 'metricSourceModal';
            modalWrapper.innerHTML = modalHtml;
            document.body.appendChild(modalWrapper);
        }

        function closeMetricSourceModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('metricSourceModal');
            if (modal) {
                modal.remove();
            }
        }

        function showCountyStatSource(statType) {
            const sourceInfo = {
                evictions: {
                    title: 'Evictions Per Year',
                    description: 'Annualized count of eviction filings in Davidson County.',
                    source: 'Davidson County Sessions Court',
                    sourceUrl: 'https://caselink.nashville.gov/',
                    methodology: 'Calculated by annualizing the eviction filing count based on available data. If data spans less than a full year, the count is pro-rated to estimate the annual total.'
                },
                population: {
                    title: 'Population',
                    description: 'Total population of Davidson County.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Population data from the U.S. Census Bureau American Community Survey, aggregated across all 35 council districts.'
                },
                income: {
                    title: 'Median Household Income',
                    description: 'Median annual household income for Davidson County residents.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Median income calculated from census data representing the midpoint of all household incomes in the county.'
                },
                poverty: {
                    title: 'Poverty Rate',
                    description: 'Percentage of Davidson County residents living below the federal poverty line.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Poverty rate based on federal poverty thresholds which vary by family size and composition.'
                }
            };

            const info = sourceInfo[statType];
            if (!info) return;

            // Create modal content
            const modalHtml = `
                <div class="modal-overlay" onclick="closeMetricSourceModal(event)">
                    <div class="modal-container" style="max-width: 500px;" onclick="event.stopPropagation()">
                        <button class="modal-close" onclick="closeMetricSourceModal()">&times;</button>
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e3a5f; margin-bottom: 1rem;">${info.title}</h2>
                        <div style="margin-bottom: 1rem;">
                            <p style="color: #374151; margin-bottom: 0.5rem;">${info.description}</p>
                        </div>
                        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.5rem;">Methodology</div>
                            <p style="color: #374151; font-size: 0.875rem;">${info.methodology}</p>
                        </div>
                        <div class="modal-source">
                            Source: <a href="${info.sourceUrl}" target="_blank">${info.source}</a>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to body
            const modalWrapper = document.createElement('div');
            modalWrapper.id = 'metricSourceModal';
            modalWrapper.innerHTML = modalHtml;
            document.body.appendChild(modalWrapper);
        }

        function showDemographicMetricSource(metricType) {
            const sourceInfo = {
                avgPerMonth: {
                    title: 'Average Evictions per Month',
                    description: 'Average number of eviction filings per month in each district.',
                    source: 'Davidson County Sessions Court',
                    sourceUrl: 'https://caselink.nashville.gov/',
                    methodology: 'Calculated by dividing total eviction filings by the number of months in the data range for each district.'
                },
                perCapita: {
                    title: 'Evictions per 1,000 Renter Households',
                    description: 'Eviction rate normalized per 1,000 renter households in each district. This metric provides the most accurate measure of eviction burden by comparing filings only against the population at risk of eviction (renters), not the total population.',
                    source: 'Court records + American Community Survey',
                    sourceUrl: 'https://caselink.nashville.gov/',
                    methodology: `<strong>Formula:</strong><br>
                        <div style="background: #e8f4f8; padding: 12px; border-radius: 6px; margin: 8px 0; font-family: monospace;">
                            (Eviction Filings √∑ Renter Households) √ó 1,000
                        </div>
                        <strong>Renter Households</strong> are calculated from Census data as: Total Occupied Housing Units minus Owner-Occupied Units.<br><br>
                        <strong>Why use renter households?</strong> Evictions only affect renters, so comparing against total population would undercount the true eviction rate in areas with more homeowners. This metric enables fair comparison across districts with different homeownership rates.`
                },
                population: {
                    title: 'District Population',
                    description: 'Total population count for each council district.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Population data from U.S. Census Bureau, aggregated by council district boundaries.'
                },
                income: {
                    title: 'Median Household Income',
                    description: 'Median annual household income for residents in each district.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Median income represents the midpoint of all household incomes in the district.'
                },
                poverty: {
                    title: 'Poverty Rate',
                    description: 'Percentage of residents living below the federal poverty line.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Based on federal poverty thresholds which vary by family size and composition.'
                },
                rentBurden: {
                    title: 'Renter Cost Burden',
                    description: 'Percentage of renters spending more than 30% of income on housing.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'HUD defines cost-burdened households as those paying more than 30% of income for housing costs.'
                },
                unemployment: {
                    title: 'Unemployment Rate',
                    description: 'Percentage of labor force that is unemployed in each district.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Unemployment rate for civilian labor force aged 16 and over.'
                }
            };

            const info = sourceInfo[metricType];
            if (!info) return;

            // Create modal content
            const modalHtml = `
                <div class="modal-overlay" onclick="closeMetricSourceModal(event)">
                    <div class="modal-container" style="max-width: 500px;" onclick="event.stopPropagation()">
                        <button class="modal-close" onclick="closeMetricSourceModal()">&times;</button>
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e3a5f; margin-bottom: 1rem;">${info.title}</h2>
                        <div style="margin-bottom: 1rem;">
                            <p style="color: #374151; margin-bottom: 0.5rem;">${info.description}</p>
                        </div>
                        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.5rem;">Methodology</div>
                            <p style="color: #374151; font-size: 0.875rem;">${info.methodology}</p>
                        </div>
                        <div class="modal-source">
                            Source: <a href="${info.sourceUrl}" target="_blank">${info.source}</a>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to body
            const modalWrapper = document.createElement('div');
            modalWrapper.id = 'metricSourceModal';
            modalWrapper.innerHTML = modalHtml;
            document.body.appendChild(modalWrapper);
        }

        // District Profile Stat Source Modal (for community profile stats in district modal)
        function showDistrictStatSource(statType, event) {
            // Prevent the click from closing the district modal
            if (event) {
                event.stopPropagation();
            }

            const sourceInfo = {
                // Eviction Context
                evictionFilings: {
                    title: 'Eviction Filings',
                    description: 'Total number of eviction filings (detainer warrants) in this district during the data period.',
                    source: 'Davidson County Sessions Court',
                    sourceUrl: 'https://caselink.nashville.gov/',
                    methodology: 'Count of eviction filings from court records where the property address falls within this council district boundary.'
                },
                population: {
                    title: 'Population',
                    description: 'Total population count for this council district.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Population data from U.S. Census Bureau, aggregated by council district boundaries via Metropolitan Social Services.'
                },
                evictionRate: {
                    title: 'Evictions per 1,000 Renter Households (Annualized)',
                    description: 'Annualized eviction rate normalized per 1,000 renter households for comparison across districts.',
                    source: 'Court records + American Community Survey',
                    sourceUrl: 'https://caselink.nashville.gov/',
                    methodology: `<strong>Formula:</strong><br>
                        <div style="background: #e8f4f8; padding: 12px; border-radius: 6px; margin: 8px 0; font-family: monospace;">
                            (Eviction Filings √ó (365 √∑ Days of Data) √∑ Renter Households) √ó 1,000
                        </div>
                        <strong>Renter Households</strong> are calculated from Census data as: Total Occupied Housing Units minus Owner-Occupied Units.<br><br>
                        <strong>Why annualize?</strong> When data covers less than a full year, we project to annual rates for consistent comparison.`
                },
                evictionRatePerRenters: {
                    title: 'Evictions per 1,000 Renter Households',
                    description: 'Eviction rate normalized per 1,000 renter households in this district. This metric provides the most accurate measure of eviction burden by comparing filings only against the population at risk of eviction (renters), not the total population.',
                    source: 'Court records + American Community Survey',
                    sourceUrl: 'https://caselink.nashville.gov/',
                    methodology: `<strong>Formula:</strong><br>
                        <div style="background: #e8f4f8; padding: 12px; border-radius: 6px; margin: 8px 0; font-family: monospace;">
                            (Eviction Filings √∑ Renter Households) √ó 1,000
                        </div>
                        <strong>If annualized (less than 1 year of data):</strong><br>
                        <div style="background: #e8f4f8; padding: 12px; border-radius: 6px; margin: 8px 0; font-family: monospace;">
                            (Eviction Filings √ó (365 √∑ Days of Data) √∑ Renter Households) √ó 1,000
                        </div>
                        <strong>Renter Households</strong> are calculated from Census data as: Total Occupied Housing Units minus Owner-Occupied Units.<br><br>
                        <strong>Why use renter households?</strong> Evictions only affect renters, so comparing against total population would undercount the true eviction rate in areas with more homeowners. This metric enables fair comparison across districts with different homeownership rates.`
                },
                povertyRate: {
                    title: 'Poverty Rate',
                    description: 'Percentage of residents living below the federal poverty line.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Based on federal poverty thresholds which vary by family size and composition. A family of 4 is below poverty if income is under ~$27,750.'
                },
                medianIncome: {
                    title: 'Median Household Income',
                    description: 'Median annual household income for residents in this district.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Median income represents the midpoint of all household incomes in the district - half earn more, half earn less.'
                },
                renterCostBurden: {
                    title: 'Renters Cost-Burdened (35%+)',
                    description: 'Percentage of renters spending 35% or more of income on housing costs.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'HUD considers households severely cost-burdened at 35%+ of income. This metric shows the percentage of renter households meeting this threshold.'
                },
                // Housing
                housingUnits: {
                    title: 'Housing Units',
                    description: 'Total number of housing units in this district.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Count of all housing units including occupied and vacant units, apartments, houses, and other residential structures.'
                },
                occupiedRate: {
                    title: 'Occupied Housing Rate',
                    description: 'Percentage of housing units that are occupied.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Calculated as occupied units divided by total housing units. Higher vacancy rates may indicate housing market issues.'
                },
                medianHomeValue: {
                    title: 'Median Home Value',
                    description: 'Median value of owner-occupied housing units.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Self-reported owner estimate of how much the property would sell for. Represents the midpoint value for owner-occupied homes.'
                },
                medianRent: {
                    title: 'Median Rent',
                    description: 'Median monthly rent for renter-occupied units.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Gross rent including contract rent plus utilities. Represents the midpoint monthly rent for all rental units.'
                },
                ownerCostBurden: {
                    title: 'Owners Cost-Burdened',
                    description: 'Percentage of homeowners spending 35% or more of income on housing costs.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Housing costs for owners include mortgage, insurance, taxes, and utilities. 35%+ is considered severely cost-burdened.'
                },
                renterCostBurdenHousing: {
                    title: 'Renters Cost-Burdened',
                    description: 'Percentage of renters spending 35% or more of income on housing costs.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Housing costs for renters include rent and utilities. 35%+ is considered severely cost-burdened by HUD standards.'
                },
                // Demographics
                medianAge: {
                    title: 'Median Age',
                    description: 'Median age of residents in this district.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'The age that divides the population in half - 50% are older, 50% are younger.'
                },
                under18: {
                    title: 'Under 18',
                    description: 'Percentage of population under 18 years old.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Share of total population who are children and adolescents under 18 years of age.'
                },
                over65: {
                    title: '65 and Over',
                    description: 'Percentage of population aged 65 and older.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Share of total population who are seniors aged 65 and over.'
                },
                // Race & Ethnicity
                white: {
                    title: 'White',
                    description: 'Percentage of population identifying as White alone.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Self-reported race from Census data. Includes those who identify as White alone, not Hispanic or Latino.'
                },
                black: {
                    title: 'Black',
                    description: 'Percentage of population identifying as Black or African American alone.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Self-reported race from Census data. Includes those who identify as Black or African American alone.'
                },
                hispanic: {
                    title: 'Hispanic',
                    description: 'Percentage of population identifying as Hispanic or Latino.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Self-reported ethnicity from Census data. Hispanic/Latino is an ethnicity and may include any race.'
                },
                asian: {
                    title: 'Asian',
                    description: 'Percentage of population identifying as Asian alone.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Self-reported race from Census data. Includes those who identify as Asian alone.'
                },
                twoOrMore: {
                    title: 'Two or More Races',
                    description: 'Percentage of population identifying with two or more races.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Self-reported race from Census data. Includes those who identify with multiple racial categories.'
                },
                // Poverty Status
                totalPoverty: {
                    title: 'Total Poverty Rate',
                    description: 'Percentage of all residents living below the federal poverty line.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Based on federal poverty thresholds which vary by family size. Represents overall poverty rate for all ages.'
                },
                childPoverty: {
                    title: 'Child Poverty',
                    description: 'Percentage of children under 18 living below the federal poverty line.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Poverty rate specifically for population under 18 years old. Child poverty often exceeds overall poverty rates.'
                },
                seniorPoverty: {
                    title: 'Senior Poverty',
                    description: 'Percentage of adults 65+ living below the federal poverty line.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Poverty rate specifically for population aged 65 and over.'
                },
                // Employment
                laborForce: {
                    title: 'Labor Force Participation',
                    description: 'Percentage of working-age population in the labor force.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Labor force includes employed and unemployed persons aged 16+ who are working or actively seeking work.'
                },
                unemployment: {
                    title: 'Unemployment Rate',
                    description: 'Percentage of labor force that is unemployed.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Unemployment rate for civilian labor force aged 16 and over who are actively seeking work but not employed.'
                },
                // Education
                lessHS: {
                    title: 'Less Than High School',
                    description: 'Percentage of adults 25+ without a high school diploma.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Educational attainment for population 25 years and over who did not complete high school or equivalent.'
                },
                hsGraduate: {
                    title: 'High School Graduate',
                    description: 'Percentage of adults 25+ with high school diploma or equivalent.',
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: 'Includes high school diploma, GED, or equivalent credential as highest level of education.'
                },
                bachelors: {
                    title: "Bachelor's Degree",
                    description: "Percentage of adults 25+ with a bachelor's degree.",
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: "Educational attainment for population 25+ with a bachelor's degree as their highest credential."
                },
                graduate: {
                    title: 'Graduate/Professional Degree',
                    description: "Percentage of adults 25+ with a master's, doctoral, or professional degree.",
                    source: 'American Community Survey 2017-2021 5-Year Estimates',
                    sourceUrl: 'https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf',
                    methodology: "Includes master's degrees, doctoral degrees (PhD), and professional degrees (MD, JD, etc.)."
                }
            };

            const info = sourceInfo[statType];
            if (!info) return;

            // Create modal content
            const modalHtml = `
                <div class="modal-overlay" onclick="closeMetricSourceModal(event)">
                    <div class="modal-container" style="max-width: 500px;" onclick="event.stopPropagation()">
                        <button class="modal-close" onclick="closeMetricSourceModal()">&times;</button>
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e3a5f; margin-bottom: 1rem;">${info.title}</h2>
                        <div style="margin-bottom: 1rem;">
                            <p style="color: #374151; margin-bottom: 0.5rem;">${info.description}</p>
                        </div>
                        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.5rem;">Methodology</div>
                            <p style="color: #374151; font-size: 0.875rem;">${info.methodology}</p>
                        </div>
                        <div class="modal-source">
                            Source: <a href="${info.sourceUrl}" target="_blank">${info.source}</a>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to body
            const modalWrapper = document.createElement('div');
            modalWrapper.id = 'metricSourceModal';
            modalWrapper.innerHTML = modalHtml;
            document.body.appendChild(modalWrapper);
        }

        // Benchmark Metro Area Source Modal
        function showBenchmarkSource(metroKey) {
            const sourceInfo = {
                nashville: {
                    title: 'Nashville, TN',
                    description: 'Davidson County eviction data covering 146,940 renter households.',
                    source: 'Davidson County Sessions Court + Eviction Lab ETS',
                    sourceUrl: 'https://caselink.nashville.gov/',
                    dataCollector: 'Legal Services Corporation (LSC)',
                    methodology: 'Court records from Davidson County Sessions Court public filing system. Filing rate calculated as filings √∑ renter households (Census ACS). Judgment rate based on 2019 court outcome data (67% of filings result in eviction orders).',
                    notes: 'Nashville excluded from some ETS demographic analyses due to defendant name data quality issues. 2024 judgment rate estimated using 2019 rate.'
                },
                austin: {
                    title: 'Austin, TX',
                    description: 'Travis County eviction data covering approximately 302,000 renter households.',
                    source: 'BASTA Austin / January Advisors',
                    sourceUrl: 'https://evictionlab.org/eviction-tracking/austin-tx/',
                    dataCollector: 'BASTA Austin / January Advisors',
                    methodology: 'Court records collected through partnership with BASTA Austin and January Advisors. Travis County has one of the lower eviction filing rates among tracked Texas metros.',
                    notes: 'Judgment outcome data not consistently reported for Austin. Median judgment amount increased from $1,423 (2019) to $2,984 (2024).'
                },
                san_antonio: {
                    title: 'San Antonio, TX',
                    description: 'Bexar County eviction data covering approximately 300,000 renter households.',
                    source: 'Texas Housers (Public Information Act)',
                    sourceUrl: 'https://texashousers.org/',
                    dataCollector: 'Texas Housers',
                    methodology: 'Data obtained through Public Information Act requests. NOT tracked by Eviction Lab ETS - Texas Housers is the only comprehensive public source for San Antonio eviction data.',
                    notes: '76% landlord win rate in 2022. 59% of all filings result in eviction. More than half of top evicting properties owned by out-of-state investors.'
                },
                jacksonville: {
                    title: 'Jacksonville, FL',
                    description: 'Duval County eviction data - designated "eviction filing capital of Florida".',
                    source: 'January Advisors / Eviction Lab ETS',
                    sourceUrl: 'https://evictionlab.org/eviction-tracking/jacksonville-fl/',
                    dataCollector: 'January Advisors',
                    methodology: 'Court records collected through Eviction Tracking System. Jacksonville has highest monthly eviction rate per 1,000 renters among Florida metros (7.08 vs Miami-Dade 3.70).',
                    notes: '34% of filings come from top 100 buildings. 72% of these buildings are investment-firm owned. 19% above pre-pandemic baseline.'
                },
                memphis: {
                    title: 'Memphis, TN',
                    description: 'Shelby County eviction data covering 156,500 renter households (54% renter rate).',
                    source: 'Legal Services Corporation / Eviction Lab',
                    sourceUrl: 'https://evictionlab.org/eviction-tracking/memphis-tn/',
                    dataCollector: 'Legal Services Corporation (LSC)',
                    methodology: 'Court records from Shelby County. Filing rate of 17.7% is twice the national average. 1 in 5 renters face eviction filing annually.',
                    notes: 'EXTREME outlier: 98% landlord win rate. 81.7% of hearings last under 1 minute. Only 2% tenant win rate in 2019.'
                },
                indianapolis: {
                    title: 'Indianapolis, IN',
                    description: 'Marion County eviction data covering 177,000 renter households.',
                    source: 'Legal Services Corporation / Eviction Lab ETS',
                    sourceUrl: 'https://evictionlab.org/eviction-tracking/indianapolis-in/',
                    dataCollector: 'Legal Services Corporation (LSC)',
                    methodology: 'Court records from Marion County. Filing rate of 16% is double the ETS average of 7.8%. 49% of renters are rent-burdened; 26% severely rent-burdened.',
                    notes: 'State law prohibits local tenant protections since 2020. Black renters face 1.79x higher filing rate than white renters. Top 50 evictors account for 55% of filings.'
                },
                columbus: {
                    title: 'Columbus, OH',
                    description: 'Franklin County eviction data covering 212,650 renter households.',
                    source: 'Eviction Lab ETS / Court Records',
                    sourceUrl: 'https://evictionlab.org/eviction-tracking/columbus-oh/',
                    dataCollector: 'Eviction Lab',
                    methodology: 'Court records from Franklin County. 2024 set all-time high with 25,320 filings - 30% above pre-pandemic levels.',
                    notes: 'Willis Law Firm filed ~14,000 cases in 2024 (50% of all filings). White renters are 53% of population but only 36% of defendants.'
                },
                charlotte: {
                    title: 'Charlotte, NC',
                    description: 'Mecklenburg County eviction data covering ~190,000 renter households.',
                    source: 'NC Judicial Branch / County Housing Dashboard',
                    sourceUrl: 'https://www.nccourts.gov/',
                    dataCollector: 'NC Judicial Branch',
                    methodology: 'NOT tracked by Eviction Lab ETS. Uses fiscal year data (July-June). FY2024: 46,026 filings with 65% judgment rate (29,716 eviction orders).',
                    notes: '84% tenant no-show rate. 82% landlord representation. 97% of cases are failure to pay rent. Median amount owed: $850.'
                },
                national: {
                    title: 'National Average',
                    description: 'Aggregate eviction statistics across the United States.',
                    source: 'Eviction Lab / Collinson et al. QJE 2024',
                    sourceUrl: 'https://evictionlab.org/',
                    dataCollector: 'Princeton Eviction Lab',
                    methodology: 'Filing rate: 7.8% (ETS cities 2024). Judgment rate: ~50% nationally per Collinson et al. Eviction rate: 2.5% (1 in 40 renter households). ~3.6M filings and 900K evictions annually.',
                    notes: 'ETS covers approximately 1/3 of US renters. Judgment rates vary significantly by jurisdiction (NYC ~35%, Cook County ~65%, San Antonio ~76%).'
                }
            };

            const info = sourceInfo[metroKey];
            if (!info) return;

            const modalHtml = `
                <div class="modal-overlay" onclick="closeMetricSourceModal(event)">
                    <div class="modal-container" style="max-width: 550px;" onclick="event.stopPropagation()">
                        <button class="modal-close" onclick="closeMetricSourceModal()">&times;</button>
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: #7c3aed; margin-bottom: 1rem;">${info.title}</h2>
                        <div style="margin-bottom: 1rem;">
                            <p style="color: #374151; margin-bottom: 0.5rem;">${info.description}</p>
                        </div>
                        <div style="background: #f5f3ff; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: #7c3aed; text-transform: uppercase; margin-bottom: 0.5rem;">Data Collector</div>
                            <p style="color: #374151; font-size: 0.875rem;">${info.dataCollector}</p>
                        </div>
                        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.5rem;">Methodology</div>
                            <p style="color: #374151; font-size: 0.875rem;">${info.methodology}</p>
                        </div>
                        ${info.notes ? `
                        <div style="background: #fffbeb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border: 1px solid #fcd34d;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: #92400e; text-transform: uppercase; margin-bottom: 0.5rem;">Important Notes</div>
                            <p style="color: #78350f; font-size: 0.875rem;">${info.notes}</p>
                        </div>
                        ` : ''}
                        <div class="modal-source">
                            Source: <a href="${info.sourceUrl}" target="_blank">${info.source}</a>
                        </div>
                    </div>
                </div>
            `;

            const modalWrapper = document.createElement('div');
            modalWrapper.id = 'metricSourceModal';
            modalWrapper.innerHTML = modalHtml;
            document.body.appendChild(modalWrapper);
        }

        // Benchmark Metric Source Modal (for table header info icons)
        function showBenchmarkMetricSource(metricType) {
            const sourceInfo = {
                filing_rate: {
                    title: 'Filing Rate',
                    description: 'Percentage of renter households facing an eviction filing in a given period.',
                    formula: '(eviction_filings √∑ renter_households) √ó 100',
                    source: 'Eviction Lab ETS / Census ACS',
                    sourceUrl: 'https://evictionlab.org/eviction-tracking',
                    methodology: 'Measures the threat of eviction. Includes serial filings (same household filed multiple times). National average is 7.8% (2024 ETS cities). Higher rates indicate greater housing instability.',
                    interpretation: 'A 10% filing rate means 10 of every 100 renter households faced an eviction filing that year.'
                },
                judgment_rate: {
                    title: 'Judgment Rate',
                    description: 'Percentage of filed cases that result in an eviction judgment/order.',
                    formula: '(eviction_judgments √∑ eviction_filings) √ó 100',
                    source: 'Collinson et al. QJE 2024 / Court Records',
                    sourceUrl: 'https://evictionlab.org/',
                    methodology: 'Measures court outcome rates. National average is ~50% (Collinson et al.). Varies significantly by jurisdiction: NYC ~35% (strong tenant protections), Memphis 98% (minimal protections).',
                    interpretation: 'Lower judgment rates may indicate better tenant protections, higher representation rates, or more cases dismissed/settled.'
                },
                eviction_rate: {
                    title: 'Eviction Rate',
                    description: 'Percentage of renter households receiving an eviction judgment in a given period.',
                    formula: '(eviction_judgments √∑ renter_households) √ó 100',
                    source: 'Eviction Lab / Calculated',
                    sourceUrl: 'https://evictionlab.org/',
                    methodology: 'The "true" eviction rate measuring actual displacement. Calculated as: Filing Rate √ó Judgment Rate. National average is ~2.5% (1 in 40 renter households). Approximately 900,000 households evicted annually in the US.',
                    interpretation: 'Nashville\'s 6.5% eviction rate means 6.5 of every 100 renter households received an eviction order in 2024.'
                },
                vs_prepandemic: {
                    title: 'vs Pre-Pandemic',
                    description: 'Comparison of current filing rates to pre-pandemic baseline (typically 2016-2019 average).',
                    formula: '((current_rate √∑ baseline_rate) - 1) √ó 100',
                    source: 'Eviction Lab ETS / Historical Records',
                    sourceUrl: 'https://evictionlab.org/eviction-tracking',
                    methodology: 'Measures recovery/growth from COVID-era lows. Most cities saw 40-60% drops during eviction moratoriums (2020-2021). Positive values indicate rates exceeding pre-pandemic levels.',
                    interpretation: '+25% means current filings are 25% higher than the 2016-2019 baseline.'
                }
            };

            const info = sourceInfo[metricType];
            if (!info) return;

            const modalHtml = `
                <div class="modal-overlay" onclick="closeMetricSourceModal(event)">
                    <div class="modal-container" style="max-width: 550px;" onclick="event.stopPropagation()">
                        <button class="modal-close" onclick="closeMetricSourceModal()">&times;</button>
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: #7c3aed; margin-bottom: 1rem;">${info.title}</h2>
                        <div style="margin-bottom: 1rem;">
                            <p style="color: #374151; margin-bottom: 0.5rem;">${info.description}</p>
                        </div>
                        <div style="background: #ede9fe; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; font-family: monospace;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: #7c3aed; text-transform: uppercase; margin-bottom: 0.5rem;">Formula</div>
                            <p style="color: #5b21b6; font-size: 0.875rem;">${info.formula}</p>
                        </div>
                        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.5rem;">Methodology</div>
                            <p style="color: #374151; font-size: 0.875rem;">${info.methodology}</p>
                        </div>
                        <div style="background: #ecfdf5; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: #059669; text-transform: uppercase; margin-bottom: 0.5rem;">Interpretation</div>
                            <p style="color: #065f46; font-size: 0.875rem;">${info.interpretation}</p>
                        </div>
                        <div class="modal-source">
                            Source: <a href="${info.sourceUrl}" target="_blank">${info.source}</a>
                        </div>
                    </div>
                </div>
            `;

            const modalWrapper = document.createElement('div');
            modalWrapper.id = 'metricSourceModal';
            modalWrapper.innerHTML = modalHtml;
            document.body.appendChild(modalWrapper);
        }

        // Track active chart filter for month/year
        let chartFilter = null;

        function initCharts() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'point',
                        intersect: true
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} filings`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Filings'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const element = elements[0];
                            const datasetIndex = element.datasetIndex;
                            const monthIndex = element.index;
                            const year = monthlyChart.data.datasets[datasetIndex].label;
                            const month = monthIndex + 1;
                            filterByChartClick(year, month);
                        }
                    },
                    onHover: function(event, elements) {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
        }

        function updateCharts() {
            // Group data by year and month
            const yearMonthCounts = {};

            allData.forEach(record => {
                const date = new Date(record.File_Date);
                if (isNaN(date.getTime())) return;

                const year = date.getFullYear();
                const month = date.getMonth(); // 0-11

                if (!yearMonthCounts[year]) {
                    yearMonthCounts[year] = new Array(12).fill(0);
                }
                yearMonthCounts[year][month]++;
            });

            // Get sorted years
            const years = Object.keys(yearMonthCounts).sort();

            // Color palette for different years - solid colors for bar charts
            const colors = [
                { bg: 'rgba(79, 70, 229, 0.8)', border: '#4f46e5' },   // Indigo
                { bg: 'rgba(16, 185, 129, 0.8)', border: '#10b981' },  // Emerald
                { bg: 'rgba(245, 158, 11, 0.8)', border: '#f59e0b' },  // Amber
                { bg: 'rgba(239, 68, 68, 0.8)', border: '#ef4444' },   // Red
                { bg: 'rgba(6, 182, 212, 0.8)', border: '#06b6d4' },   // Cyan
                { bg: 'rgba(168, 85, 247, 0.8)', border: '#a855f7' },  // Purple
                { bg: 'rgba(236, 72, 153, 0.8)', border: '#ec4899' },  // Pink
                { bg: 'rgba(34, 197, 94, 0.8)', border: '#22c55e' }    // Green
            ];

            // Create datasets for each year
            const datasets = years.map((year, index) => ({
                label: year,
                data: yearMonthCounts[year],
                backgroundColor: colors[index % colors.length].bg,
                borderColor: colors[index % colors.length].border,
                borderWidth: 1,
                borderRadius: 4,
                hoverBackgroundColor: colors[index % colors.length].border
            }));

            // Only update if chart is initialized
            if (!monthlyChart) {
                console.warn('‚ö†Ô∏è monthlyChart not initialized yet, skipping update');
                return;
            }
            monthlyChart.data.datasets = datasets;
            monthlyChart.update();
        }

        function filterByChartClick(year, month) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];

            chartFilter = { year: parseInt(year), month: month };

            filteredData = allData.filter(record => {
                const date = new Date(record.File_Date);
                if (isNaN(date.getTime())) return false;
                return date.getFullYear() === chartFilter.year &&
                       (date.getMonth() + 1) === chartFilter.month;
            });

            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }

            if (gridApi) {
                if (viewMode === 'pivot') {
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setRowData(filteredData);
                }
            }

            updateRecordCount();
            updateChartFilterIndicator();
            updateDemographicsCharts();
            updateDemoFilterIndicator();
            updateStatus(`Filtered to ${monthNames[month - 1]} ${year} - ${filteredData.length} records`, 'success');

            // Persist chart filter state
            debouncedSaveUIState();

            // Update URL with filter state
            updateUrlWithFilters();
        }

        function downloadChart(chartType) {
            if (chartType === 'monthly') {
                downloadMonthlyChartData();
            }
        }

        function downloadMonthlyChartData() {
            if (!monthlyChart || !monthlyChart.data) {
                alert('Chart data not available. Please wait for data to load.');
                return;
            }

            const today = new Date().toISOString().split('T')[0];

            // Build CSV from chart data
            let csv = 'Nashville Eviction Filings by Month - Export\n';
            csv += `Generated: ${new Date().toLocaleString()}\n`;
            csv += 'Privacy Notice: This export contains aggregate statistical data only. Individual tenant information is redacted.\n\n';

            // Get labels (months) and datasets (years)
            const labels = monthlyChart.data.labels;
            const datasets = monthlyChart.data.datasets;

            // Header row with years
            csv += 'Month';
            datasets.forEach(ds => {
                csv += `,${ds.label}`;
            });
            csv += ',Total\n';

            // Data rows
            labels.forEach((month, monthIdx) => {
                csv += month;
                let rowTotal = 0;
                datasets.forEach(ds => {
                    const value = ds.data[monthIdx] || 0;
                    csv += `,${value}`;
                    rowTotal += value;
                });
                csv += `,${rowTotal}\n`;
            });

            // Add yearly totals row
            csv += '\nYearly Totals';
            let grandTotal = 0;
            datasets.forEach(ds => {
                const yearTotal = ds.data.reduce((sum, val) => sum + (val || 0), 0);
                csv += `,${yearTotal}`;
                grandTotal += yearTotal;
            });
            csv += `,${grandTotal}\n`;

            // Add summary statistics
            csv += '\n\nSUMMARY STATISTICS\n';
            csv += 'Metric,Value\n';
            csv += `Total Records in Dataset,${allData.length}\n`;
            csv += `Date Range,"${getDateRange()}"\n`;
            csv += `Average Monthly Filings,${Math.round(grandTotal / (labels.length * datasets.length))}\n`;

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nashville_monthly_evictions_${today}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            console.log('Monthly chart data exported successfully');
        }

        function getDateRange() {
            if (!allData || allData.length === 0) return 'N/A';

            const dates = allData
                .map(r => new Date(r.File_Date))
                .filter(d => !isNaN(d.getTime()))
                .sort((a, b) => a - b);

            if (dates.length === 0) return 'N/A';

            const formatDate = (d) => d.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            return `${formatDate(dates[0])} - ${formatDate(dates[dates.length - 1])}`;
        }

        // Demographics Visualization Charts
        let scatterChart = null;
        let rankedBarChart = null;
        let normalizationMode = 'population'; // 'population' or 'housing'

        function setNormalization(mode) {
            normalizationMode = mode;
            document.getElementById('normPop').classList.toggle('active', mode === 'population');
            document.getElementById('normHousing').classList.toggle('active', mode === 'housing');
            updateDemographicsCharts();
        }

        // Toggle demographics section collapse state
        let demographicsCollapsed = false;
        function toggleDemographicsSection() {
            demographicsCollapsed = !demographicsCollapsed;
            const content = document.getElementById('demographicsContent');
            const icon = document.getElementById('demographicsCollapseIcon');

            if (demographicsCollapsed) {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            } else {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            }

            // Save collapse state
            debouncedSaveUIState();
        }

        // Update the filter indicator on demographics charts
        function updateDemoFilterIndicator() {
            const indicator = document.getElementById('demoFilterIndicator');
            if (!indicator) return;

            const isFiltered = filteredData && allData && filteredData.length !== allData.length;

            if (isFiltered) {
                indicator.classList.remove('hidden');
                indicator.textContent = `Filtered (${filteredData.length.toLocaleString()} records)`;
            } else {
                indicator.classList.add('hidden');
            }
        }

        function getDistrictEvictionData() {
            // Use filteredData if available and filters are active, otherwise use allData
            const dataSource = (filteredData && filteredData.length > 0 && filteredData.length !== allData.length)
                ? filteredData
                : allData;
            if (!districtDemographics || !dataSource) return [];

            const districtCounts = {};
            dataSource.forEach(record => {
                const district = record.District;
                if (district && district !== 'Unknown') {
                    districtCounts[district] = (districtCounts[district] || 0) + 1;
                }
            });

            const data = [];
            for (let i = 1; i <= 35; i++) {
                const districtNum = String(i);
                const demo = districtDemographics.districts[districtNum];
                if (!demo) continue;

                const evictionCount = districtCounts[districtNum] || 0;
                const population = demo.population || 0;
                const housingUnits = demo.housing?.total_housing_units || 0;
                const estimatedRenters = demo.housing?.estimated_renters || 0;

                // Calculate eviction rates - using estimated_renters for accurate per-renter rate
                const evictionRatePer1k = estimatedRenters > 0 ? (evictionCount / estimatedRenters) * 1000 : 0;
                const evictionRatePer100Units = housingUnits > 0 ? (evictionCount / housingUnits) * 100 : 0;

                // Calculate housing units per 1,000 population (housing density)
                const unitsPerPopulation = population > 0 ? (housingUnits / population) * 1000 : 0;

                data.push({
                    district: districtNum,
                    evictionCount,
                    population,
                    housingUnits,
                    estimatedRenters,
                    pctRenters: demo.housing?.pct_renters || 0,
                    evictionRatePer1k,
                    evictionRatePer100Units,
                    unitsPerPopulation,
                    renterCostBurden: demo.housing?.pct_renter_cost_burdened_35plus || 0,
                    povertyRate: demo.poverty?.pct_total_poverty || 0,
                    pctBlack: demo.race_ethnicity?.pct_black || 0,
                    pctHispanic: demo.race_ethnicity?.pct_hispanic || 0,
                    medianIncome: demo.income?.median_household_income || 0,
                    unemployment: demo.employment?.unemployment_rate || 0,
                    medianRent: demo.housing?.median_monthly_rent || 0,
                    pctLessThanHS: demo.education?.pct_less_than_hs || 0,
                    childPoverty: demo.poverty?.pct_child_poverty || 0,
                    pctSenior: demo.age?.pct_65_and_over || 0
                });
            }

            return data;
        }

        function calculateCorrelation(xValues, yValues) {
            const n = xValues.length;
            if (n < 3) return 0;

            const sumX = xValues.reduce((a, b) => a + b, 0);
            const sumY = yValues.reduce((a, b) => a + b, 0);
            const sumXY = xValues.reduce((total, x, i) => total + x * yValues[i], 0);
            const sumX2 = xValues.reduce((total, x) => total + x * x, 0);
            const sumY2 = yValues.reduce((total, y) => total + y * y, 0);

            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

            if (denominator === 0) return 0;
            return numerator / denominator;
        }

        function getCorrelationStrength(r) {
            const absR = Math.abs(r);
            if (absR >= 0.6) return { label: 'Strong', class: 'correlation-strong' };
            if (absR >= 0.3) return { label: 'Moderate', class: 'correlation-moderate' };
            return { label: 'Weak', class: 'correlation-weak' };
        }

        // Calculate linear regression line (least squares method)
        function calculateLinearRegression(xValues, yValues) {
            const n = xValues.length;
            if (n < 2) return null;

            const sumX = xValues.reduce((a, b) => a + b, 0);
            const sumY = yValues.reduce((a, b) => a + b, 0);
            const sumXY = xValues.reduce((total, x, i) => total + x * yValues[i], 0);
            const sumX2 = xValues.reduce((total, x) => total + x * x, 0);

            const meanX = sumX / n;
            const meanY = sumY / n;

            const denominator = n * sumX2 - sumX * sumX;
            if (denominator === 0) return null;

            const slope = (n * sumXY - sumX * sumY) / denominator;
            const intercept = meanY - slope * meanX;

            // Get min and max X values with some padding
            const minX = Math.min(...xValues);
            const maxX = Math.max(...xValues);

            return {
                slope,
                intercept,
                minX,
                maxX,
                // Generate line points
                getLinePoints: function() {
                    return [
                        { x: minX, y: slope * minX + intercept },
                        { x: maxX, y: slope * maxX + intercept }
                    ];
                }
            };
        }

        // Get regression line styling based on correlation strength
        function getRegressionLineStyle(correlation) {
            const absR = Math.abs(correlation);
            // Line width and opacity based on correlation strength
            // Stronger correlation = thicker, more opaque line
            const baseWidth = 2;
            const maxWidth = 6;
            const lineWidth = baseWidth + (absR * (maxWidth - baseWidth));

            // Opacity ranges from 0.2 (weak) to 0.9 (strong)
            const opacity = 0.2 + (absR * 0.7);

            // Color based on direction: positive = green-ish, negative = red-ish
            let color;
            if (absR >= 0.6) {
                color = correlation > 0 ? `rgba(220, 38, 38, ${opacity})` : `rgba(37, 99, 235, ${opacity})`; // Strong: red/blue
            } else if (absR >= 0.3) {
                color = correlation > 0 ? `rgba(249, 115, 22, ${opacity})` : `rgba(59, 130, 246, ${opacity})`; // Moderate: orange/blue
            } else {
                color = `rgba(156, 163, 175, ${opacity})`; // Weak: gray
            }

            return { lineWidth, color, opacity };
        }

        function getDemographicLabel(key) {
            const labels = {
                renterCostBurden: 'Renter Cost Burden (%)',
                povertyRate: 'Poverty Rate (%)',
                pctBlack: '% Black Population',
                pctHispanic: '% Hispanic Population',
                medianIncome: 'Median Household Income ($)',
                unemployment: 'Unemployment Rate (%)',
                medianRent: 'Median Monthly Rent ($)',
                pctLessThanHS: '% Less Than High School',
                childPoverty: 'Child Poverty Rate (%)',
                pctSenior: '% Senior Population (65+)',
                unitsPerPopulation: 'Housing Units per 1,000 Pop'
            };
            return labels[key] || key;
        }

        function initDemographicsCharts() {
            // Initialize Scatter Chart with responsive point sizing
            const scatterCtx = document.getElementById('scatterChart').getContext('2d');
            const isMobile = window.innerWidth < 640;
            const pointRadius = isMobile ? 6 : 8;
            const pointHoverRadius = isMobile ? 9 : 12;

            scatterChart = new Chart(scatterCtx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Districts',
                            data: [],
                            backgroundColor: 'rgba(79, 70, 229, 0.6)',
                            borderColor: '#4f46e5',
                            borderWidth: isMobile ? 1 : 2,
                            pointRadius: pointRadius,
                            pointHoverRadius: pointHoverRadius,
                            pointHoverBackgroundColor: '#4f46e5',
                            order: 2 // Draw points above the line
                        },
                        {
                            label: 'Trend Line',
                            data: [],
                            type: 'line',
                            borderColor: 'rgba(156, 163, 175, 0.5)',
                            borderWidth: 3,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            tension: 0,
                            order: 1 // Draw line behind points
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            filter: function(tooltipItem) {
                                // Only show tooltip for scatter points, not trend line
                                return tooltipItem.datasetIndex === 0;
                            },
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    if (!point.district) return null;
                                    return [
                                        `District ${point.district}`,
                                        `Eviction Rate: ${point.y.toFixed(2)}`,
                                        `${getDemographicLabel(document.getElementById('demoXAxis').value)}: ${point.x.toFixed(1)}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Renter Cost Burden (%)',
                                font: { weight: 'bold' }
                            },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Evictions per 1,000 Renter Households',
                                font: { weight: 'bold' }
                            },
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0 && elements[0].datasetIndex === 0) {
                            const point = scatterChart.data.datasets[0].data[elements[0].index];
                            openDistrictModal(point.district);
                        }
                    },
                    onHover: function(event, elements) {
                        const hasScatterPoint = elements.some(el => el.datasetIndex === 0);
                        event.native.target.style.cursor = hasScatterPoint ? 'pointer' : 'default';
                    }
                }
            });

            // Initialize Ranked Bar Chart
            const barCtx = document.getElementById('rankedBarChart').getContext('2d');
            rankedBarChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Eviction Rate',
                        data: [],
                        backgroundColor: [],
                        borderColor: [],
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const districtData = context.raw;
                                    if (typeof districtData === 'object') {
                                        return [
                                            `Rate: ${districtData.y.toFixed(2)}`,
                                            `Evictions: ${districtData.count}`,
                                            `Population: ${districtData.population.toLocaleString()}`
                                        ];
                                    }
                                    return `Rate: ${context.parsed.x.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Evictions per 1,000 Renter Households',
                                font: { weight: 'bold' }
                            },
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        y: {
                            title: { display: false },
                            grid: { display: false }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const district = rankedBarChart.data.labels[index].replace('District ', '');
                            openDistrictModal(district);
                        }
                    },
                    onHover: function(event, elements) {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });

            updateDemographicsCharts();
        }

        function updateDemographicsCharts() {
            if (!scatterChart || !rankedBarChart || !districtDemographics) return;

            const data = getDistrictEvictionData();
            if (data.length === 0) return;

            const xAxisKey = document.getElementById('demoXAxis').value;
            const yAxisKey = normalizationMode === 'population' ? 'evictionRatePer1k' : 'evictionRatePer100Units';
            const yAxisLabel = normalizationMode === 'population' ? 'Evictions per 1,000 Renter Households' : 'Evictions per 100 Housing Units';

            // Update Scatter Chart
            const scatterData = data.map(d => ({
                x: d[xAxisKey],
                y: d[yAxisKey],
                district: d.district,
                count: d.evictionCount,
                population: d.population
            }));

            scatterChart.data.datasets[0].data = scatterData;
            scatterChart.options.scales.x.title.text = getDemographicLabel(xAxisKey);
            scatterChart.options.scales.y.title.text = yAxisLabel;

            // Update variable labels overlay
            const xVarLabel = document.getElementById('xVarLabel');
            const yVarLabel = document.getElementById('yVarLabel');
            if (xVarLabel) xVarLabel.textContent = getDemographicLabel(xAxisKey);
            if (yVarLabel) yVarLabel.textContent = yAxisLabel;

            // Calculate and display correlation
            const xValues = data.map(d => d[xAxisKey]);
            const yValues = data.map(d => d[yAxisKey]);
            const correlation = calculateCorrelation(xValues, yValues);
            const strength = getCorrelationStrength(correlation);

            // Calculate and add regression line with correlation-based styling
            const regression = calculateLinearRegression(xValues, yValues);
            if (regression) {
                const lineStyle = getRegressionLineStyle(correlation);
                const linePoints = regression.getLinePoints();

                scatterChart.data.datasets[1].data = linePoints;
                scatterChart.data.datasets[1].borderColor = lineStyle.color;
                scatterChart.data.datasets[1].borderWidth = lineStyle.lineWidth;
            } else {
                scatterChart.data.datasets[1].data = [];
            }

            scatterChart.update();

            const correlationBadge = document.getElementById('correlationBadge');
            correlationBadge.textContent = `${strength.label} (r = ${correlation.toFixed(2)})`;
            correlationBadge.className = `correlation-badge ${strength.class}`;

            // Update scatter insight
            const scatterInsight = document.getElementById('scatterInsight');
            const direction = correlation > 0 ? 'positive' : 'negative';
            const demoLabel = getDemographicLabel(xAxisKey).toLowerCase();

            let insightText = '';
            if (Math.abs(correlation) >= 0.6) {
                insightText = `Strong ${direction} correlation: Districts with higher ${demoLabel} tend to have ${correlation > 0 ? 'higher' : 'lower'} eviction rates.`;
                scatterInsight.className = 'demo-insight-box warning';
            } else if (Math.abs(correlation) >= 0.3) {
                insightText = `Moderate ${direction} correlation between ${demoLabel} and eviction rates. Other factors may also play a role.`;
                scatterInsight.className = 'demo-insight-box';
            } else {
                insightText = `Weak correlation suggests ${demoLabel} alone does not strongly predict eviction rates in Nashville districts.`;
                scatterInsight.className = 'demo-insight-box';
            }
            scatterInsight.innerHTML = `<div class="insight-title">Key Insight</div><div class="insight-text">${insightText}</div>`;

            // Update Ranked Bar Chart
            const sortedData = [...data].sort((a, b) => b[yAxisKey] - a[yAxisKey]);
            const labels = sortedData.map(d => `District ${d.district}`);
            const values = sortedData.map(d => d[yAxisKey]);

            // Color gradient from high (red) to low (green)
            const colors = sortedData.map((d, i) => {
                const ratio = i / (sortedData.length - 1);
                if (ratio < 0.2) return 'rgba(239, 68, 68, 0.8)';  // Red for top 20%
                if (ratio < 0.4) return 'rgba(249, 115, 22, 0.8)'; // Orange
                if (ratio < 0.6) return 'rgba(245, 158, 11, 0.8)'; // Amber
                if (ratio < 0.8) return 'rgba(34, 197, 94, 0.7)';  // Light green
                return 'rgba(22, 163, 74, 0.8)';                   // Green for bottom 20%
            });

            rankedBarChart.data.labels = labels;
            rankedBarChart.data.datasets[0].data = values;
            rankedBarChart.data.datasets[0].backgroundColor = colors;
            rankedBarChart.data.datasets[0].borderColor = colors.map(c => c.replace('0.8', '1').replace('0.7', '1'));
            rankedBarChart.options.scales.x.title.text = yAxisLabel;
            rankedBarChart.update();

            // Update bar insight
            const barInsight = document.getElementById('barInsight');
            const top3 = sortedData.slice(0, 3);
            const top3Text = top3.map(d => `District ${d.district} (${d[yAxisKey].toFixed(1)})`).join(', ');
            barInsight.innerHTML = `
                <div class="insight-title">Highest Eviction Rates</div>
                <div class="insight-text">${top3Text}</div>
            `;
        }

        function clearChartFilter() {
            chartFilter = null;
            filteredData = allData;

            // Re-apply any existing filters from the filter panel
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            if (dateFrom || dateTo) {
                applyFilters();
            } else {
                if (viewMode === 'pivot') {
                    pivotData = buildPivotData(pivotDimension);
                }

                if (gridApi) {
                    if (viewMode === 'pivot') {
                        gridApi.setRowData(pivotData);
                    } else {
                        gridApi.setRowData(filteredData);
                    }
                }
            }

            updateRecordCount();
            updateChartFilterIndicator();
            updateDemographicsCharts();
            updateDemoFilterIndicator();
            updateUrlWithFilters();
            updateStatus(`Showing all ${allData.length} records`, 'success');
        }

        function updateChartFilterIndicator() {
            const indicator = document.getElementById('chartFilterIndicator');
            if (!indicator) return;

            if (chartFilter) {
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                indicator.innerHTML = `
                    <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium">
                        Filtered: ${monthNames[chartFilter.month - 1]} ${chartFilter.year}
                        <button onclick="clearChartFilter()" class="ml-2 text-indigo-600 hover:text-indigo-800 font-bold">&times;</button>
                    </span>
                `;
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        // Filter by name (landlord, tenant, or attorney)
        function filterByName(name, type) {
            if (!name || String(name).trim() === '') return;

            const trimmedName = String(name).trim();
            const fieldMap = {
                plaintiff: 'Plaintiff',
                defendant: 'Defendant',
                attorney: 'Attorney',
                defenseAttorney: 'Defense_Attorney'
            };
            const labelMap = {
                plaintiff: 'Landlord',
                defendant: 'Tenant',
                attorney: 'Attorney',
                defenseAttorney: 'Defense Attorney'
            };

            const field = fieldMap[type] || 'Plaintiff';
            const label = labelMap[type] || 'Name';

            // Clear chart filter when filtering by name
            chartFilter = null;
            updateChartFilterIndicator();

            nameFilter = { name: trimmedName, type: type, field: field, label: label };

            filteredData = allData.filter(record => {
                const recordValue = record[field];
                return recordValue && String(recordValue).trim() === trimmedName;
            });

            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }

            if (gridApi) {
                if (viewMode === 'pivot') {
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setRowData(filteredData);
                }
            }

            updateRecordCount();
            updateNameFilterIndicator();
            updateDemographicsCharts();
            updateDemoFilterIndicator();
            updateStatus(`Showing ${filteredData.length} records for ${label}: ${trimmedName}`, 'success');

            // Persist filter state
            debouncedSaveUIState();

            // Update URL with filter state
            updateUrlWithFilters();
        }

        function clearNameFilter() {
            nameFilter = null;
            filteredData = allData;

            // Re-apply any existing filters from the filter panel
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            if (dateFrom || dateTo) {
                applyFilters();
            } else {
                if (viewMode === 'pivot') {
                    pivotData = buildPivotData(pivotDimension);
                }

                if (gridApi) {
                    if (viewMode === 'pivot') {
                        gridApi.setRowData(pivotData);
                    } else {
                        gridApi.setRowData(filteredData);
                    }
                }
            }

            updateRecordCount();
            updateNameFilterIndicator();
            updateDemographicsCharts();
            updateDemoFilterIndicator();
            updateUrlWithFilters();
            updateStatus(`Showing all ${allData.length} records`, 'success');
        }

        function updateNameFilterIndicator() {
            const indicator = document.getElementById('nameFilterIndicator');
            if (!indicator) return;

            if (nameFilter) {
                indicator.innerHTML = `
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium inline-flex items-center mt-2">
                        ${nameFilter.label}: ${nameFilter.name}
                        <button onclick="clearNameFilter()" class="ml-2 text-blue-600 hover:text-blue-800 font-bold">&times;</button>
                    </span>
                `;
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        // Handle clicking on a pivot row to drill down to all records for that group
        function drillDownFromPivot(groupName) {
            if (!groupName || groupName === 'Unknown') return;

            const field = pivotFieldMap[pivotDimension];
            const label = pivotDimensionLabels[pivotDimension];

            // Map pivot dimension to filter type
            const typeMap = {
                plaintiff: 'plaintiff',
                defendant: 'defendant',
                attorney: 'attorney',
                defenseAttorney: 'defenseAttorney'
            };

            const filterType = typeMap[pivotDimension] || 'plaintiff';

            // Clear chart filter
            chartFilter = null;
            updateChartFilterIndicator();

            nameFilter = { name: groupName, type: filterType, field: field, label: label };

            filteredData = allData.filter(record => {
                const recordValue = record[field];
                return recordValue && String(recordValue).trim() === groupName.trim();
            });

            // Switch to records view to show matching records
            viewMode = 'records';

            if (gridApi) {
                gridApi.setColumnDefs(getFullRecordColumnDefs());
                gridApi.setRowData(filteredData);
            }

            updatePivotControls();
            updateRecordCount();
            updateNameFilterIndicator();
            updateStatus(`Showing ${filteredData.length} records for ${label}: ${groupName}`, 'success');
        }

        function createDistrictMap() {
            console.group('üó∫Ô∏è Creating District Map');
            console.log('üìä Filtered data count:', filteredData?.length || 0);

            // Check cache for district counts
            const cacheKey = `district_counts_${filteredData.length}_${filteredData[0]?.Case_Number || 'empty'}`;
            let districtCounts = {};
            let unknownCount = 0;

            const cachedCounts = dataCache.get(cacheKey);
            if (cachedCounts) {
                districtCounts = cachedCounts.districtCounts;
                unknownCount = cachedCounts.unknownCount;
                console.log('‚úÖ Using cached district counts');
            } else {
                console.log('üîÑ Computing district counts from', filteredData.length, 'records...');
                filteredData.forEach(record => {
                    const district = record.District;
                    if (district === 'Unknown' || district === 'unknown') {
                        unknownCount++;
                    } else if (district && !isNaN(district)) {
                        districtCounts[district] = (districtCounts[district] || 0) + 1;
                    }
                });

                console.log('üìà District counts computed:', districtCounts);
                console.log('‚ùì Unknown district count:', unknownCount);

                // Cache the computed counts
                dataCache.set(cacheKey, { districtCounts, unknownCount });
            }
            console.groupEnd();
            
            const maxCount = Math.max(...Object.values(districtCounts), 1);
            const grid = document.getElementById('districtGrid');
            
            let html = '';
            for (let i = 1; i <= 35; i++) {
                const count = districtCounts[i] || 0;
                const intensity = count / maxCount;
                let heatClass = 'heat-0';
                let descriptor = '';
                
                if (intensity > 0.8) {
                    heatClass = 'heat-5';
                    descriptor = '‚óè‚óè‚óè';
                } else if (intensity > 0.6) {
                    heatClass = 'heat-4';
                    descriptor = '‚óè‚óè‚óè';
                } else if (intensity > 0.4) {
                    heatClass = 'heat-3';
                    descriptor = '‚óè‚óè';
                } else if (intensity > 0.2) {
                    heatClass = 'heat-2';
                    descriptor = '‚óè‚óè';
                } else if (intensity > 0) {
                    heatClass = 'heat-1';
                    descriptor = '‚óè';
                } else {
                    descriptor = '‚óã';
                }
                
                // Check if this district is the active filter
                const isActive = activeDistrictFilter !== null && activeDistrictFilter == i;
                const activeClass = isActive ? 'ring-2 ring-indigo-500 ring-offset-2' : '';

                html += `
                    <div class="district-cell ${heatClass} ${activeClass}"
                         onclick="filterByDistrict(${i})"
                         title="District ${i}*">
                        <div class="text-center">
                            <div class="text-sm font-bold opacity-80">${i}</div>
                            <div class="activity-dots mt-1">${descriptor}</div>
                        </div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
            
            // Add unknown count below the grid if there are any
            if (unknownCount > 0) {
                const existingUnknown = grid.parentElement.querySelector('.unknown-district-info');
                if (existingUnknown) {
                    existingUnknown.remove();
                }
                
                const unknownDiv = document.createElement('div');
                const isUnknownActive = activeDistrictFilter === 'Unknown' || activeDistrictFilter === 'unknown';
                const unknownActiveClass = isUnknownActive ? 'ring-2 ring-indigo-500' : '';
                unknownDiv.className = `unknown-district-info mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm cursor-pointer hover:bg-yellow-100 transition ${unknownActiveClass}`;
                unknownDiv.innerHTML = `
                    <span class="text-gray-700">Additional records with unverified district information available*</span>
                    <span class="text-xs text-gray-600 ml-2">(click to view)</span>
                `;
                unknownDiv.onclick = () => filterByDistrict('Unknown');
                grid.parentElement.appendChild(unknownDiv);
            }
        }

        function initGrid() {
            const gridOptions = {
                columnDefs: getFullRecordColumnDefs(),
                rowData: filteredData,
                defaultColDef: {
                    sortable: true,
                    filter: true,
                    resizable: true
                },
                enableCellTextSelection: true,
                ensureDomOrder: true,
                pagination: true,
                paginationPageSize: 50,
                paginationPageSizeSelector: [25, 50, 100, 200],
                animateRows: true,
                onRowClicked: event => {
                    if (viewMode === 'pivot') {
                        // In pivot view, drill down to show all records for the clicked group
                        if (event.data && event.data.groupKey) {
                            drillDownFromPivot(event.data.groupKey);
                        }
                        return;
                    }
                    showCaseModal(event.data);
                },
                onGridReady: params => {
                    gridApi = params.api;
                    if (viewMode === 'pivot') {
                        pivotData = buildPivotData(pivotDimension);
                        gridApi.setColumnDefs(getPivotColumnDefs());
                        gridApi.setRowData(pivotData);
                    } else {
                        // Ensure records mode has correct data after grid is ready
                        gridApi.setRowData(filteredData);
                    }
                    updateRecordCount();
                }
            };

            const gridDiv = document.querySelector('#dataGrid');
            if (gridApi) {
                if (viewMode === 'pivot') {
                    pivotData = buildPivotData(pivotDimension);
                    gridApi.setColumnDefs(getPivotColumnDefs());
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setColumnDefs(getFullRecordColumnDefs());
                    gridApi.setRowData(filteredData);
                }
            } else {
                new agGrid.Grid(gridDiv, gridOptions);
            }
        }

        function updateRecordCount() {
            const count = document.getElementById('recordCount');
            if (!count) return;

            const displayedRows = gridApi ? gridApi.getDisplayedRowCount() : 0;

            if (viewMode === 'pivot') {
                const totalGroups = pivotData.length;
                if (displayedRows && displayedRows !== totalGroups) {
                    count.textContent = `(${displayedRows} of ${totalGroups} summary groups)`;
                } else {
                    count.textContent = `(${totalGroups} summary groups)`;
                }
            } else {
                const totalRecords = filteredData.length;
                if (displayedRows && displayedRows !== totalRecords) {
                    count.textContent = `(${displayedRows} of ${totalRecords} records)`;
                } else {
                    count.textContent = `(${totalRecords} records)`;
                }
            }
        }

        function formatModalValue(value, { fallback = 'Not available', transform } = {}) {
            if (value === null || value === undefined) return fallback;
            let output = typeof transform === 'function' ? transform(value) : value;
            if (typeof output === 'string') {
                const trimmed = output.trim();
                return trimmed.length > 0 ? trimmed : fallback;
            }
            if (Number.isFinite(output)) {
                return output.toLocaleString();
            }
            return output || fallback;
        }

        function showCaseModal(record) {
            if (!record) return;

            const modal = document.getElementById('caseModal');
            if (!modal) return;

            const title = document.getElementById('caseModalTitle');
            const metaContainer = document.getElementById('caseModalMeta');
            const sectionsContainer = document.getElementById('caseModalSections');

            // Helper functions
            const formatDate = value => {
                if (!value) return null;
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return String(value);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            };

            const formatCurrency = value => {
                const numeric = Number(value);
                return Number.isFinite(numeric) ? `$${numeric.toLocaleString()}` : value;
            };

            const formatBoolean = value => {
                if (value === true) return 'Yes';
                if (value === false) return 'No';
                return null;
            };

            const getFieldValue = (record, ...keys) => {
                for (const key of keys) {
                    if (record[key] !== undefined && record[key] !== null && record[key] !== '') {
                        return record[key];
                    }
                }
                return null;
            };

            // Set title
            title.textContent = record.Case_Number ? `Docket #${record.Case_Number}` : 'Case Detail';

            // Build meta cards (key stats at top)
            const statusValue = getFieldValue(record, 'Status', 'status');
            const statusColors = {
                'PENDING': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                'CLOSED': 'bg-gray-100 text-gray-800 border-gray-200',
                'DISMISSED': 'bg-green-100 text-green-800 border-green-200',
                'JUDGMENT': 'bg-red-100 text-red-800 border-red-200'
            };
            const statusColor = statusValue ? (statusColors[statusValue.toUpperCase()] || 'bg-blue-100 text-blue-800 border-blue-200') : null;

            const metaEntries = [
                { label: 'Filed', value: formatDate(getFieldValue(record, 'File_Date', 'file_date', 'filing_date')) },
                { label: 'Status', value: statusValue, className: statusColor },
                { label: 'District', value: getFieldValue(record, 'District', 'council_district_number', 'council_district'), isDistrict: true },
                { label: 'Judge', value: getFieldValue(record, 'Judge', 'judge') }
            ].filter(e => e.value);

            metaContainer.innerHTML = '';
            metaEntries.forEach(entry => {
                const card = document.createElement('div');
                card.className = `p-3 rounded-lg border ${entry.className || 'bg-gray-50 border-gray-100'}`;

                const labelEl = document.createElement('p');
                labelEl.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wide';
                labelEl.textContent = entry.label;

                const valueEl = document.createElement('p');
                valueEl.className = 'mt-1 text-sm font-semibold text-gray-900';

                if (entry.isDistrict && entry.value && entry.value !== 'Unknown') {
                    const linkEl = document.createElement('span');
                    linkEl.className = 'district-link cursor-pointer text-indigo-600 hover:text-indigo-800';
                    linkEl.textContent = `District ${entry.value}`;
                    linkEl.onclick = () => openDistrictModal(entry.value);
                    linkEl.title = 'Click to view district demographics';
                    valueEl.appendChild(linkEl);
                } else {
                    valueEl.textContent = entry.value;
                }

                card.appendChild(labelEl);
                card.appendChild(valueEl);
                metaContainer.appendChild(card);
            });

            // Helper to create a section
            const createSection = (title, fields, options = {}) => {
                const validFields = fields.filter(f => f.value !== null && f.value !== undefined && f.value !== '');
                if (validFields.length === 0 && !options.showEmpty) return null;

                const section = document.createElement('div');
                section.className = `rounded-lg border ${options.borderColor || 'border-gray-200'} overflow-hidden`;

                if (options.bgColor) {
                    section.classList.add(options.bgColor);
                }

                const header = document.createElement('div');
                header.className = `px-4 py-3 ${options.headerBg || 'bg-gray-50'} border-b ${options.borderColor || 'border-gray-200'}`;

                const titleEl = document.createElement('h4');
                titleEl.className = `text-sm font-semibold ${options.titleColor || 'text-gray-700'} uppercase tracking-wide flex items-center gap-2`;
                if (options.icon) {
                    titleEl.innerHTML = `${options.icon} ${title}`;
                } else {
                    titleEl.textContent = title;
                }
                header.appendChild(titleEl);
                section.appendChild(header);

                const content = document.createElement('div');
                content.className = 'p-4 bg-white';

                if (validFields.length === 0) {
                    const emptyEl = document.createElement('p');
                    emptyEl.className = 'text-sm text-gray-400 italic';
                    emptyEl.textContent = options.emptyText || 'No data available';
                    content.appendChild(emptyEl);
                } else {
                    const grid = document.createElement('div');
                    grid.className = options.singleColumn ? 'space-y-3' : 'grid grid-cols-1 md:grid-cols-2 gap-3';

                    validFields.forEach(field => {
                        const item = document.createElement('div');
                        item.className = field.fullWidth ? 'md:col-span-2' : '';

                        const label = document.createElement('p');
                        label.className = 'text-xs font-medium text-gray-500 uppercase tracking-wide';
                        label.textContent = field.label;

                        const value = document.createElement('p');
                        value.className = `mt-1 text-sm ${field.valueClass || 'text-gray-900'} break-words`;

                        if (field.isClickable && field.onClick) {
                            const link = document.createElement('span');
                            link.className = 'text-indigo-600 hover:text-indigo-800 cursor-pointer hover:underline';
                            link.textContent = field.value;
                            link.onclick = field.onClick;
                            value.appendChild(link);
                        } else if (field.isHtml) {
                            value.innerHTML = field.value;
                        } else {
                            value.textContent = field.value;
                        }

                        item.appendChild(label);
                        item.appendChild(value);
                        grid.appendChild(item);
                    });
                    content.appendChild(grid);
                }

                section.appendChild(content);
                return section;
            };

            // Helper to create timeline section for pleadings/judgments
            const createTimelineSection = (title, items, options = {}) => {
                if (!items || !Array.isArray(items) || items.length === 0) return null;

                const section = document.createElement('div');
                section.className = `rounded-lg border ${options.borderColor || 'border-gray-200'} overflow-hidden`;

                const header = document.createElement('div');
                header.className = `px-4 py-3 ${options.headerBg || 'bg-gray-50'} border-b ${options.borderColor || 'border-gray-200'}`;

                const titleEl = document.createElement('h4');
                titleEl.className = `text-sm font-semibold ${options.titleColor || 'text-gray-700'} uppercase tracking-wide flex items-center gap-2`;
                titleEl.innerHTML = `${options.icon || ''} ${title} <span class="text-xs font-normal text-gray-500">(${items.length})</span>`;
                header.appendChild(titleEl);
                section.appendChild(header);

                const content = document.createElement('div');
                content.className = 'p-4 bg-white';

                const timeline = document.createElement('div');
                timeline.className = 'space-y-2';

                items.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = `flex items-start gap-3 ${index < items.length - 1 ? 'pb-2 border-b border-gray-100' : ''}`;

                    const dateEl = document.createElement('span');
                    dateEl.className = 'text-xs font-medium text-gray-500 min-w-[80px]';
                    dateEl.textContent = item.date ? formatDate(item.date) : '‚Äî';

                    const descEl = document.createElement('span');
                    descEl.className = `text-sm ${options.itemClass || 'text-gray-700'}`;
                    descEl.textContent = item.description || item.code || item.type || '';
                    if (item.for) {
                        descEl.textContent += ` (${item.for})`;
                    }

                    row.appendChild(dateEl);
                    row.appendChild(descEl);
                    timeline.appendChild(row);
                });

                content.appendChild(timeline);
                section.appendChild(content);
                return section;
            };

            // Clear sections container
            sectionsContainer.innerHTML = '';

            // 1. PARTIES SECTION
            const defendantName = getFieldValue(record, 'Defendant', 'defendant', 'Defendant_Respondent', 'defendant_respondent');
            const partiesSection = createSection('Parties', [
                { label: 'Plaintiff / Landlord', value: getFieldValue(record, 'Plaintiff', 'plaintiff', 'Plaintiff_Petitioner', 'plaintiff_petitioner'), fullWidth: true },
                { label: 'Defendant / Tenant', value: defendantName ? getDefendantDisplayName(defendantName) : null, fullWidth: true },
                { label: 'Landlord Attorney', value: getFieldValue(record, 'Attorney', 'attorney', 'plaintiff_attorney') },
                { label: 'Defense Attorney', value: getFieldValue(record, 'Defense_Attorney', 'defense_attorney') },
                { label: 'Individual Landlord', value: formatBoolean(getFieldValue(record, 'individual_ll', 'Individual_LL')) }
            ], { icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>' });
            if (partiesSection) sectionsContainer.appendChild(partiesSection);

            // 2. PROPERTY SECTION
            const address = getFieldValue(record, 'Address', 'address', 'Address_1', 'address_1');
            const address2 = getFieldValue(record, 'Address_2', 'address_2');
            const cityStateZip = getFieldValue(record, 'city_state_zip', 'City_State_Zip');
            const formattedAddress = getFieldValue(record, 'address_formatted', 'formatted_address');
            const lat = getFieldValue(record, 'latitude', 'lat');
            const lng = getFieldValue(record, 'longitude', 'lng', 'lon');

            const propertySection = createSection('Property', [
                { label: 'Street Address', value: formattedAddress || address, fullWidth: true },
                { label: 'Address Line 2', value: address2 },
                { label: 'City, State, ZIP', value: cityStateZip },
                { label: 'Coordinates', value: lat && lng ? `${lat}, ${lng}` : null },
                { label: 'Council Member', value: getFieldValue(record, 'council_member', 'Council_Member') }
            ], { icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>' });
            if (propertySection) sectionsContainer.appendChild(propertySection);

            // 3. SERVICE & WRIT SECTION - Custom layout for clarity
            const writIssued = getFieldValue(record, 'writ_issued_date', 'Writ_Issued_Date');
            const writServed = getFieldValue(record, 'writ_served_date', 'Writ_Served_Date');
            const serviceDate = getFieldValue(record, 'service_date', 'Service_Date');

            const hasWritData = writIssued || writServed;

            // Build custom section for better clarity between summons and writ
            const writSection = document.createElement('div');
            writSection.className = 'rounded-lg border border-gray-200 overflow-hidden';

            // Main header
            const writHeader = document.createElement('div');
            writHeader.className = 'px-4 py-3 bg-gray-50 border-b border-gray-200';
            writHeader.innerHTML = `
                <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wide flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                    Service & Enforcement
                </h4>
            `;
            writSection.appendChild(writHeader);

            const writContent = document.createElement('div');
            writContent.className = 'bg-white divide-y divide-gray-100';

            // Subsection 1: Summons Served
            const summonsSub = document.createElement('div');
            summonsSub.className = 'p-4';
            summonsSub.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="text-xs font-semibold text-blue-700 uppercase tracking-wide">Summons Served</p>
                        <p class="text-sm text-gray-600 mt-0.5">Defendant notified of lawsuit</p>
                        <p class="mt-2 text-lg font-medium ${serviceDate ? 'text-gray-900' : 'text-gray-400 italic'}">${serviceDate ? formatDate(serviceDate) : 'Not recorded'}</p>
                    </div>
                </div>
            `;
            writContent.appendChild(summonsSub);

            // Subsection 2: Writ of Restitution (Physical Removal by Sheriff)
            const writSub = document.createElement('div');
            writSub.className = hasWritData ? 'p-4 bg-red-50' : 'p-4';
            writSub.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full ${hasWritData ? 'bg-red-200' : 'bg-gray-100'} flex items-center justify-center">
                        <svg class="w-4 h-4 ${hasWritData ? 'text-red-700' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="text-xs font-semibold ${hasWritData ? 'text-red-800' : 'text-gray-500'} uppercase tracking-wide">Writ of Restitution (Paper Writ)</p>
                        <p class="text-sm ${hasWritData ? 'text-red-700' : 'text-gray-600'} mt-0.5">Sheriff authorized to physically remove occupants</p>
                        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <p class="text-xs text-gray-500 uppercase">Writ Issued</p>
                                <p class="text-sm font-medium ${writIssued ? 'text-orange-700' : 'text-gray-400 italic'}">${writIssued ? formatDate(writIssued) : 'Not issued'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase">Sheriff Paper Return</p>
                                <p class="text-sm font-bold ${writServed ? 'text-red-700' : 'text-gray-400 italic'}">${writServed ? formatDate(writServed) : 'Not executed'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            writContent.appendChild(writSub);

            writSection.appendChild(writContent);
            sectionsContainer.appendChild(writSection);

            // 4. JUDGMENT & OUTCOME SECTION
            const judgmentFor = getFieldValue(record, 'judgment_for', 'Judgment_For');
            const judgmentSection = createSection('Judgment & Outcome', [
                { label: 'Hearing Date', value: formatDate(getFieldValue(record, 'Hearing_Date', 'hearing_date')) },
                { label: 'Judgment Date', value: formatDate(getFieldValue(record, 'judgment_date', 'Judgment_Date')) },
                {
                    label: 'Judgment For',
                    value: judgmentFor,
                    valueClass: judgmentFor ? (judgmentFor.toLowerCase().includes('plaintiff') ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold') : 'text-gray-900'
                },
                { label: 'Judgment Type', value: getFieldValue(record, 'judgment_type', 'Judgment_Type') },
                { label: 'Disposition', value: getFieldValue(record, 'Disposition', 'disposition') },
                { label: 'Disposition Date', value: formatDate(getFieldValue(record, 'Disposition_Date', 'disposition_date')) },
                {
                    label: 'Case Dismissed',
                    value: formatBoolean(getFieldValue(record, 'case_dismissed', 'Case_Dismissed')),
                    valueClass: record.case_dismissed === true ? 'text-green-600 font-semibold' : 'text-gray-900'
                },
                { label: 'Dismissal Date', value: formatDate(getFieldValue(record, 'dismissal_date', 'Dismissal_Date')) }
            ], { icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg>' });
            if (judgmentSection) sectionsContainer.appendChild(judgmentSection);

            // EVICTION EXECUTION SECTION REMOVED - eviction_executed, eviction_date, eviction_method were derived/interpreted
            // Raw data is available in pleadings[] timeline and writ_issued_date/writ_served_date fields

            // 6. FINANCIAL SECTION
            const financialSection = createSection('Financial', [
                { label: 'Amount Claimed', value: getFieldValue(record, 'Amount_Claimed', 'amount_claimed') ? formatCurrency(getFieldValue(record, 'Amount_Claimed', 'amount_claimed')) : null },
                { label: 'Judgment Amount', value: getFieldValue(record, 'Amount_Judgment', 'amount_judgment') ? formatCurrency(getFieldValue(record, 'Amount_Judgment', 'amount_judgment')) : null }
            ], { icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' });
            if (financialSection) sectionsContainer.appendChild(financialSection);

            // 7. PLEADINGS TIMELINE
            const pleadings = record.pleadings;
            const pleadingsSection = createTimelineSection('Court Filings (Pleadings)', pleadings, {
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>',
                itemClass: 'text-gray-700'
            });
            if (pleadingsSection) sectionsContainer.appendChild(pleadingsSection);

            // 8. JUDGMENTS TIMELINE
            const judgments = record.judgments;
            const judgmentsSection = createTimelineSection('Judgments', judgments, {
                icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>',
                headerBg: 'bg-red-50',
                borderColor: 'border-red-200',
                titleColor: 'text-red-800',
                itemClass: 'text-red-700'
            });
            if (judgmentsSection) sectionsContainer.appendChild(judgmentsSection);

            // 9. CASE NOTES
            const notes = getFieldValue(record, 'Notes', 'notes');
            if (notes) {
                const notesSection = createSection('Notes', [
                    { label: 'Case Notes', value: notes, fullWidth: true }
                ], {
                    icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>',
                    singleColumn: true
                });
                if (notesSection) sectionsContainer.appendChild(notesSection);
            }

            // 10. ALL OTHER DATA (catch-all for any fields we haven't explicitly handled)
            const handledKeys = new Set([
                'Case_Number', 'case_number', 'id', 'File_Date', 'file_date', 'filing_date',
                'Status', 'status', 'District', 'council_district_number', 'council_district',
                'Judge', 'judge', 'Plaintiff', 'plaintiff', 'Plaintiff_Petitioner', 'plaintiff_petitioner',
                'Defendant', 'defendant', 'Defendant_Respondent', 'defendant_respondent',
                'Attorney', 'attorney', 'plaintiff_attorney', 'Defense_Attorney', 'defense_attorney',
                'individual_ll', 'Individual_LL', 'Address', 'address', 'Address_1', 'address_1',
                'Address_2', 'address_2', 'city_state_zip', 'City_State_Zip',
                'address_formatted', 'formatted_address', 'latitude', 'lat', 'longitude', 'lng', 'lon',
                'council_member', 'Council_Member', 'writ_issued_date', 'Writ_Issued_Date',
                'writ_served_date', 'Writ_Served_Date', 'service_date', 'Service_Date',
                'Hearing_Date', 'hearing_date', 'judgment_date', 'Judgment_Date',
                'judgment_for', 'Judgment_For', 'judgment_type', 'Judgment_Type',
                'Disposition', 'disposition', 'Disposition_Date', 'disposition_date',
                'case_dismissed', 'Case_Dismissed', 'dismissal_date', 'Dismissal_Date',
                'eviction_executed', 'Eviction_Executed', 'eviction_date', 'Eviction_Date',
                'eviction_method', 'Eviction_Method', 'Amount_Claimed', 'amount_claimed',
                'Amount_Judgment', 'amount_judgment', 'pleadings', 'judgments', 'Notes', 'notes',
                'Office', 'office', 'Description', 'description', 'logged_at', 'action', 'case_data'
            ]);

            const otherFields = [];
            for (const [key, value] of Object.entries(record)) {
                if (handledKeys.has(key)) continue;
                if (value === null || value === undefined || value === '') continue;
                if (typeof value === 'object' && !Array.isArray(value)) continue; // Skip nested objects

                // Format the key nicely
                const label = key
                    .replace(/_/g, ' ')
                    .replace(/([A-Z])/g, ' $1')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .split(' ')
                    .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
                    .join(' ');

                let displayValue = value;
                if (Array.isArray(value)) {
                    displayValue = JSON.stringify(value);
                } else if (typeof value === 'boolean') {
                    displayValue = value ? 'Yes' : 'No';
                }

                otherFields.push({ label, value: String(displayValue) });
            }

            if (otherFields.length > 0) {
                const otherSection = createSection('Additional Data', otherFields, {
                    icon: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>'
                });
                if (otherSection) sectionsContainer.appendChild(otherSection);
            }

            // Show if no sections were added
            if (sectionsContainer.childElementCount === 0) {
                const emptyEl = document.createElement('p');
                emptyEl.className = 'text-sm text-gray-500 text-center py-8';
                emptyEl.textContent = 'No additional details available for this record.';
                sectionsContainer.appendChild(emptyEl);
            }

            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function hideCaseModal() {
            const modal = document.getElementById('caseModal');
            if (!modal) return;
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        // District Demographics Modal
        let districtDemographics = null;

        async function loadDistrictDemographics() {
            console.group('üèòÔ∏è Loading District Demographics');

            // Check cache first (demographics rarely change, cache for 1 hour)
            const cached = dataCache.get('district_demographics');
            if (cached) {
                districtDemographics = cached;
                console.log('‚úÖ Using cached district demographics');
                console.log('üìä Districts loaded:', Object.keys(cached.districts || {}).length);
                console.groupEnd();
                return;
            }

            try {
                console.log('üì° Fetching district-data.json...');
                const response = await fetch('district-data.json');
                console.log('üì° Response:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });

                if (response.ok) {
                    districtDemographics = await response.json();
                    console.log('‚úÖ District demographics loaded:', {
                        hasDistricts: !!districtDemographics?.districts,
                        districtCount: Object.keys(districtDemographics?.districts || {}).length,
                        hasCountyTotals: !!districtDemographics?.county_totals,
                        sampleDistrict: districtDemographics?.districts?.['1']
                    });
                    // Cache for 1 hour
                    dataCache.set('district_demographics', districtDemographics, 60 * 60 * 1000);
                } else {
                    console.error('‚ùå Failed to load district demographics:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('‚ùå Error loading district demographics:', {
                    message: error.message,
                    name: error.name,
                    stack: error.stack
                });
            }
            console.groupEnd();
        }

        function openDistrictModal(districtNumber) {
            if (!districtNumber || districtNumber === 'Unknown') return;

            const modal = document.getElementById('districtModal');
            const demo = districtDemographics?.districts?.[districtNumber];
            const county = districtDemographics?.county_totals;

            document.getElementById('districtModalTitle').textContent = `District ${districtNumber}`;
            document.getElementById('districtModalSubtitle').textContent = 'Community Profile';
            document.getElementById('districtModalLocation').innerHTML = getDistrictLocationSVG(districtNumber, 'lg');

            // Calculate eviction stats for this district
            let evictionCount = 0;
            let districtEvictions = [];
            if (allData) {
                districtEvictions = allData.filter(r => r.District == districtNumber);
                evictionCount = districtEvictions.length;
            }

            // Calculate district-specific date range from actual evictions
            let districtDateRange = { earliest: null, latest: null, days: 0, annualizationFactor: 1 };
            if (districtEvictions.length > 0) {
                let earliest = null;
                let latest = null;
                for (const record of districtEvictions) {
                    if (record.File_Date) {
                        const date = new Date(record.File_Date);
                        if (!isNaN(date.getTime())) {
                            if (earliest === null || date < earliest) earliest = date;
                            if (latest === null || date > latest) latest = date;
                        }
                    }
                }
                if (earliest && latest) {
                    const days = Math.ceil((latest - earliest) / (1000 * 60 * 60 * 24));
                    const annualizationFactor = days > 0 ? 365 / days : 1;
                    districtDateRange = { earliest, latest, days, annualizationFactor };
                }
            }

            // Pro-rate to full year if we have partial year data
            const annualizedCount = Math.round(evictionCount * districtDateRange.annualizationFactor);
            const isProRated = districtDateRange.days > 0 && districtDateRange.days < 365;

            let html = '';

            // Eviction Context Section
            const population = demo?.population || 0;
            const estimatedRenters = demo?.housing?.estimated_renters || 0;
            // Use annualized count for per-renter calculation
            const evictionRate = estimatedRenters > 0 ? ((annualizedCount / estimatedRenters) * 1000).toFixed(2) : 'N/A';
            const povertyRate = demo?.poverty?.pct_total_poverty || 0;
            const medianIncome = demo?.income?.median_household_income || 0;
            const countyMedianIncome = county?.median_household_income || 65348;
            const countyPovertyRate = county?.poverty_rate_percent || 15.0;
            const renterCostBurden = demo?.housing?.pct_renter_cost_burdened_35plus || 0;

            // Format date range info for display - use district-specific dates
            const dateRangeInfo = districtDateRange.earliest && districtDateRange.latest
                ? `${districtDateRange.earliest.toLocaleDateString()} - ${districtDateRange.latest.toLocaleDateString()} (${districtDateRange.days} days)`
                : '';

            html += `
                <div class="demo-section">
                    <div class="demo-section-title">Eviction Context</div>
                    ${dateRangeInfo ? `<div class="demo-section-subtitle" style="font-size: 11px; color: #666; margin-bottom: 8px;">Data: ${dateRangeInfo}</div>` : ''}
                    <div class="demo-grid">
                        <div class="demo-item clickable" onclick="showDistrictStatSource('evictionFilings', event)" title="Click for source">
                            <div class="label">Eviction Filings</div>
                            <div class="value highlight">${evictionCount.toLocaleString()}</div>
                        </div>
                        <div class="demo-item clickable" onclick="showDistrictStatSource('population', event)" title="Click for source">
                            <div class="label">Population</div>
                            <div class="value">${population.toLocaleString()}</div>
                        </div>
                        <div class="demo-item clickable" onclick="showDistrictStatSource('evictionRatePerRenters', event)" title="Click for calculation details">
                            <div class="label">Per 1,000 Renters${isProRated ? ' (ann.)' : ''}</div>
                            <div class="value highlight">${evictionRate}</div>
                        </div>
                        <div class="demo-item">
                            <div class="label">Renter Households</div>
                            <div class="value">${estimatedRenters.toLocaleString()}</div>
                        </div>
                        <div class="demo-item">
                            <div class="label">Poverty Rate</div>
                            <div class="value ${povertyRate > countyPovertyRate ? 'highlight' : ''}">${povertyRate}%</div>
                            <div class="compare-county">
                                ${povertyRate > countyPovertyRate
                                    ? `<span class="arrow-up">+${(povertyRate - countyPovertyRate).toFixed(1)}%</span> above county avg`
                                    : `<span class="arrow-down">${(countyPovertyRate - povertyRate).toFixed(1)}%</span> below county avg`}
                            </div>
                        </div>
                        <div class="demo-item clickable" onclick="showDistrictStatSource('medianIncome', event)" title="Click for source">
                            <div class="label">Median Household Income</div>
                            <div class="value ${medianIncome < countyMedianIncome ? 'highlight' : 'positive'}">$${medianIncome.toLocaleString()}</div>
                            <div class="compare-county">
                                ${medianIncome < countyMedianIncome
                                    ? `<span class="arrow-up">$${(countyMedianIncome - medianIncome).toLocaleString()}</span> below county avg`
                                    : `<span class="arrow-down">$${(medianIncome - countyMedianIncome).toLocaleString()}</span> above county avg`}
                            </div>
                        </div>
                        <div class="demo-item clickable" onclick="showDistrictStatSource('renterCostBurden', event)" title="Click for source">
                            <div class="label">Renters Cost-Burdened (35%+)</div>
                            <div class="value ${renterCostBurden > 35 ? 'highlight' : ''}">${renterCostBurden}%</div>
                        </div>
                    </div>
                </div>
            `;

            if (demo) {
                // Housing Section
                html += `
                    <div class="demo-section">
                        <div class="demo-section-title">Housing</div>
                        <div class="demo-grid">
                            <div class="demo-item clickable" onclick="showDistrictStatSource('housingUnits', event)" title="Click for source">
                                <div class="label">Housing Units</div>
                                <div class="value">${demo.housing?.total_housing_units?.toLocaleString() || '-'}</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('occupiedRate', event)" title="Click for source">
                                <div class="label">Occupied</div>
                                <div class="value">${demo.housing?.pct_occupied || '-'}%</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('medianHomeValue', event)" title="Click for source">
                                <div class="label">Median Home Value</div>
                                <div class="value">$${demo.housing?.median_owner_value?.toLocaleString() || '-'}</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('medianRent', event)" title="Click for source">
                                <div class="label">Median Rent</div>
                                <div class="value">$${demo.housing?.median_monthly_rent?.toLocaleString() || '-'}</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('ownerCostBurden', event)" title="Click for source">
                                <div class="label">Owners Cost-Burdened</div>
                                <div class="value">${demo.housing?.pct_owner_cost_burdened_35plus || '-'}%</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('renterCostBurdenHousing', event)" title="Click for source">
                                <div class="label">Renters Cost-Burdened</div>
                                <div class="value ${(demo.housing?.pct_renter_cost_burdened_35plus || 0) > 35 ? 'highlight' : ''}">${demo.housing?.pct_renter_cost_burdened_35plus || '-'}%</div>
                            </div>
                        </div>
                    </div>
                `;

                // Demographics Section
                html += `
                    <div class="demo-section">
                        <div class="demo-section-title">Demographics</div>
                        <div class="demo-grid">
                            <div class="demo-item clickable" onclick="showDistrictStatSource('medianAge', event)" title="Click for source">
                                <div class="label">Median Age</div>
                                <div class="value">${demo.median_age || '-'}</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('under18', event)" title="Click for source">
                                <div class="label">Under 18</div>
                                <div class="value">${demo.age?.pct_under_18 || '-'}%</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('over65', event)" title="Click for source">
                                <div class="label">65 and Over</div>
                                <div class="value">${demo.age?.pct_65_and_over || '-'}%</div>
                            </div>
                        </div>
                    </div>
                `;

                // Race/Ethnicity
                html += `
                    <div class="demo-section">
                        <div class="demo-section-title">Race & Ethnicity</div>
                        <div class="demo-grid">
                            <div class="demo-item clickable" onclick="showDistrictStatSource('white', event)" title="Click for source">
                                <div class="label">White</div>
                                <div class="value">${demo.race_ethnicity?.pct_white || '-'}%</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('black', event)" title="Click for source">
                                <div class="label">Black</div>
                                <div class="value">${demo.race_ethnicity?.pct_black || '-'}%</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('hispanic', event)" title="Click for source">
                                <div class="label">Hispanic</div>
                                <div class="value">${demo.race_ethnicity?.pct_hispanic || '-'}%</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('asian', event)" title="Click for source">
                                <div class="label">Asian</div>
                                <div class="value">${demo.race_ethnicity?.pct_asian || '-'}%</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('twoOrMore', event)" title="Click for source">
                                <div class="label">Two or More</div>
                                <div class="value">${demo.race_ethnicity?.pct_two_or_more || '-'}%</div>
                            </div>
                        </div>
                    </div>
                `;

                // Poverty Section
                html += `
                    <div class="demo-section">
                        <div class="demo-section-title">Poverty Status</div>
                        <div class="demo-grid">
                            <div class="demo-item clickable" onclick="showDistrictStatSource('totalPoverty', event)" title="Click for source">
                                <div class="label">Total Poverty Rate</div>
                                <div class="value ${(demo.poverty?.pct_total_poverty || 0) > countyPovertyRate ? 'highlight' : ''}">${demo.poverty?.pct_total_poverty || '-'}%</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('childPoverty', event)" title="Click for source">
                                <div class="label">Child Poverty</div>
                                <div class="value ${(demo.poverty?.pct_child_poverty || 0) > 20 ? 'highlight' : ''}">${demo.poverty?.pct_child_poverty || '-'}%</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('seniorPoverty', event)" title="Click for source">
                                <div class="label">Senior Poverty</div>
                                <div class="value">${demo.poverty?.pct_senior_poverty || '-'}%</div>
                            </div>
                        </div>
                    </div>
                `;

                // Employment
                html += `
                    <div class="demo-section">
                        <div class="demo-section-title">Employment</div>
                        <div class="demo-grid">
                            <div class="demo-item clickable" onclick="showDistrictStatSource('laborForce', event)" title="Click for source">
                                <div class="label">Labor Force Participation</div>
                                <div class="value">${demo.employment?.labor_force_participation_rate || '-'}%</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('unemployment', event)" title="Click for source">
                                <div class="label">Unemployment Rate</div>
                                <div class="value ${(demo.employment?.unemployment_rate || 0) > 6 ? 'highlight' : ''}">${demo.employment?.unemployment_rate || '-'}%</div>
                            </div>
                        </div>
                    </div>
                `;

                // Education
                html += `
                    <div class="demo-section">
                        <div class="demo-section-title">Educational Attainment (25+)</div>
                        <div class="demo-grid">
                            <div class="demo-item clickable" onclick="showDistrictStatSource('lessHS', event)" title="Click for source">
                                <div class="label">Less Than High School</div>
                                <div class="value">${demo.education?.pct_less_than_hs || '-'}%</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('hsGraduate', event)" title="Click for source">
                                <div class="label">High School Graduate</div>
                                <div class="value">${demo.education?.pct_hs_graduate || '-'}%</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('bachelors', event)" title="Click for source">
                                <div class="label">Bachelor's Degree</div>
                                <div class="value">${demo.education?.pct_bachelors || '-'}%</div>
                            </div>
                            <div class="demo-item clickable" onclick="showDistrictStatSource('graduate', event)" title="Click for source">
                                <div class="label">Graduate/Professional</div>
                                <div class="value">${demo.education?.pct_graduate_professional || '-'}%</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="demo-section">
                        <p style="color: #6b7280; text-align: center;">Demographic data not available for this district.</p>
                    </div>
                `;
            }

            // Source
            html += `
                <div class="modal-source">
                    Source: <a href="https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf?ct=1706286236" target="_blank">Metropolitan Social Services Know Your Community 2023</a>
                    <br>Data: American Community Survey 2017-2021 5-Year Estimates
                </div>
            `;

            document.getElementById('districtModalBody').innerHTML = html;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeDistrictModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('districtModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Attorney Modal Functions
        let attorneyModalData = [];
        let attorneyModalSort = { field: 'filings', direction: 'desc' };
        let attorneyModalFilter = '';
        let currentAttorneyTab = 'plaintiff'; // 'plaintiff' or 'defense'

        function openAttorneyModal() {
            const modal = document.getElementById('attorneyModal');

            // Build attorney data from current filtered data
            attorneyModalData = buildAttorneyRollupData();
            attorneyModalSort = { field: 'filings', direction: 'desc' };
            attorneyModalFilter = '';
            currentAttorneyTab = 'plaintiff';

            // Clear search input
            const searchInput = document.getElementById('attorneySearchInput');
            if (searchInput) searchInput.value = '';

            // Reset tabs
            setAttorneyTab('plaintiff');

            // Populate summary stats
            populateAttorneySummary();

            // Populate table
            renderAttorneyTable();

            // Show modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function setAttorneyTab(tab) {
            currentAttorneyTab = tab;
            attorneyModalFilter = '';

            // Clear search input
            const searchInput = document.getElementById('attorneySearchInput');
            if (searchInput) searchInput.value = '';

            // Update tab styles
            const plaintiffTab = document.getElementById('plaintiffAttorneyTab');
            const defenseTab = document.getElementById('defenseAttorneyTab');

            if (tab === 'plaintiff') {
                plaintiffTab.style.borderBottomColor = '#4f46e5';
                plaintiffTab.style.color = '#4f46e5';
                defenseTab.style.borderBottomColor = 'transparent';
                defenseTab.style.color = '#6b7280';
            } else {
                plaintiffTab.style.borderBottomColor = 'transparent';
                plaintiffTab.style.color = '#6b7280';
                defenseTab.style.borderBottomColor = '#4f46e5';
                defenseTab.style.color = '#4f46e5';
            }

            // Reset sort for new tab
            attorneyModalSort = { field: 'filings', direction: 'desc' };

            // Re-render table
            renderAttorneyTable();
        }

        function closeAttorneyModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('attorneyModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function buildAttorneyRollupData() {
            const plaintiffSummaries = new Map();
            const defenseSummaries = new Map();
            const dataSource = filteredData.length > 0 ? filteredData : allData;
            const totalRecords = dataSource.length;

            // Pro Se tokens to filter out
            const proSeTokens = new Set([
                'PRO SE', 'PRO-SE', 'PROSE', 'PRO SE LITIGANT', 'PRS'
            ]);

            function cleanAttorneyName(att) {
                if (!att) return null;
                // Remove leading/trailing punctuation and whitespace
                att = att.replace(/^[^A-Za-z0-9'&.-]+/, '').replace(/[^A-Za-z0-9'&.-]+$/, '').trim();
                if (!att) return null;

                // Check if it's a Pro Se representation
                const upperAtt = att.replace(/\./g, '').toUpperCase();
                if (proSeTokens.has(upperAtt)) {
                    return 'Pro Se';
                }
                return att;
            }

            dataSource.forEach(record => {
                const rawAttorney = record.Attorney || '';

                // Split by semicolon - first is plaintiff's attorney, second (if exists) is defendant's attorney
                const attorneyParts = String(rawAttorney)
                    .split(/[;]/)
                    .map(a => a.trim());

                // First attorney is plaintiff's attorney (landlord's lawyer)
                const plaintiffAttorney = cleanAttorneyName(attorneyParts[0]) || 'Pro Se';

                // Second attorney (if present) is defendant's attorney (tenant's lawyer)
                const defenseAttorney = attorneyParts.length > 1 ? cleanAttorneyName(attorneyParts[1]) : null;

                const fileDate = record.File_Date ? new Date(record.File_Date) : null;
                const validFileDate = fileDate && !isNaN(fileDate) ? fileDate : null;

                // Process plaintiff's attorney
                if (!plaintiffSummaries.has(plaintiffAttorney)) {
                    plaintiffSummaries.set(plaintiffAttorney, {
                        name: plaintiffAttorney,
                        filings: 0,
                        lastFiled: null,
                        properties: new Set(),
                        plaintiffs: new Set(),
                        type: 'plaintiff'
                    });
                }

                const pSummary = plaintiffSummaries.get(plaintiffAttorney);
                pSummary.filings += 1;

                if (validFileDate && (!pSummary.lastFiled || validFileDate > pSummary.lastFiled)) {
                    pSummary.lastFiled = validFileDate;
                }

                if (record.Address) {
                    pSummary.properties.add(String(record.Address).trim().toLowerCase());
                }

                if (record.Plaintiff) {
                    pSummary.plaintiffs.add(String(record.Plaintiff).trim());
                }

                // Process defendant's attorney if present
                if (defenseAttorney) {
                    if (!defenseSummaries.has(defenseAttorney)) {
                        defenseSummaries.set(defenseAttorney, {
                            name: defenseAttorney,
                            filings: 0,
                            lastFiled: null,
                            properties: new Set(),
                            defendants: new Set(),
                            type: 'defense'
                        });
                    }

                    const dSummary = defenseSummaries.get(defenseAttorney);
                    dSummary.filings += 1;

                    if (validFileDate && (!dSummary.lastFiled || validFileDate > dSummary.lastFiled)) {
                        dSummary.lastFiled = validFileDate;
                    }

                    if (record.Address) {
                        dSummary.properties.add(String(record.Address).trim().toLowerCase());
                    }
                }
            });

            // Store defense data for separate display
            attorneyDefenseData = Array.from(defenseSummaries.values())
                .map(summary => ({
                    name: summary.name,
                    filings: summary.filings,
                    percent: totalRecords > 0 ? (summary.filings / totalRecords) * 100 : 0,
                    lastFiled: summary.lastFiled,
                    properties: summary.properties.size,
                    type: 'defense'
                }))
                .sort((a, b) => b.filings - a.filings);

            // Return plaintiff attorney data (primary view)
            return Array.from(plaintiffSummaries.values())
                .map(summary => ({
                    name: summary.name,
                    filings: summary.filings,
                    percent: totalRecords > 0 ? (summary.filings / totalRecords) * 100 : 0,
                    lastFiled: summary.lastFiled,
                    properties: summary.properties.size,
                    plaintiffs: summary.plaintiffs.size,
                    topPlaintiffs: Array.from(summary.plaintiffs).slice(0, 3),
                    type: 'plaintiff'
                }))
                .sort((a, b) => b.filings - a.filings);
        }

        // Store defense attorney data separately
        let attorneyDefenseData = [];

        function populateAttorneySummary() {
            const container = document.getElementById('attorneyModalSummary');
            if (!container) return;

            const dataSource = filteredData.length > 0 ? filteredData : allData;
            const totalCases = dataSource.length;

            // Plaintiff attorney stats
            const totalPlaintiffAttorneys = attorneyModalData.length;
            const plaintiffProSeCount = attorneyModalData.find(a => a.name === 'Pro Se')?.filings || 0;
            const plaintiffRepresentedPercent = totalCases > 0 ? (((totalCases - plaintiffProSeCount) / totalCases) * 100).toFixed(1) : 0;

            // Defense attorney stats
            const totalDefenseAttorneys = attorneyDefenseData.length;
            const casesWithDefense = attorneyDefenseData.reduce((sum, a) => sum + a.filings, 0);
            const defenseRepPercent = totalCases > 0 ? ((casesWithDefense / totalCases) * 100).toFixed(1) : 0;

            // Top attorneys
            const topPlaintiff = attorneyModalData.find(a => a.name !== 'Pro Se');
            const topDefense = attorneyDefenseData.find(a => a.name !== 'Pro Se');

            container.innerHTML = `
                <div class="attorney-modal-stat">
                    <div class="value">${totalCases.toLocaleString()}</div>
                    <div class="label">Total Cases</div>
                </div>
                <div class="attorney-modal-stat">
                    <div class="value">${totalPlaintiffAttorneys.toLocaleString()}</div>
                    <div class="label">Landlord Attorneys</div>
                </div>
                <div class="attorney-modal-stat">
                    <div class="value">${plaintiffRepresentedPercent}%</div>
                    <div class="label">Landlords w/ Attorney</div>
                </div>
                <div class="attorney-modal-stat">
                    <div class="value">${totalDefenseAttorneys.toLocaleString()}</div>
                    <div class="label">Defense Attorneys</div>
                </div>
                <div class="attorney-modal-stat">
                    <div class="value">${defenseRepPercent}%</div>
                    <div class="label">Tenants w/ Attorney</div>
                </div>
            `;
        }

        function renderAttorneyTable() {
            const tbody = document.getElementById('attorneyTableBody');
            if (!tbody) return;

            // Select data source based on current tab
            const sourceData = currentAttorneyTab === 'plaintiff' ? attorneyModalData : attorneyDefenseData;

            // Filter data
            let displayData = sourceData;
            if (attorneyModalFilter) {
                const searchLower = attorneyModalFilter.toLowerCase();
                displayData = sourceData.filter(a =>
                    a.name.toLowerCase().includes(searchLower)
                );
            }

            // Sort data
            displayData = [...displayData].sort((a, b) => {
                let valA, valB;
                switch (attorneyModalSort.field) {
                    case 'name':
                        valA = a.name.toLowerCase();
                        valB = b.name.toLowerCase();
                        break;
                    case 'filings':
                        valA = a.filings;
                        valB = b.filings;
                        break;
                    case 'percent':
                        valA = a.percent;
                        valB = b.percent;
                        break;
                    case 'lastFiled':
                        valA = a.lastFiled ? a.lastFiled.getTime() : 0;
                        valB = b.lastFiled ? b.lastFiled.getTime() : 0;
                        break;
                    case 'properties':
                        valA = a.properties;
                        valB = b.properties;
                        break;
                    default:
                        valA = a.filings;
                        valB = b.filings;
                }

                if (typeof valA === 'string') {
                    return attorneyModalSort.direction === 'asc'
                        ? valA.localeCompare(valB)
                        : valB.localeCompare(valA);
                }
                return attorneyModalSort.direction === 'asc' ? valA - valB : valB - valA;
            });

            // Show message if no data
            if (displayData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: #6b7280;">
                            ${attorneyModalFilter ? 'No attorneys match your search.' : (currentAttorneyTab === 'defense' ? 'No defense attorneys found in the current data.' : 'No attorneys found.')}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = displayData.map(attorney => `
                <tr>
                    <td>
                        <span class="attorney-name" onclick="drillDownToAttorney('${escapeHtml(attorney.name)}', '${currentAttorneyTab}')">${escapeHtml(attorney.name)}</span>
                    </td>
                    <td class="num-col">${attorney.filings.toLocaleString()}</td>
                    <td class="num-col">
                        <div class="pct-bar">
                            <div class="pct-bar-fill" style="width: ${Math.min(attorney.percent * 2, 100)}px"></div>
                            <span>${attorney.percent.toFixed(1)}%</span>
                        </div>
                    </td>
                    <td>${attorney.lastFiled ? attorney.lastFiled.toLocaleDateString() : '‚Äî'}</td>
                    <td class="num-col">${attorney.properties.toLocaleString()}</td>
                </tr>
            `).join('');

            // Update sort indicators
            updateAttorneySortIndicators();
        }

        function sortAttorneyTable(field) {
            if (attorneyModalSort.field === field) {
                attorneyModalSort.direction = attorneyModalSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                attorneyModalSort.field = field;
                attorneyModalSort.direction = field === 'name' ? 'asc' : 'desc';
            }
            renderAttorneyTable();
        }

        function updateAttorneySortIndicators() {
            const headers = document.querySelectorAll('#attorneyTable th.sortable');
            headers.forEach(th => {
                const field = th.dataset.sort;
                const indicator = th.querySelector('.sort-indicator');
                if (field === attorneyModalSort.field) {
                    th.classList.add('sorted');
                    indicator.textContent = attorneyModalSort.direction === 'asc' ? '‚Üë' : '‚Üì';
                } else {
                    th.classList.remove('sorted');
                    indicator.textContent = '‚Üï';
                }
            });
        }

        function filterAttorneyTable(searchTerm) {
            attorneyModalFilter = searchTerm;
            renderAttorneyTable();
        }

        function drillDownToAttorney(attorneyName, attorneyType) {
            closeAttorneyModal();
            if (attorneyType === 'defense') {
                filterByName(attorneyName, 'defenseAttorney');
            } else {
                filterByName(attorneyName, 'attorney');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Demographics Table Functions
        function getDistrictData() {
            if (!districtDemographics?.districts) return [];

            const county = districtDemographics.county_totals;
            const countyMedianIncome = county?.median_household_income || 65348;
            const countyPovertyRate = county?.poverty_rate_percent || 15.0;

            const districts = [];
            for (let i = 1; i <= 35; i++) {
                const demo = districtDemographics.districts[i];
                if (!demo) continue;

                // Get evictions for this district and calculate district-specific date range
                let evictionCount = 0;
                let districtEvictions = [];
                let earliest = null;
                let latest = null;

                if (allData) {
                    districtEvictions = allData.filter(r => r.District == i);
                    evictionCount = districtEvictions.length;

                    // Calculate district-specific date range
                    for (const record of districtEvictions) {
                        if (record.File_Date) {
                            const date = new Date(record.File_Date);
                            if (!isNaN(date.getTime())) {
                                if (earliest === null || date < earliest) earliest = date;
                                if (latest === null || date > latest) latest = date;
                            }
                        }
                    }
                }

                // Calculate months of data coverage for this district
                let monthsOfData = 0;
                if (earliest && latest) {
                    const days = Math.ceil((latest - earliest) / (1000 * 60 * 60 * 24));
                    monthsOfData = Math.max(days / 30, 1); // At least 1 month to avoid division issues
                }

                // Calculate per-month average
                const evictionsPerMonth = monthsOfData > 0 ? evictionCount / monthsOfData : 0;

                const population = demo.population || 0;
                const estimatedRenters = demo.housing?.estimated_renters || 0;
                // Use per-month average annualized to yearly for per-renter calculation
                const annualizedCount = evictionsPerMonth * 12;
                // Calculate eviction rate per 1,000 renter households for accurate comparison
                const evictionRate = estimatedRenters > 0 ? ((annualizedCount / estimatedRenters) * 1000) : 0;
                const medianIncome = demo.income?.median_household_income || 0;
                const povertyRate = demo.poverty?.pct_total_poverty || 0;
                const renterCostBurden = demo.housing?.pct_renter_cost_burdened_35plus || 0;
                const unemployment = demo.employment?.unemployment_rate || 0;

                districts.push({
                    district: i,
                    evictions: evictionCount,
                    evictionsPerMonth: evictionsPerMonth,
                    monthsOfData: monthsOfData,
                    evictionRate: evictionRate,
                    population: population,
                    estimatedRenters: estimatedRenters,
                    medianIncome: medianIncome,
                    povertyRate: povertyRate,
                    renterCostBurden: renterCostBurden,
                    unemployment: unemployment,
                    isHighPoverty: povertyRate > countyPovertyRate,
                    isLowIncome: medianIncome < countyMedianIncome
                });
            }

            return districts;
        }

        function renderDemographicsTable() {
            const data = getDistrictData();
            if (data.length === 0) return;

            const sortField = document.getElementById('demographicsSortField')?.value || 'district';
            const sortOrder = document.getElementById('demographicsSortOrder')?.value || 'asc';

            // Sort data
            data.sort((a, b) => {
                let valA = a[sortField];
                let valB = b[sortField];
                if (sortOrder === 'desc') {
                    return valB - valA;
                }
                return valA - valB;
            });

            // Calculate averages for highlighting (using per-month averages)
            const avgEvictionsPerMonth = data.reduce((s, d) => s + d.evictionsPerMonth, 0) / data.length;
            const avgEvictionRate = data.reduce((s, d) => s + d.evictionRate, 0) / data.length;

            // Update per capita header
            const perCapitaHeader = document.getElementById('perCapitaHeader');
            if (perCapitaHeader) {
                perCapitaHeader.textContent = 'Per 1K';
                perCapitaHeader.title = 'Annualized evictions per 1,000 renter households (based on monthly average)';
            }

            // Show data range info - explain per-month averaging
            const dataRangeEl = document.getElementById('demographicsDataRange');
            if (dataRangeEl && globalDataRange.earliest && globalDataRange.latest) {
                dataRangeEl.style.display = 'block';
                const dateRange = `${globalDataRange.earliest.toLocaleDateString()} - ${globalDataRange.latest.toLocaleDateString()}`;
                dataRangeEl.innerHTML = `üìä Data: ${dateRange} ‚Äî <em>Showing monthly averages for fair comparison across districts</em>`;
            }

            // Update county summary
            const county = districtDemographics?.county_totals;
            const totalEvictions = allData ? allData.length : 0;
            // Calculate evictions per year using the data's date range
            const evictionsPerYear = globalDataRange.days > 0
                ? Math.round(totalEvictions * (365 / globalDataRange.days))
                : totalEvictions;
            document.getElementById('countyTotalEvictions').textContent = evictionsPerYear.toLocaleString();
            document.getElementById('countyPopulation').textContent = (county?.population || 0).toLocaleString();
            document.getElementById('countyMedianIncome').textContent = '$' + (county?.median_household_income || 0).toLocaleString();
            document.getElementById('countyPovertyRate').textContent = (county?.poverty_rate_percent || 0) + '%';

            // Render table
            const tbody = document.getElementById('demographicsTableBody');
            let html = '';

            data.forEach(d => {
                const isHighEviction = d.evictionsPerMonth > avgEvictionsPerMonth * 1.5;
                const badgeClass = isHighEviction ? 'high-evictions' : '';

                html += `
                    <tr onclick="openDistrictModal(${d.district})">
                        <td><div style="display: flex; align-items: center; gap: 8px;">${getDistrictLocationSVG(d.district)}<span class="district-num-badge ${badgeClass}">${d.district}</span></div></td>
                        <td class="${d.evictionsPerMonth > avgEvictionsPerMonth ? 'value-highlight' : ''}">${d.evictionsPerMonth.toFixed(1)}</td>
                        <td class="${d.evictionRate > avgEvictionRate ? 'value-highlight' : ''}">${d.evictionRate.toFixed(2)}</td>
                        <td>${d.population.toLocaleString()}</td>
                        <td class="${d.isLowIncome ? 'value-highlight' : 'value-positive'}">$${d.medianIncome.toLocaleString()}</td>
                        <td class="${d.isHighPoverty ? 'value-highlight' : ''}">${d.povertyRate}%</td>
                        <td class="${d.renterCostBurden > 40 ? 'value-highlight' : ''}">${d.renterCostBurden}%</td>
                        <td class="${d.unemployment > 6 ? 'value-highlight' : ''}">${d.unemployment}%</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // Also render card view
            renderDemographicsCards(data, avgEvictionsPerMonth);
        }

        function renderDemographicsCards(data, avgEvictionsPerMonth) {
            const cardContainer = document.getElementById('demographicsCardView');
            let html = '';

            data.forEach(d => {
                const isHighEviction = d.evictionsPerMonth > avgEvictionsPerMonth * 1.5;
                const badgeClass = isHighEviction ? 'high-evictions' : '';

                html += `
                    <div class="demo-card" onclick="openDistrictModal(${d.district})">
                        <div class="demo-card-header">
                            ${getDistrictLocationSVG(d.district)}
                            <span class="district-num-badge ${badgeClass}">${d.district}</span>
                            <span class="demo-card-title">District ${d.district}</span>
                        </div>
                        <div class="demo-card-stat">
                            <span class="demo-card-stat-label">Avg/Month</span>
                            <span class="demo-card-stat-value ${d.evictionsPerMonth > avgEvictionsPerMonth ? 'highlight' : ''}">${d.evictionsPerMonth.toFixed(1)}</span>
                        </div>
                        <div class="demo-card-stat">
                            <span class="demo-card-stat-label">Per 1K Renters</span>
                            <span class="demo-card-stat-value">${d.evictionRate.toFixed(2)}</span>
                        </div>
                        <div class="demo-card-stat">
                            <span class="demo-card-stat-label">Population</span>
                            <span class="demo-card-stat-value">${d.population.toLocaleString()}</span>
                        </div>
                        <div class="demo-card-stat">
                            <span class="demo-card-stat-label">Med. Income</span>
                            <span class="demo-card-stat-value ${d.isLowIncome ? 'highlight' : ''}">$${d.medianIncome.toLocaleString()}</span>
                        </div>
                        <div class="demo-card-stat">
                            <span class="demo-card-stat-label">Poverty</span>
                            <span class="demo-card-stat-value ${d.isHighPoverty ? 'highlight' : ''}">${d.povertyRate}%</span>
                        </div>
                    </div>
                `;
            });

            cardContainer.innerHTML = html;
        }

        // ==========================================
        // METRO BENCHMARKS FUNCTIONS
        // ==========================================
        let benchmarkData = null;
        let metroBenchmarkChart = null;
        let currentBenchmarkMetric = 'filing_rate';

        // Helper function to ensure benchmark data is loaded (used by export functions)
        async function ensureBenchmarkDataLoaded() {
            if (!benchmarkData) {
                try {
                    const response = await fetch('benchmarks.json');
                    if (response.ok) {
                        benchmarkData = await response.json();
                        console.log('Benchmark data loaded for export:', benchmarkData);
                        return true;
                    } else {
                        console.error('Failed to load benchmarks.json');
                        return false;
                    }
                } catch (error) {
                    console.error('Error loading benchmarks:', error);
                    return false;
                }
            }
            return true;
        }

        async function loadAndRenderBenchmarks() {
            const chartContainer = document.getElementById('metroBenchmarkChart')?.parentElement;
            const tableBody = document.getElementById('benchmarkTableBody');

            // Show loading state
            if (chartContainer && !benchmarkData) {
                chartContainer.innerHTML = '<div class="flex items-center justify-center h-64 text-gray-500"><svg class="animate-spin h-8 w-8 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Loading benchmark data...</div>';
            }

            if (!benchmarkData) {
                try {
                    const response = await fetch('benchmarks.json');
                    if (response.ok) {
                        benchmarkData = await response.json();
                        console.log('Benchmark data loaded:', benchmarkData);
                    } else {
                        console.error('Failed to load benchmarks.json, status:', response.status);
                        if (chartContainer) {
                            chartContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-64 text-red-500"><svg class="h-12 w-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg><span class="font-semibold">Failed to load benchmark data</span><span class="text-sm text-gray-500 mt-1">Please refresh the page to try again</span></div>';
                        }
                        return;
                    }
                } catch (error) {
                    console.error('Error loading benchmarks:', error);
                    if (chartContainer) {
                        chartContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-64 text-red-500"><svg class="h-12 w-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg><span class="font-semibold">Error loading benchmark data</span><span class="text-sm text-gray-500 mt-1">' + error.message + '</span></div>';
                    }
                    return;
                }
            }

            // Restore chart canvas if it was replaced
            if (chartContainer && !document.getElementById('metroBenchmarkChart')) {
                chartContainer.innerHTML = '<canvas id="metroBenchmarkChart" height="300"></canvas>';
            }

            renderBenchmarkChart();
            renderBenchmarkTable();
        }

        function setBenchmarkMetric(metric) {
            currentBenchmarkMetric = metric;

            // Update button states
            document.querySelectorAll('.benchmark-metric-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('metric' + metric.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('')).classList.add('active');

            // Update explanation
            const explanations = {
                'filing_rate': '<strong>Filing Rate:</strong> Eviction filings (detainer warrants) √∑ renter households. Measures threat of eviction.',
                'judgment_rate': '<strong>Judgment Rate:</strong> Eviction judgments √∑ eviction filings. What % of cases result in eviction orders. National avg ~50%.',
                'eviction_rate': '<strong>Eviction Rate:</strong> Eviction judgments √∑ renter households. Actual displacement rate. National avg ~2.5%.'
            };
            document.getElementById('metricExplanation').innerHTML = explanations[metric];

            // Re-render chart and table
            renderBenchmarkChart();
            renderBenchmarkTable();
        }

        function getBenchmarkChartData() {
            if (!benchmarkData) return { labels: [], data: [], colors: [] };

            const summary = benchmarkData.comparative_summary;
            let rankedData;

            switch(currentBenchmarkMetric) {
                case 'filing_rate':
                    rankedData = summary.filing_rates_ranked;
                    break;
                case 'judgment_rate':
                    rankedData = summary.judgment_rates_pct_of_filings_ranked;
                    break;
                case 'eviction_rate':
                    rankedData = summary.eviction_rates_pct_of_renters_ranked;
                    break;
                default:
                    rankedData = summary.filing_rates_ranked;
            }

            const labels = rankedData.map(d => d.city);
            const data = rankedData.map(d => d.rate);
            const colors = rankedData.map(d => {
                if (d.city === 'Nashville') return '#7c3aed';
                if (d.city === 'National Average') return '#10b981';
                return '#94a3b8';
            });

            return { labels, data, colors };
        }

        function renderBenchmarkChart() {
            const canvas = document.getElementById('metroBenchmarkChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const chartData = getBenchmarkChartData();

            if (metroBenchmarkChart) {
                metroBenchmarkChart.destroy();
            }

            const metricLabels = {
                'filing_rate': 'Filing Rate (%)',
                'judgment_rate': 'Judgment Rate (% of filings)',
                'eviction_rate': 'Eviction Rate (% of renters)'
            };

            metroBenchmarkChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: metricLabels[currentBenchmarkMetric],
                        data: chartData.data,
                        backgroundColor: chartData.colors,
                        borderColor: chartData.colors.map(c => c === '#7c3aed' ? '#5b21b6' : c === '#10b981' ? '#059669' : '#64748b'),
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.raw.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: metricLabels[currentBenchmarkMetric]
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    weight: function(context) {
                                        return chartData.labels[context.index] === 'Nashville' ? 'bold' : 'normal';
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderBenchmarkTable() {
            const tbody = document.getElementById('benchmarkTableBody');
            if (!tbody || !benchmarkData) return;

            const metros = [
                { name: 'Nashville', key: 'nashville', data: benchmarkData.nashville, isNashville: true },
                { name: 'Austin', key: 'austin', data: benchmarkData.comparable_cities.austin },
                { name: 'San Antonio', key: 'san_antonio', data: benchmarkData.comparable_cities.san_antonio },
                { name: 'Jacksonville', key: 'jacksonville', data: benchmarkData.comparable_cities.jacksonville },
                { name: 'Memphis', key: 'memphis', data: benchmarkData.comparable_cities.memphis },
                { name: 'Indianapolis', key: 'indianapolis', data: benchmarkData.comparable_cities.indianapolis },
                { name: 'Columbus', key: 'columbus', data: benchmarkData.comparable_cities.columbus },
                { name: 'Charlotte', key: 'charlotte', data: benchmarkData.comparable_cities.charlotte }
            ];

            const nationalAvg = benchmarkData.national_benchmarks;

            let html = metros.map(metro => {
                const fr = metro.data.filing_rates;
                const jr = metro.data.judgment_rates_pct_of_filings;
                const er = metro.data.eviction_rates_pct_of_renters;

                const filingRate = fr?.['2024_calculated'] || fr?.['2024_estimated'] || fr?.['2024'] || fr?.pre_pandemic_2016_2019 || '-';
                const judgmentRate = jr?.['2019'] || jr?.['fy2024'] || jr?.['2022'] || jr?.rate || (jr?.data_available === false ? 'N/A' : '-');
                const evictionRate = er?.['2024_estimated'] || er?.['2019_estimated'] || er?.['fy2024_estimated'] || (er?.data_available === false ? 'N/A' : '-');

                // Get pre-pandemic comparison
                let prePandemic = '-';
                if (fr?.vs_pre_pandemic_percent) {
                    const pct = fr.vs_pre_pandemic_percent;
                    prePandemic = pct > 100 ? `+${pct - 100}%` : `${pct - 100}%`;
                } else if (metro.data.year_over_year?.['2024_vs_pre_pandemic_pct']) {
                    const pct = metro.data.year_over_year['2024_vs_pre_pandemic_pct'];
                    prePandemic = pct > 100 ? `+${pct - 100}%` : `${pct - 100}%`;
                }

                const rowClass = metro.isNashville ? 'bg-purple-50 font-semibold' : '';
                const highlight = metro.isNashville ? 'text-purple-700' : '';

                return `
                    <tr class="${rowClass}">
                        <td class="px-4 py-2 ${highlight}">${metro.name}</td>
                        <td class="px-4 py-2 text-right">${typeof filingRate === 'number' ? filingRate.toFixed(1) + '%' : filingRate}</td>
                        <td class="px-4 py-2 text-right">${typeof judgmentRate === 'number' ? judgmentRate + '%' : judgmentRate}</td>
                        <td class="px-4 py-2 text-right">${typeof evictionRate === 'number' ? evictionRate.toFixed(1) + '%' : evictionRate}</td>
                        <td class="px-4 py-2 text-right">${prePandemic}</td>
                        <td class="px-4 py-2 text-center">
                            <button onclick="showBenchmarkSource('${metro.key}')" class="source-btn" title="View data source for ${metro.name}">
                                üìä
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Add national average row
            html += `
                <tr class="bg-green-50 border-t-2 border-green-200">
                    <td class="px-4 py-2 font-semibold text-green-700">National Average</td>
                    <td class="px-4 py-2 text-right font-semibold">${nationalAvg.filing_rates_pct_of_renters['2024_ets_cities_avg']}%</td>
                    <td class="px-4 py-2 text-right font-semibold">${nationalAvg.judgment_rates_pct_of_filings.national_avg}%</td>
                    <td class="px-4 py-2 text-right font-semibold">${nationalAvg.eviction_rates_pct_of_renters.current_estimated}%</td>
                    <td class="px-4 py-2 text-right">baseline</td>
                    <td class="px-4 py-2 text-center">
                        <button onclick="showBenchmarkSource('national')" class="source-btn" title="View data source for National Average">
                            üìä
                        </button>
                    </td>
                </tr>
            `;

            tbody.innerHTML = html;
        }

        // ============================================
        // BENCHMARK EXPORT FUNCTIONS
        // ============================================

        function toggleBenchmarkExportMenu() {
            const menu = document.getElementById('benchmarkExportMenu');
            menu.classList.toggle('hidden');

            // Close menu when clicking outside
            if (!menu.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeBenchmarkExportMenuOnClickOutside);
                }, 0);
            }
        }

        function closeBenchmarkExportMenuOnClickOutside(e) {
            const dropdown = document.getElementById('benchmarkExportDropdown');
            if (!dropdown.contains(e.target)) {
                document.getElementById('benchmarkExportMenu').classList.add('hidden');
                document.removeEventListener('click', closeBenchmarkExportMenuOnClickOutside);
            }
        }

        // ==========================================
        // DOWNLOAD MODAL FUNCTIONS
        // ==========================================
        let selectedDownloadFormat = 'csv';

        function openDownloadModal() {
            // Update the filename with today's date
            updateDownloadFileName();

            // Show modal
            document.getElementById('downloadModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeDownloadModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('downloadModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function selectDownloadFormat(format) {
            selectedDownloadFormat = format;

            // Update UI - remove selected from all, add to clicked
            document.querySelectorAll('.download-format-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`.download-format-option[data-format="${format}"]`).classList.add('selected');

            // Update filename preview
            updateDownloadFileName();
        }

        function updateDownloadFileName() {
            const today = new Date().toISOString().split('T')[0];
            const extensions = {
                csv: 'csv',
                json: 'json',
                pdf: 'pdf',
                excel: 'xlsx'
            };
            const sizes = {
                csv: '~15 KB',
                json: '~25 KB',
                pdf: '~150 KB',
                excel: '~20 KB'
            };
            const icons = {
                csv: '&#128196;',
                json: '{ }',
                pdf: '&#128209;',
                excel: '&#128202;'
            };

            const fileName = `nashville_eviction_benchmarks_${today}.${extensions[selectedDownloadFormat]}`;
            document.getElementById('downloadFileName').textContent = fileName;
            document.querySelector('.download-file-preview .file-size').textContent = `Estimated size: ${sizes[selectedDownloadFormat]}`;
            document.querySelector('.download-file-preview .file-icon').innerHTML = icons[selectedDownloadFormat];
        }

        async function confirmDownload() {
            // Close modal
            closeDownloadModal();

            // Call the appropriate export function based on selected format
            switch (selectedDownloadFormat) {
                case 'csv':
                    await exportBenchmarkCSV();
                    break;
                case 'json':
                    await exportBenchmarkJSON();
                    break;
                case 'pdf':
                    await exportBenchmarkPDF();
                    break;
                case 'excel':
                    await exportBenchmarkExcel();
                    break;
            }
        }

        // Nav Download Menu Functions
        function toggleNavDownloadMenu() {
            const menu = document.getElementById('navDownloadMenu');
            menu.classList.toggle('open');

            // Close menu when clicking outside
            if (menu.classList.contains('open')) {
                setTimeout(() => {
                    document.addEventListener('click', closeNavDownloadMenuOnClickOutside);
                }, 0);
            }
        }

        function closeNavDownloadMenu() {
            const menu = document.getElementById('navDownloadMenu');
            menu.classList.remove('open');
            document.removeEventListener('click', closeNavDownloadMenuOnClickOutside);
        }

        function closeNavDownloadMenuOnClickOutside(e) {
            const dropdown = e.target.closest('.download-dropdown');
            if (!dropdown) {
                closeNavDownloadMenu();
            }
        }

        function showExportLoading(message = 'Generating report...') {
            const overlay = document.createElement('div');
            overlay.id = 'exportLoadingOverlay';
            overlay.className = 'export-loading-overlay';
            overlay.innerHTML = `
                <div class="export-loading-content">
                    <div class="export-spinner"></div>
                    <div class="text-lg font-semibold text-gray-900">${message}</div>
                    <div class="text-sm text-gray-500 mt-1">Please wait...</div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideExportLoading() {
            const overlay = document.getElementById('exportLoadingOverlay');
            if (overlay) overlay.remove();
        }

        async function exportBenchmarkCSV() {
            // Ensure benchmark data is loaded before exporting
            const loaded = await ensureBenchmarkDataLoaded();
            if (!loaded) {
                alert('Failed to load benchmark data. Please try again.');
                return;
            }

            // Close dropdown
            document.getElementById('benchmarkExportMenu').classList.add('hidden');

            const today = new Date().toISOString().split('T')[0];

            // Build CSV with all benchmark data
            let csv = '';

            // Header section
            csv += 'Nashville Eviction Benchmark Report\n';
            csv += `Generated: ${new Date().toLocaleString()}\n`;
            csv += `Data Source: ${benchmarkData.metadata.primary_sources.join('; ')}\n\n`;

            // Metro comparison table
            csv += 'METRO AREA COMPARISON\n';
            csv += 'Metro Area,Filing Rate (%),Judgment Rate (%),Eviction Rate (%),vs Pre-Pandemic,Renter Households,Notes\n';

            const metros = [
                { name: 'Nashville', data: benchmarkData.nashville, isNashville: true },
                { name: 'Austin', data: benchmarkData.comparable_cities.austin },
                { name: 'San Antonio', data: benchmarkData.comparable_cities.san_antonio },
                { name: 'Jacksonville', data: benchmarkData.comparable_cities.jacksonville },
                { name: 'Memphis', data: benchmarkData.comparable_cities.memphis },
                { name: 'Indianapolis', data: benchmarkData.comparable_cities.indianapolis },
                { name: 'Columbus', data: benchmarkData.comparable_cities.columbus },
                { name: 'Charlotte', data: benchmarkData.comparable_cities.charlotte }
            ];

            metros.forEach(metro => {
                const fr = metro.data.filing_rates || {};
                const jr = metro.data.judgment_rates_pct_of_filings || {};
                const er = metro.data.eviction_rates_pct_of_renters || {};
                const rd = metro.data.renter_demographics || {};

                const filingRate = fr['2024_calculated'] || fr['2024_estimated'] || fr['2024'] || fr.pre_pandemic_2016_2019 || 'N/A';
                const judgmentRate = jr['2019'] || jr['fy2024'] || jr['2022'] || jr.rate || 'N/A';
                const evictionRate = er['2024_estimated'] || er['2019_estimated'] || er['fy2024_estimated'] || 'N/A';
                const renters = rd.renter_households || rd.renter_households_estimated || 'N/A';

                let prePandemic = 'N/A';
                if (fr.vs_pre_pandemic_percent) {
                    const pct = fr.vs_pre_pandemic_percent;
                    prePandemic = pct > 100 ? `+${pct - 100}%` : `${pct - 100}%`;
                } else if (metro.data.year_over_year?.['2024_vs_pre_pandemic_pct']) {
                    const pct = metro.data.year_over_year['2024_vs_pre_pandemic_pct'];
                    prePandemic = pct > 100 ? `+${pct - 100}%` : `${pct - 100}%`;
                }

                const notes = metro.data.data_note || metro.data.data_caveats?.join('; ') || '';

                csv += `"${metro.name}",${filingRate},${judgmentRate},${evictionRate},"${prePandemic}",${renters},"${notes.replace(/"/g, '""')}"\n`;
            });

            // National averages
            const natl = benchmarkData.national_benchmarks;
            csv += `"National Average",${natl.filing_rates_pct_of_renters['2024_ets_cities_avg']},${natl.judgment_rates_pct_of_filings.national_avg},${natl.eviction_rates_pct_of_renters.current_estimated},"baseline","~44M","ETS tracked cities average"\n`;

            csv += '\n';

            // Ranked comparisons
            csv += 'FILING RATES RANKED (Highest to Lowest)\n';
            csv += 'Rank,City,Rate (%),Notes\n';
            benchmarkData.comparative_summary.filing_rates_ranked.forEach((item, idx) => {
                csv += `${idx + 1},"${item.city}",${item.rate},"${item.note || ''}"\n`;
            });

            csv += '\nJUDGMENT RATES RANKED (Highest to Lowest)\n';
            csv += 'Rank,City,Rate (%),Notes\n';
            benchmarkData.comparative_summary.judgment_rates_pct_of_filings_ranked.forEach((item, idx) => {
                csv += `${idx + 1},"${item.city}",${item.rate},"${item.note || ''}"\n`;
            });

            csv += '\nEVICTION RATES RANKED (Highest to Lowest)\n';
            csv += 'Rank,City,Rate (%),Notes\n';
            benchmarkData.comparative_summary.eviction_rates_pct_of_renters_ranked.forEach((item, idx) => {
                csv += `${idx + 1},"${item.city}",${item.rate},"${item.note || ''}"\n`;
            });

            csv += '\n';

            // Nashville context summary
            csv += 'NASHVILLE CONTEXT\n';
            const ctx = benchmarkData.comparative_summary.nashville_context;
            csv += `Filing Rate vs National,"${ctx.filing_rate_vs_national}"\n`;
            csv += `Eviction Rate vs National,"${ctx.eviction_rate_vs_national}"\n`;
            csv += `Judgment Rate vs National,"${ctx.judgment_rate_vs_national}"\n`;
            csv += `Peer Group,"${ctx.peer_group}"\n`;
            csv += `Trend,"${ctx.trend}"\n`;

            csv += '\n';

            // Demographic disparities
            csv += 'DEMOGRAPHIC DISPARITIES\n';
            const racial = benchmarkData.demographic_disparities.racial_disparities;
            const gender = benchmarkData.demographic_disparities.gender_disparities;

            csv += 'Metric,Value,Source\n';
            csv += `Black Renter Share (National),${racial.national_2024_ets.black_renter_share}%,ETS 2024\n`;
            csv += `Black Defendant Share (National),${racial.national_2024_ets.black_defendant_share}%,ETS 2024\n`;
            csv += `Overrepresentation Ratio,${racial.national_2024_ets.overrepresentation_ratio}x,ETS 2024\n`;
            csv += `Female Defendant Share,${gender.female_defendant_share_2024}%,ETS 2024\n`;
            csv += `Female Renter Share,${gender.female_renter_share}%,Census\n`;

            csv += '\n';

            // Metric definitions
            csv += 'METRIC DEFINITIONS\n';
            csv += 'Metric,Formula,Description\n';
            Object.entries(benchmarkData.metadata.metric_definitions).forEach(([key, def]) => {
                if (def.formula) {
                    csv += `"${key}","${def.formula}","${def.description || ''}"\n`;
                }
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nashville_eviction_benchmarks_${today}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            console.log('Benchmark CSV exported successfully');
        }

        async function exportBenchmarkJSON() {
            // Ensure benchmark data is loaded before exporting
            const loaded = await ensureBenchmarkDataLoaded();
            if (!loaded) {
                alert('Failed to load benchmark data. Please try again.');
                return;
            }

            // Close dropdown
            document.getElementById('benchmarkExportMenu').classList.add('hidden');

            const today = new Date().toISOString().split('T')[0];

            // Add export metadata
            const exportData = {
                export_info: {
                    exported_at: new Date().toISOString(),
                    exported_from: 'Nashville Eviction Tracker',
                    format_version: '1.0'
                },
                ...benchmarkData
            };

            const json = JSON.stringify(exportData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nashville_eviction_benchmarks_${today}.json`;
            a.click();
            window.URL.revokeObjectURL(url);

            console.log('Benchmark JSON exported successfully');
        }

        async function exportBenchmarkPDF() {
            // Ensure benchmark data is loaded before exporting
            const loaded = await ensureBenchmarkDataLoaded();
            if (!loaded) {
                alert('Failed to load benchmark data. Please try again.');
                return;
            }

            // Close dropdown
            document.getElementById('benchmarkExportMenu').classList.add('hidden');

            showExportLoading('Generating PDF report...');

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                let yPos = margin;

                const today = new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Helper functions
                const addText = (text, size, style = 'normal', color = [0, 0, 0]) => {
                    pdf.setFontSize(size);
                    pdf.setFont('helvetica', style);
                    pdf.setTextColor(...color);
                    const lines = pdf.splitTextToSize(text, pageWidth - 2 * margin);
                    lines.forEach(line => {
                        if (yPos > pageHeight - 20) {
                            pdf.addPage();
                            yPos = margin;
                        }
                        pdf.text(line, margin, yPos);
                        yPos += size * 0.4;
                    });
                    return lines.length * size * 0.4;
                };

                const addSpace = (space) => {
                    yPos += space;
                    if (yPos > pageHeight - 20) {
                        pdf.addPage();
                        yPos = margin;
                    }
                };

                // Title
                pdf.setFillColor(79, 70, 229);
                pdf.rect(0, 0, pageWidth, 40, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(24);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Nashville Eviction Benchmark Report', margin, 20);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Generated: ${today}`, margin, 30);
                yPos = 50;

                // Executive Summary
                addText('Executive Summary', 16, 'bold', [31, 41, 55]);
                addSpace(3);

                const ctx = benchmarkData.comparative_summary.nashville_context;
                addText(`Nashville's eviction filing rate is ${ctx.filing_rate_vs_national}. The eviction rate (judgments per renter households) is ${ctx.eviction_rate_vs_national}. Current filing levels are ${ctx.trend}.`, 10, 'normal', [75, 85, 99]);
                addSpace(8);

                // Key Metrics Box
                pdf.setFillColor(245, 243, 255);
                pdf.setDrawColor(167, 139, 250);
                pdf.roundedRect(margin, yPos, pageWidth - 2 * margin, 35, 3, 3, 'FD');

                pdf.setTextColor(124, 58, 237);
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'bold');
                pdf.text('NASHVILLE 2024 KEY METRICS', margin + 5, yPos + 8);

                const nashville = benchmarkData.nashville;
                const metrics = [
                    { label: 'Filing Rate', value: `${nashville.filing_rates['2024_calculated']}%` },
                    { label: 'Judgment Rate', value: `${nashville.judgment_rates_pct_of_filings['2019']}%` },
                    { label: 'Eviction Rate', value: `${nashville.eviction_rates_pct_of_renters['2024_estimated']}%` },
                    { label: 'Total Filings', value: nashville.eviction_filings['2024'].toLocaleString() }
                ];

                const colWidth = (pageWidth - 2 * margin - 10) / 4;
                metrics.forEach((m, i) => {
                    const x = margin + 5 + i * colWidth;
                    pdf.setTextColor(88, 28, 135);
                    pdf.setFontSize(18);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(m.value, x, yPos + 22);
                    pdf.setTextColor(124, 58, 237);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(m.label, x, yPos + 28);
                });

                yPos += 45;

                // Capture and add the chart
                addText('Metro Area Comparison', 14, 'bold', [31, 41, 55]);
                addSpace(5);

                try {
                    const chartCanvas = document.getElementById('metroBenchmarkChart');
                    if (chartCanvas) {
                        const chartImage = chartCanvas.toDataURL('image/png', 1.0);
                        const imgWidth = pageWidth - 2 * margin;
                        const imgHeight = 60;

                        if (yPos + imgHeight > pageHeight - 20) {
                            pdf.addPage();
                            yPos = margin;
                        }

                        pdf.addImage(chartImage, 'PNG', margin, yPos, imgWidth, imgHeight);
                        yPos += imgHeight + 10;
                    }
                } catch (chartErr) {
                    console.warn('Could not capture chart:', chartErr);
                    addText('(Chart not available)', 10, 'italic', [156, 163, 175]);
                    addSpace(5);
                }

                // Comparison Table
                addText('Detailed Comparison', 14, 'bold', [31, 41, 55]);
                addSpace(5);

                // Table header
                const tableStartY = yPos;
                const cols = [
                    { label: 'Metro Area', width: 40 },
                    { label: 'Filing Rate', width: 25 },
                    { label: 'Judgment Rate', width: 28 },
                    { label: 'Eviction Rate', width: 28 },
                    { label: 'vs Pre-Pandemic', width: 32 }
                ];

                pdf.setFillColor(249, 250, 251);
                pdf.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');

                let xPos = margin + 2;
                pdf.setFontSize(8);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(55, 65, 81);
                cols.forEach(col => {
                    pdf.text(col.label, xPos, yPos + 5);
                    xPos += col.width;
                });
                yPos += 10;

                // Table rows
                const metros = [
                    { name: 'Nashville', data: benchmarkData.nashville, highlight: true },
                    { name: 'Austin', data: benchmarkData.comparable_cities.austin },
                    { name: 'San Antonio', data: benchmarkData.comparable_cities.san_antonio },
                    { name: 'Jacksonville', data: benchmarkData.comparable_cities.jacksonville },
                    { name: 'Memphis', data: benchmarkData.comparable_cities.memphis },
                    { name: 'Indianapolis', data: benchmarkData.comparable_cities.indianapolis },
                    { name: 'Columbus', data: benchmarkData.comparable_cities.columbus },
                    { name: 'Charlotte', data: benchmarkData.comparable_cities.charlotte }
                ];

                pdf.setFont('helvetica', 'normal');
                metros.forEach((metro, idx) => {
                    if (yPos > pageHeight - 25) {
                        pdf.addPage();
                        yPos = margin;
                    }

                    const fr = metro.data.filing_rates || {};
                    const jr = metro.data.judgment_rates_pct_of_filings || {};
                    const er = metro.data.eviction_rates_pct_of_renters || {};

                    const filingRate = fr['2024_calculated'] || fr['2024_estimated'] || fr['2024'] || fr.pre_pandemic_2016_2019 || '-';
                    const judgmentRate = jr['2019'] || jr['fy2024'] || jr['2022'] || jr.rate || (jr.data_available === false ? 'N/A' : '-');
                    const evictionRate = er['2024_estimated'] || er['2019_estimated'] || er['fy2024_estimated'] || (er.data_available === false ? 'N/A' : '-');

                    let prePandemic = '-';
                    if (fr.vs_pre_pandemic_percent) {
                        const pct = fr.vs_pre_pandemic_percent;
                        prePandemic = pct > 100 ? `+${pct - 100}%` : `${pct - 100}%`;
                    } else if (metro.data.year_over_year?.['2024_vs_pre_pandemic_pct']) {
                        const pct = metro.data.year_over_year['2024_vs_pre_pandemic_pct'];
                        prePandemic = pct > 100 ? `+${pct - 100}%` : `${pct - 100}%`;
                    }

                    if (metro.highlight) {
                        pdf.setFillColor(245, 243, 255);
                        pdf.rect(margin, yPos - 2, pageWidth - 2 * margin, 7, 'F');
                        pdf.setTextColor(109, 40, 217);
                        pdf.setFont('helvetica', 'bold');
                    } else {
                        pdf.setTextColor(55, 65, 81);
                        pdf.setFont('helvetica', 'normal');
                    }

                    xPos = margin + 2;
                    const rowData = [
                        metro.name,
                        typeof filingRate === 'number' ? `${filingRate.toFixed(1)}%` : String(filingRate),
                        typeof judgmentRate === 'number' ? `${judgmentRate}%` : String(judgmentRate),
                        typeof evictionRate === 'number' ? `${evictionRate.toFixed(1)}%` : String(evictionRate),
                        prePandemic
                    ];

                    rowData.forEach((val, i) => {
                        pdf.text(val, xPos, yPos + 3);
                        xPos += cols[i].width;
                    });

                    yPos += 7;
                });

                // National average row
                pdf.setFillColor(236, 253, 245);
                pdf.rect(margin, yPos - 2, pageWidth - 2 * margin, 7, 'F');
                pdf.setTextColor(4, 120, 87);
                pdf.setFont('helvetica', 'bold');

                const natl = benchmarkData.national_benchmarks;
                xPos = margin + 2;
                const natlRow = [
                    'National Average',
                    `${natl.filing_rates_pct_of_renters['2024_ets_cities_avg']}%`,
                    `${natl.judgment_rates_pct_of_filings.national_avg}%`,
                    `${natl.eviction_rates_pct_of_renters.current_estimated}%`,
                    'baseline'
                ];
                natlRow.forEach((val, i) => {
                    pdf.text(val, xPos, yPos + 3);
                    xPos += cols[i].width;
                });

                yPos += 15;

                // Methodology section
                if (yPos > pageHeight - 60) {
                    pdf.addPage();
                    yPos = margin;
                }

                addText('Methodology & Definitions', 14, 'bold', [31, 41, 55]);
                addSpace(3);

                const definitions = [
                    'Filing Rate: (eviction filings √∑ renter households) √ó 100. Measures threat of eviction.',
                    'Judgment Rate: (eviction judgments √∑ filings) √ó 100. What % of cases result in eviction orders.',
                    'Eviction Rate: (eviction judgments √∑ renter households) √ó 100. Actual displacement rate.'
                ];
                definitions.forEach(def => {
                    addText('‚Ä¢ ' + def, 9, 'normal', [75, 85, 99]);
                    addSpace(2);
                });

                addSpace(5);
                addText('Data Sources', 12, 'bold', [31, 41, 55]);
                addSpace(3);
                benchmarkData.metadata.primary_sources.forEach(src => {
                    addText('‚Ä¢ ' + src, 9, 'normal', [75, 85, 99]);
                    addSpace(1);
                });

                // Footer on last page
                pdf.setFontSize(8);
                pdf.setTextColor(156, 163, 175);
                pdf.text(
                    'Generated by Nashville Eviction Tracker | Data for informational purposes only',
                    pageWidth / 2,
                    pageHeight - 10,
                    { align: 'center' }
                );

                // Save PDF
                const today_file = new Date().toISOString().split('T')[0];
                pdf.save(`nashville_eviction_benchmark_report_${today_file}.pdf`);

                console.log('Benchmark PDF exported successfully');
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            } finally {
                hideExportLoading();
            }
        }

        async function exportBenchmarkExcel() {
            // Ensure benchmark data is loaded before exporting
            const loaded = await ensureBenchmarkDataLoaded();
            if (!loaded) {
                alert('Failed to load benchmark data. Please try again.');
                return;
            }

            showExportLoading('Generating Excel workbook...');

            try {
                const today = new Date().toISOString().split('T')[0];

                // Build multi-sheet XML for Excel
                let xml = '<?xml version="1.0"?>\n';
                xml += '<?mso-application progid="Excel.Sheet"?>\n';
                xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"\n';
                xml += ' xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n';

                // Styles
                xml += '<Styles>\n';
                xml += '<Style ss:ID="Header"><Font ss:Bold="1" ss:Size="12"/><Interior ss:Color="#4F46E5" ss:Pattern="Solid"/><Font ss:Color="#FFFFFF"/></Style>\n';
                xml += '<Style ss:ID="Title"><Font ss:Bold="1" ss:Size="14"/></Style>\n';
                xml += '<Style ss:ID="Nashville"><Interior ss:Color="#F5F3FF" ss:Pattern="Solid"/><Font ss:Bold="1"/></Style>\n';
                xml += '<Style ss:ID="National"><Interior ss:Color="#ECFDF5" ss:Pattern="Solid"/><Font ss:Bold="1" ss:Color="#047857"/></Style>\n';
                xml += '<Style ss:ID="Redacted"><Font ss:Color="#9CA3AF" ss:Italic="1"/></Style>\n';
                xml += '</Styles>\n';

                // Sheet 1: Metro Comparison
                xml += '<Worksheet ss:Name="Metro Comparison">\n<Table>\n';

                // Header row
                xml += '<Row ss:StyleID="Header">\n';
                ['Metro Area', 'Filing Rate (%)', 'Judgment Rate (%)', 'Eviction Rate (%)', 'vs Pre-Pandemic', 'Total Filings', 'Renter Households'].forEach(h => {
                    xml += `<Cell><Data ss:Type="String">${h}</Data></Cell>\n`;
                });
                xml += '</Row>\n';

                // Metro data rows
                const metros = [
                    { name: 'Nashville', data: benchmarkData.nashville, isNashville: true },
                    { name: 'Austin', data: benchmarkData.comparable_cities.austin },
                    { name: 'San Antonio', data: benchmarkData.comparable_cities.san_antonio },
                    { name: 'Jacksonville', data: benchmarkData.comparable_cities.jacksonville },
                    { name: 'Memphis', data: benchmarkData.comparable_cities.memphis },
                    { name: 'Indianapolis', data: benchmarkData.comparable_cities.indianapolis },
                    { name: 'Columbus', data: benchmarkData.comparable_cities.columbus },
                    { name: 'Charlotte', data: benchmarkData.comparable_cities.charlotte }
                ];

                metros.forEach(metro => {
                    const fr = metro.data.filing_rates || {};
                    const jr = metro.data.judgment_rates_pct_of_filings || {};
                    const er = metro.data.eviction_rates_pct_of_renters || {};
                    const rd = metro.data.renter_demographics || {};
                    const ef = metro.data.eviction_filings || {};

                    const filingRate = fr['2024_calculated'] || fr['2024_estimated'] || fr['2024'] || fr.pre_pandemic_2016_2019 || '';
                    const judgmentRate = jr['2019'] || jr['fy2024'] || jr['2022'] || jr.rate || '';
                    const evictionRate = er['2024_estimated'] || er['2019_estimated'] || er['fy2024_estimated'] || '';
                    const totalFilings = ef['2024'] || ef['2023'] || ef.fy2024 || '';
                    const renters = rd.renter_households || rd.renter_households_estimated || '';

                    let prePandemic = '';
                    if (fr.vs_pre_pandemic_percent) {
                        const pct = fr.vs_pre_pandemic_percent;
                        prePandemic = pct > 100 ? `+${pct - 100}%` : `${pct - 100}%`;
                    } else if (metro.data.year_over_year?.['2024_vs_pre_pandemic_pct']) {
                        const pct = metro.data.year_over_year['2024_vs_pre_pandemic_pct'];
                        prePandemic = pct > 100 ? `+${pct - 100}%` : `${pct - 100}%`;
                    }

                    const style = metro.isNashville ? ' ss:StyleID="Nashville"' : '';
                    xml += `<Row${style}>\n`;
                    xml += `<Cell><Data ss:Type="String">${metro.name}</Data></Cell>\n`;
                    xml += `<Cell><Data ss:Type="Number">${filingRate}</Data></Cell>\n`;
                    xml += `<Cell><Data ss:Type="${judgmentRate ? 'Number' : 'String'}">${judgmentRate || 'N/A'}</Data></Cell>\n`;
                    xml += `<Cell><Data ss:Type="Number">${evictionRate}</Data></Cell>\n`;
                    xml += `<Cell><Data ss:Type="String">${prePandemic}</Data></Cell>\n`;
                    xml += `<Cell><Data ss:Type="Number">${totalFilings}</Data></Cell>\n`;
                    xml += `<Cell><Data ss:Type="Number">${renters}</Data></Cell>\n`;
                    xml += '</Row>\n';
                });

                // National average row
                const natl = benchmarkData.national_benchmarks;
                xml += '<Row ss:StyleID="National">\n';
                xml += '<Cell><Data ss:Type="String">National Average</Data></Cell>\n';
                xml += `<Cell><Data ss:Type="Number">${natl.filing_rates_pct_of_renters['2024_ets_cities_avg']}</Data></Cell>\n`;
                xml += `<Cell><Data ss:Type="Number">${natl.judgment_rates_pct_of_filings.national_avg}</Data></Cell>\n`;
                xml += `<Cell><Data ss:Type="Number">${natl.eviction_rates_pct_of_renters.current_estimated}</Data></Cell>\n`;
                xml += '<Cell><Data ss:Type="String">baseline</Data></Cell>\n';
                xml += '<Cell><Data ss:Type="String">-</Data></Cell>\n';
                xml += '<Cell><Data ss:Type="String">~44M</Data></Cell>\n';
                xml += '</Row>\n';

                xml += '</Table>\n</Worksheet>\n';

                // Sheet 2: Rankings
                xml += '<Worksheet ss:Name="Rankings">\n<Table>\n';

                // Filing rates ranked
                xml += '<Row ss:StyleID="Title"><Cell><Data ss:Type="String">Filing Rates (Highest to Lowest)</Data></Cell></Row>\n';
                xml += '<Row ss:StyleID="Header"><Cell><Data ss:Type="String">Rank</Data></Cell><Cell><Data ss:Type="String">City</Data></Cell><Cell><Data ss:Type="String">Rate (%)</Data></Cell></Row>\n';
                benchmarkData.comparative_summary.filing_rates_ranked.forEach((item, idx) => {
                    const style = item.city === 'Nashville' ? ' ss:StyleID="Nashville"' : '';
                    xml += `<Row${style}><Cell><Data ss:Type="Number">${idx + 1}</Data></Cell><Cell><Data ss:Type="String">${item.city}</Data></Cell><Cell><Data ss:Type="Number">${item.rate}</Data></Cell></Row>\n`;
                });

                xml += '<Row></Row>\n'; // Empty row

                // Judgment rates ranked
                xml += '<Row ss:StyleID="Title"><Cell><Data ss:Type="String">Judgment Rates (Highest to Lowest)</Data></Cell></Row>\n';
                xml += '<Row ss:StyleID="Header"><Cell><Data ss:Type="String">Rank</Data></Cell><Cell><Data ss:Type="String">City</Data></Cell><Cell><Data ss:Type="String">Rate (%)</Data></Cell></Row>\n';
                benchmarkData.comparative_summary.judgment_rates_pct_of_filings_ranked.forEach((item, idx) => {
                    const style = item.city === 'Nashville' ? ' ss:StyleID="Nashville"' : '';
                    xml += `<Row${style}><Cell><Data ss:Type="Number">${idx + 1}</Data></Cell><Cell><Data ss:Type="String">${item.city}</Data></Cell><Cell><Data ss:Type="Number">${item.rate}</Data></Cell></Row>\n`;
                });

                xml += '<Row></Row>\n';

                // Eviction rates ranked
                xml += '<Row ss:StyleID="Title"><Cell><Data ss:Type="String">Eviction Rates (Highest to Lowest)</Data></Cell></Row>\n';
                xml += '<Row ss:StyleID="Header"><Cell><Data ss:Type="String">Rank</Data></Cell><Cell><Data ss:Type="String">City</Data></Cell><Cell><Data ss:Type="String">Rate (%)</Data></Cell></Row>\n';
                benchmarkData.comparative_summary.eviction_rates_pct_of_renters_ranked.forEach((item, idx) => {
                    const style = item.city === 'Nashville' ? ' ss:StyleID="Nashville"' : '';
                    xml += `<Row${style}><Cell><Data ss:Type="Number">${idx + 1}</Data></Cell><Cell><Data ss:Type="String">${item.city}</Data></Cell><Cell><Data ss:Type="Number">${item.rate}</Data></Cell></Row>\n`;
                });

                xml += '</Table>\n</Worksheet>\n';

                // Sheet 3: Demographic Disparities (Redacted/Anonymized)
                xml += '<Worksheet ss:Name="Demographic Disparities">\n<Table>\n';

                xml += '<Row ss:StyleID="Title"><Cell><Data ss:Type="String">Demographic Disparities (Anonymized Aggregate Data)</Data></Cell></Row>\n';
                xml += '<Row ss:StyleID="Redacted"><Cell><Data ss:Type="String">Note: Individual-level demographic data is not included to protect privacy. Only aggregate patterns are shown.</Data></Cell></Row>\n';
                xml += '<Row></Row>\n';

                const racial = benchmarkData.demographic_disparities.racial_disparities;
                const gender = benchmarkData.demographic_disparities.gender_disparities;

                xml += '<Row ss:StyleID="Header"><Cell><Data ss:Type="String">Metric</Data></Cell><Cell><Data ss:Type="String">Value</Data></Cell><Cell><Data ss:Type="String">Source</Data></Cell></Row>\n';
                xml += `<Row><Cell><Data ss:Type="String">Black Renter Share (National)</Data></Cell><Cell><Data ss:Type="String">${racial.national_2024_ets.black_renter_share}%</Data></Cell><Cell><Data ss:Type="String">ETS 2024</Data></Cell></Row>\n`;
                xml += `<Row><Cell><Data ss:Type="String">Black Defendant Share (National)</Data></Cell><Cell><Data ss:Type="String">${racial.national_2024_ets.black_defendant_share}%</Data></Cell><Cell><Data ss:Type="String">ETS 2024</Data></Cell></Row>\n`;
                xml += `<Row><Cell><Data ss:Type="String">Overrepresentation Ratio</Data></Cell><Cell><Data ss:Type="String">${racial.national_2024_ets.overrepresentation_ratio}x</Data></Cell><Cell><Data ss:Type="String">ETS 2024</Data></Cell></Row>\n`;
                xml += `<Row><Cell><Data ss:Type="String">Female Defendant Share</Data></Cell><Cell><Data ss:Type="String">${gender.female_defendant_share_2024}%</Data></Cell><Cell><Data ss:Type="String">ETS 2024</Data></Cell></Row>\n`;
                xml += `<Row><Cell><Data ss:Type="String">Female Renter Share</Data></Cell><Cell><Data ss:Type="String">${gender.female_renter_share}%</Data></Cell><Cell><Data ss:Type="String">Census</Data></Cell></Row>\n`;

                xml += '</Table>\n</Worksheet>\n';

                // Sheet 4: Methodology
                xml += '<Worksheet ss:Name="Methodology">\n<Table>\n';

                xml += '<Row ss:StyleID="Title"><Cell><Data ss:Type="String">Metric Definitions</Data></Cell></Row>\n';
                xml += '<Row></Row>\n';
                xml += '<Row ss:StyleID="Header"><Cell><Data ss:Type="String">Metric</Data></Cell><Cell><Data ss:Type="String">Formula</Data></Cell><Cell><Data ss:Type="String">Description</Data></Cell></Row>\n';

                Object.entries(benchmarkData.metadata.metric_definitions).forEach(([key, def]) => {
                    if (def.formula) {
                        xml += `<Row><Cell><Data ss:Type="String">${key}</Data></Cell><Cell><Data ss:Type="String">${def.formula}</Data></Cell><Cell><Data ss:Type="String">${def.description || ''}</Data></Cell></Row>\n`;
                    }
                });

                xml += '<Row></Row>\n';
                xml += '<Row ss:StyleID="Title"><Cell><Data ss:Type="String">Data Sources</Data></Cell></Row>\n';
                xml += '<Row></Row>\n';
                benchmarkData.metadata.primary_sources.forEach(src => {
                    xml += `<Row><Cell><Data ss:Type="String">${src}</Data></Cell></Row>\n`;
                });

                xml += '<Row></Row>\n';
                xml += '<Row ss:StyleID="Title"><Cell><Data ss:Type="String">Privacy Notice</Data></Cell></Row>\n';
                xml += '<Row ss:StyleID="Redacted"><Cell><Data ss:Type="String">This export contains aggregate statistical data only. All individual tenant names, specific addresses, and personally identifiable information have been redacted to protect privacy.</Data></Cell></Row>\n';

                xml += '</Table>\n</Worksheet>\n';

                xml += '</Workbook>';

                // Download as .xls file
                const blob = new Blob([xml], { type: 'application/vnd.ms-excel' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `nashville_eviction_benchmarks_${today}.xls`;
                a.click();
                window.URL.revokeObjectURL(url);

                console.log('Benchmark Excel exported successfully');
            } catch (error) {
                console.error('Error generating Excel:', error);
                alert('Error generating Excel file. Please try again.');
            } finally {
                hideExportLoading();
            }
        }

        function toggleDemographicsView() {
            const cardView = document.getElementById('demographicsCardView');
            const tableContainer = document.querySelector('.demographics-table-container');
            const toggleBtn = document.getElementById('demographicsViewToggleBtn');

            cardView.classList.toggle('hidden');
            tableContainer.classList.toggle('hidden');

            // Update button text to reflect current state
            if (toggleBtn) {
                const isCardViewVisible = !cardView.classList.contains('hidden');
                toggleBtn.textContent = isCardViewVisible ? 'Show Table View' : 'Show Card View';
            }
        }

        document.addEventListener('keydown', event => {
            if (event.key === 'Escape') {
                const caseModal = document.getElementById('caseModal');
                if (caseModal && !caseModal.classList.contains('hidden')) {
                    hideCaseModal();
                }
                const districtModal = document.getElementById('districtModal');
                if (districtModal && districtModal.classList.contains('active')) {
                    closeDistrictModal();
                }
                const attorneyModal = document.getElementById('attorneyModal');
                if (attorneyModal && attorneyModal.classList.contains('active')) {
                    closeAttorneyModal();
                }
            }
        });

        function setSearchTab(tab) {
            // Update tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tab}Tab`).classList.add('active');

            // Show/hide panels
            document.getElementById('quickSearch').classList.toggle('hidden', tab !== 'quick');
            document.getElementById('bulkSearch').classList.toggle('hidden', tab !== 'bulk');
            document.getElementById('groupingSearch').classList.toggle('hidden', tab !== 'grouping');
            document.getElementById('demographicsSearch').classList.toggle('hidden', tab !== 'demographics');
            document.getElementById('benchmarksSearch').classList.toggle('hidden', tab !== 'benchmarks');

            // Load saved groupings when opening grouping tab
            if (tab === 'grouping') {
                loadSavedGroupings();
            }

            // Initialize demographics panel when opening demographics tab
            if (tab === 'demographics') {
                renderDemographicsTable();
            }

            // Initialize benchmarks panel when opening benchmarks tab
            if (tab === 'benchmarks') {
                loadAndRenderBenchmarks();
            }
        }

        function quickSearch() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            if (!gridApi) return;
            
            gridApi.setQuickFilter(searchText);
            updateRecordCount();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            if (gridApi) {
                gridApi.setQuickFilter('');
                updateRecordCount();
            }
        }

        function runBulkSearch() {
            const input = document.getElementById('bulkNames').value;
            const threshold = parseFloat(document.getElementById('fuzzyThreshold').value);
            const searchField = document.getElementById('bulkSearchField').value;
            const searchTerms = input.split(/[,\n]/).map(t => t.trim()).filter(t => t);

            if (searchTerms.length === 0) return;

            searchMatches = [];

            searchTerms.forEach(term => {
                filteredData.forEach(record => {
                    let fields = [];

                    // Determine which fields to search based on selection
                    if (searchField === 'landlord') {
                        fields = [{ value: record.Plaintiff, type: 'Landlord' }];
                    } else if (searchField === 'address') {
                        fields = [{ value: record.Address, type: 'Address' }];
                    } else {
                        // 'both' - search both landlord and address
                        fields = [
                            { value: record.Plaintiff, type: 'Landlord' },
                            { value: record.Address, type: 'Address' }
                        ];
                    }

                    fields.forEach(field => {
                        if (field.value) {
                            const similarity = calculateSimilarity(term.toLowerCase(), field.value.toLowerCase());
                            if (similarity >= threshold) {
                                searchMatches.push({
                                    searchTerm: term,
                                    match: field.value,
                                    matchType: field.type,
                                    record: record,
                                    confidence: similarity
                                });
                            }
                        }
                    });
                });
            });

            displayBulkResults(searchMatches);
        }

        function calculateSimilarity(str1, str2) {
            // Levenshtein distance implementation
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            const longerLength = longer.length;
            
            if (longerLength === 0) return 1.0;
            
            const editDistance = levenshtein(longer, shorter);
            return (longerLength - editDistance) / parseFloat(longerLength);
        }

        function levenshtein(s1, s2) {
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }

            return value
                .toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function displayBulkResults(results) {
            const resultsDiv = document.getElementById('bulkResults');

            if (!resultsDiv) return;

            if (results.length === 0) {
                resultsDiv.innerHTML = '<p class="p-4 text-gray-500">No matches found</p>';
            } else {
                const rows = results.map(r => {
                    const confClass = r.confidence > 0.9 ? 'confidence-high' :
                                     r.confidence > 0.8 ? 'confidence-med' : 'confidence-low';
                    const fileDate = r.record.File_Date ? new Date(r.record.File_Date).toLocaleDateString() : '‚Äî';

                    return `
                        <tr>
                            <td>${escapeHtml(r.searchTerm)}</td>
                            <td>${escapeHtml(r.match)}</td>
                            <td><span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700">${escapeHtml(r.matchType || 'Name')}</span></td>
                            <td><span class="confidence-badge ${confClass}">${(r.confidence * 100).toFixed(0)}%</span></td>
                            <td>${escapeHtml(fileDate)}</td>
                            <td>${escapeHtml(r.record.Plaintiff || '‚Äî')}</td>
                            <td>${escapeHtml(r.record.Address || '‚Äî')}</td>
                        </tr>
                    `;
                }).join('');

                resultsDiv.innerHTML = `
                    <div class="bulk-results-header">Found ${results.length} matches</div>
                    <div class="bulk-results-table-wrapper">
                        <table class="bulk-results-table">
                            <thead>
                                <tr>
                                    <th>Search Term</th>
                                    <th>Matched Value</th>
                                    <th>Match Type</th>
                                    <th>Confidence</th>
                                    <th>File Date</th>
                                    <th>Landlord</th>
                                    <th>Address</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            resultsDiv.classList.remove('hidden');
            resultsDiv.scrollTop = 0;
        }

        function updateThreshold() {
            const value = document.getElementById('fuzzyThreshold').value;
            document.getElementById('thresholdValue').textContent = `${Math.round(value * 100)}%`;
        }

        function setDateRange(days) {
            const now = new Date();
            const past = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
            
            document.getElementById('dateFrom').value = past.toISOString().split('T')[0];
            document.getElementById('dateTo').value = now.toISOString().split('T')[0];
            
            applyFilters();
        }

        function applyFilters() {
            // Clear chart filter when applying advanced filters
            chartFilter = null;
            updateChartFilterIndicator();

            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            filteredData = allData.filter(record => {
                // Date filter
                if (dateFrom || dateTo) {
                    const recordDate = new Date(record.File_Date);
                    if (dateFrom && recordDate < new Date(dateFrom)) return false;
                    if (dateTo && recordDate > new Date(dateTo)) return false;
                }

                return true;
            });

            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }

            if (gridApi) {
                if (viewMode === 'pivot') {
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setRowData(filteredData);
                }
            }
            updateRecordCount();
            createDistrictMap();
            updateDemographicsCharts();
            updateDemoFilterIndicator();
        }

        function clearFilters() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';

            // Also clear chart filter
            chartFilter = null;
            updateChartFilterIndicator();

            // Also clear name filter
            nameFilter = null;
            updateNameFilterIndicator();

            filteredData = allData;
            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }
            if (gridApi) {
                if (viewMode === 'pivot') {
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setRowData(filteredData);
                }
            }
            updateRecordCount();
            createDistrictMap();
            updateDemographicsCharts();
            updateDemoFilterIndicator();
        }

        function buildPivotData(dimension) {
            // Generate cache key based on dimension and filtered data signature
            const cacheKey = `pivot_${dimension}_${filteredData.length}_${filteredData[0]?.Case_Number || 'empty'}`;
            const cached = dataCache.get(cacheKey);
            if (cached) {
                console.log(`Using cached pivot data for ${dimension}`);
                return cached;
            }

            const field = pivotFieldMap[dimension] || pivotFieldMap.plaintiff;
            const summaries = new Map();

            filteredData.forEach(record => {
                let rawKey;
                // Handle computed date fields
                if (field === 'File_Date_Month') {
                    const date = new Date(record.File_Date);
                    if (!isNaN(date.getTime())) {
                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        rawKey = `${months[date.getMonth()]} ${date.getFullYear()}`;
                    }
                } else {
                    rawKey = record[field];
                }
                const key = rawKey && String(rawKey).trim() !== '' ? String(rawKey).trim() : 'Unknown';

                if (!summaries.has(key)) {
                    summaries.set(key, {
                        groupKey: key,
                        totalFilings: 0,
                        lastFiled: null,
                        properties: new Set()
                    });
                }

                const summary = summaries.get(key);
                summary.totalFilings += 1;

                if (record.File_Date) {
                    const fileDate = new Date(record.File_Date);
                    if (!isNaN(fileDate)) {
                        if (!summary.lastFiled || fileDate > summary.lastFiled) {
                            summary.lastFiled = fileDate;
                        }
                    }
                }

                if (record.Address) {
                    summary.properties.add(String(record.Address).trim().toLowerCase());
                }
            });

            const totalRecords = filteredData.length;
            const result = Array.from(summaries.values())
                .map(summary => ({
                    groupKey: summary.groupKey,
                    totalFilings: summary.totalFilings,
                    percentOfTotal: totalRecords > 0 ? (summary.totalFilings / totalRecords) * 100 : 0,
                    lastFiled: summary.lastFiled ? summary.lastFiled.toISOString() : '',
                    uniqueProperties: summary.properties.size
                }))
                .sort((a, b) => b.totalFilings - a.totalFilings);

            // Cache the result for 5 minutes
            dataCache.set(cacheKey, result);
            return result;
        }

        function filterByDistrict(district) {
            // Clear chart filter when filtering by district
            chartFilter = null;
            updateChartFilterIndicator();

            // Set active district filter for persistence
            activeDistrictFilter = district;

            if (district === 'Unknown' || district === 'unknown') {
                filteredData = allData.filter(r => r.District === 'Unknown' || r.District === 'unknown');
            } else {
                filteredData = allData.filter(r => r.District == district);
            }

            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }

            if (gridApi) {
                if (viewMode === 'pivot') {
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setRowData(filteredData);
                }
            }
            updateRecordCount();

            // Update the district map to highlight the selected district
            createDistrictMap();

            // Update the district filter indicator
            updateDistrictFilterIndicator();

            // Update demographics charts with filtered data
            updateDemographicsCharts();
            updateDemoFilterIndicator();

            // Persist state
            debouncedSaveUIState();

            // Update URL with filter state
            updateUrlWithFilters();

            // Update status message without exact counts
            const filterMsg = district === 'Unknown' ? 'unverified districts*' : `District ${district}*`;
            updateStatus(`Showing records for ${filterMsg}`, 'success');
        }

        function clearDistrictFilter() {
            activeDistrictFilter = null;
            filteredData = allData;

            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }

            if (gridApi) {
                if (viewMode === 'pivot') {
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setRowData(filteredData);
                }
            }
            updateRecordCount();
            createDistrictMap();
            updateDemographicsCharts();
            updateDemoFilterIndicator();
            updateDistrictFilterIndicator();
            debouncedSaveUIState();
            updateUrlWithFilters();
            updateStatus('District filter cleared - showing all records', 'success');
        }

        function updateDistrictFilterIndicator() {
            const container = document.getElementById('districtFilterIndicator');
            if (!container) return;

            if (activeDistrictFilter !== null) {
                const label = activeDistrictFilter === 'Unknown' ? 'Unverified Districts' : `District ${activeDistrictFilter}`;
                container.innerHTML = `
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm">
                        <span>Filtered: ${label}</span>
                        <button onclick="clearDistrictFilter()" class="ml-1 hover:text-indigo-600" title="Clear district filter">√ó</button>
                    </span>
                `;
                container.classList.remove('hidden');
            } else {
                container.innerHTML = '';
                container.classList.add('hidden');
            }
        }

        function getPivotColumnDefs() {
            const label = pivotDimensionLabels[pivotDimension] || 'Group';

            return [
                { field: 'groupKey', headerName: label, flex: 2, minWidth: 160,
                  cellRenderer: params => {
                      if (!params.value) return '';
                      // Scramble defendant names in pivot view when not logged in
                      const displayValue = (pivotDimension === 'defendant' && !isLoggedIn)
                          ? getDefendantDisplayName(params.value)
                          : params.value;
                      if (pivotDimension === 'defendant' && !isLoggedIn) {
                          return `<span class="text-gray-500 cursor-default" title="Login to view tenant name">${displayValue}</span>`;
                      }
                      return `<span class="text-indigo-600 hover:text-indigo-800 hover:underline cursor-pointer">${displayValue}</span>`;
                  }
                },
                { field: 'totalFilings', headerName: 'Total Filings', width: 140, sort: 'desc', sortIndex: 0 },
                { field: 'percentOfTotal', headerName: '% of Total', width: 120,
                  valueFormatter: params => params.value != null ? params.value.toFixed(1) + '%' : '' },
                { field: 'lastFiled', headerName: 'Last Filing', width: 140,
                  valueFormatter: params => params.value ? new Date(params.value).toLocaleDateString() : '',
                  comparator: (valueA, valueB) => {
                      const dateA = valueA ? new Date(valueA).getTime() : 0;
                      const dateB = valueB ? new Date(valueB).getTime() : 0;
                      return dateA - dateB;
                  } }
            ];
        }

        function setViewMode(mode) {
            const nextMode = mode === 'pivot' ? 'pivot' : 'records';
            if (viewMode === nextMode) {
                updatePivotControls();
                updateRecordCount();
                return;
            }

            viewMode = nextMode;

            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }

            if (gridApi) {
                if (viewMode === 'pivot') {
                    gridApi.setColumnDefs(getPivotColumnDefs());
                    gridApi.setRowData(pivotData);
                } else {
                    gridApi.setColumnDefs(getFullRecordColumnDefs());
                    gridApi.setRowData(filteredData);
                }
            }

            updatePivotControls();
            updateRecordCount();

            // Persist view mode change
            debouncedSaveUIState();
        }

        function setPivotDimension(dimension) {
            if (!pivotFieldMap[dimension]) {
                dimension = 'plaintiff';
            }

            if (pivotDimension === dimension) {
                updatePivotControls();
                return;
            }

            pivotDimension = dimension;

            if (viewMode === 'pivot') {
                pivotData = buildPivotData(pivotDimension);
            }

            if (viewMode === 'pivot' && gridApi) {
                gridApi.setColumnDefs(getPivotColumnDefs());
                gridApi.setRowData(pivotData);
            }

            updatePivotControls();
            updateRecordCount();

            // Persist pivot dimension change
            debouncedSaveUIState();
        }

        function updatePivotControls() {
            const recordBtn = document.getElementById('recordModeBtn');
            const pivotBtn = document.getElementById('pivotModeBtn');
            const pivotControls = document.getElementById('pivotDimensionControls');

            if (recordBtn) {
                recordBtn.classList.toggle('active', viewMode !== 'pivot');
            }

            if (pivotBtn) {
                pivotBtn.classList.toggle('active', viewMode === 'pivot');
            }

            if (pivotControls) {
                pivotControls.classList.toggle('hidden', viewMode !== 'pivot');
            }

            document.querySelectorAll('.pivot-option').forEach(button => {
                const isActive = button.dataset.pivotDimension === pivotDimension;
                button.classList.toggle('active', isActive);
            });
        }

        // Format a value for CSV export, handling special types
        function formatCSVValue(value) {
            if (value === null || value === undefined) return '';
            if (typeof value === 'boolean') return value ? 'Yes' : 'No';
            if (typeof value === 'object') return JSON.stringify(value);
            return String(value).replace(/"/g, '""');
        }

        function exportCSV() {
            // Include all available fields, respecting redaction rules for non-logged-in users
            // Get sorted list of dynamic keys for consistent column order
            const sortedDynamicKeys = Array.from(dynamicCaseDataKeys).sort();

            // Build header row with base fields + backfill fields + dynamic fields
            const baseHeaders = [
                'File Date', 'Docket Number', 'Plaintiff', 'Defendant', 'Landlord Attorney', 'Defense Attorney',
                'Address', 'Council District', 'Council Member', 'Individual Landlord',
                // Backfill data fields
                'Status', 'Judge', 'Service Date', 'Paper Writ Date', 'Judgment Date', 'Judgment For', 'Judgment Type',
                'Case Dismissed', 'Dismissal Date',
                'Writ Issued Date', 'Writ Served Date', 'Pleadings Count', 'Pleadings', 'Judgments Count', 'Judgments'
            ];
            const dynamicHeaders = sortedDynamicKeys.map(formatDynamicColumnHeader);
            const allHeaders = [...baseHeaders, ...dynamicHeaders];
            let csv = allHeaders.join(',') + '\n';

            // Log dynamic columns being exported
            if (sortedDynamicKeys.length > 0) {
                console.log('üìä Exporting with dynamic columns:', sortedDynamicKeys);
            }

            filteredData.forEach(row => {
                const defendantName = getDefendantDisplayName(row.Defendant).replace(/"/g, '""');
                const fileDate = new Date(row.File_Date).toLocaleDateString();
                const caseNumber = (row.Case_Number || '').replace(/"/g, '""');
                const plaintiff = (row.Plaintiff || '').replace(/"/g, '""');
                const attorney = (row.Attorney || '').replace(/"/g, '""');
                const defenseAttorney = (row.Defense_Attorney || '').replace(/"/g, '""');
                const address = (row.Address || '').replace(/"/g, '""');
                const district = row.District && row.District !== 'Unknown' ? row.District : '';
                const councilMember = (row.CouncilMember || '').replace(/"/g, '""');
                const individualLandlord = row.individual_ll ? 'Yes' : 'No';

                // Backfill data values
                const status = (row.Status || '').replace(/"/g, '""');
                const judge = (row.judge || '').replace(/"/g, '""');
                const serviceDate = row.service_date ? new Date(row.service_date).toLocaleDateString() : '';
                const paperWritDate = row.paper_writ_date ? new Date(row.paper_writ_date).toLocaleDateString() : '';
                const judgmentDate = row.judgment_date ? new Date(row.judgment_date).toLocaleDateString() : '';
                const judgmentFor = (row.judgment_for || '').replace(/"/g, '""');
                const judgmentType = (row.judgment_type || '').replace(/"/g, '""');
                const caseDismissed = row.case_dismissed === true ? 'Yes' : row.case_dismissed === false ? 'No' : '';
                const dismissalDate = row.dismissal_date ? new Date(row.dismissal_date).toLocaleDateString() : '';
                // evictionDate, evictionMethod, evictionExecuted removed - derived/interpreted fields
                const writIssuedDate = row.writ_issued_date ? new Date(row.writ_issued_date).toLocaleDateString() : '';
                const writServedDate = row.writ_served_date ? new Date(row.writ_served_date).toLocaleDateString() : '';
                const pleadingsCount = Array.isArray(row.pleadings) ? row.pleadings.length : 0;
                const pleadingsJson = Array.isArray(row.pleadings) && row.pleadings.length > 0
                    ? JSON.stringify(row.pleadings).replace(/"/g, '""')
                    : '';
                const judgmentsCount = Array.isArray(row.judgments) ? row.judgments.length : 0;
                const judgmentsJson = Array.isArray(row.judgments) && row.judgments.length > 0
                    ? JSON.stringify(row.judgments).replace(/"/g, '""')
                    : '';

                // Build row with base values + backfill values
                const baseValues = [
                    fileDate, caseNumber, plaintiff, defendantName, attorney, defenseAttorney,
                    address, district, councilMember, individualLandlord,
                    // Backfill values
                    status, judge, serviceDate, paperWritDate, judgmentDate, judgmentFor, judgmentType,
                    caseDismissed, dismissalDate,
                    writIssuedDate, writServedDate, pleadingsCount, pleadingsJson, judgmentsCount, judgmentsJson
                ];

                // Add dynamic column values
                const dynamicValues = sortedDynamicKeys.map(key => formatCSVValue(row[key]));

                // Combine and format as CSV row
                const allValues = [...baseValues, ...dynamicValues];
                csv += allValues.map(v => `"${v}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eviction_data_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function exportMatches() {
            if (searchMatches.length === 0) {
                alert('No matches to export. Run a bulk search first.');
                return;
            }

            let csv = 'Search Term,Matched Name,Confidence,File Date,Attorney\n';

            searchMatches.forEach(match => {
                csv += `"${match.searchTerm}","${match.match}","${(match.confidence * 100).toFixed(1)}%","${new Date(match.record.File_Date).toLocaleDateString()}","${match.record.Attorney}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fuzzy_matches_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ============================================
        // BULK UPLOAD TOOL (Secret: ESC x3 + "detainer")
        // ============================================

        // Secret key combo state
        let escPressCount = 0;
        let escPressTimer = null;
        let secretInputBuffer = '';
        let secretInputTimer = null;
        let secretModeActive = false;

        // Bulk upload state
        let bulkUploadStep = 1;
        let bulkUploadData = [];
        let bulkUploadHeaders = [];
        let bulkUploadFieldMapping = {};

        // Target schema fields for the API
        const targetSchemaFields = [
            { key: 'id', label: 'ID', type: 'integer' },
            { key: 'Office', label: 'Office', type: 'text' },
            { key: 'Docket_Number', label: 'Docket Number', type: 'text' },
            { key: 'Status', label: 'Status', type: 'text' },
            { key: 'File_Date', label: 'File Date', type: 'text' },
            { key: 'Description', label: 'Description', type: 'text' },
            { key: 'Plaintiff_Petitioner', label: 'Plaintiff/Petitioner', type: 'text' },
            { key: 'Defendant_Respondent', label: 'Defendant/Respondent', type: 'text' },
            { key: 'Attorney', label: 'Attorney', type: 'text' },
            { key: 'Defendant_Attorney', label: 'Defendant Attorney', type: 'text' },
            { key: 'address_formatted', label: 'Address (Formatted)', type: 'text' },
            { key: 'Address_1', label: 'Address Line 1', type: 'text' },
            { key: 'Address_2', label: 'Address Line 2', type: 'text' },
            { key: 'city_state_zip', label: 'City, State, ZIP', type: 'text' },
            { key: 'council_member', label: 'Council Member', type: 'text' },
            { key: 'longitude', label: 'Longitude', type: 'text' },
            { key: 'latitude', label: 'Latitude', type: 'text' },
            { key: 'council_district', label: 'Council District', type: 'text' },
            { key: 'council_district_number', label: 'Council District Number', type: 'integer' },
            { key: 'individual_ll', label: 'Individual Landlord', type: 'text' }
        ];

        // Auto-mapping rules (CSV header -> target field)
        const autoMappingRules = {
            'id': 'id',
            'office': 'Office',
            'docket_number': 'Docket_Number',
            'docket': 'Docket_Number',
            'case_number': 'Docket_Number',
            'case': 'Docket_Number',
            'status': 'Status',
            'case_status': 'Status',
            'file_date': 'File_Date',
            'filedate': 'File_Date',
            'date': 'File_Date',
            'filed': 'File_Date',
            'description': 'Description',
            'plaintiff_petitioner': 'Plaintiff_Petitioner',
            'plaintiff': 'Plaintiff_Petitioner',
            'petitioner': 'Plaintiff_Petitioner',
            'landlord': 'Plaintiff_Petitioner',
            'defendant_respondent': 'Defendant_Respondent',
            'defendant': 'Defendant_Respondent',
            'respondent': 'Defendant_Respondent',
            'tenant': 'Defendant_Respondent',
            'attorney': 'Attorney',
            'lawyer': 'Attorney',
            'defendant_attorney': 'Defendant_Attorney',
            'defendantattorney': 'Defendant_Attorney',
            'defense_attorney': 'Defendant_Attorney',
            'defenseattorney': 'Defendant_Attorney',
            'tenant_attorney': 'Defendant_Attorney',
            'tenantattorney': 'Defendant_Attorney',
            'def_attorney': 'Defendant_Attorney',
            'defattorney': 'Defendant_Attorney',
            'address_formatted': 'address_formatted',
            'address': 'address_formatted',
            'property_address': 'address_formatted',
            'address_1': 'Address_1',
            'address1': 'Address_1',
            'street_address': 'Address_1',
            'street': 'Address_1',
            'address_2': 'Address_2',
            'address2': 'Address_2',
            'apt': 'Address_2',
            'unit': 'Address_2',
            'city_state_zip': 'city_state_zip',
            'citystatezip': 'city_state_zip',
            'city_state': 'city_state_zip',
            'council_member': 'council_member',
            'councilmember': 'council_member',
            'council': 'council_member',
            'longitude': 'longitude',
            'lng': 'longitude',
            'lon': 'longitude',
            'latitude': 'latitude',
            'lat': 'latitude',
            'council_district': 'council_district',
            'district': 'council_district',
            'council_district_number': 'council_district_number',
            'district_number': 'council_district_number',
            'individual_ll': 'individual_ll',
            'individual_landlord': 'individual_ll',
            'individual': 'individual_ll'
        };

        // Secret key combo detection
        document.addEventListener('keydown', function(event) {
            // If bulk upload modal is open and ESC is pressed, close it
            const uploadModal = document.getElementById('bulkUploadModal');
            if (uploadModal && !uploadModal.classList.contains('hidden') && event.key === 'Escape') {
                hideBulkUploadModal();
                return;
            }

            // If we're in secret input mode, capture alphanumeric keys
            if (secretModeActive) {
                if (event.key.length === 1 && /[a-zA-Z]/.test(event.key)) {
                    event.preventDefault();
                    secretInputBuffer += event.key.toLowerCase();

                    // Reset timer
                    if (secretInputTimer) clearTimeout(secretInputTimer);
                    secretInputTimer = setTimeout(() => {
                        secretInputBuffer = '';
                        secretModeActive = false;
                    }, 3000);

                    // Check if "detainer" was typed
                    if (secretInputBuffer === 'detainer') {
                        secretInputBuffer = '';
                        secretModeActive = false;
                        showBulkUploadModal();
                    }
                }
                return;
            }

            // Track ESC presses
            if (event.key === 'Escape') {
                // Don't trigger if case modal is open
                const caseModal = document.getElementById('caseModal');
                if (caseModal && !caseModal.classList.contains('hidden')) {
                    return;
                }

                escPressCount++;

                // Reset timer
                if (escPressTimer) clearTimeout(escPressTimer);
                escPressTimer = setTimeout(() => {
                    escPressCount = 0;
                }, 1500);

                // After 3 ESC presses, enter secret input mode
                if (escPressCount >= 3) {
                    escPressCount = 0;
                    secretModeActive = true;
                    secretInputBuffer = '';

                    // Auto-reset after 5 seconds
                    if (secretInputTimer) clearTimeout(secretInputTimer);
                    secretInputTimer = setTimeout(() => {
                        secretInputBuffer = '';
                        secretModeActive = false;
                    }, 5000);
                }
            }
        });

        // Bulk Upload Modal Functions
        function showBulkUploadModal() {
            const modal = document.getElementById('bulkUploadModal');
            if (!modal) return;

            // Reset state
            bulkUploadStep = 1;
            bulkUploadData = [];
            bulkUploadHeaders = [];
            bulkUploadFieldMapping = {};

            // Reset UI
            document.getElementById('bulkUploadFile').value = '';
            document.getElementById('bulkUploadPaste').value = '';
            document.getElementById('uploadFileInfo').classList.add('hidden');
            document.getElementById('uploadProgressSection').classList.add('hidden');

            updateUploadStep();
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');

            // Setup drag and drop
            setupDropZone();
        }

        function hideBulkUploadModal() {
            const modal = document.getElementById('bulkUploadModal');
            if (!modal) return;
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        function setupDropZone() {
            const dropZone = document.getElementById('uploadDropZone');
            if (!dropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('dragover');
                }, false);
            });

            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.csv')) {
                    handleBulkUploadFileFromDrop(files[0]);
                }
            }, false);
        }

        function handleBulkUploadFile(event) {
            const file = event.target.files[0];
            if (file) {
                handleBulkUploadFileFromDrop(file);
            }
        }

        function handleBulkUploadFileFromDrop(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseCSVContent(content);

                // Show file info
                document.getElementById('uploadFileName').textContent = `${file.name} (${bulkUploadData.length} rows)`;
                document.getElementById('uploadFileInfo').classList.remove('hidden');
            };
            reader.readAsText(file);
        }

        function parseCSVContent(content) {
            const lines = content.trim().split(/\r?\n/);
            if (lines.length < 2) {
                alert('CSV must have at least a header row and one data row.');
                return;
            }

            // Parse header
            bulkUploadHeaders = parseCSVLine(lines[0]);

            // Parse data rows
            bulkUploadData = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    const row = {};
                    bulkUploadHeaders.forEach((header, idx) => {
                        row[header] = values[idx] || '';
                    });
                    bulkUploadData.push(row);
                }
            }

            // Auto-map fields
            autoMapFields();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (inQuotes) {
                    if (char === '"' && nextChar === '"') {
                        current += '"';
                        i++; // Skip next quote
                    } else if (char === '"') {
                        inQuotes = false;
                    } else {
                        current += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
            }
            result.push(current.trim());
            return result;
        }

        function autoMapFields() {
            bulkUploadFieldMapping = {};

            bulkUploadHeaders.forEach(header => {
                const normalizedHeader = header.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');

                // Check for exact or close matches
                if (autoMappingRules[normalizedHeader]) {
                    bulkUploadFieldMapping[header] = autoMappingRules[normalizedHeader];
                } else {
                    // Try partial matching
                    for (const [key, value] of Object.entries(autoMappingRules)) {
                        if (normalizedHeader.includes(key) || key.includes(normalizedHeader)) {
                            bulkUploadFieldMapping[header] = value;
                            break;
                        }
                    }
                }

                // Default to unmapped
                if (!bulkUploadFieldMapping[header]) {
                    bulkUploadFieldMapping[header] = '';
                }
            });
        }

        function updateUploadStep() {
            // Update step visibility
            for (let i = 1; i <= 3; i++) {
                const stepDiv = document.getElementById(`uploadStep${i}`);
                const indicator = document.getElementById(`stepIndicator${i}`);

                if (stepDiv) {
                    stepDiv.classList.toggle('active', i === bulkUploadStep);
                }

                if (indicator) {
                    indicator.classList.toggle('opacity-50', i > bulkUploadStep);
                    const circle = indicator.querySelector('span:first-child');
                    const label = indicator.querySelector('span:last-child');

                    if (i <= bulkUploadStep) {
                        circle.className = 'w-7 h-7 rounded-full bg-indigo-600 text-white text-sm font-bold flex items-center justify-center';
                        label.className = 'text-sm font-medium text-gray-700';
                    } else {
                        circle.className = 'w-7 h-7 rounded-full bg-gray-300 text-gray-600 text-sm font-bold flex items-center justify-center';
                        label.className = 'text-sm font-medium text-gray-500';
                    }
                }
            }

            // Update buttons
            const backBtn = document.getElementById('uploadBackBtn');
            const nextBtn = document.getElementById('uploadNextBtn');
            const submitBtn = document.getElementById('uploadSubmitBtn');

            backBtn.classList.toggle('hidden', bulkUploadStep === 1);
            nextBtn.classList.toggle('hidden', bulkUploadStep === 3);
            submitBtn.classList.toggle('hidden', bulkUploadStep !== 3);

            // Populate step content
            if (bulkUploadStep === 2) {
                renderFieldMapping();
            } else if (bulkUploadStep === 3) {
                renderPreview();
            }
        }

        function uploadNextStep() {
            if (bulkUploadStep === 1) {
                // Validate that we have data
                const pasteContent = document.getElementById('bulkUploadPaste').value.trim();
                if (pasteContent && bulkUploadData.length === 0) {
                    parseCSVContent(pasteContent);
                }

                if (bulkUploadData.length === 0) {
                    alert('Please upload a CSV file or paste CSV data first.');
                    return;
                }
            }

            if (bulkUploadStep < 3) {
                bulkUploadStep++;
                updateUploadStep();
            }
        }

        function uploadPrevStep() {
            if (bulkUploadStep > 1) {
                bulkUploadStep--;
                updateUploadStep();
            }
        }

        function renderFieldMapping() {
            const container = document.getElementById('fieldMappingContainer');
            if (!container) return;

            let html = '';

            bulkUploadHeaders.forEach(header => {
                const currentMapping = bulkUploadFieldMapping[header] || '';

                html += `
                    <div class="mapping-row">
                        <div class="csv-field">${escapeHtml(header)}</div>
                        <div class="mapping-arrow">‚Üí</div>
                        <select class="target-field-select" data-csv-field="${escapeHtml(header)}" onchange="updateFieldMapping(this)">
                            <option value="">(Skip this field)</option>
                            ${targetSchemaFields.map(field => `
                                <option value="${field.key}" ${currentMapping === field.key ? 'selected' : ''}>
                                    ${field.label}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateFieldMapping(selectEl) {
            const csvField = selectEl.dataset.csvField;
            const targetField = selectEl.value;
            bulkUploadFieldMapping[csvField] = targetField;
        }

        function renderPreview() {
            const headContainer = document.getElementById('uploadPreviewHead');
            const bodyContainer = document.getElementById('uploadPreviewBody');
            const rowCountEl = document.getElementById('uploadRowCount');

            if (!headContainer || !bodyContainer) return;

            // Get mapped fields (non-empty mappings)
            const mappedFields = [];
            for (const [csvField, targetField] of Object.entries(bulkUploadFieldMapping)) {
                if (targetField) {
                    mappedFields.push({ csvField, targetField });
                }
            }

            if (mappedFields.length === 0) {
                headContainer.innerHTML = '<tr><th>No fields mapped</th></tr>';
                bodyContainer.innerHTML = '<tr><td>Please go back and map at least one field.</td></tr>';
                return;
            }

            // Render header
            headContainer.innerHTML = '<tr>' + mappedFields.map(f => `<th>${escapeHtml(f.targetField)}</th>`).join('') + '</tr>';

            // Render body (first 10 rows)
            const previewRows = bulkUploadData.slice(0, 10);
            bodyContainer.innerHTML = previewRows.map(row => {
                return '<tr>' + mappedFields.map(f => `<td>${escapeHtml(row[f.csvField] || '')}</td>`).join('') + '</tr>';
            }).join('');

            // Update row count
            if (rowCountEl) {
                rowCountEl.textContent = `Total: ${bulkUploadData.length} rows`;
            }
        }

        async function submitBulkUpload() {
            const progressSection = document.getElementById('uploadProgressSection');
            const progressBar = document.getElementById('uploadProgressBar');
            const progressText = document.getElementById('uploadProgressText');
            const statusLog = document.getElementById('uploadStatusLog');
            const submitBtn = document.getElementById('uploadSubmitBtn');

            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            // Show progress section
            progressSection.classList.remove('hidden');
            statusLog.innerHTML = '';

            // Get mapped fields
            const mappedFields = [];
            for (const [csvField, targetField] of Object.entries(bulkUploadFieldMapping)) {
                if (targetField) {
                    mappedFields.push({ csvField, targetField });
                }
            }

            // Transform data to target format
            const transformedData = bulkUploadData.map(row => {
                const transformed = {};
                mappedFields.forEach(({ csvField, targetField }) => {
                    let value = row[csvField] || '';

                    // Type conversion
                    const fieldDef = targetSchemaFields.find(f => f.key === targetField);
                    if (fieldDef && fieldDef.type === 'integer') {
                        value = parseInt(value, 10) || 0;
                    }

                    transformed[targetField] = value;
                });
                // Note: 'updated' timestamp is automatically set by the API on upsert
                return transformed;
            });

            const total = transformedData.length;
            let success = 0;
            let failed = 0;

            // EO operations POST endpoint (requires login to decrypt)
            if (!isLoggedIn || !decryptedPostEndpoint) {
                addUploadStatusItem(statusLog, 'Authentication required', 'error', {
                    recordId: 'System',
                    errorType: 'AUTH',
                    details: 'You must be logged in to upload data.',
                    errorMessage: 'Please login before uploading records.'
                });
                return;
            }
            const apiUrl = decryptedPostEndpoint;

            // Upload each record as an EO event
            for (let i = 0; i < transformedData.length; i++) {
                const record = transformedData[i];
                const progress = Math.round(((i + 1) / total) * 100);

                // Validate that Docket_Number is present (required for entity_id)
                if (!record.Docket_Number) {
                    failed++;
                    addUploadStatusItem(statusLog, 'Missing required field', 'error', {
                        recordId: `Row ${i + 1}`,
                        errorType: 'VALIDATION',
                        details: 'Docket_Number is required for all records. Please ensure this field is mapped correctly.',
                        errorMessage: 'The Docket_Number field must be present and non-empty for each record.'
                    });
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${progress}% (${i + 1}/${total})`;
                    statusLog.scrollTop = statusLog.scrollHeight;
                    continue;
                }

                try {
                    // Create EO INS event for each record
                    const event = typeof EOMigration !== 'undefined'
                        ? EOMigration.toXanoFormat(EOMigration.createInsertEvent(record, { source: 'csv_upload', version: '1.0' }))
                        : {
                            id: crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            ts: Date.now(),
                            ts_iso: new Date().toISOString(),
                            op: 'INS',
                            entity_id: record.Docket_Number,
                            entity_type: 'eviction_case',
                            source_table: 'eviction_cases',
                            target: JSON.stringify({ id: record.Docket_Number, type: 'eviction_case' }),
                            context: JSON.stringify({ table: 'eviction_cases', data: record }),
                            frame: JSON.stringify({ source: 'csv_upload', version: '1.0' })
                        };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(event)
                    });

                    if (response.ok) {
                        success++;
                        const resultData = await response.json().catch(() => ({}));
                        addUploadStatusItem(statusLog, 'Uploaded successfully', 'success', {
                            recordId: record.Docket_Number || `Row ${i + 1}`
                        });
                    } else {
                        failed++;
                        const errorText = await response.text();
                        const parsedError = parseApiError(errorText, response.status);

                        addUploadStatusItem(statusLog, parsedError.message, 'error', {
                            recordId: record.Docket_Number || `Row ${i + 1}`,
                            errorType: parsedError.type,
                            statusCode: response.status,
                            errorMessage: parsedError.message,
                            details: parsedError.details
                        });
                    }
                } catch (error) {
                    failed++;
                    // Categorize network/fetch errors
                    let errorType = 'NETWORK';
                    let errorMessage = error.message;

                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        errorType = 'NETWORK';
                        errorMessage = 'Network error - check your connection';
                    } else if (error.name === 'AbortError') {
                        errorType = 'TIMEOUT';
                        errorMessage = 'Request timed out';
                    } else if (error.message.includes('JSON')) {
                        errorType = 'PARSE_ERROR';
                        errorMessage = 'Invalid response from server';
                    }

                    addUploadStatusItem(statusLog, errorMessage, 'error', {
                        recordId: record.Docket_Number || `Row ${i + 1}`,
                        errorType: errorType,
                        details: `${error.name}: ${error.message}\n\nThis may be a temporary issue. Try uploading this record again.`,
                        errorMessage: error.message
                    });
                }

                // Update progress
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${progress}% (${i + 1}/${total})`;

                // Scroll status log to bottom
                statusLog.scrollTop = statusLog.scrollHeight;
            }

            // Final status summary
            const successRate = total > 0 ? Math.round((success / total) * 100) : 0;
            let finalStatus = 'success';
            let finalMessage = `Upload complete: ${success}/${total} records uploaded successfully`;

            if (failed > 0 && success === 0) {
                finalStatus = 'error';
                finalMessage = `Upload failed: All ${failed} records encountered errors`;
            } else if (failed > 0) {
                finalStatus = 'warning';
                finalMessage = `Upload complete with errors: ${success} succeeded, ${failed} failed (${successRate}% success rate)`;
            }

            addUploadStatusItem(statusLog, finalMessage, finalStatus, {
                errorType: finalStatus === 'success' ? 'COMPLETE' : finalStatus === 'warning' ? 'PARTIAL' : 'FAILED'
            });

            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.textContent = failed === 0 ? 'Upload Complete' : 'Upload Complete (with errors)';

            // Refresh data if any succeeded
            if (success > 0) {
                setTimeout(() => {
                    loadData();
                }, 2000);
            }
        }

        function addUploadStatusItem(container, message, status, options = {}) {
            const item = document.createElement('div');
            item.className = `upload-status-item ${status}`;

            const icon = status === 'success' ? '‚úì' : status === 'error' ? '‚úó' : status === 'warning' ? '‚ö†' : '‚óã';

            // Build the main status line
            let mainHtml = `<div class="status-main">
                <span class="status-icon">${icon}</span>`;

            // Add record identifier if provided
            if (options.recordId) {
                mainHtml += `<span class="status-record">[${escapeHtml(options.recordId)}]</span>`;
            }

            // Add error type badge if provided
            if (options.errorType) {
                mainHtml += `<span class="error-type">${escapeHtml(options.errorType)}</span>`;
            }

            mainHtml += `<span class="status-message">${escapeHtml(message)}</span>
            </div>`;

            item.innerHTML = mainHtml;

            // Add expandable error details if provided
            if (options.details) {
                const detailsId = 'error-details-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'error-details-toggle';
                toggleBtn.textContent = 'Show details';
                toggleBtn.onclick = function() {
                    const detailsDiv = document.getElementById(detailsId);
                    if (detailsDiv.style.display === 'none') {
                        detailsDiv.style.display = 'block';
                        toggleBtn.textContent = 'Hide details';
                    } else {
                        detailsDiv.style.display = 'none';
                        toggleBtn.textContent = 'Show details';
                    }
                };

                const detailsDiv = document.createElement('div');
                detailsDiv.id = detailsId;
                detailsDiv.className = 'error-details';
                detailsDiv.style.display = 'none';

                // Format the details content
                let detailsContent = '';
                if (options.statusCode) {
                    detailsContent += `<strong>HTTP Status:</strong> ${options.statusCode}\n`;
                }
                if (options.errorMessage) {
                    detailsContent += `<strong>Error:</strong> ${escapeHtml(options.errorMessage)}\n`;
                }
                if (options.details) {
                    detailsContent += `<code>${escapeHtml(typeof options.details === 'object' ? JSON.stringify(options.details, null, 2) : options.details)}</code>`;
                }

                detailsDiv.innerHTML = detailsContent;

                item.appendChild(toggleBtn);
                item.appendChild(detailsDiv);
            }

            container.appendChild(item);
        }

        function parseApiError(responseText, statusCode) {
            // Parse the API error response and return a user-friendly error object
            const result = {
                type: 'API_ERROR',
                message: 'Request failed',
                details: responseText
            };

            try {
                const parsed = JSON.parse(responseText);

                // Handle Xano-style error responses
                if (parsed.message) {
                    result.message = parsed.message;
                }
                if (parsed.code) {
                    result.type = parsed.code;
                }
                if (parsed.payload) {
                    result.details = parsed.payload;
                }

                // Handle validation errors
                if (parsed.errors && Array.isArray(parsed.errors)) {
                    result.type = 'VALIDATION';
                    result.message = parsed.errors.map(e => e.message || e).join(', ');
                    result.details = parsed.errors;
                }

                // Handle field-specific errors
                if (parsed.field) {
                    result.type = 'FIELD_ERROR';
                    result.message = `Field "${parsed.field}": ${parsed.message || 'Invalid value'}`;
                }

            } catch (e) {
                // Not JSON, use status code to determine error type
                if (statusCode === 400) {
                    result.type = 'BAD_REQUEST';
                    result.message = 'Invalid request data';
                } else if (statusCode === 401) {
                    result.type = 'UNAUTHORIZED';
                    result.message = 'Authentication required';
                } else if (statusCode === 403) {
                    result.type = 'FORBIDDEN';
                    result.message = 'Access denied';
                } else if (statusCode === 404) {
                    result.type = 'NOT_FOUND';
                    result.message = 'Endpoint not found';
                } else if (statusCode === 409) {
                    result.type = 'CONFLICT';
                    result.message = 'Record conflict (duplicate?)';
                } else if (statusCode === 422) {
                    result.type = 'VALIDATION';
                    result.message = 'Validation failed';
                } else if (statusCode >= 500) {
                    result.type = 'SERVER_ERROR';
                    result.message = 'Server error - please try again';
                }
            }

            return result;
        }

        // ============================================
        // ADVANCED FILTER BUILDER WITH AND/OR LOGIC
        // ============================================

        // Filter builder state
        let filterGroups = [];
        let filterGroupIdCounter = 0;
        let activeAdvancedFilter = null;

        // Available fields for filtering
        const filterableFields = [
            { key: 'Plaintiff', label: 'Plaintiff/Landlord', type: 'text' },
            { key: 'Defendant', label: 'Defendant/Tenant', type: 'text' },
            { key: 'Attorney', label: 'Landlord Attorney', type: 'text' },
            { key: 'Defense_Attorney', label: 'Defense Attorney', type: 'text' },
            { key: 'Case_Number', label: 'Case Number', type: 'text' },
            { key: 'District', label: 'Council District', type: 'text' },
            { key: 'File_Date', label: 'File Date', type: 'date' },
            { key: 'Address', label: 'Address', type: 'text' },
            { key: 'Status', label: 'Status', type: 'select', options: ['PENDING', 'CLOSED', 'DISMISSED', 'JUDGMENT'] },
            { key: 'Judge', label: 'Judge', type: 'text' },
            // Service & Writ
            { key: 'service_date', label: 'Service Date', type: 'date' },
            { key: 'paper_writ_date', label: 'Paper Writ Date', type: 'date' },
            { key: 'writ_issued_date', label: 'Writ of Restitution Issued', type: 'date' },
            { key: 'writ_served_date', label: 'Sheriff Paper Return (Physical Removal)', type: 'date' },
            // Judgment
            { key: 'judgment_date', label: 'Judgment Date', type: 'date' },
            { key: 'judgment_for', label: 'Judgment For', type: 'select', options: ['Plaintiff', 'Defendant'] },
            { key: 'case_dismissed', label: 'Case Dismissed', type: 'boolean' },
            { key: 'dismissal_date', label: 'Dismissal Date', type: 'date' }
            // eviction_executed, eviction_date, eviction_method removed - derived/interpreted fields
        ];

        // Available operators by field type
        const operatorsByType = {
            text: [
                { key: 'contains', label: 'Contains' },
                { key: 'not_contains', label: 'Does not contain' },
                { key: 'equals', label: 'Equals' },
                { key: 'not_equals', label: 'Does not equal' },
                { key: 'starts_with', label: 'Starts with' },
                { key: 'ends_with', label: 'Ends with' },
                { key: 'is_empty', label: 'Is empty' },
                { key: 'is_not_empty', label: 'Is not empty' }
            ],
            select: [
                { key: 'equals', label: 'Is' },
                { key: 'not_equals', label: 'Is not' }
            ],
            date: [
                { key: 'equals', label: 'Is' },
                { key: 'not_equals', label: 'Is not' },
                { key: 'before', label: 'Before' },
                { key: 'after', label: 'After' },
                { key: 'between', label: 'Between' },
                { key: 'last_n_days', label: 'In last N days' },
                { key: 'is_empty', label: 'Has no date' },
                { key: 'is_not_empty', label: 'Has a date' }
            ],
            boolean: [
                { key: 'equals', label: 'Is' },
                { key: 'is_empty', label: 'Not recorded' }
            ]
        };

        function initializeFilterBuilder() {
            loadFilterPresets();

            // Add initial empty group if none exist
            if (filterGroups.length === 0) {
                addFilterGroup();
            } else {
                renderFilterGroups();
            }
        }

        function addFilterGroup(parentGroupId = null) {
            const groupId = ++filterGroupIdCounter;
            const newGroup = {
                id: groupId,
                logic: 'AND',
                conditions: [],
                nestedGroups: [],
                parentId: parentGroupId
            };

            if (parentGroupId === null) {
                filterGroups.push(newGroup);
            } else {
                const parentGroup = findGroupById(parentGroupId);
                if (parentGroup) {
                    parentGroup.nestedGroups.push(newGroup);
                }
            }

            // Add one empty condition by default
            addConditionToGroup(groupId);

            renderFilterGroups();
            return groupId;
        }

        function findGroupById(groupId, groups = filterGroups) {
            for (const group of groups) {
                if (group.id === groupId) return group;
                const found = findGroupById(groupId, group.nestedGroups);
                if (found) return found;
            }
            return null;
        }

        function addConditionToGroup(groupId) {
            const group = findGroupById(groupId);
            if (!group) return;

            group.conditions.push({
                id: Date.now() + Math.random(),
                field: 'Plaintiff',
                operator: 'contains',
                value: '',
                value2: '' // For 'between' operator
            });

            renderFilterGroups();
        }

        function removeCondition(groupId, conditionId) {
            const group = findGroupById(groupId);
            if (!group) return;

            group.conditions = group.conditions.filter(c => c.id !== conditionId);
            renderFilterGroups();
        }

        function removeGroup(groupId) {
            // Remove from root level
            filterGroups = filterGroups.filter(g => g.id !== groupId);

            // Also remove from nested groups
            function removeNested(groups) {
                for (const group of groups) {
                    group.nestedGroups = group.nestedGroups.filter(g => g.id !== groupId);
                    removeNested(group.nestedGroups);
                }
            }
            removeNested(filterGroups);

            renderFilterGroups();
        }

        function toggleGroupLogic(groupId) {
            const group = findGroupById(groupId);
            if (!group) return;

            group.logic = group.logic === 'AND' ? 'OR' : 'AND';
            renderFilterGroups();
        }

        function updateCondition(groupId, conditionId, field, value) {
            const group = findGroupById(groupId);
            if (!group) return;

            const condition = group.conditions.find(c => c.id === conditionId);
            if (!condition) return;

            condition[field] = value;

            // Reset operator if field type changed
            if (field === 'field') {
                const fieldDef = filterableFields.find(f => f.key === value);
                const operators = operatorsByType[fieldDef?.type || 'text'];
                condition.operator = operators[0].key;
                condition.value = '';
                condition.value2 = '';
            }

            renderFilterGroups();
        }

        function renderFilterGroups() {
            const container = document.getElementById('filterGroupsContainer');
            if (!container) return;

            if (filterGroups.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No filter groups. Click "Add Group" to start building your filter.</p>';
                return;
            }

            container.innerHTML = filterGroups.map(group => renderGroup(group, false)).join('');
        }

        function renderGroup(group, isNested) {
            const logicClass = group.logic === 'AND' ? 'and-group' : 'or-group';
            const nestedClass = isNested ? `nested-group ${logicClass}` : '';

            let html = `
                <div class="filter-group ${logicClass} ${nestedClass}" data-group-id="${group.id}">
                    <div class="filter-group-header">
                        <div class="filter-group-logic">
                            <span class="text-xs font-semibold text-gray-500 uppercase">Match</span>
                            <div class="logic-toggle">
                                <button onclick="toggleGroupLogic(${group.id})" class="${group.logic === 'AND' ? 'active-and' : ''}">AND</button>
                                <button onclick="toggleGroupLogic(${group.id})" class="${group.logic === 'OR' ? 'active-or' : ''}">OR</button>
                            </div>
                            <span class="text-xs text-gray-500">of the following</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="addConditionToGroup(${group.id})" class="add-condition-btn">+ Condition</button>
                            <button onclick="addFilterGroup(${group.id})" class="add-condition-btn">+ Nested Group</button>
                            ${filterGroups.length > 1 || group.parentId ? `<button onclick="removeGroup(${group.id})" class="add-condition-btn" style="color: #dc2626; border-color: #fecaca;">Remove</button>` : ''}
                        </div>
                    </div>
                    <div class="filter-conditions">
            `;

            // Render conditions
            for (const condition of group.conditions) {
                html += renderCondition(group.id, condition);
            }

            // Render nested groups
            for (const nestedGroup of group.nestedGroups) {
                html += renderGroup(nestedGroup, true);
            }

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        function renderCondition(groupId, condition) {
            const fieldDef = filterableFields.find(f => f.key === condition.field) || filterableFields[0];
            const operators = operatorsByType[fieldDef.type] || operatorsByType.text;

            const fieldOptions = filterableFields.map(f =>
                `<option value="${f.key}" ${condition.field === f.key ? 'selected' : ''}>${f.label}</option>`
            ).join('');

            const operatorOptions = operators.map(op =>
                `<option value="${op.key}" ${condition.operator === op.key ? 'selected' : ''}>${op.label}</option>`
            ).join('');

            let valueInput = '';
            const needsNoValue = ['is_empty', 'is_not_empty'].includes(condition.operator);

            if (needsNoValue) {
                valueInput = '<span class="text-gray-400 text-sm italic">No value needed</span>';
            } else if (fieldDef.type === 'boolean') {
                valueInput = `<select onchange="updateCondition(${groupId}, ${condition.id}, 'value', this.value)">
                    <option value="">Select...</option>
                    <option value="true" ${condition.value === 'true' ? 'selected' : ''}>Yes</option>
                    <option value="false" ${condition.value === 'false' ? 'selected' : ''}>No</option>
                </select>`;
            } else if (fieldDef.type === 'select') {
                const selectOptions = (fieldDef.options || []).map(opt =>
                    `<option value="${opt}" ${condition.value === opt ? 'selected' : ''}>${opt}</option>`
                ).join('');
                valueInput = `<select onchange="updateCondition(${groupId}, ${condition.id}, 'value', this.value)">
                    <option value="">Select...</option>
                    ${selectOptions}
                </select>`;
            } else if (fieldDef.type === 'date') {
                if (condition.operator === 'between') {
                    valueInput = `
                        <div class="flex gap-2 items-center">
                            <input type="date" value="${condition.value}" onchange="updateCondition(${groupId}, ${condition.id}, 'value', this.value)">
                            <span class="text-xs text-gray-500">to</span>
                            <input type="date" value="${condition.value2 || ''}" onchange="updateCondition(${groupId}, ${condition.id}, 'value2', this.value)">
                        </div>
                    `;
                } else if (condition.operator === 'last_n_days') {
                    valueInput = `<input type="number" min="1" placeholder="Number of days" value="${condition.value}" onchange="updateCondition(${groupId}, ${condition.id}, 'value', this.value)">`;
                } else {
                    valueInput = `<input type="date" value="${condition.value}" onchange="updateCondition(${groupId}, ${condition.id}, 'value', this.value)">`;
                }
            } else {
                valueInput = `<input type="text" placeholder="Enter value..." value="${escapeHtml(condition.value)}" onchange="updateCondition(${groupId}, ${condition.id}, 'value', this.value)">`;
            }

            return `
                <div class="filter-condition" data-condition-id="${condition.id}">
                    <select onchange="updateCondition(${groupId}, ${condition.id}, 'field', this.value)">
                        ${fieldOptions}
                    </select>
                    <select onchange="updateCondition(${groupId}, ${condition.id}, 'operator', this.value)">
                        ${operatorOptions}
                    </select>
                    ${valueInput}
                    <button class="remove-condition" onclick="removeCondition(${groupId}, ${condition.id})">√ó</button>
                </div>
            `;
        }

        // Evaluate a single condition against a record
        function evaluateCondition(record, condition) {
            const fieldDef = filterableFields.find(f => f.key === condition.field);
            let recordValue = record[condition.field];

            // Handle null/undefined
            if (recordValue === null || recordValue === undefined) {
                recordValue = '';
            }

            // Convert to string for text comparisons
            const strValue = String(recordValue).toLowerCase();
            const compareValue = String(condition.value || '').toLowerCase();

            switch (condition.operator) {
                case 'contains':
                    return strValue.includes(compareValue);
                case 'not_contains':
                    return !strValue.includes(compareValue);
                case 'equals':
                    if (fieldDef?.type === 'boolean') {
                        // Handle boolean comparison - condition.value is 'true' or 'false' string
                        const boolValue = condition.value === 'true';
                        return recordValue === boolValue;
                    }
                    if (fieldDef?.type === 'date') {
                        return recordValue === condition.value;
                    }
                    if (fieldDef?.type === 'select') {
                        // Case-insensitive match for select fields
                        return strValue === compareValue;
                    }
                    return strValue === compareValue;
                case 'not_equals':
                    if (fieldDef?.type === 'boolean') {
                        const boolValue = condition.value === 'true';
                        return recordValue !== boolValue;
                    }
                    if (fieldDef?.type === 'date') {
                        return recordValue !== condition.value;
                    }
                    return strValue !== compareValue;
                case 'starts_with':
                    return strValue.startsWith(compareValue);
                case 'ends_with':
                    return strValue.endsWith(compareValue);
                case 'is_empty':
                    return strValue.trim() === '';
                case 'is_not_empty':
                    return strValue.trim() !== '';
                case 'before':
                    if (!recordValue || !condition.value) return false;
                    return new Date(recordValue) < new Date(condition.value);
                case 'after':
                    if (!recordValue || !condition.value) return false;
                    return new Date(recordValue) > new Date(condition.value);
                case 'between':
                    if (!recordValue || !condition.value || !condition.value2) return false;
                    const date = new Date(recordValue);
                    return date >= new Date(condition.value) && date <= new Date(condition.value2);
                case 'last_n_days':
                    if (!recordValue || !condition.value) return false;
                    const days = parseInt(condition.value, 10);
                    if (isNaN(days)) return false;
                    const cutoff = new Date();
                    cutoff.setDate(cutoff.getDate() - days);
                    return new Date(recordValue) >= cutoff;
                default:
                    return true;
            }
        }

        // Evaluate a group (with AND/OR logic)
        function evaluateGroup(record, group) {
            const conditionResults = group.conditions.map(c => evaluateCondition(record, c));
            const nestedResults = group.nestedGroups.map(g => evaluateGroup(record, g));
            const allResults = [...conditionResults, ...nestedResults];

            if (allResults.length === 0) return true;

            if (group.logic === 'AND') {
                return allResults.every(result => result === true);
            } else {
                return allResults.some(result => result === true);
            }
        }

        // Show/hide filter loading state
        function setFilterLoadingState(isLoading) {
            const loadingIndicator = document.getElementById('filterLoadingIndicator');
            const applyBtn = document.getElementById('applyFilterBtn');
            const filterBuilder = document.getElementById('filterBuilderContainer');

            if (isLoading) {
                if (loadingIndicator) loadingIndicator.classList.remove('hidden');
                if (applyBtn) {
                    applyBtn.classList.add('loading');
                    applyBtn.disabled = true;
                }
                if (filterBuilder) filterBuilder.classList.add('loading');
                updateStatus('Applying filters...', 'loading');
            } else {
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
                if (applyBtn) {
                    applyBtn.classList.remove('loading');
                    applyBtn.disabled = false;
                }
                if (filterBuilder) filterBuilder.classList.remove('loading');
            }
        }

        // Apply the advanced filter
        function applyAdvancedFilters() {
            // Show loading state immediately
            setFilterLoadingState(true);

            // Use setTimeout to allow UI to update before heavy processing
            setTimeout(() => {
                try {
                    // Clear other filters
                    chartFilter = null;
                    nameFilter = null;
                    updateChartFilterIndicator();
                    updateNameFilterIndicator();

                    // Check if there are any valid conditions
                    const hasConditions = filterGroups.some(group =>
                        group.conditions.length > 0 || group.nestedGroups.length > 0
                    );

                    if (!hasConditions) {
                        filteredData = allData;
                        activeAdvancedFilter = null;
                    } else {
                        // Store the active filter for display
                        activeAdvancedFilter = JSON.parse(JSON.stringify(filterGroups));

                        // Filter data - records must pass ALL root-level groups (implicit AND between root groups)
                        filteredData = allData.filter(record => {
                            return filterGroups.every(group => evaluateGroup(record, group));
                        });
                    }

                    // Update display
                    if (viewMode === 'pivot') {
                        pivotData = buildPivotData(pivotDimension);
                    }

                    if (gridApi) {
                        if (viewMode === 'pivot') {
                            gridApi.setRowData(pivotData);
                        } else {
                            gridApi.setRowData(filteredData);
                        }
                    }

                    updateRecordCount();
                    updateFilterSummary();
                    createDistrictMap();
                    updateDemographicsCharts();
                    updateDemoFilterIndicator();
                    updateStatus(`Filter applied - showing ${filteredData.length.toLocaleString()} records`, 'success');

                    // Persist advanced filter state
                    debouncedSaveUIState();

                    // Update URL with filter state
                    updateUrlWithFilters();
                } finally {
                    // Always hide loading state when done
                    setFilterLoadingState(false);
                }
            }, 50);
        }

        function clearAdvancedFilters() {
            // Show loading state
            setFilterLoadingState(true);
            updateStatus('Clearing filters...', 'loading');

            setTimeout(() => {
                try {
                    filterGroups = [];
                    filterGroupIdCounter = 0;
                    activeAdvancedFilter = null;

                    // Reset to all data
                    filteredData = allData;

                    // Add a fresh group
                    addFilterGroup();

                    if (viewMode === 'pivot') {
                        pivotData = buildPivotData(pivotDimension);
                    }

                    if (gridApi) {
                        if (viewMode === 'pivot') {
                            gridApi.setRowData(pivotData);
                        } else {
                            gridApi.setRowData(filteredData);
                        }
                    }

                    updateRecordCount();
                    updateFilterSummary();
                    createDistrictMap();
                    updateDemographicsCharts();
                    updateDemoFilterIndicator();
                    updateStatus(`Filters cleared - showing all ${allData.length.toLocaleString()} records`, 'success');

                    // Persist cleared filter state
                    debouncedSaveUIState();

                    // Clear URL filter parameters
                    updateUrlWithFilters();
                } finally {
                    setFilterLoadingState(false);
                }
            }, 50);
        }

        function updateFilterSummary() {
            const summaryDiv = document.getElementById('activeFilterSummary');
            const summaryText = document.getElementById('filterSummaryText');

            if (!summaryDiv || !summaryText) return;

            if (!activeAdvancedFilter || activeAdvancedFilter.length === 0) {
                summaryDiv.classList.add('hidden');
                return;
            }

            // Build human-readable summary
            const summary = buildFilterSummaryText(activeAdvancedFilter);
            summaryText.innerHTML = summary;
            summaryDiv.classList.remove('hidden');
        }

        function buildFilterSummaryText(groups) {
            return groups.map(group => {
                const parts = [];

                for (const condition of group.conditions) {
                    const fieldDef = filterableFields.find(f => f.key === condition.field);
                    const fieldLabel = fieldDef?.label || condition.field;

                    let conditionText = `<code>${fieldLabel}</code> `;

                    // Format value for display (convert boolean strings to Yes/No)
                    const displayValue = fieldDef?.type === 'boolean'
                        ? (condition.value === 'true' ? 'Yes' : 'No')
                        : condition.value;

                    switch (condition.operator) {
                        case 'contains': conditionText += `contains "${condition.value}"`; break;
                        case 'not_contains': conditionText += `doesn't contain "${condition.value}"`; break;
                        case 'equals': conditionText += `= "${displayValue}"`; break;
                        case 'not_equals': conditionText += `‚â† "${displayValue}"`; break;
                        case 'starts_with': conditionText += `starts with "${condition.value}"`; break;
                        case 'ends_with': conditionText += `ends with "${condition.value}"`; break;
                        case 'is_empty': conditionText += fieldDef?.type === 'date' ? 'has no date' : 'is empty'; break;
                        case 'is_not_empty': conditionText += fieldDef?.type === 'date' ? 'has a date' : 'is not empty'; break;
                        case 'before': conditionText += `before ${condition.value}`; break;
                        case 'after': conditionText += `after ${condition.value}`; break;
                        case 'between': conditionText += `between ${condition.value} and ${condition.value2}`; break;
                        case 'last_n_days': conditionText += `in last ${condition.value} days`; break;
                        default: conditionText += condition.operator;
                    }

                    parts.push(conditionText);
                }

                // Add nested groups
                for (const nestedGroup of group.nestedGroups) {
                    parts.push(`(${buildFilterSummaryText([nestedGroup])})`);
                }

                const logicWord = group.logic === 'AND' ? ' AND ' : ' OR ';
                return parts.join(logicWord);
            }).join(' AND ');
        }

        // Quick filter presets
        function applyQuickFilter(preset) {
            // Show immediate feedback
            const presetNames = { last30: 'Last 30 Days', last90: 'Last 90 Days', lastYear: 'Last Year' };
            updateStatus(`Applying ${presetNames[preset] || preset} filter...`, 'loading');

            // Clear existing groups
            filterGroups = [];
            filterGroupIdCounter = 0;

            const now = new Date();
            const groupId = addFilterGroup();
            const group = findGroupById(groupId);

            // Remove the default empty condition
            group.conditions = [];

            switch (preset) {
                case 'last30':
                    group.conditions.push({
                        id: Date.now(),
                        field: 'File_Date',
                        operator: 'last_n_days',
                        value: '30',
                        value2: ''
                    });
                    break;
                case 'last90':
                    group.conditions.push({
                        id: Date.now(),
                        field: 'File_Date',
                        operator: 'last_n_days',
                        value: '90',
                        value2: ''
                    });
                    break;
                case 'lastYear':
                    group.conditions.push({
                        id: Date.now(),
                        field: 'File_Date',
                        operator: 'last_n_days',
                        value: '365',
                        value2: ''
                    });
                    break;
            }

            renderFilterGroups();
            applyAdvancedFilters();
        }

        // ============================================
        // FILTER PRESETS (SAVE/LOAD)
        // ============================================

        const FILTER_PRESETS_KEY = 'eviction_filter_presets';

        function loadFilterPresets() {
            const container = document.getElementById('presetsList');
            if (!container) return;

            const presets = getFilterPresets();

            if (presets.length === 0) {
                container.innerHTML = '<span class="text-sm text-gray-400">No saved filters yet</span>';
                return;
            }

            container.innerHTML = presets.map((preset, index) => `
                <span class="filter-preset-badge" onclick="loadFilterPreset(${index})">
                    ${escapeHtml(preset.name)}
                    <span class="delete-preset" onclick="event.stopPropagation(); deleteFilterPreset(${index})">√ó</span>
                </span>
            `).join('');
        }

        function getFilterPresets() {
            try {
                return JSON.parse(localStorage.getItem(FILTER_PRESETS_KEY) || '[]');
            } catch {
                return [];
            }
        }

        function saveFilterPresets(presets) {
            localStorage.setItem(FILTER_PRESETS_KEY, JSON.stringify(presets));
        }

        function saveFilterPreset() {
            const hasConditions = filterGroups.some(group =>
                group.conditions.length > 0 || group.nestedGroups.length > 0
            );

            if (!hasConditions) {
                alert('Please add at least one filter condition before saving.');
                return;
            }

            const name = prompt('Enter a name for this filter preset:');
            if (!name || name.trim() === '') return;

            const presets = getFilterPresets();
            presets.push({
                name: name.trim(),
                groups: JSON.parse(JSON.stringify(filterGroups)),
                createdAt: new Date().toISOString()
            });

            saveFilterPresets(presets);
            loadFilterPresets();
            updateStatus(`Filter preset "${name}" saved!`, 'success');
        }

        function loadFilterPreset(index) {
            const presets = getFilterPresets();
            if (index < 0 || index >= presets.length) return;

            const preset = presets[index];

            // Show immediate feedback
            updateStatus(`Loading filter preset: ${preset.name}...`, 'loading');

            filterGroups = JSON.parse(JSON.stringify(preset.groups));

            // Recalculate max ID to avoid collisions
            filterGroupIdCounter = 0;
            function findMaxId(groups) {
                for (const group of groups) {
                    if (group.id > filterGroupIdCounter) filterGroupIdCounter = group.id;
                    findMaxId(group.nestedGroups);
                }
            }
            findMaxId(filterGroups);

            renderFilterGroups();
            applyAdvancedFilters();
            // Note: applyAdvancedFilters will show success message when done
        }

        function deleteFilterPreset(index) {
            const presets = getFilterPresets();
            if (index < 0 || index >= presets.length) return;

            if (!confirm(`Delete filter preset "${presets[index].name}"?`)) return;

            presets.splice(index, 1);
            saveFilterPresets(presets);
            loadFilterPresets();
        }

        // ============================================
        // CUSTOM GROUPING FUNCTIONALITY
        // ============================================

        const GROUPING_PRESETS_KEY = 'eviction_grouping_presets';
        let customGroupingConfig = {
            field1: '',
            field2: '',
            aggregations: ['count', 'lastDate']
        };

        function toggleAggregation(button) {
            button.classList.toggle('active');
            updateCustomGroupingConfig();
        }

        function updateCustomGroupingConfig() {
            customGroupingConfig.field1 = document.getElementById('customGroupField')?.value || '';
            customGroupingConfig.field2 = document.getElementById('customGroupField2')?.value || '';

            customGroupingConfig.aggregations = [];
            document.querySelectorAll('.aggregation-option.active').forEach(btn => {
                customGroupingConfig.aggregations.push(btn.dataset.agg);
            });
        }

        function updateCustomGroupPreview() {
            updateCustomGroupingConfig();
        }

        function applyCustomGrouping() {
            updateCustomGroupingConfig();

            if (!customGroupingConfig.field1) {
                alert('Please select a field to group by.');
                return;
            }

            // Switch to pivot view with custom grouping
            viewMode = 'pivot';

            // Build custom pivot data
            const field1 = customGroupingConfig.field1;
            const field2 = customGroupingConfig.field2;

            pivotData = buildCustomPivotData(field1, field2, customGroupingConfig.aggregations);

            if (gridApi) {
                gridApi.setColumnDefs(getCustomPivotColumnDefs(field1, field2, customGroupingConfig.aggregations));
                gridApi.setRowData(pivotData);
            }

            updatePivotControls();
            updateRecordCount();
            updateStatus(`Grouped by ${getFieldLabel(field1)}${field2 ? ' and ' + getFieldLabel(field2) : ''}`, 'success');
        }

        function getFieldLabel(fieldKey) {
            const labels = {
                'Plaintiff': 'Landlord',
                'Defendant': 'Tenant',
                'Attorney': 'Attorney',
                'District': 'Council District',
                'File_Date_Month': 'Month',
                'File_Date_Year': 'Year',
                'File_Date_Quarter': 'Quarter'
            };
            return labels[fieldKey] || fieldKey;
        }

        function getFieldValue(record, fieldKey) {
            if (fieldKey === 'File_Date_Month') {
                const date = new Date(record.File_Date);
                if (isNaN(date.getTime())) return 'Unknown';
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${months[date.getMonth()]} ${date.getFullYear()}`;
            }
            if (fieldKey === 'File_Date_Year') {
                const date = new Date(record.File_Date);
                if (isNaN(date.getTime())) return 'Unknown';
                return String(date.getFullYear());
            }
            if (fieldKey === 'File_Date_Quarter') {
                const date = new Date(record.File_Date);
                if (isNaN(date.getTime())) return 'Unknown';
                const quarter = Math.floor(date.getMonth() / 3) + 1;
                return `Q${quarter} ${date.getFullYear()}`;
            }
            return record[fieldKey] || 'Unknown';
        }

        function buildCustomPivotData(field1, field2, aggregations) {
            const summaries = new Map();

            filteredData.forEach(record => {
                const key1 = String(getFieldValue(record, field1)).trim() || 'Unknown';
                const key2 = field2 ? String(getFieldValue(record, field2)).trim() || 'Unknown' : null;
                const groupKey = field2 ? `${key1} | ${key2}` : key1;

                if (!summaries.has(groupKey)) {
                    summaries.set(groupKey, {
                        groupKey: groupKey,
                        field1Value: key1,
                        field2Value: key2,
                        count: 0,
                        firstDate: null,
                        lastDate: null,
                        addresses: new Set()
                    });
                }

                const summary = summaries.get(groupKey);
                summary.count += 1;

                if (record.File_Date) {
                    const fileDate = new Date(record.File_Date);
                    if (!isNaN(fileDate)) {
                        if (!summary.firstDate || fileDate < summary.firstDate) {
                            summary.firstDate = fileDate;
                        }
                        if (!summary.lastDate || fileDate > summary.lastDate) {
                            summary.lastDate = fileDate;
                        }
                    }
                }

                if (record.Address) {
                    summary.addresses.add(String(record.Address).trim().toLowerCase());
                }
            });

            return Array.from(summaries.values())
                .map(summary => ({
                    groupKey: summary.groupKey,
                    field1Value: summary.field1Value,
                    field2Value: summary.field2Value,
                    count: summary.count,
                    firstDate: summary.firstDate ? summary.firstDate.toISOString() : '',
                    lastDate: summary.lastDate ? summary.lastDate.toISOString() : '',
                    uniqueAddresses: summary.addresses.size
                }))
                .sort((a, b) => b.count - a.count);
        }

        function getCustomPivotColumnDefs(field1, field2, aggregations) {
            const columns = [];
            const isDefendantField1 = field1 === 'Defendant';
            const isDefendantField2 = field2 === 'Defendant';

            columns.push({
                field: 'field1Value',
                headerName: getFieldLabel(field1),
                flex: 2,
                minWidth: 160,
                cellRenderer: params => {
                    if (!params.value) return '';
                    // Scramble defendant names when not logged in
                    const displayValue = (isDefendantField1 && !isLoggedIn)
                        ? getDefendantDisplayName(params.value)
                        : params.value;
                    if (isDefendantField1 && !isLoggedIn) {
                        return `<span class="text-gray-500 cursor-default" title="Login to view tenant name">${displayValue}</span>`;
                    }
                    return `<span class="text-indigo-600 hover:text-indigo-800 hover:underline cursor-pointer">${displayValue}</span>`;
                }
            });

            if (field2) {
                columns.push({
                    field: 'field2Value',
                    headerName: getFieldLabel(field2),
                    flex: 1,
                    minWidth: 120,
                    cellRenderer: params => {
                        if (!params.value) return '';
                        // Scramble defendant names when not logged in
                        if (isDefendantField2 && !isLoggedIn) {
                            return `<span class="text-gray-500" title="Login to view tenant name">${getDefendantDisplayName(params.value)}</span>`;
                        }
                        return params.value;
                    }
                });
            }

            if (aggregations.includes('count')) {
                columns.push({ field: 'count', headerName: 'Count', width: 100, sort: 'desc', sortIndex: 0 });
            }
            if (aggregations.includes('firstDate')) {
                columns.push({
                    field: 'firstDate',
                    headerName: 'First Filing',
                    width: 120,
                    valueFormatter: params => params.value ? new Date(params.value).toLocaleDateString() : '',
                    comparator: (valueA, valueB) => {
                        const dateA = valueA ? new Date(valueA).getTime() : 0;
                        const dateB = valueB ? new Date(valueB).getTime() : 0;
                        return dateA - dateB;
                    }
                });
            }
            if (aggregations.includes('lastDate')) {
                columns.push({
                    field: 'lastDate',
                    headerName: 'Last Filing',
                    width: 120,
                    valueFormatter: params => params.value ? new Date(params.value).toLocaleDateString() : '',
                    comparator: (valueA, valueB) => {
                        const dateA = valueA ? new Date(valueA).getTime() : 0;
                        const dateB = valueB ? new Date(valueB).getTime() : 0;
                        return dateA - dateB;
                    }
                });
            }
            if (aggregations.includes('uniqueAddresses')) {
                columns.push({ field: 'uniqueAddresses', headerName: 'Unique Addresses', width: 140 });
            }

            return columns;
        }

        function resetToDefaultGrouping() {
            // Reset to default pivot dimension
            pivotDimension = 'plaintiff';
            viewMode = 'pivot';

            // Reset the dropdowns
            const field1Select = document.getElementById('customGroupField');
            const field2Select = document.getElementById('customGroupField2');
            if (field1Select) field1Select.value = '';
            if (field2Select) field2Select.value = '';

            // Reset aggregation buttons
            document.querySelectorAll('.aggregation-option').forEach(btn => {
                const agg = btn.dataset.agg;
                if (['count', 'lastDate'].includes(agg)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Use default pivot
            pivotData = buildPivotData(pivotDimension);

            if (gridApi) {
                gridApi.setColumnDefs(getPivotColumnDefs());
                gridApi.setRowData(pivotData);
            }

            updatePivotControls();
            updateRecordCount();
            updateStatus('Reset to default grouping', 'success');
        }

        // Saved groupings
        function loadSavedGroupings() {
            const container = document.getElementById('savedGroupingsList');
            if (!container) return;

            const groupings = getSavedGroupings();

            if (groupings.length === 0) {
                container.innerHTML = '<span class="text-sm text-gray-400">No saved groupings yet</span>';
                return;
            }

            container.innerHTML = groupings.map((grouping, index) => `
                <span class="filter-preset-badge" onclick="loadSavedGrouping(${index})">
                    ${escapeHtml(grouping.name)}
                    <span class="delete-preset" onclick="event.stopPropagation(); deleteSavedGrouping(${index})">√ó</span>
                </span>
            `).join('');
        }

        function getSavedGroupings() {
            try {
                return JSON.parse(localStorage.getItem(GROUPING_PRESETS_KEY) || '[]');
            } catch {
                return [];
            }
        }

        function saveCustomGrouping() {
            updateCustomGroupingConfig();

            if (!customGroupingConfig.field1) {
                alert('Please select a field to group by before saving.');
                return;
            }

            const name = prompt('Enter a name for this grouping:');
            if (!name || name.trim() === '') return;

            const groupings = getSavedGroupings();
            groupings.push({
                name: name.trim(),
                config: JSON.parse(JSON.stringify(customGroupingConfig)),
                createdAt: new Date().toISOString()
            });

            localStorage.setItem(GROUPING_PRESETS_KEY, JSON.stringify(groupings));
            loadSavedGroupings();
            updateStatus(`Grouping "${name}" saved!`, 'success');
        }

        function loadSavedGrouping(index) {
            const groupings = getSavedGroupings();
            if (index < 0 || index >= groupings.length) return;

            const grouping = groupings[index];
            customGroupingConfig = JSON.parse(JSON.stringify(grouping.config));

            // Update UI
            const field1Select = document.getElementById('customGroupField');
            const field2Select = document.getElementById('customGroupField2');
            if (field1Select) field1Select.value = customGroupingConfig.field1 || '';
            if (field2Select) field2Select.value = customGroupingConfig.field2 || '';

            // Update aggregation buttons
            document.querySelectorAll('.aggregation-option').forEach(btn => {
                const agg = btn.dataset.agg;
                if (customGroupingConfig.aggregations.includes(agg)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            applyCustomGrouping();
            updateStatus(`Loaded grouping: ${grouping.name}`, 'success');
        }

        function deleteSavedGrouping(index) {
            const groupings = getSavedGroupings();
            if (index < 0 || index >= groupings.length) return;

            if (!confirm(`Delete grouping "${groupings[index].name}"?`)) return;

            groupings.splice(index, 1);
            localStorage.setItem(GROUPING_PRESETS_KEY, JSON.stringify(groupings));
            loadSavedGroupings();
        }

        // Keep legacy applyFilters for compatibility
        function applyFilters() {
            // Convert to advanced filter format
            filterGroups = [];
            filterGroupIdCounter = 0;

            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            if (dateFrom || dateTo) {
                const groupId = addFilterGroup();
                const group = findGroupById(groupId);
                group.conditions = [];

                if (dateFrom && dateTo) {
                    group.conditions.push({
                        id: Date.now(),
                        field: 'File_Date',
                        operator: 'between',
                        value: dateFrom,
                        value2: dateTo
                    });
                } else if (dateFrom) {
                    group.conditions.push({
                        id: Date.now(),
                        field: 'File_Date',
                        operator: 'after',
                        value: dateFrom,
                        value2: ''
                    });
                } else if (dateTo) {
                    group.conditions.push({
                        id: Date.now(),
                        field: 'File_Date',
                        operator: 'before',
                        value: dateTo,
                        value2: ''
                    });
                }

                renderFilterGroups();
                applyAdvancedFilters();
            }
        }
    </script>
</body>
</html>
