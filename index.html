<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nashville Eviction Tracker (Community Project - UNOFFICIAL)</title>
    <link rel="icon" type="image/png" href="https://storage.googleapis.com/intelechia-content/im/eviction%20prevention%20logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/styles/ag-theme-alpine.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #4f46e5;
            --secondary: #06b6d4;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
        }
        
        body { 
            font-family: 'Inter', sans-serif;a
            background: #f9fafb;
        }
        
        .unofficial-banner {
            background: #fef3c7;
            border-bottom: 2px solid #f59e0b;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            color: #92400e;
        }
        
        .data-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        
        .trend-up { color: var(--danger); }
        .trend-down { color: var(--success); }
        
        .district-cell {
            border: 1px solid #e5e7eb;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            font-weight: 600;
            border-radius: 4px;
            position: relative;
        }
        
        .district-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .heat-0 { background: #f3f4f6; color: #9ca3af; }
        .heat-1 { background: #dbeafe; color: #1e40af; }
        .heat-2 { background: #fef3c7; color: #92400e; }
        .heat-3 { background: #fed7aa; color: #9a3412; }
        .heat-4 { background: #fca5a5; color: #991b1b; }
        .heat-5 { background: #ef4444; color: white; }
        
        .activity-dots {
            font-size: 16px;
            line-height: 1;
            letter-spacing: -2px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            font-weight: 500;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .search-input {
            background: white;
            border: 2px solid #e5e7eb;
            padding: 10px 16px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #4338ca;
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }
        
        #dataGrid {
            height: 600px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .ag-theme-alpine {
            --ag-header-background-color: #f9fafb;
            --ag-header-foreground-color: #111827;
            --ag-header-height: 48px;
            --ag-row-hover-color: #f3f4f6;
        }

        .ag-theme-alpine .ag-cell,
        .ag-theme-alpine .ag-header-cell,
        .ag-theme-alpine .ag-header-cell-label {
            -webkit-user-select: text;
            user-select: text;
        }
        
        .chart-container {
            position: relative;
            height: 320px;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-weight: 500;
        }
        
        .status-loading {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .fuzzy-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
        }
        
        .fuzzy-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }
        
        .match-result {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
        }
        
        .match-result:hover {
            background: #f9fafb;
        }
        
        .confidence-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .confidence-high { background: #10b981; color: white; }
        .confidence-med { background: #f59e0b; color: white; }
        .confidence-low { background: #ef4444; color: white; }
    </style>
</head>
<body>
    <!-- Unofficial Notice Banner -->
    <div class="unofficial-banner">
        ‚ö†Ô∏è UNOFFICIAL COMMUNITY PROJECT - Not affiliated with Metro Nashville or any government agency
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4">
        <div class="max-w-screen-2xl mx-auto">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">
                        Nashville Eviction Tracker
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">
                        Community-maintained analysis of public court records ‚Ä¢ Data sourced from Sessions Court
                    </p>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-500">Last Updated: <span id="lastUpdate">Loading...</span></span>
                    <button onclick="loadData()" class="btn btn-secondary">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-screen-2xl mx-auto p-6">
        <!-- Status Message -->
        <div id="statusMessage" class="status-message status-loading">
            ‚è≥ Loading data from public records API...
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="data-card p-6">
                <div class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Records</div>
                <div id="totalRecords" class="metric-value text-gray-900">-</div>
                <div id="totalChange" class="text-sm mt-2"></div>
            </div>
            <div class="data-card p-6">
                <div class="text-sm font-semibold text-gray-500 uppercase tracking-wide">This Month</div>
                <div id="thisMonth" class="metric-value text-gray-900">-</div>
                <div id="monthChange" class="text-sm mt-2"></div>
            </div>
            <div class="data-card p-6">
                <div class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Last 30 Days</div>
                <div id="last30Days" class="metric-value text-gray-900">-</div>
                <div id="thirtyChange" class="text-sm mt-2"></div>
            </div>
            <div class="data-card p-6">
                <div class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Status: Pending</div>
                <div id="pendingCount" class="metric-value text-orange-600">-</div>
                <div class="text-sm mt-2 text-gray-500">Active cases</div>
            </div>
            <div class="data-card p-6">
                <div class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Individual LL</div>
                <div id="individualLL" class="metric-value text-blue-600">-</div>
                <div class="text-sm mt-2 text-gray-500">vs Corporate</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Monthly Trend Chart -->
            <div class="lg:col-span-2 data-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900">Monthly Eviction Filings</h2>
                    <button onclick="downloadChart('monthly')" class="text-gray-500 hover:text-gray-700">
                        üìä Export
                    </button>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- District Heat Map -->
            <div class="data-card p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-2">District Activity Patterns*</h2>
                <div class="grid grid-cols-7 gap-1" id="districtGrid">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="mt-4 flex items-center justify-between text-xs">
                    <span class="text-gray-500">Lower activity</span>
                    <div class="flex gap-1 items-center">
                        <span class="text-gray-400">‚óã</span>
                        <div class="w-4 h-4 heat-1 rounded"></div>
                        <div class="w-4 h-4 heat-2 rounded"></div>
                        <div class="w-4 h-4 heat-3 rounded"></div>
                        <div class="w-4 h-4 heat-4 rounded"></div>
                        <div class="w-4 h-4 heat-5 rounded"></div>
                        <span class="text-gray-700">‚óè‚óè‚óè</span>
                    </div>
                    <span class="text-gray-500">Higher activity</span>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">Relative distribution based on available data*</p>
                <p class="text-xs text-gray-400 mt-1 text-center">*District insights are approximated from publicly available records and may not reflect official designations.</p>
            </div>
        </div>

        <!-- Search Section -->
        <div class="data-card p-6 mb-6">
            <div class="border-b border-gray-200 mb-4">
                <div class="flex gap-2">
                    <button onclick="setSearchTab('quick')" class="tab-btn active" id="quickTab">Quick Search</button>
                    <button onclick="setSearchTab('bulk')" class="tab-btn" id="bulkTab">Bulk Search</button>
                    <button onclick="setSearchTab('filter')" class="tab-btn" id="filterTab">Advanced Filters</button>
                </div>
            </div>

            <!-- Quick Search -->
            <div id="quickSearch" class="search-panel">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="searchInput" placeholder="Search any field..." 
                           class="search-input md:col-span-2" onkeyup="quickSearch()">
                    <button onclick="clearSearch()" class="btn btn-secondary">Clear</button>
                </div>
            </div>

            <!-- Bulk Search -->
            <div id="bulkSearch" class="search-panel hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Paste Names (one per line or comma-separated)
                        </label>
                        <textarea id="bulkNames" rows="6" 
                                  placeholder="John Smith&#10;Jane Doe&#10;ABC Properties LLC"
                                  class="search-input w-full font-mono text-sm"></textarea>
                        <div class="mt-3 flex items-center gap-4">
                            <label class="text-sm text-gray-600">Match Threshold:</label>
                            <input type="range" id="fuzzyThreshold" min="0.5" max="1" step="0.05" value="0.8"
                                   class="fuzzy-slider flex-1" oninput="updateThreshold()">
                            <span id="thresholdValue" class="text-sm font-semibold">80%</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Or Upload CSV File
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                            <input type="file" id="csvFile" class="hidden" accept=".csv" onchange="handleCSV(event)">
                            <label for="csvFile" class="cursor-pointer">
                                <div class="text-3xl mb-2">üìÅ</div>
                                <p class="text-sm text-gray-600">Click to upload CSV</p>
                                <p class="text-xs text-gray-400 mt-1">First column should contain names</p>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex gap-2">
                    <button onclick="runBulkSearch()" class="btn btn-primary">Run Fuzzy Match</button>
                    <button onclick="exportMatches()" class="btn btn-secondary">Export Matches</button>
                </div>
                <div id="bulkResults" class="mt-4 hidden max-h-96 overflow-y-auto border rounded-lg"></div>
            </div>

            <!-- Advanced Filters -->
            <div id="filterSearch" class="search-panel hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Status</label>
                        <select id="statusFilter" class="search-input w-full" onchange="applyFilters()">
                            <option value="">All</option>
                            <option value="PENDING">Pending</option>
                            <option value="CLOSED">Closed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Date From</label>
                        <input type="date" id="dateFrom" class="search-input w-full" onchange="applyFilters()">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Date To</label>
                        <input type="date" id="dateTo" class="search-input w-full" onchange="applyFilters()">
                    </div>
                </div>
                <div class="mt-4 flex gap-2">
                    <button onclick="setDateRange(30)" class="btn btn-secondary">Last 30 Days</button>
                    <button onclick="setDateRange(90)" class="btn btn-secondary">Last 90 Days</button>
                    <button onclick="setDateRange(365)" class="btn btn-secondary">Last Year</button>
                    <button onclick="clearFilters()" class="btn btn-secondary">Clear All</button>
                </div>
            </div>
        </div>

        <!-- Data Grid -->
        <div class="data-card p-6">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold text-gray-900">
                    Eviction Records
                    <span id="recordCount" class="text-sm font-normal text-gray-500"></span>
                </h2>
                <div class="flex gap-2">
                    <button onclick="exportCSV()" class="btn btn-primary">
                        üì• Export CSV
                    </button>
                </div>
            </div>
            <p class="text-xs text-gray-500 mb-4">*Location and district details are approximated from the underlying court records and may be inaccurate.</p>
            <div id="dataGrid" class="ag-theme-alpine"></div>
        </div>
    </div>

    <script>
        // Global variables
        let allData = [];
        let filteredData = [];
        let gridApi;
        let monthlyChart;
        let searchMatches = [];

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            initCharts();
        });

        function cleanAttorney(attorney) {
            if (!attorney) return '';

            const proSeTokens = new Set([
                'PRO SE',
                'PRO-SE',
                'PROSE',
                'PRO SE LITIGANT',
                'PRS'
            ]);

            const segments = String(attorney)
                .replace(/\s+/g, ' ')
                .replace(/\s*,\s*/g, ', ')
                .trim()
                .split(',')
                .map(segment => segment.replace(/\s+/g, ' ').trim())
                .filter(Boolean);

            const normalizedSegments = [];
            const seen = new Set();

            for (const segment of segments) {
                const cleanedSegment = segment
                    .replace(/^[^A-Za-z0-9'&.-]+/, '')
                    .replace(/[^A-Za-z0-9'&.-]+$/, '')
                    .trim();

                if (!cleanedSegment) continue;

                const comparisonValue = cleanedSegment.replace(/\./g, '').toUpperCase();
                if (proSeTokens.has(comparisonValue)) {
                    continue;
                }

                if (seen.has(comparisonValue)) continue;
                seen.add(comparisonValue);
                normalizedSegments.push(cleanedSegment);
            }

            if (normalizedSegments.length === 0) {
                return 'Pro Se';
            }

            return normalizedSegments.join(', ');
        }

        async function loadData() {
            try {
                updateStatus('Loading data from public records API...', 'loading');
                
                const response = await fetch('https://xvkq-pq7i-idtl.n7d.xano.io/api:gx-QnxD1/detainers');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Handle different response formats
                let data;
                if (Array.isArray(result)) {
                    data = result;
                } else if (result?.items) {
                    data = result.items;
                } else if (result?.data) {
                    data = result.data;
                } else {
                    data = [result];
                }
                
                allData = data.map(normalizeRecord);
                filteredData = allData;
                
                updateStatus(`Loaded ${allData.length} records from public court data`, 'success');
                updateMetrics();
                updateCharts();
                createDistrictMap();
                initGrid();
                
                // Update last update time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                
            } catch (error) {
                console.error('Error loading data:', error);
                updateStatus(`Error loading data: ${error.message}`, 'error');
            }
        }

        function normalizeRecord(record) {
            const normalized = {
                ...record,
                File_Date: record.File_Date || record.file_date,
                Status: record.Status || record.status || 'UNKNOWN',
                Plaintiff: record.Plaintiff_Petitioner || record.Plaintiff || record.plaintiff || '',
                Defendant: record.Defendant_Respondent || record.Defendant || record.defendant || '',
                Address: record.address_formatted || record.formatted_address || record.address || '',
                District: record.council_district_number || record.council_district || 'Unknown',
                Case_Number: record.Docket_Number || record.Case_Number || record.case_number || record.id || '',
                Attorney: cleanAttorney(record.Attorney || record.attorney || ''),
                CouncilMember: record.council_member || '',
                individual_ll: record.individual_ll === "1" || record.individual_ll === true || record.individual_ll === 'true'
            };
            
            // Only mark as unknown for TRULY generic addresses
            const addressLower = normalized.Address.toLowerCase().trim();
            
            // Check if this is JUST a generic address (not part of a real address)
            const isGenericAddress = 
                // Exactly "Nashville, TN, USA" or similar (no street info)
                /^nashville,?\s*(tn|tennessee)?,?\s*(usa)?$/i.test(addressLower) ||
                // Just "1 Public Square" (individual landlord placeholder)
                addressLower.includes('1 public square') ||
                // Just an apartment number with no street
                /^#\d+,?\s*nashville/i.test(addressLower) ||
                // Empty or missing
                addressLower === '' ||
                addressLower === 'unknown';
            
            if (isGenericAddress) {
                normalized.District = 'Unknown';
                normalized.CouncilMember = 'Unknown';
            }
            
            // Also mark as unknown if district is 0 or invalid
            if (normalized.District === 0 || normalized.District === '0' || normalized.District === null) {
                normalized.District = 'Unknown';
            }
            
            // Mark individual landlords as unknown district (they're all at city hall)
            if (normalized.individual_ll === true || normalized.individual_ll === "1") {
                normalized.District = 'Unknown';
                if (!normalized.CouncilMember || normalized.CouncilMember === 'unknown') {
                    normalized.CouncilMember = 'Individual Landlord';
                }
            }
            
            return normalized;
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            
            // Hide after success
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        function updateMetrics() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            // Total records
            document.getElementById('totalRecords').textContent = allData.length.toLocaleString();
            
            // This month
            const thisMonthCount = allData.filter(d => {
                const date = new Date(d.File_Date);
                return date >= thisMonthStart;
            }).length;
            document.getElementById('thisMonth').textContent = thisMonthCount.toLocaleString();
            
            // Last 30 days
            const last30Count = allData.filter(d => {
                const date = new Date(d.File_Date);
                return date >= thirtyDaysAgo;
            }).length;
            document.getElementById('last30Days').textContent = last30Count.toLocaleString();
            
            // Pending
            const pendingCount = allData.filter(d => d.Status === 'PENDING').length;
            document.getElementById('pendingCount').textContent = pendingCount.toLocaleString();
            
            // Individual landlords
            const individualCount = allData.filter(d => d.individual_ll === true || d.individual_ll === "1").length;
            const unknownDistrictCount = allData.filter(d => d.District === 'Unknown' || d.District === 'unknown').length;
            const unknownPercent = ((unknownDistrictCount / allData.length) * 100).toFixed(1);
            
            document.getElementById('individualLL').textContent = individualCount.toLocaleString();
            // Update the subtitle to show unknown districts
            const individualCard = document.getElementById('individualLL').parentElement;
            const subtitleEl = individualCard.querySelector('.text-sm.mt-2');
            if (subtitleEl) {
                subtitleEl.innerHTML = `<span title="${unknownDistrictCount} records">${unknownPercent}% unknown dist.*</span>`;
            }
        }

        function initCharts() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Eviction Filings',
                        data: [],
                        backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        borderColor: '#4f46e5',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 50
                            }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            // Group data by month
            const monthCounts = {};
            
            allData.forEach(record => {
                const date = new Date(record.File_Date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
            });
            
            // Sort months and get last 12
            const sortedMonths = Object.keys(monthCounts).sort().slice(-12);
            const labels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                const date = new Date(year, parseInt(month) - 1);
                return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            });
            const data = sortedMonths.map(m => monthCounts[m]);
            
            monthlyChart.data.labels = labels;
            monthlyChart.data.datasets[0].data = data;
            monthlyChart.update();
        }

        function createDistrictMap() {
            const districtCounts = {};
            let unknownCount = 0;
            
            filteredData.forEach(record => {
                const district = record.District;
                if (district === 'Unknown' || district === 'unknown') {
                    unknownCount++;
                } else if (district && !isNaN(district)) {
                    districtCounts[district] = (districtCounts[district] || 0) + 1;
                }
            });
            
            const maxCount = Math.max(...Object.values(districtCounts), 1);
            const grid = document.getElementById('districtGrid');
            
            let html = '';
            for (let i = 1; i <= 35; i++) {
                const count = districtCounts[i] || 0;
                const intensity = count / maxCount;
                let heatClass = 'heat-0';
                let descriptor = '';
                
                if (intensity > 0.8) {
                    heatClass = 'heat-5';
                    descriptor = '‚óè‚óè‚óè';
                } else if (intensity > 0.6) {
                    heatClass = 'heat-4';
                    descriptor = '‚óè‚óè‚óè';
                } else if (intensity > 0.4) {
                    heatClass = 'heat-3';
                    descriptor = '‚óè‚óè';
                } else if (intensity > 0.2) {
                    heatClass = 'heat-2';
                    descriptor = '‚óè‚óè';
                } else if (intensity > 0) {
                    heatClass = 'heat-1';
                    descriptor = '‚óè';
                } else {
                    descriptor = '‚óã';
                }
                
                html += `
                        <div class="district-cell ${heatClass}"
                         onclick="filterByDistrict(${i})"
                         title="District ${i}*">
                        <div class="text-center">
                            <div class="text-sm font-bold opacity-80">${i}</div>
                            <div class="activity-dots mt-1">${descriptor}</div>
                        </div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
            
            // Add unknown count below the grid if there are any
            if (unknownCount > 0) {
                const existingUnknown = grid.parentElement.querySelector('.unknown-district-info');
                if (existingUnknown) {
                    existingUnknown.remove();
                }
                
                const unknownDiv = document.createElement('div');
                unknownDiv.className = 'unknown-district-info mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm cursor-pointer hover:bg-yellow-100 transition';
                unknownDiv.innerHTML = `
                    <span class="text-gray-700">Additional records with unverified district information available*</span>
                    <span class="text-xs text-gray-600 ml-2">(click to view)</span>
                `;
                unknownDiv.onclick = () => filterByDistrict('Unknown');
                grid.parentElement.appendChild(unknownDiv);
            }
        }

        function initGrid() {
            const columnDefs = [
                { field: 'File_Date', headerName: 'File Date', width: 110, 
                  valueFormatter: params => new Date(params.value).toLocaleDateString() },
                { field: 'Case_Number', headerName: 'Docket #', width: 120 },
                { field: 'Plaintiff', headerName: 'Plaintiff/Landlord', width: 200 },
                { field: 'Defendant', headerName: 'Defendant/Tenant', width: 200 },
                { field: 'Attorney', headerName: 'Attorney', width: 150 },
                { field: 'Address', headerName: 'Possible Property Address*', width: 300 },
                { field: 'District', headerName: 'District*', width: 90 },
                { field: 'CouncilMember', headerName: 'Council', width: 120 },
                { field: 'Status', headerName: 'Status', width: 100,
                  cellStyle: params => {
                      if (params.value === 'PENDING') return { color: '#f59e0b', fontWeight: 'bold' };
                      if (params.value === 'CLOSED') return { color: '#6b7280' };
                      return null;
                  }
                }
            ];

            const gridOptions = {
                columnDefs: columnDefs,
                rowData: filteredData,
                defaultColDef: {
                    sortable: true,
                    filter: true,
                    resizable: true
                },
                enableCellTextSelection: true,
                ensureDomOrder: true,
                pagination: true,
                paginationPageSize: 20,
                animateRows: true,
                onGridReady: params => {
                    gridApi = params.api;
                    updateRecordCount();
                }
            };

            const gridDiv = document.querySelector('#dataGrid');
            if (gridApi) {
                gridApi.setRowData(filteredData);
            } else {
                new agGrid.Grid(gridDiv, gridOptions);
            }
        }

        function updateRecordCount() {
            const count = document.getElementById('recordCount');
            count.textContent = `(${filteredData.length} records)`;
        }

        function setSearchTab(tab) {
            // Update tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tab}Tab`).classList.add('active');
            
            // Show/hide panels
            document.getElementById('quickSearch').classList.toggle('hidden', tab !== 'quick');
            document.getElementById('bulkSearch').classList.toggle('hidden', tab !== 'bulk');
            document.getElementById('filterSearch').classList.toggle('hidden', tab !== 'filter');
        }

        function quickSearch() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            if (!gridApi) return;
            
            gridApi.setQuickFilter(searchText);
            updateRecordCount();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            if (gridApi) {
                gridApi.setQuickFilter('');
                updateRecordCount();
            }
        }

        function runBulkSearch() {
            const input = document.getElementById('bulkNames').value;
            const threshold = parseFloat(document.getElementById('fuzzyThreshold').value);
            const searchTerms = input.split(/[,\n]/).map(t => t.trim()).filter(t => t);
            
            if (searchTerms.length === 0) return;
            
            searchMatches = [];
            
            searchTerms.forEach(term => {
                filteredData.forEach(record => {
                    const fields = [record.Plaintiff, record.Defendant];
                    fields.forEach(field => {
                        if (field) {
                            const similarity = calculateSimilarity(term.toLowerCase(), field.toLowerCase());
                            if (similarity >= threshold) {
                                searchMatches.push({
                                    searchTerm: term,
                                    match: field,
                                    record: record,
                                    confidence: similarity
                                });
                            }
                        }
                    });
                });
            });
            
            displayBulkResults(searchMatches);
        }

        function calculateSimilarity(str1, str2) {
            // Levenshtein distance implementation
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            const longerLength = longer.length;
            
            if (longerLength === 0) return 1.0;
            
            const editDistance = levenshtein(longer, shorter);
            return (longerLength - editDistance) / parseFloat(longerLength);
        }

        function levenshtein(s1, s2) {
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        function displayBulkResults(results) {
            const resultsDiv = document.getElementById('bulkResults');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<p class="p-4 text-gray-500">No matches found</p>';
            } else {
                let html = `<div class="p-3 bg-gray-50 font-semibold">Found ${results.length} matches</div>`;
                
                results.forEach(r => {
                    const confClass = r.confidence > 0.9 ? 'confidence-high' : 
                                     r.confidence > 0.8 ? 'confidence-med' : 'confidence-low';
                    
                    html += `
                        <div class="match-result">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-semibold">${r.match}</div>
                                    <div class="text-xs text-gray-500">Searched: "${r.searchTerm}"</div>
                                    <div class="text-xs text-gray-600 mt-1">
                                        Possible property address*: ${r.record.Address || 'Unavailable'} ‚Ä¢ District*: ${r.record.District || 'Unavailable'}
                                    </div>
                                </div>
                                <span class="confidence-badge ${confClass}">
                                    ${(r.confidence * 100).toFixed(0)}%
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                resultsDiv.innerHTML = html;
            }
            
            resultsDiv.classList.remove('hidden');
        }

        function updateThreshold() {
            const value = document.getElementById('fuzzyThreshold').value;
            document.getElementById('thresholdValue').textContent = `${Math.round(value * 100)}%`;
        }

        function setDateRange(days) {
            const now = new Date();
            const past = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
            
            document.getElementById('dateFrom').value = past.toISOString().split('T')[0];
            document.getElementById('dateTo').value = now.toISOString().split('T')[0];
            
            applyFilters();
        }

        function applyFilters() {
            const status = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            filteredData = allData.filter(record => {
                // Status filter
                if (status && record.Status !== status) return false;
                
                // Date filter
                if (dateFrom || dateTo) {
                    const recordDate = new Date(record.File_Date);
                    if (dateFrom && recordDate < new Date(dateFrom)) return false;
                    if (dateTo && recordDate > new Date(dateTo)) return false;
                }
                
                return true;
            });
            
            if (gridApi) {
                gridApi.setRowData(filteredData);
            }
            updateRecordCount();
            createDistrictMap();
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            
            filteredData = allData;
            if (gridApi) {
                gridApi.setRowData(filteredData);
            }
            updateRecordCount();
            createDistrictMap();
        }

        function filterByDistrict(district) {
            if (district === 'Unknown' || district === 'unknown') {
                filteredData = allData.filter(r => r.District === 'Unknown' || r.District === 'unknown');
            } else {
                filteredData = allData.filter(r => r.District == district);
            }
            
            if (gridApi) {
                gridApi.setRowData(filteredData);
            }
            updateRecordCount();
            
            // Update status message without exact counts
            const filterMsg = district === 'Unknown' ? 'unverified districts*' : `District ${district}*`;
            updateStatus(`Showing records for ${filterMsg}`, 'success');
        }

        function exportCSV() {
            let csv = 'File Date,Docket Number,Plaintiff,Defendant,Attorney,Possible Property Address*,District*,Council Member,Status\n';
            
            filteredData.forEach(row => {
                csv += `"${new Date(row.File_Date).toLocaleDateString()}","${row.Case_Number}","${row.Plaintiff}","${row.Defendant}","${row.Attorney}","${row.Address}","${row.District}","${row.CouncilMember}","${row.Status}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eviction_data_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function exportMatches() {
            if (searchMatches.length === 0) {
                alert('No matches to export. Run a bulk search first.');
                return;
            }
            
            let csv = 'Search Term,Matched Name,Confidence,File Date,Attorney,Possible Property Address*,District*,Council Member,Status\n';
            
            searchMatches.forEach(match => {
                csv += `"${match.searchTerm}","${match.match}","${(match.confidence * 100).toFixed(1)}%","${new Date(match.record.File_Date).toLocaleDateString()}","${match.record.Attorney}","${match.record.Address}","${match.record.District}","${match.record.CouncilMember}","${match.record.Status}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fuzzy_matches_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>
