<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eviction Detainer Dashboard - Enhanced</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .tab-dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .tab-drag-over {
            border-left: 3px solid #3b82f6;
        }
        .draggable-tab {
            cursor: grab;
            user-select: none;
        }
        .draggable-tab:active {
            cursor: grabbing;
        }
        .bucket-rule {
            transition: all 0.2s;
        }
        .bucket-rule:hover {
            background-color: #f9fafb;
        }
        .tab-edit-mode .draggable-tab {
            animation: shake 0.3s ease-in-out infinite;
        }
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-1deg); }
            75% { transform: rotate(1deg); }
        }
        .tab-edit-indicator {
            display: none;
        }
        .tab-edit-mode .tab-edit-indicator {
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // Icon SVG components
        const icons = {
            search: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>',
            download: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',
            upload: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>',
            building: '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"></path><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"></path></svg>',
            scale: '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"></path><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"></path><path d="M7 21h10"></path><path d="M12 3v18"></path></svg>',
            user: '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
            alert: '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>',
            calendar: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
            filter: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>',
            folder: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>',
            plus: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
            x: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
            edit: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',
            trash: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',
            grip: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="19" r="1"></circle></svg>'
        };

        // Default tabs if no custom order exists
        const defaultTabs = [
            { id: 'overview', label: 'Overview', icon: 'building' },
            { id: 'landlords', label: 'Top Landlords', icon: 'building' },
            { id: 'attorneys', label: 'Top Attorneys', icon: 'scale' },
            { id: 'timeline', label: 'Timeline', icon: 'calendar' },
            { id: 'cases', label: 'Case List', icon: 'user' },
            { id: 'buckets', label: 'Buckets', icon: 'folder' }
        ];

        let charts = {};

        // LocalStorage functions
        function loadTabOrder() {
            const saved = localStorage.getItem('eviction_tab_order');
            return saved ? JSON.parse(saved) : defaultTabs;
        }

        function loadBuckets() {
            const saved = localStorage.getItem('eviction_buckets');
            if (saved) {
                return JSON.parse(saved);
            }
            // Default buckets
            return [
                {
                    id: 'corporate',
                    name: 'Corporate Landlords',
                    color: 'blue',
                    rules: [
                        { field: 'Plaintiff_Petitioner', operator: 'contains', value: 'LLC', caseSensitive: false },
                        { field: 'Plaintiff_Petitioner', operator: 'contains', value: 'LP', caseSensitive: false },
                        { field: 'Plaintiff_Petitioner', operator: 'contains', value: 'CORP', caseSensitive: false },
                        { field: 'Plaintiff_Petitioner', operator: 'contains', value: 'INC', caseSensitive: false }
                    ],
                    matchType: 'any' // 'any' or 'all'
                },
                {
                    id: 'pro_se',
                    name: 'Pro Se Defendants',
                    color: 'yellow',
                    rules: [
                        { field: 'Attorney', operator: 'contains', value: 'PRS', caseSensitive: false }
                    ],
                    matchType: 'any'
                }
            ];
        }

        // State management with localStorage support
        let state = {
            data: [],
            loading: true,
            error: null,
            searchTerm: '',
            selectedView: 'overview',
            selectedBucket: 'all',
            filterCriteria: {
                attorney: 'all',
                plaintiff: 'all',
                status: 'all',
                startDate: getDateDaysAgo(365),
                endDate: getTodayDate()
            },
            showBucketManager: false,
            showBulkSearch: false,
            bulkSearchNames: [],
            tabEditMode: false,
            tabOrder: loadTabOrder(),
            buckets: loadBuckets(),
            pagination: {
                currentPage: 1,
                perPage: 1000,
                totalPages: 1,
                totalItems: 0
            }
        };

        function saveTabOrder(order) {
            localStorage.setItem('eviction_tab_order', JSON.stringify(order));
            state.tabOrder = order;
        }

        function saveBuckets(buckets) {
            localStorage.setItem('eviction_buckets', JSON.stringify(buckets));
            state.buckets = buckets;
        }

        // Helper functions for date handling
        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        function getDateDaysAgo(days) {
            const date = new Date();
            date.setDate(date.getDate() - days);
            return date.toISOString().split('T')[0];
        }

        function formatDateForDisplay(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        }

        function formatDateForAPI(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${month}/${day}/${year}`;
        }

        // Bucket matching logic
        function recordMatchesBucket(record, bucket) {
            if (bucket.matchType === 'all') {
                return bucket.rules.every(rule => matchesRule(record, rule));
            } else {
                return bucket.rules.some(rule => matchesRule(record, rule));
            }
        }

        function matchesRule(record, rule) {
            const fieldValue = record[rule.field] || '';
            const searchValue = rule.caseSensitive ? rule.value : rule.value.toLowerCase();
            const recordValue = rule.caseSensitive ? fieldValue : fieldValue.toLowerCase();

            switch (rule.operator) {
                case 'contains':
                    return recordValue.includes(searchValue);
                case 'equals':
                    return recordValue === searchValue;
                case 'starts_with':
                    return recordValue.startsWith(searchValue);
                case 'ends_with':
                    return recordValue.endsWith(searchValue);
                case 'not_contains':
                    return !recordValue.includes(searchValue);
                default:
                    return false;
            }
        }

        // Fetch data
        async function fetchData() {
            try {
                state.loading = true;
                render();

                const params = new URLSearchParams();

                if (state.filterCriteria.startDate) {
                    params.append('start_date', formatDateForAPI(state.filterCriteria.startDate));
                }
                if (state.filterCriteria.endDate) {
                    params.append('end_date', formatDateForAPI(state.filterCriteria.endDate));
                }
                if (state.filterCriteria.status && state.filterCriteria.status !== 'all') {
                    params.append('Status', state.filterCriteria.status);
                }
                if (state.filterCriteria.attorney && state.filterCriteria.attorney !== 'all') {
                    params.append('Attorney', state.filterCriteria.attorney);
                }
                if (state.filterCriteria.plaintiff && state.filterCriteria.plaintiff !== 'all') {
                    params.append('Plaintiff_Petitioner', state.filterCriteria.plaintiff);
                }

                const queryString = params.toString();
                const url = `https://xvkq-pq7i-idtl.n7d.xano.io/api:gx-QnxD1/detainers?${queryString}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                state.data = result;
                state.pagination.totalItems = result.length;
                
                state.loading = false;
                render();
            } catch (error) {
                console.error('Error fetching data:', error);
                state.error = error.message;
                state.loading = false;
                render();
            }
        }

        // Data processing
        function processData() {
            let filtered = state.data;

            // Apply search filter
            if (state.searchTerm) {
                const searchLower = state.searchTerm.toLowerCase();
                filtered = filtered.filter(record =>
                    (record.Defendant_Respondent?.toLowerCase().includes(searchLower)) ||
                    (record.Plaintiff_Petitioner?.toLowerCase().includes(searchLower)) ||
                    (record.Docket_Number?.toLowerCase().includes(searchLower)) ||
                    (record.Attorney?.toLowerCase().includes(searchLower))
                );
            }

            // Apply bulk search filter
            if (state.bulkSearchNames.length > 0) {
                filtered = filtered.filter(record => {
                    const defendant = (record.Defendant_Respondent || '').toLowerCase();
                    return state.bulkSearchNames.some(name => 
                        defendant.includes(name.toLowerCase())
                    );
                });
            }

            // Apply bucket filter
            if (state.selectedBucket !== 'all') {
                const bucket = state.buckets.find(b => b.id === state.selectedBucket);
                if (bucket) {
                    filtered = filtered.filter(record => recordMatchesBucket(record, bucket));
                }
            }

            return filtered;
        }

        function calculateAnalytics(data) {
            const analytics = {
                totalCases: data.length,
                pendingCases: data.filter(r => r.Status === 'PENDING').length,
                resolvedCases: data.filter(r => r.Status !== 'PENDING').length,
                corporateLandlords: data.filter(r => 
                    r.Plaintiff_Petitioner?.includes('LLC') || 
                    r.Plaintiff_Petitioner?.includes('LP') ||
                    r.Plaintiff_Petitioner?.includes('CORP') ||
                    r.Plaintiff_Petitioner?.includes('INC')
                ).length,
                proSeDefendants: data.filter(r => 
                    r.Attorney?.includes('PRS') || r.Attorney?.trim() === ','
                ).length,
                attorneyData: [],
                plaintiffData: [],
                dailyFilings: {},
                bucketStats: {}
            };

            // Attorney statistics
            const attorneyMap = {};
            data.forEach(record => {
                const attorney = record.Attorney || 'Unknown';
                if (!attorneyMap[attorney]) {
                    attorneyMap[attorney] = 0;
                }
                attorneyMap[attorney]++;
            });
            analytics.attorneyData = Object.entries(attorneyMap)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 15);

            // Plaintiff statistics
            const plaintiffMap = {};
            data.forEach(record => {
                const plaintiff = record.Plaintiff_Petitioner || 'Unknown';
                if (!plaintiffMap[plaintiff]) {
                    plaintiffMap[plaintiff] = 0;
                }
                plaintiffMap[plaintiff]++;
            });
            analytics.plaintiffData = Object.entries(plaintiffMap)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 15);

            // Daily filings
            data.forEach(record => {
                const date = record.File_Date || 'Unknown';
                if (!analytics.dailyFilings[date]) {
                    analytics.dailyFilings[date] = 0;
                }
                analytics.dailyFilings[date]++;
            });

            // Bucket statistics
            state.buckets.forEach(bucket => {
                const matchingRecords = data.filter(record => recordMatchesBucket(record, bucket));
                analytics.bucketStats[bucket.id] = {
                    name: bucket.name,
                    count: matchingRecords.length,
                    percentage: ((matchingRecords.length / data.length) * 100).toFixed(1)
                };
            });

            return analytics;
        }

        // Chart creation functions
        function destroyChart(chartId) {
            if (charts[chartId]) {
                charts[chartId].destroy();
                delete charts[chartId];
            }
        }

        function createBarChart(canvasId, data, labels, label) {
            destroyChart(canvasId);
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createLineChart(canvasId, data, labels) {
            destroyChart(canvasId);
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Filings',
                        data: data,
                        borderColor: 'rgba(34, 197, 94, 1)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Export to CSV
        function exportToCSV() {
            const data = processData();
            const headers = ['Docket Number', 'File Date', 'Plaintiff', 'Defendant', 'Attorney', 'Status'];
            const rows = data.map(r => [
                r.Docket_Number,
                r.File_Date,
                r.Plaintiff_Petitioner,
                r.Defendant_Respondent,
                r.Attorney,
                r.Status
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell || ''}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eviction-data-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Tab drag and drop with long-press activation
        let draggedTab = null;
        let longPressTimer = null;
        let longPressTarget = null;

        function startLongPress(e, tabId) {
            if (state.tabEditMode) return; // Already in edit mode
            
            longPressTarget = tabId;
            longPressTimer = setTimeout(() => {
                state.tabEditMode = true;
                render();
                // Haptic feedback for mobile devices
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }, 500); // 500ms long press
        }

        function cancelLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        function handleTabDragStart(e, tabId) {
            if (!state.tabEditMode) {
                e.preventDefault();
                return;
            }
            draggedTab = tabId;
            e.target.classList.add('tab-dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleTabDragOver(e) {
            if (!state.tabEditMode) return;
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const target = e.target.closest('.draggable-tab');
            if (target) {
                target.classList.add('tab-drag-over');
            }
        }

        function handleTabDragLeave(e) {
            const target = e.target.closest('.draggable-tab');
            if (target) {
                target.classList.remove('tab-drag-over');
            }
        }

        function handleTabDrop(e, targetTabId) {
            if (!state.tabEditMode) return;
            e.preventDefault();
            const target = e.target.closest('.draggable-tab');
            if (target) {
                target.classList.remove('tab-drag-over');
            }

            if (draggedTab && draggedTab !== targetTabId) {
                const newOrder = [...state.tabOrder];
                const draggedIndex = newOrder.findIndex(t => t.id === draggedTab);
                const targetIndex = newOrder.findIndex(t => t.id === targetTabId);

                const [removed] = newOrder.splice(draggedIndex, 1);
                newOrder.splice(targetIndex, 0, removed);

                saveTabOrder(newOrder);
                render();
            }
        }

        function handleTabDragEnd(e) {
            e.target.classList.remove('tab-dragging');
            draggedTab = null;
        }

        function exitTabEditMode() {
            state.tabEditMode = false;
            render();
        }

        // Bulk search functions
        function toggleBulkSearch() {
            state.showBulkSearch = !state.showBulkSearch;
            render();
        }

        function processBulkSearch() {
            const textarea = document.getElementById('bulkSearchInput');
            if (!textarea) return;
            
            const names = textarea.value
                .split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            state.bulkSearchNames = names;
            state.showBulkSearch = false;
            state.selectedView = 'cases'; // Switch to cases view
            render();
        }

        function clearBulkSearch() {
            state.bulkSearchNames = [];
            render();
        }

        function renderBulkSearchModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) toggleBulkSearch()">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full m-4">
                        <div class="border-b px-6 py-4 flex justify-between items-center">
                            <h2 class="text-xl font-bold">Bulk Name Search</h2>
                            <button onclick="toggleBulkSearch()" class="text-gray-500 hover:text-gray-700">
                                ${icons.x}
                            </button>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <p class="text-sm text-gray-600">
                                Enter one name per line. The search will find any defendant whose name contains any of these search terms.
                            </p>
                            
                            <textarea 
                                id="bulkSearchInput"
                                placeholder="John Smith&#10;Jane Doe&#10;Robert Johnson"
                                class="w-full h-64 px-4 py-2 border rounded-lg font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >${state.bulkSearchNames.join('\n')}</textarea>
                            
                            <div class="flex justify-between items-center">
                                <button onclick="clearBulkSearch(); toggleBulkSearch()" 
                                    class="px-4 py-2 text-red-600 hover:text-red-800">
                                    Clear All
                                </button>
                                <div class="space-x-2">
                                    <button onclick="toggleBulkSearch()" 
                                        class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                                        Cancel
                                    </button>
                                    <button onclick="processBulkSearch()" 
                                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        Search
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Bucket management UI
        function renderBucketManager() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) toggleBucketManager()">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto m-4">
                        <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                            <h2 class="text-2xl font-bold">Manage Buckets</h2>
                            <button onclick="toggleBucketManager()" class="text-gray-500 hover:text-gray-700">
                                ${icons.x}
                            </button>
                        </div>
                        
                        <div class="p-6 space-y-6">
                            ${state.buckets.map((bucket, index) => `
                                <div class="border rounded-lg p-4 space-y-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <input type="text" 
                                                value="${bucket.name}" 
                                                onchange="updateBucketName(${index}, this.value)"
                                                class="text-lg font-semibold border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none px-2 py-1">
                                            <select onchange="updateBucketColor(${index}, this.value)" 
                                                class="px-3 py-1 rounded border bg-${bucket.color}-100 text-${bucket.color}-800 text-sm">
                                                <option value="blue" ${bucket.color === 'blue' ? 'selected' : ''}>Blue</option>
                                                <option value="red" ${bucket.color === 'red' ? 'selected' : ''}>Red</option>
                                                <option value="green" ${bucket.color === 'green' ? 'selected' : ''}>Green</option>
                                                <option value="yellow" ${bucket.color === 'yellow' ? 'selected' : ''}>Yellow</option>
                                                <option value="purple" ${bucket.color === 'purple' ? 'selected' : ''}>Purple</option>
                                                <option value="pink" ${bucket.color === 'pink' ? 'selected' : ''}>Pink</option>
                                            </select>
                                        </div>
                                        <button onclick="deleteBucket(${index})" 
                                            class="text-red-600 hover:text-red-800 p-2">
                                            ${icons.trash}
                                        </button>
                                    </div>

                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between text-sm">
                                            <span class="font-medium">Match Type:</span>
                                            <select onchange="updateBucketMatchType(${index}, this.value)" 
                                                class="px-3 py-1 rounded border text-sm">
                                                <option value="any" ${bucket.matchType === 'any' ? 'selected' : ''}>Any rule (OR)</option>
                                                <option value="all" ${bucket.matchType === 'all' ? 'selected' : ''}>All rules (AND)</option>
                                            </select>
                                        </div>

                                        <div class="space-y-2">
                                            ${bucket.rules.map((rule, ruleIndex) => `
                                                <div class="bucket-rule flex items-center space-x-2 p-2 border rounded">
                                                    <select onchange="updateBucketRule(${index}, ${ruleIndex}, 'field', this.value)" 
                                                        class="flex-1 px-2 py-1 text-sm border rounded">
                                                        <option value="Plaintiff_Petitioner" ${rule.field === 'Plaintiff_Petitioner' ? 'selected' : ''}>Plaintiff</option>
                                                        <option value="Defendant_Respondent" ${rule.field === 'Defendant_Respondent' ? 'selected' : ''}>Defendant</option>
                                                        <option value="Attorney" ${rule.field === 'Attorney' ? 'selected' : ''}>Attorney</option>
                                                        <option value="Status" ${rule.field === 'Status' ? 'selected' : ''}>Status</option>
                                                        <option value="Docket_Number" ${rule.field === 'Docket_Number' ? 'selected' : ''}>Docket #</option>
                                                    </select>
                                                    
                                                    <select onchange="updateBucketRule(${index}, ${ruleIndex}, 'operator', this.value)" 
                                                        class="px-2 py-1 text-sm border rounded">
                                                        <option value="contains" ${rule.operator === 'contains' ? 'selected' : ''}>contains</option>
                                                        <option value="equals" ${rule.operator === 'equals' ? 'selected' : ''}>equals</option>
                                                        <option value="starts_with" ${rule.operator === 'starts_with' ? 'selected' : ''}>starts with</option>
                                                        <option value="ends_with" ${rule.operator === 'ends_with' ? 'selected' : ''}>ends with</option>
                                                        <option value="not_contains" ${rule.operator === 'not_contains' ? 'selected' : ''}>not contains</option>
                                                    </select>
                                                    
                                                    <input type="text" 
                                                        value="${rule.value}" 
                                                        onchange="updateBucketRule(${index}, ${ruleIndex}, 'value', this.value)"
                                                        placeholder="value"
                                                        class="flex-1 px-2 py-1 text-sm border rounded">
                                                    
                                                    <label class="flex items-center space-x-1 text-xs whitespace-nowrap">
                                                        <input type="checkbox" 
                                                            ${rule.caseSensitive ? 'checked' : ''}
                                                            onchange="updateBucketRule(${index}, ${ruleIndex}, 'caseSensitive', this.checked)"
                                                            class="rounded">
                                                        <span>Case</span>
                                                    </label>
                                                    
                                                    <button onclick="deleteBucketRule(${index}, ${ruleIndex})" 
                                                        class="text-red-600 hover:text-red-800 p-1">
                                                        ${icons.x}
                                                    </button>
                                                </div>
                                            `).join('')}
                                        </div>

                                        <button onclick="addBucketRule(${index})" 
                                            class="text-sm text-blue-600 hover:text-blue-800 flex items-center space-x-1">
                                            ${icons.plus}
                                            <span>Add Rule</span>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}

                            <button onclick="createNewBucket()" 
                                class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-500 hover:text-blue-600 flex items-center justify-center space-x-2">
                                ${icons.plus}
                                <span>Create New Bucket</span>
                            </button>
                        </div>

                        <div class="sticky bottom-0 bg-gray-50 border-t px-6 py-4 flex justify-end">
                            <button onclick="toggleBucketManager()" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Bucket management functions
        function toggleBucketManager() {
            state.showBucketManager = !state.showBucketManager;
            render();
        }

        function createNewBucket() {
            const newBucket = {
                id: 'bucket_' + Date.now(),
                name: 'New Bucket',
                color: 'gray',
                rules: [
                    { field: 'Plaintiff_Petitioner', operator: 'contains', value: '', caseSensitive: false }
                ],
                matchType: 'any'
            };
            state.buckets.push(newBucket);
            saveBuckets(state.buckets);
            render();
        }

        function deleteBucket(index) {
            if (confirm('Are you sure you want to delete this bucket?')) {
                state.buckets.splice(index, 1);
                saveBuckets(state.buckets);
                if (state.selectedBucket === state.buckets[index]?.id) {
                    state.selectedBucket = 'all';
                }
                render();
            }
        }

        function updateBucketName(index, name) {
            state.buckets[index].name = name;
            saveBuckets(state.buckets);
        }

        function updateBucketColor(index, color) {
            state.buckets[index].color = color;
            saveBuckets(state.buckets);
            render();
        }

        function updateBucketMatchType(index, matchType) {
            state.buckets[index].matchType = matchType;
            saveBuckets(state.buckets);
            render();
        }

        function addBucketRule(bucketIndex) {
            state.buckets[bucketIndex].rules.push({
                field: 'Plaintiff_Petitioner',
                operator: 'contains',
                value: '',
                caseSensitive: false
            });
            saveBuckets(state.buckets);
            render();
        }

        function deleteBucketRule(bucketIndex, ruleIndex) {
            state.buckets[bucketIndex].rules.splice(ruleIndex, 1);
            saveBuckets(state.buckets);
            render();
        }

        function updateBucketRule(bucketIndex, ruleIndex, field, value) {
            state.buckets[bucketIndex].rules[ruleIndex][field] = value;
            saveBuckets(state.buckets);
        }

        // Main render function
        function render() {
            const processedData = processData();
            const analytics = calculateAnalytics(processedData);

            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen">
                    <!-- Header -->
                    <div class="bg-white border-b sticky top-0 z-40">
                        <div class="max-w-7xl mx-auto px-4 py-4">
                            <div class="flex flex-col space-y-4">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h1 class="text-2xl font-bold text-gray-900">Eviction Detainer Dashboard</h1>
                                        <p class="text-sm text-gray-600">Nashville Sessions Court</p>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="toggleBulkSearch()" 
                                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center space-x-2">
                                            ${icons.search}
                                            <span>Bulk Search</span>
                                            ${state.bulkSearchNames.length > 0 ? `<span class="ml-1 px-2 py-0.5 bg-white text-indigo-600 rounded-full text-xs font-bold">${state.bulkSearchNames.length}</span>` : ''}
                                        </button>
                                        <button onclick="exportToCSV()" 
                                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center space-x-2">
                                            ${icons.download}
                                            <span>Export CSV</span>
                                        </button>
                                        <button onclick="toggleBucketManager()" 
                                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center space-x-2">
                                            ${icons.folder}
                                            <span>Manage Buckets</span>
                                        </button>
                                    </div>
                                </div>

                                ${state.bulkSearchNames.length > 0 ? `
                                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm font-medium text-indigo-900">
                                                Bulk Search Active: ${state.bulkSearchNames.length} names
                                            </span>
                                            <button onclick="toggleBulkSearch()" 
                                                class="text-xs text-indigo-600 hover:text-indigo-800 underline">
                                                Edit
                                            </button>
                                        </div>
                                        <button onclick="clearBulkSearch()" 
                                            class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center space-x-1">
                                            ${icons.x}
                                            <span>Clear</span>
                                        </button>
                                    </div>
                                ` : ''}

                                <!-- Search and Filters -->
                                <div class="flex flex-col md:flex-row gap-3">
                                    <div class="flex-1 relative">
                                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                                            ${icons.search}
                                        </div>
                                        <input type="text" 
                                            placeholder="Search by defendant, plaintiff, docket, attorney..."
                                            value="${state.searchTerm}"
                                            oninput="updateSearch(this.value)"
                                            class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    
                                    <select onchange="updateBucketFilter(this.value)" 
                                        value="${state.selectedBucket}"
                                        class="px-4 py-2 border rounded-lg bg-white">
                                        <option value="all">All Cases</option>
                                        ${state.buckets.map(bucket => `
                                            <option value="${bucket.id}" ${state.selectedBucket === bucket.id ? 'selected' : ''}>
                                                ${bucket.name} (${analytics.bucketStats[bucket.id]?.count || 0})
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <!-- Date Range Filters -->
                                <div class="flex flex-wrap gap-2 items-center">
                                    <span class="text-sm font-medium text-gray-700">Date Range:</span>
                                    <input type="date" 
                                        id="startDateInput"
                                        value="${state.filterCriteria.startDate}"
                                        class="px-3 py-1 text-sm border rounded">
                                    <span class="text-sm text-gray-500">to</span>
                                    <input type="date" 
                                        id="endDateInput"
                                        value="${state.filterCriteria.endDate}"
                                        class="px-3 py-1 text-sm border rounded">
                                    <button onclick="applyDateRange()" 
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                                        Apply
                                    </button>
                                    <div class="flex gap-2">
                                        <button onclick="setDatePreset(30)" 
                                            class="px-3 py-1 text-sm border rounded hover:bg-gray-50">30 days</button>
                                        <button onclick="setDatePreset(90)" 
                                            class="px-3 py-1 text-sm border rounded hover:bg-gray-50">90 days</button>
                                        <button onclick="setDatePreset(365)" 
                                            class="px-3 py-1 text-sm border rounded hover:bg-gray-50">1 year</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Draggable Tabs -->
                        <div class="border-t ${state.tabEditMode ? 'tab-edit-mode bg-blue-50' : ''}">
                            <div class="max-w-7xl mx-auto px-4">
                                ${state.tabEditMode ? `
                                    <div class="py-2 flex items-center justify-between">
                                        <span class="text-sm text-blue-700 font-medium">âœ¨ Drag tabs to reorder</span>
                                        <button onclick="exitTabEditMode()" 
                                            class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                                            Done
                                        </button>
                                    </div>
                                ` : ''}
                                <div class="flex space-x-1 overflow-x-auto">
                                    ${state.tabOrder.map(tab => `
                                        <button 
                                            draggable="${state.tabEditMode}"
                                            onmousedown="startLongPress(event, '${tab.id}')"
                                            onmouseup="cancelLongPress()"
                                            onmouseleave="cancelLongPress()"
                                            ontouchstart="startLongPress(event, '${tab.id}')"
                                            ontouchend="cancelLongPress()"
                                            ontouchcancel="cancelLongPress()"
                                            ondragstart="handleTabDragStart(event, '${tab.id}')"
                                            ondragover="handleTabDragOver(event)"
                                            ondragleave="handleTabDragLeave(event)"
                                            ondrop="handleTabDrop(event, '${tab.id}')"
                                            ondragend="handleTabDragEnd(event)"
                                            onclick="if(!state.tabEditMode) changeView('${tab.id}')" 
                                            class="draggable-tab px-4 py-3 flex items-center space-x-2 border-b-2 transition ${
                                                state.selectedView === tab.id ? 
                                                'border-blue-600 text-blue-600' : 
                                                'border-transparent text-gray-600 hover:text-gray-900'
                                            } ${state.tabEditMode ? 'cursor-move' : ''}">
                                            ${state.tabEditMode ? `<span class="text-gray-400">${icons.grip}</span>` : ''}
                                            <span>${tab.label}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="max-w-7xl mx-auto px-4 py-6">
                        ${state.loading ? renderLoading() : 
                          state.error ? renderError() : 
                          renderView(processedData, analytics)}
                    </div>
                </div>

                ${state.showBucketManager ? renderBucketManager() : ''}
                ${state.showBulkSearch ? renderBulkSearchModal() : ''}
            `;
        }

        function renderLoading() {
            return `
                <div class="flex items-center justify-center h-64">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                        <p class="mt-4 text-gray-600">Loading data...</p>
                    </div>
                </div>
            `;
        }

        function renderError() {
            return `
                <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                    <p class="text-red-800">Error loading data: ${state.error}</p>
                    <button onclick="fetchData()" 
                        class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Retry
                    </button>
                </div>
            `;
        }

        function renderView(processedData, analytics) {
            const viewContent = document.createElement('div');
            
            if (state.selectedView === 'overview') {
                viewContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Total Cases</p>
                                    <p class="text-3xl font-bold text-gray-900 mt-2">${analytics.totalCases}</p>
                                </div>
                                <div class="text-blue-600">${icons.building}</div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Pending Cases</p>
                                    <p class="text-3xl font-bold text-red-600 mt-2">${analytics.pendingCases}</p>
                                </div>
                                <div class="text-red-600">${icons.alert}</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Corporate Landlords</p>
                                    <p class="text-3xl font-bold text-gray-900 mt-2">${analytics.corporateLandlords}</p>
                                </div>
                                <div class="text-blue-600">${icons.building}</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Pro Se Defendants</p>
                                    <p class="text-3xl font-bold text-yellow-600 mt-2">${analytics.proSeDefendants}</p>
                                </div>
                                <div class="text-yellow-600">${icons.user}</div>
                            </div>
                        </div>
                    </div>

                    ${state.buckets.length > 0 ? `
                        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <h3 class="text-lg font-semibold mb-4">Bucket Overview</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${state.buckets.map(bucket => {
                                    const stats = analytics.bucketStats[bucket.id];
                                    return `
                                        <div class="border-l-4 border-${bucket.color}-500 bg-${bucket.color}-50 p-4 rounded cursor-pointer hover:shadow-md transition"
                                            onclick="selectBucket('${bucket.id}')">
                                            <div class="flex justify-between items-start mb-2">
                                                <h4 class="font-semibold text-${bucket.color}-900">${bucket.name}</h4>
                                                <span class="text-2xl font-bold text-${bucket.color}-700">${stats?.count || 0}</span>
                                            </div>
                                            <div class="text-sm text-${bucket.color}-700">
                                                ${stats?.percentage || 0}% of total cases
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

            } else if (state.selectedView === 'attorneys') {
                viewContent.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Top 15 Attorneys by Case Volume</h3>
                        <div class="chart-container">
                            <canvas id="attorneyChart"></canvas>
                        </div>
                    </div>
                `;
                setTimeout(() => {
                    createBarChart('attorneyChart',
                        analytics.attorneyData.map(a => a.count),
                        analytics.attorneyData.map(a => a.name),
                        'Number of Cases'
                    );
                }, 100);

            } else if (state.selectedView === 'landlords') {
                viewContent.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Top 15 Plaintiffs (Landlords) by Filing Volume</h3>
                        <div class="chart-container">
                            <canvas id="landlordChart"></canvas>
                        </div>
                    </div>
                `;
                setTimeout(() => {
                    createBarChart('landlordChart',
                        analytics.plaintiffData.map(p => p.count),
                        analytics.plaintiffData.map(p => p.name),
                        'Number of Cases'
                    );
                }, 100);

            } else if (state.selectedView === 'timeline') {
                const filingDates = Object.keys(analytics.dailyFilings).sort();
                const filingCounts = filingDates.map(date => analytics.dailyFilings[date]);

                viewContent.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Filing Timeline</h3>
                        <div class="chart-container">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    </div>
                `;
                setTimeout(() => {
                    createLineChart('timelineChart', filingCounts, filingDates);
                }, 100);

            } else if (state.selectedView === 'cases') {
                viewContent.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Case Details (${processedData.length} cases)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 border-b-2 border-gray-200">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Docket #</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Filed</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Plaintiff (Landlord)</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Defendant (Tenant)</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Attorney</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Status</th>
                                        ${state.buckets.length > 0 ? '<th class="px-4 py-3 text-left font-semibold text-gray-700">Buckets</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${processedData.map(record => {
                                        const matchingBuckets = state.buckets.filter(b => recordMatchesBucket(record, b));
                                        return `
                                            <tr class="hover:bg-gray-50 transition">
                                                <td class="px-4 py-3 font-mono text-blue-600">${record.Docket_Number}</td>
                                                <td class="px-4 py-3">${record.File_Date}</td>
                                                <td class="px-4 py-3">
                                                    <div class="max-w-xs truncate" title="${record.Plaintiff_Petitioner}">
                                                        ${record.Plaintiff_Petitioner}
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 font-semibold">${record.Defendant_Respondent}</td>
                                                <td class="px-4 py-3">
                                                    ${record.Attorney?.includes('PRS') || record.Attorney?.trim() === ',' ? 
                                                        '<span class="inline-block px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded">Pro Se</span>' : 
                                                        record.Attorney
                                                    }
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="inline-block px-2 py-1 text-xs rounded ${
                                                        record.Status === 'PENDING' ? 
                                                            'bg-red-100 text-red-800' : 
                                                            'bg-gray-100 text-gray-800'
                                                    }">
                                                        ${record.Status}
                                                    </span>
                                                </td>
                                                ${state.buckets.length > 0 ? `
                                                    <td class="px-4 py-3">
                                                        <div class="flex flex-wrap gap-1">
                                                            ${matchingBuckets.map(b => `
                                                                <span class="inline-block px-2 py-0.5 text-xs bg-${b.color}-100 text-${b.color}-800 rounded">
                                                                    ${b.name}
                                                                </span>
                                                            `).join('')}
                                                        </div>
                                                    </td>
                                                ` : ''}
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-6 border-t pt-4 text-sm text-gray-600 text-center">
                            Showing ${processedData.length} cases
                        </div>
                    </div>
                `;
            } else if (state.selectedView === 'buckets') {
                viewContent.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-semibold">Bucket Analytics</h3>
                                <button onclick="toggleBucketManager()" 
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center space-x-2">
                                    ${icons.edit}
                                    <span>Manage</span>
                                </button>
                            </div>

                            ${state.buckets.length === 0 ? `
                                <div class="text-center py-12">
                                    <p class="text-gray-600 mb-4">No buckets created yet</p>
                                    <button onclick="toggleBucketManager()" 
                                        class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                        Create Your First Bucket
                                    </button>
                                </div>
                            ` : `
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    ${state.buckets.map(bucket => {
                                        const stats = analytics.bucketStats[bucket.id];
                                        const bucketData = processedData.filter(r => recordMatchesBucket(r, bucket));
                                        const pendingCount = bucketData.filter(r => r.Status === 'PENDING').length;
                                        
                                        return `
                                            <div class="border-l-4 border-${bucket.color}-500 bg-${bucket.color}-50 p-6 rounded-lg">
                                                <div class="flex justify-between items-start mb-4">
                                                    <h4 class="text-xl font-bold text-${bucket.color}-900">${bucket.name}</h4>
                                                    <button onclick="selectBucket('${bucket.id}')" 
                                                        class="text-sm px-3 py-1 bg-${bucket.color}-600 text-white rounded hover:bg-${bucket.color}-700">
                                                        View Cases
                                                    </button>
                                                </div>
                                                
                                                <div class="space-y-3">
                                                    <div class="flex justify-between">
                                                        <span class="text-${bucket.color}-700">Total Cases:</span>
                                                        <span class="font-bold text-${bucket.color}-900">${stats?.count || 0}</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-${bucket.color}-700">Pending:</span>
                                                        <span class="font-bold text-${bucket.color}-900">${pendingCount}</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-${bucket.color}-700">% of Total:</span>
                                                        <span class="font-bold text-${bucket.color}-900">${stats?.percentage || 0}%</span>
                                                    </div>
                                                </div>

                                                <div class="mt-4 pt-4 border-t border-${bucket.color}-200">
                                                    <p class="text-xs text-${bucket.color}-700 font-medium mb-2">Rules (${bucket.matchType === 'any' ? 'ANY' : 'ALL'}):</p>
                                                    <div class="space-y-1">
                                                        ${bucket.rules.map(rule => `
                                                            <div class="text-xs text-${bucket.color}-600">
                                                                â€¢ ${rule.field} ${rule.operator} "${rule.value}"
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

            return viewContent.innerHTML;
        }

        // Event handlers
        function updateSearch(value) {
            state.searchTerm = value;
            render();
        }

        function updateBucketFilter(bucketId) {
            state.selectedBucket = bucketId;
            state.selectedView = 'cases'; // Switch to cases view to show filtered results
            render();
        }

        function selectBucket(bucketId) {
            state.selectedBucket = bucketId;
            state.selectedView = 'cases';
            render();
        }

        function updateFilter(type, value) {
            state.filterCriteria[type] = value;
            fetchData();
        }

        function updateDateRange(startDate, endDate) {
            state.filterCriteria.startDate = startDate;
            state.filterCriteria.endDate = endDate;
            fetchData();
        }

        function applyDateRange() {
            const startInput = document.getElementById('startDateInput');
            const endInput = document.getElementById('endDateInput');
            
            if (startInput && endInput) {
                updateDateRange(startInput.value, endInput.value);
            }
        }

        function setDatePreset(days) {
            const endDate = getTodayDate();
            const startDate = getDateDaysAgo(days);
            updateDateRange(startDate, endDate);
        }

        function changeView(view) {
            state.selectedView = view;
            render();
        }

        // Initialize
        fetchData();
    </script>
</body>
</html>
