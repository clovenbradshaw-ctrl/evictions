<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eviction Detainer Dashboard - Nashville Sessions Court</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // Icon SVG components as strings
        const icons = {
            search: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>',
            download: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',
            upload: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>',
            building: '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"></path><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"></path></svg>',
            scale: '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"></path><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"></path><path d="M7 21h10"></path><path d="M12 3v18"></path></svg>',
            user: '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
            alert: '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>',
            calendar: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
            filter: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>'
        };

        // State management
        let state = {
            data: [],
            loading: true,
            error: null,
            searchTerm: '',
            selectedView: 'overview',
            filterCriteria: {
                attorney: 'all',
                plaintiff: 'all',
                status: 'all',
                startDate: getDateDaysAgo(365),
                endDate: getTodayDate()
            },
            bulkSearchNames: [],
            showBulkSearch: false,
            pagination: {
                currentPage: 1,
                perPage: 1000, // Changed from 25 to 1000 to get more results
                totalPages: 1,
                totalItems: 0
            }
        };

        let charts = {};

        // Helper functions for date handling
        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0]; // Returns YYYY-MM-DD
        }

        function getDateDaysAgo(days) {
            const date = new Date();
            date.setDate(date.getDate() - days);
            return date.toISOString().split('T')[0]; // Returns YYYY-MM-DD
        }

        function formatDateForDisplay(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        }

        function formatDateForAPI(dateString) {
            // Convert YYYY-MM-DD to MM/DD/YYYY for Xano
            const [year, month, day] = dateString.split('-');
            return `${month}/${day}/${year}`;
        }

        // Fetch data
        async function fetchData() {
            try {
                state.loading = true;
                render();

                // Build query parameters - no pagination
                const params = new URLSearchParams();

                // Add date range filters
                if (state.filterCriteria.startDate) {
                    params.append('start_date', formatDateForAPI(state.filterCriteria.startDate));
                }
                if (state.filterCriteria.endDate) {
                    params.append('end_date', formatDateForAPI(state.filterCriteria.endDate));
                }

                // Add other filters if they have actual values (not 'all')
                if (state.filterCriteria.status && state.filterCriteria.status !== 'all') {
                    params.append('Status', state.filterCriteria.status);
                }
                if (state.filterCriteria.attorney && state.filterCriteria.attorney !== 'all') {
                    params.append('Attorney', state.filterCriteria.attorney);
                }
                if (state.filterCriteria.plaintiff && state.filterCriteria.plaintiff !== 'all') {
                    params.append('Plaintiff_Petitioner', state.filterCriteria.plaintiff);
                }

                // Build URL
                const queryString = params.toString();
                const url = `https://xvkq-pq7i-idtl.n7d.xano.io/api:gx-QnxD1/detainers?${queryString}`;
                
                console.log('Fetching:', url); // Debug log
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Handle response - no pagination
                state.data = result;
                state.pagination.totalItems = result.length;
                
                state.loading = false;
                render();
            } catch (error) {
                console.error('Error fetching data:', error);
                state.error = error.message;
                state.loading = false;
                render();
            }
        }

        // Fetch all data for analytics (needed for attorney/plaintiff lists and charts)
        async function fetchAllForAnalytics() {
            try {
                // Fetch without filters to get full dataset for dropdowns and analytics
                const response = await fetch('https://xvkq-pq7i-idtl.n7d.xano.io/api:gx-QnxD1/detainers?per_page=1000');
                if (!response.ok) return [];
                const result = await response.json();
                return result.items || result;
            } catch (error) {
                console.error('Error fetching analytics data:', error);
                return [];
            }
        }

        // Process data
        function getProcessedData() {
            let filtered = state.data;

            if (state.filterCriteria.attorney !== 'all') {
                filtered = filtered.filter(d => d.Attorney === state.filterCriteria.attorney);
            }
            if (state.filterCriteria.plaintiff !== 'all') {
                filtered = filtered.filter(d => d.Plaintiff_Petitioner === state.filterCriteria.plaintiff);
            }
            if (state.filterCriteria.status !== 'all') {
                filtered = filtered.filter(d => d.Status === state.filterCriteria.status);
            }

            // Date filtering now happens server-side in Xano!
            // No need for client-side date filtering anymore

            // Bulk name search
            if (state.bulkSearchNames.length > 0) {
                filtered = filtered.filter(d => {
                    const defendantName = (d.Defendant_Respondent || '').toLowerCase();
                    return state.bulkSearchNames.some(searchName => {
                        const search = searchName.toLowerCase().trim();
                        return defendantName.includes(search);
                    });
                });
            }

            // Regular search
            if (state.searchTerm) {
                filtered = filtered.filter(d => 
                    d.Defendant_Respondent?.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
                    d.Plaintiff_Petitioner?.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
                    d.Docket_Number?.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
                    d.Attorney?.toLowerCase().includes(state.searchTerm.toLowerCase())
                );
            }

            return filtered;
        }

        // Calculate analytics
        function getAnalytics() {
            const processedData = getProcessedData();
            const attorneyCount = {};
            const plaintiffCount = {};
            const dailyFilings = {};
            
            processedData.forEach(d => {
                const attorney = d.Attorney || 'Pro Se';
                attorneyCount[attorney] = (attorneyCount[attorney] || 0) + 1;
                
                const plaintiff = d.Plaintiff_Petitioner;
                plaintiffCount[plaintiff] = (plaintiffCount[plaintiff] || 0) + 1;
                
                const date = d.File_Date;
                dailyFilings[date] = (dailyFilings[date] || 0) + 1;
            });

            const attorneyData = Object.entries(attorneyCount)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            const plaintiffData = Object.entries(plaintiffCount)
                .map(([name, count]) => ({ name: name.length > 30 ? name.substring(0, 30) + '...' : name, fullName: name, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 15);

            const proSeCount = processedData.filter(d => 
                d.Attorney?.includes('PRS') || d.Attorney?.trim() === ','
            ).length;

            return {
                attorneyData,
                plaintiffData,
                dailyFilings,
                totalCases: processedData.length,
                representedByAttorney: processedData.length - proSeCount,
                proSe: proSeCount
            };
        }

        // Create charts
        function createPieChart(canvasId, data, labels) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createBarChart(canvasId, data, labels, label = 'Count') {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    indexAxis: labels.length > 10 ? 'y' : 'x',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createLineChart(canvasId, data, labels) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Filings per Day',
                        data: data,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Export to CSV
        function exportToCSV() {
            const processedData = getProcessedData();
            const csv = [
                Object.keys(processedData[0] || {}).join(','),
                ...processedData.map(row => Object.values(row).join(','))
            ].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eviction-data-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Bulk search functions
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseNameList(content);
            };
            reader.readAsText(file);
        }

        function parseNameList(text) {
            // Handle CSV, comma-delimited, or newline-separated
            let names = [];
            
            // First try splitting by newlines
            if (text.includes('\n')) {
                names = text.split('\n');
            } 
            // Then try comma-separated
            else if (text.includes(',')) {
                names = text.split(',');
            }
            // Otherwise treat as single name
            else {
                names = [text];
            }

            // Clean up names
            names = names
                .map(name => name.trim())
                .filter(name => name.length > 0)
                // Remove CSV header if it looks like one
                .filter(name => !name.toLowerCase().match(/^(name|defendant|tenant|respondent)/));

            state.bulkSearchNames = names;
            state.showBulkSearch = true;
            render();
        }

        function clearBulkSearch() {
            state.bulkSearchNames = [];
            state.showBulkSearch = false;
            const fileInput = document.getElementById('nameFileInput');
            if (fileInput) fileInput.value = '';
            render();
        }

        function handleTextareaSearch() {
            const textarea = document.getElementById('bulkSearchTextarea');
            if (textarea) {
                parseNameList(textarea.value);
            }
        }

        // Render functions
        function render() {
            const app = document.getElementById('app');
            
            if (state.loading) {
                app.innerHTML = `
                    <div class="flex items-center justify-center h-screen">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p class="text-gray-600">Loading eviction data...</p>
                        </div>
                    </div>
                `;
                return;
            }

            if (state.error) {
                app.innerHTML = `
                    <div class="flex items-center justify-center h-screen">
                        <div class="text-center max-w-md p-6 bg-white rounded-lg shadow-lg">
                            <div class="text-red-500 mb-4">${icons.alert}</div>
                            <h2 class="text-xl font-bold text-gray-900 mb-2">Unable to Load Data</h2>
                            <p class="text-gray-600 mb-4">${state.error}</p>
                            <button onclick="fetchData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                Retry
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            const analytics = getAnalytics();
            
            // For dropdowns, we need unique values from current data
            const uniqueAttorneys = [...new Set(state.data.map(d => d.Attorney))].sort();
            const uniquePlaintiffs = [...new Set(state.data.map(d => d.Plaintiff_Petitioner))].sort();

            app.innerHTML = `
                <div class="min-h-screen p-6">
                    <div class="max-w-7xl mx-auto">
                        <!-- Header -->
                        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                                        ${icons.scale}
                                        Eviction Detainer Dashboard
                                    </h1>
                                    <p class="text-gray-600 mt-1">Nashville Sessions Court - Defense Analysis Tool</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="document.getElementById('bulkSearchModal').classList.remove('hidden')" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                                        ${icons.upload}
                                        Bulk Search
                                    </button>
                                    <button onclick="exportToCSV()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                        ${icons.download}
                                        Export Data
                                    </button>
                                </div>
                            </div>

                            ${state.showBulkSearch ? `
                                <div class="mb-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-semibold text-purple-900">Bulk Search Active</p>
                                            <p class="text-sm text-purple-700">Searching for ${state.bulkSearchNames.length} name(s) | Found ${getProcessedData().length} match(es)</p>
                                        </div>
                                        <button onclick="clearBulkSearch()" class="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 transition text-sm">
                                            Clear Search
                                        </button>
                                    </div>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-sm text-purple-700 hover:text-purple-900">Show search names</summary>
                                        <div class="mt-2 p-2 bg-white rounded text-sm max-h-40 overflow-y-auto">
                                            ${state.bulkSearchNames.map(name => `<div class="text-gray-700">• ${name}</div>`).join('')}
                                        </div>
                                    </details>
                                </div>
                            ` : ''}

                            <!-- Date Range Filter -->
                            <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-semibold text-blue-900">Date Range Filter</h3>
                                    <div class="flex gap-2 flex-wrap">
                                        <button onclick="setDatePreset(30)" class="px-2 py-1 text-xs bg-white border border-blue-300 rounded hover:bg-blue-100 transition">30 Days</button>
                                        <button onclick="setDatePreset(90)" class="px-2 py-1 text-xs bg-white border border-blue-300 rounded hover:bg-blue-100 transition">90 Days</button>
                                        <button onclick="setDatePreset(180)" class="px-2 py-1 text-xs bg-white border border-blue-300 rounded hover:bg-blue-100 transition">6 Months</button>
                                        <button onclick="setDatePreset(365)" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition">1 Year</button>
                                        <button onclick="setDatePreset(730)" class="px-2 py-1 text-xs bg-white border border-blue-300 rounded hover:bg-blue-100 transition">2 Years</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-blue-900 mb-1">Start Date</label>
                                        <input 
                                            type="date" 
                                            value="${state.filterCriteria.startDate}"
                                            onchange="updateDateRange(this.value, state.filterCriteria.endDate)"
                                            class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-blue-900 mb-1">End Date</label>
                                        <input 
                                            type="date" 
                                            value="${state.filterCriteria.endDate}"
                                            onchange="updateDateRange(state.filterCriteria.startDate, this.value)"
                                            class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        />
                                    </div>
                                </div>
                                <p class="text-xs text-blue-700 mt-2">
                                    Showing cases filed between ${formatDateForDisplay(state.filterCriteria.startDate)} and ${formatDateForDisplay(state.filterCriteria.endDate)}
                                </p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="relative">
                                    <div class="absolute left-3 top-3 text-gray-400">${icons.search}</div>
                                    <input
                                        type="text"
                                        placeholder="Search defendants, plaintiffs, docket..."
                                        value="${state.searchTerm}"
                                        oninput="updateSearch(this.value)"
                                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                
                                <select onchange="updateFilter('attorney', this.value)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="all">All Attorneys</option>
                                    ${uniqueAttorneys.map(a => `<option value="${a}" ${state.filterCriteria.attorney === a ? 'selected' : ''}>${a || 'Pro Se'}</option>`).join('')}
                                </select>

                                <select onchange="updateFilter('plaintiff', this.value)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="all">All Landlords</option>
                                    ${uniquePlaintiffs.slice(0, 50).map(p => `<option value="${p}" ${state.filterCriteria.plaintiff === p ? 'selected' : ''}>${p.length > 40 ? p.substring(0, 40) + '...' : p}</option>`).join('')}
                                </select>

                                <select onchange="updateFilter('status', this.value)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="all">All Statuses</option>
                                    <option value="PENDING" ${state.filterCriteria.status === 'PENDING' ? 'selected' : ''}>Pending</option>
                                    <option value="CLOSED" ${state.filterCriteria.status === 'CLOSED' ? 'selected' : ''}>Closed</option>
                                </select>
                            </div>
                        </div>

                        <!-- Key Metrics -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">Total Cases</p>
                                        <p class="text-3xl font-bold text-gray-900">${analytics.totalCases}</p>
                                    </div>
                                    <div class="text-red-500">${icons.alert}</div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">Corporate Landlords</p>
                                        <p class="text-3xl font-bold text-gray-900">${analytics.corporateLandlords}</p>
                                        <p class="text-xs text-gray-500 mt-1">${((analytics.corporateLandlords / analytics.totalCases) * 100).toFixed(1)}% of cases</p>
                                    </div>
                                    <div class="text-blue-500">${icons.building}</div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">Attorney Represented</p>
                                        <p class="text-3xl font-bold text-gray-900">${analytics.representedByAttorney}</p>
                                        <p class="text-xs text-gray-500 mt-1">${((analytics.representedByAttorney / analytics.totalCases) * 100).toFixed(1)}% of cases</p>
                                    </div>
                                    <div class="text-purple-500">${icons.scale}</div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">Pro Se Filers</p>
                                        <p class="text-3xl font-bold text-gray-900">${analytics.proSe}</p>
                                        <p class="text-xs text-gray-500 mt-1">${((analytics.proSe / analytics.totalCases) * 100).toFixed(1)}% of cases</p>
                                    </div>
                                    <div class="text-green-500">${icons.user}</div>
                                </div>
                            </div>
                        </div>

                        <!-- View Selector -->
                        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                            <div class="flex gap-2 overflow-x-auto">
                                ${['overview', 'attorneys', 'landlords', 'timeline', 'cases'].map(view => `
                                    <button
                                        onclick="changeView('${view}')"
                                        class="px-4 py-2 rounded-lg transition whitespace-nowrap ${
                                            state.selectedView === view
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }"
                                    >
                                        ${view.charAt(0).toUpperCase() + view.slice(1)}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <!-- View Content -->
                        <div id="viewContent"></div>

                        <!-- Footer -->
                        <div class="mt-6 bg-white rounded-lg shadow-sm p-4 text-center text-sm text-gray-600">
                            <p>Data from Nashville Sessions Court | Last Updated: ${new Date().toLocaleString()}</p>
                            <p class="mt-1">For eviction defense support, contact Legal Aid Society or Nashville Conflict Resolution Center</p>
                        </div>
                    </div>
                </div>

                <!-- Bulk Search Modal -->
                <div id="bulkSearchModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-6 z-50">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-2xl font-bold text-gray-900">Bulk Name Search</h2>
                                <button onclick="document.getElementById('bulkSearchModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>

                            <p class="text-gray-600 mb-4">Search for multiple defendants at once. Upload a file or paste names below.</p>

                            <!-- File Upload -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Upload File</label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-500 transition">
                                    <input type="file" id="nameFileInput" accept=".csv,.txt" onchange="handleFileUpload(event)" class="hidden" />
                                    <label for="nameFileInput" class="cursor-pointer">
                                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                        </svg>
                                        <p class="text-sm text-gray-600">
                                            <span class="text-purple-600 font-semibold">Click to upload</span> or drag and drop
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1">CSV or TXT file</p>
                                    </label>
                                </div>
                            </div>

                            <div class="mb-6">
                                <div class="flex items-center mb-2">
                                    <div class="flex-1 border-t border-gray-300"></div>
                                    <span class="px-3 text-sm text-gray-500">OR</span>
                                    <div class="flex-1 border-t border-gray-300"></div>
                                </div>
                            </div>

                            <!-- Text Input -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Paste Names</label>
                                <textarea 
                                    id="bulkSearchTextarea"
                                    rows="8" 
                                    placeholder="Enter names (one per line, comma-separated, or from CSV)&#10;&#10;Example:&#10;JUAN JOSE CASTRO&#10;JOSEPH KILLINGSWORTH&#10;JORGE DIAZ SALAMANCA"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent font-mono text-sm"
                                ></textarea>
                                <p class="text-xs text-gray-500 mt-2">
                                    Supports multiple formats: one name per line, comma-separated, or CSV paste
                                </p>
                            </div>

                            <!-- Actions -->
                            <div class="flex gap-3">
                                <button 
                                    onclick="handleTextareaSearch(); document.getElementById('bulkSearchModal').classList.add('hidden')"
                                    class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold"
                                >
                                    Search Names
                                </button>
                                <button 
                                    onclick="document.getElementById('bulkSearchModal').classList.add('hidden')"
                                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                                >
                                    Cancel
                                </button>
                            </div>

                            <!-- Info Box -->
                            <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <h4 class="font-semibold text-blue-900 text-sm mb-2">How it works:</h4>
                                <ul class="text-xs text-blue-800 space-y-1">
                                    <li>• Searches the "Defendant/Respondent" field for partial matches</li>
                                    <li>• Automatically removes CSV headers (name, defendant, tenant, respondent)</li>
                                    <li>• Case-insensitive matching</li>
                                    <li>• Results can be exported to CSV for further analysis</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            renderView();
        }

        function renderView() {
            const viewContent = document.getElementById('viewContent');
            if (!viewContent) return;

            const analytics = getAnalytics();
            const processedData = getProcessedData();

            if (state.selectedView === 'overview') {
                viewContent.innerHTML = `
                    <div class="grid grid-cols-1 gap-6">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-lg font-semibold mb-4">Representation Status</h3>
                            <div class="chart-container">
                                <canvas id="representationChart"></canvas>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-lg font-semibold mb-4">Top 10 Filing Attorneys</h3>
                            <div class="chart-container">
                                <canvas id="attorneyChart"></canvas>
                            </div>
                            <p class="text-sm text-gray-600 mt-4">
                                <strong>Defense Strategy Note:</strong> Serial filers may use standardized forms and processes. 
                                Look for patterns in procedural compliance and documentation quality.
                            </p>
                        </div>
                    </div>
                `;

                setTimeout(() => {
                    createPieChart('representationChart',
                        [analytics.representedByAttorney, analytics.proSe],
                        ['Attorney Represented', 'Pro Se']
                    );
                    createBarChart('attorneyChart',
                        analytics.attorneyData.map(a => a.count),
                        analytics.attorneyData.map(a => a.name),
                        'Number of Filings'
                    );
                }, 100);

            } else if (state.selectedView === 'attorneys') {
                viewContent.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Attorney Filing Patterns</h3>
                        <div class="chart-container" style="height: 500px;">
                            <canvas id="attorneyPatternChart"></canvas>
                        </div>
                        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-900 mb-2">Defense Analysis Tips:</h4>
                            <ul class="text-sm text-blue-800 space-y-1">
                                <li>• High-volume filers may be more prone to procedural errors</li>
                                <li>• Document patterns in notice requirements and service methods</li>
                                <li>• Check for proper landlord-tenant compliance in serial filer cases</li>
                                <li>• Pro se landlords may lack knowledge of tenant rights and protections</li>
                            </ul>
                        </div>
                    </div>
                `;

                setTimeout(() => {
                    createBarChart('attorneyPatternChart',
                        analytics.attorneyData.map(a => a.count),
                        analytics.attorneyData.map(a => a.name),
                        'Number of Filings'
                    );
                }, 100);

            } else if (state.selectedView === 'landlords') {
                viewContent.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Top Eviction Filers (Landlords)</h3>
                        <div class="chart-container" style="height: 600px;">
                            <canvas id="landlordChart"></canvas>
                        </div>
                        <div class="mt-6 bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-semibold text-red-900 mb-2">Landlord Pattern Analysis:</h4>
                            <ul class="text-sm text-red-800 space-y-1">
                                <li>• Serial evictors may indicate systemic housing quality issues</li>
                                <li>• Track repeated filings for patterns of retaliatory evictions</li>
                                <li>• Large property managers may have consistent procedural approaches</li>
                                <li>• Compare filing volumes across properties and management companies</li>
                            </ul>
                        </div>
                    </div>
                `;

                setTimeout(() => {
                    createBarChart('landlordChart',
                        analytics.plaintiffData.map(p => p.count),
                        analytics.plaintiffData.map(p => p.name),
                        'Number of Cases'
                    );
                }, 100);

            } else if (state.selectedView === 'timeline') {
                const filingDates = Object.keys(analytics.dailyFilings).sort();
                const filingCounts = filingDates.map(date => analytics.dailyFilings[date]);

                viewContent.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Filing Timeline</h3>
                        <div class="chart-container">
                            <canvas id="timelineChart"></canvas>
                        </div>
                        <div class="mt-6 bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-900 mb-2">Temporal Pattern Notes:</h4>
                            <ul class="text-sm text-green-800 space-y-1">
                                <li>• Spikes may correlate with end-of-month rent due dates</li>
                                <li>• Monitor for patterns following policy changes or moratorium expirations</li>
                                <li>• Seasonal trends may indicate targeting of vulnerable populations</li>
                            </ul>
                        </div>
                    </div>
                `;

                setTimeout(() => {
                    createLineChart('timelineChart', filingCounts, filingDates);
                }, 100);

            } else if (state.selectedView === 'cases') {
                viewContent.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Case Details (${processedData.length} cases)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 border-b-2 border-gray-200">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Docket #</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Filed</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Plaintiff (Landlord)</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Defendant (Tenant)</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Attorney</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${processedData.map(record => `
                                        <tr class="hover:bg-gray-50 transition">
                                            <td class="px-4 py-3 font-mono text-blue-600">${record.Docket_Number}</td>
                                            <td class="px-4 py-3">${record.File_Date}</td>
                                            <td class="px-4 py-3">
                                                <div class="max-w-xs truncate" title="${record.Plaintiff_Petitioner}">
                                                    ${record.Plaintiff_Petitioner}
                                                </div>
                                                ${(record.Plaintiff_Petitioner?.includes('LLC') || 
                                                   record.Plaintiff_Petitioner?.includes('LP') ||
                                                   record.Plaintiff_Petitioner?.includes('CORP') ||
                                                   record.Plaintiff_Petitioner?.includes('INC')) ? 
                                                    '<span class="inline-block px-2 py-0.5 text-xs bg-blue-100 text-blue-800 rounded mt-1">Corporate</span>' : ''
                                                }
                                            </td>
                                            <td class="px-4 py-3 font-semibold">${record.Defendant_Respondent}</td>
                                            <td class="px-4 py-3">
                                                ${record.Attorney?.includes('PRS') || record.Attorney?.trim() === ',' ? 
                                                    '<span class="inline-block px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded">Pro Se</span>' : 
                                                    record.Attorney
                                                }
                                            </td>
                                            <td class="px-4 py-3">
                                                <span class="inline-block px-2 py-1 text-xs rounded ${
                                                    record.Status === 'PENDING' ? 
                                                        'bg-red-100 text-red-800' : 
                                                        'bg-gray-100 text-gray-800'
                                                }">
                                                    ${record.Status}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Total Count -->
                        <div class="mt-6 border-t pt-4">
                            <div class="text-sm text-gray-600 text-center">
                                Showing ${processedData.length} cases
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Event handlers
        function updateSearch(value) {
            state.searchTerm = value;
            // Note: Search is client-side for now. Could be moved to API with Defendant_Respondent parameter
            render();
        }

        function updateFilter(type, value) {
            state.filterCriteria[type] = value;
            fetchData();
        }

        function updateDateRange(startDate, endDate) {
            state.filterCriteria.startDate = startDate;
            state.filterCriteria.endDate = endDate;
            fetchData();
        }

        function setDatePreset(days) {
            const endDate = getTodayDate();
            const startDate = getDateDaysAgo(days);
            updateDateRange(startDate, endDate);
        }

        function changeView(view) {
            state.selectedView = view;
            render();
        }

        // Initialize
        fetchData();
    </script>
</body>
</html>
