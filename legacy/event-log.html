<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Log - Nashville Eviction Tracker</title>
    <link rel="icon" type="image/png" href="https://storage.googleapis.com/intelechia-content/im/eviction%20prevention%20logo.png">
    <link rel="stylesheet" href="dist/output.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary: #4f46e5;
            --secondary: #06b6d4;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f9fafb;
            line-height: 1.6;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            height: 40px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .page-intro {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #86efac;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .page-intro h2 {
            font-size: 24px;
            font-weight: 700;
            color: #166534;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-intro p {
            color: #374151;
            font-size: 15px;
        }

        .privacy-notice {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .privacy-notice h3 {
            font-size: 14px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .privacy-notice p {
            font-size: 13px;
            color: #78350f;
        }

        .controls-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .control-input {
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            color: #374151;
            background: white;
            transition: all 0.2s;
        }

        .control-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .stats-bar {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 16px 20px;
            min-width: 140px;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            margin-top: 4px;
        }

        .event-list {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }

        .event-list-header {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .event-list-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .event-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-item:hover {
            background: #f9fafb;
        }

        .event-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .event-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .event-op {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .op-INS { background: #dcfce7; color: #166534; }
        .op-ALT { background: #dbeafe; color: #1e40af; }

        .event-entity {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .event-time {
            font-size: 12px;
            color: #6b7280;
        }

        .event-meaning {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .event-details {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
        }

        .event-detail-row {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .event-detail-row:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            color: #6b7280;
            min-width: 100px;
        }

        .detail-value {
            color: #374151;
            word-break: break-word;
        }

        .redacted {
            background: #fee2e2;
            color: #991b1b;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-style: italic;
        }

        .changes-list {
            margin-top: 8px;
        }

        .change-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .change-item:last-child {
            margin-bottom: 0;
        }

        .change-field {
            font-weight: 600;
            color: #111827;
        }

        .change-arrow {
            color: #6b7280;
            margin: 0 6px;
        }

        .change-old {
            color: #991b1b;
            text-decoration: line-through;
        }

        .change-new {
            color: #166534;
        }

        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .loading-state .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .pagination-btn {
            padding: 8px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            color: #374151;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 13px;
            color: #6b7280;
        }

        .footer {
            background: #1f2937;
            color: #9ca3af;
            padding: 24px;
            margin-top: 48px;
            text-align: center;
        }

        .footer a {
            color: #60a5fa;
        }

        .legend {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .legend-title {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 12px;
        }

        .legend-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
        }

        /* Enhanced event item with click action */
        .event-item-clickable {
            cursor: pointer;
        }

        .event-item-clickable:hover {
            background: #f0f9ff;
            border-left: 3px solid var(--primary);
        }

        .view-record-btn {
            padding: 4px 10px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 11px;
            color: #4f46e5;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .view-record-btn:hover {
            background: #e0e7ff;
            border-color: #4f46e5;
        }

        /* Enhanced change display */
        .change-item-enhanced {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .change-item-enhanced:last-child {
            margin-bottom: 0;
        }

        .change-field-header {
            font-weight: 600;
            color: #111827;
            font-size: 13px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .change-field-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .change-field-badge.added {
            background: #dcfce7;
            color: #166534;
        }

        .change-field-badge.modified {
            background: #dbeafe;
            color: #1e40af;
        }

        .change-field-badge.removed {
            background: #fee2e2;
            color: #991b1b;
        }

        .change-values {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 8px;
            align-items: center;
        }

        .change-value-box {
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Monaco', 'Consolas', monospace;
            word-break: break-word;
        }

        .change-value-old {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }

        .change-value-new {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
        }

        .change-arrow-box {
            color: #6b7280;
            font-size: 16px;
        }

        /* Record Modal Styles */
        .record-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .record-modal-overlay.active {
            display: flex;
        }

        .record-modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .record-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        }

        .record-modal-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .record-modal-title h2 {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }

        .record-modal-title .subtitle {
            font-size: 13px;
            color: #6b7280;
            margin: 0;
        }

        .record-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: #f3f4f6;
            color: #6b7280;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .record-modal-close:hover {
            background: #e5e7eb;
            color: #111827;
        }

        .record-modal-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 24px;
            background: white;
        }

        .record-modal-tab {
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s;
        }

        .record-modal-tab:hover {
            color: #111827;
        }

        .record-modal-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .record-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .record-modal-section {
            display: none;
        }

        .record-modal-section.active {
            display: block;
        }

        /* Current State Section */
        .state-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .state-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 16px;
        }

        .state-card-header {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .state-field {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .state-field:last-child {
            border-bottom: none;
        }

        .state-field-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        .state-field-value {
            font-size: 13px;
            color: #111827;
            font-weight: 500;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }

        /* Event Timeline Section */
        .event-timeline {
            position: relative;
            padding-left: 24px;
        }

        .event-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }

        .timeline-event {
            position: relative;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .timeline-event::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 16px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--primary);
        }

        .timeline-event.op-INS::before { border-color: #10b981; background: #dcfce7; }
        .timeline-event.op-ALT::before { border-color: #3b82f6; background: #dbeafe; }

        .timeline-event-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .timeline-event-op {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .timeline-event-time {
            font-size: 11px;
            color: #9ca3af;
        }

        .timeline-event-desc {
            font-size: 13px;
            color: #374151;
        }

        .timeline-changes {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f3f4f6;
        }

        .timeline-change {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .timeline-change-field {
            font-weight: 600;
            color: #374151;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 12px;
                padding: 12px 16px;
            }

            .header h1 {
                font-size: 16px;
            }

            .main-container {
                padding: 16px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                flex-direction: column;
            }

            .stat-card {
                width: 100%;
            }

            .event-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .state-grid {
                grid-template-columns: 1fr;
            }

            .record-modal {
                max-height: 95vh;
            }

            .change-values {
                grid-template-columns: 1fr;
            }

            .change-arrow-box {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <img src="https://storage.googleapis.com/intelechia-content/im/eviction%20prevention%20logo.png" alt="Logo" class="logo">
            <div>
                <h1>Event Sourcing Log</h1>
                <div style="font-size: 12px; color: #6b7280;">Transparent data change history</div>
            </div>
        </div>
        <div class="header-right">
            <a href="index.html" class="btn btn-secondary">
                <span>‚Üê</span> Dashboard
            </a>
            <a href="provenance.html" class="btn btn-secondary">
                <span>üìã</span> Provenance
            </a>
            <a href="cm-rankings.html" class="btn btn-secondary">
                <span>üìä</span> Rankings
            </a>
        </div>
    </header>

    <main class="main-container">
        <!-- Page Introduction -->
        <div class="page-intro">
            <h2>üìú Event Sourcing Transparency</h2>
            <p>
                This page shows the work done to process eviction data‚Äînot a static dump of all records pulled at once,
                but a step-by-step log of how the dataset was built and maintained over time. Each entry represents
                an operation that was performed: a case being filed, a status being updated, records being linked together,
                and so on. The <strong>operators</strong> (INS, ALT) document exactly what happened at each step,
                providing full transparency into how the data evolved.
            </p>
            <div class="privacy-notice">
                <h3>üîí Privacy Protection</h3>
                <p>
                    Tenant names (defendants) and property addresses are automatically redacted in this view to protect
                    the privacy of individuals facing eviction proceedings. Only aggregate and anonymized data is shown.
                </p>
            </div>
        </div>

        <!-- Operator Legend -->
        <div class="legend">
            <div class="legend-title">Event Operators</div>
            <div class="legend-grid">
                <div class="legend-item">
                    <span class="event-op op-INS">INS</span>
                    <span>New case filed</span>
                </div>
                <div class="legend-item">
                    <span class="event-op op-ALT">ALT</span>
                    <span>Case updated</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-section">
            <div class="controls-grid">
                <div class="control-group">
                    <label class="control-label">Filter by Operator</label>
                    <select id="opFilter" class="control-input">
                        <option value="">All Operators</option>
                        <option value="INS">INS - New Cases</option>
                        <option value="ALT">ALT - Updates</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">Search Entity ID</label>
                    <input type="text" id="entitySearch" class="control-input" placeholder="e.g., 24GC1234">
                </div>
                <div class="control-group">
                    <label class="control-label">Date Range Start</label>
                    <input type="date" id="dateStart" class="control-input">
                </div>
                <div class="control-group">
                    <label class="control-label">Date Range End</label>
                    <input type="date" id="dateEnd" class="control-input">
                </div>
                <div class="control-group" style="justify-content: flex-end;">
                    <button id="refreshBtn" class="btn btn-primary">
                        <span>üîÑ</span> Refresh Events
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Total Events</div>
                <div class="stat-value" id="totalEvents">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Inserts (INS)</div>
                <div class="stat-value" id="insertCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Updates (ALT)</div>
                <div class="stat-value" id="updateCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Unique Entities</div>
                <div class="stat-value" id="entityCount">-</div>
            </div>
        </div>

        <!-- Event List -->
        <div class="event-list">
            <div class="event-list-header">
                <div class="event-list-title">
                    <span>üìã</span>
                    Event History
                </div>
                <div style="font-size: 13px; color: #6b7280;">
                    Showing <span id="showingCount">0</span> events
                </div>
            </div>

            <div id="eventContainer">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <div>Loading events...</div>
                </div>
            </div>

            <div class="pagination" id="pagination" style="display: none;">
                <button class="pagination-btn" id="prevBtn" disabled>‚Üê Previous</button>
                <span class="pagination-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                <button class="pagination-btn" id="nextBtn">Next ‚Üí</button>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p style="font-size: 14px; margin-bottom: 8px;">
            <strong>Nashville Eviction Tracker</strong> ‚Äî Community Project (UNOFFICIAL)
        </p>
        <p style="font-size: 13px;">
            Event sourcing powered by <a href="https://epistemic-operators.org" target="_blank">Epistemic Operators</a> |
            <a href="provenance.html">Data Provenance</a>
        </p>
        <p style="font-size: 12px; margin-top: 12px; color: #6b7280;">
            Last updated: <span id="last-updated"></span>
        </p>
    </footer>

    <!-- Record Detail Modal -->
    <div class="record-modal-overlay" id="recordModal" onclick="closeRecordModal(event)">
        <div class="record-modal" onclick="event.stopPropagation()">
            <div class="record-modal-header">
                <div class="record-modal-title">
                    <div>
                        <h2 id="recordModalTitle">Record Details</h2>
                        <p class="subtitle" id="recordModalSubtitle">Consolidated view from event history</p>
                    </div>
                </div>
                <button class="record-modal-close" onclick="closeRecordModal()">&times;</button>
            </div>
            <div class="record-modal-tabs">
                <button class="record-modal-tab active" data-tab="state" onclick="switchRecordTab('state')">Current State</button>
                <button class="record-modal-tab" data-tab="timeline" onclick="switchRecordTab('timeline')">Event Timeline</button>
            </div>
            <div class="record-modal-body">
                <!-- Current State Section -->
                <div class="record-modal-section active" id="stateSection">
                    <div class="state-grid" id="stateGrid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                <!-- Event Timeline Section -->
                <div class="record-modal-section" id="timelineSection">
                    <div class="event-timeline" id="eventTimeline">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load EO Migration Library -->
    <script src="eo-migration.js"></script>

    <script>
        // =============================================================================
        // TIMEZONE UTILITIES - US Central Time (CT)
        // =============================================================================

        const CT_TIMEZONE = 'America/Chicago';

        /**
         * Format a timestamp to US Central Time
         * @param {number|Date} timestamp - Unix timestamp in ms or Date object
         * @param {Object} options - Additional Intl.DateTimeFormat options
         * @returns {string} Formatted date/time string in Central Time
         */
        function formatToCentralTime(timestamp, options = {}) {
            const date = timestamp instanceof Date ? timestamp : new Date(timestamp);
            const defaultOptions = {
                timeZone: CT_TIMEZONE,
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            return date.toLocaleString('en-US', { ...defaultOptions, ...options });
        }

        /**
         * Format a date to US Central Time (date only, no time)
         * @param {number|Date|string} timestamp - Unix timestamp in ms, Date object, or date string
         * @param {Object} options - Additional Intl.DateTimeFormat options
         * @returns {string} Formatted date string in Central Time
         */
        function formatDateToCentralTime(timestamp, options = {}) {
            const date = timestamp instanceof Date ? timestamp : new Date(timestamp);
            if (isNaN(date.getTime())) return null;
            const defaultOptions = {
                timeZone: CT_TIMEZONE,
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            };
            return date.toLocaleDateString('en-US', { ...defaultOptions, ...options });
        }

        // =============================================================================
        // REDACTION UTILITIES
        // =============================================================================

        // Fields that contain sensitive tenant information to redact
        const SENSITIVE_FIELDS = [
            'Defendant_Respondent',
            'defendant_respondent',
            'defendant',
            'Defendant',
            'Address_1',
            'Address_2',
            'address_1',
            'address_2',
            'address',
            'Address',
            'address_formatted',
            'city_state_zip'
        ];

        // Fields that are always safe to show
        const SAFE_FIELDS = [
            'Docket_Number',
            'docket_number',
            'Status',
            'status',
            'File_Date',
            'file_date',
            'Plaintiff_Petitioner',
            'plaintiff_petitioner',
            'plaintiff',
            'Attorney',
            'attorney',
            'council_district',
            'council_district_number',
            'judge',
            'judgment_for',
            'judgment_date',
            'judgment_type',
            'case_dismissed',
            'dismissal_date',
            'eviction_date',
            'eviction_method',
            'eviction_executed',
            'writ_issued_date',
            'writ_served_date',
            'individual_ll',
            'latitude',
            'longitude'
        ];

        /**
         * Name redaction (first initial + redacted last name)
         * Shows: first initial, last 2 chars of last name, stars for rest
         * If last name is 2 chars or less, stars out completely
         */
        function scrambleName(name) {
            if (!name || typeof name !== 'string') return '[REDACTED]';

            // Split into parts to identify first and last name
            const parts = name.trim().split(/\s+/);
            if (parts.length === 0) return '[REDACTED]';

            // Get first initial
            const firstName = parts[0];
            const firstInitial = firstName.charAt(0).toUpperCase();

            // Get last name (use first name if only one part)
            const lastName = parts.length > 1 ? parts[parts.length - 1] : parts[0];

            // Redact last name: show last 2 chars, star the rest
            // If 2 chars or less, star out completely
            let redactedLast;
            if (lastName.length <= 2) {
                redactedLast = '*'.repeat(lastName.length);
            } else {
                const starsCount = lastName.length - 2;
                const lastTwo = lastName.slice(-2);
                redactedLast = '*'.repeat(starsCount) + lastTwo;
            }

            return `${firstInitial}. ${redactedLast}`;
        }

        /**
         * Redact address to show only general area
         */
        function redactAddress(address) {
            if (!address || typeof address !== 'string') return '[ADDRESS REDACTED]';

            // Try to extract just the city/state portion
            const parts = address.split(',');
            if (parts.length > 1) {
                // Return last part (usually city/state/zip)
                return `[REDACTED], ${parts[parts.length - 1].trim()}`;
            }

            return '[ADDRESS REDACTED]';
        }

        /**
         * Check if a field name is sensitive
         */
        function isSensitiveField(fieldName) {
            const normalized = fieldName.toLowerCase();
            return SENSITIVE_FIELDS.some(f => f.toLowerCase() === normalized) ||
                   normalized.includes('defendant') ||
                   normalized.includes('address') ||
                   normalized.includes('tenant');
        }

        /**
         * Redact a value based on field name
         */
        function redactValue(fieldName, value) {
            if (!isSensitiveField(fieldName)) {
                return formatValue(value);
            }

            const normalized = fieldName.toLowerCase();

            if (normalized.includes('defendant') || normalized.includes('tenant')) {
                return `<span class="redacted">${scrambleName(value)}</span>`;
            }

            if (normalized.includes('address')) {
                return `<span class="redacted">${redactAddress(value)}</span>`;
            }

            return `<span class="redacted">[REDACTED]</span>`;
        }

        /**
         * Format any value for display
         */
        function formatValue(value) {
            if (value === null || value === undefined) return '<em>null</em>';
            if (typeof value === 'object') {
                return `<code>${escapeHtml(JSON.stringify(value))}</code>`;
            }
            return escapeHtml(String(value));
        }

        /**
         * Escape HTML entities
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Redact an entire data object
         */
        function redactObject(obj) {
            if (!obj || typeof obj !== 'object') return obj;

            const redacted = {};
            for (const [key, value] of Object.entries(obj)) {
                if (isSensitiveField(key)) {
                    if (key.toLowerCase().includes('defendant') || key.toLowerCase().includes('tenant')) {
                        redacted[key] = scrambleName(value);
                    } else if (key.toLowerCase().includes('address')) {
                        redacted[key] = redactAddress(value);
                    } else {
                        redacted[key] = '[REDACTED]';
                    }
                } else if (typeof value === 'object' && value !== null) {
                    redacted[key] = redactObject(value);
                } else {
                    redacted[key] = value;
                }
            }
            return redacted;
        }

        // =============================================================================
        // EVENT DISPLAY
        // =============================================================================

        const OPERATOR_MEANINGS = {
            INS: 'New eviction filing recorded',
            ALT: 'Filing data updated'
        };

        // Pagination state
        let allEvents = [];
        let filteredEvents = [];
        let currentPage = 1;
        const EVENTS_PER_PAGE = 50;

        /**
         * Render a single event item
         */
        function renderEvent(event) {
            const timestamp = formatToCentralTime(event.ts);
            const meaning = OPERATOR_MEANINGS[event.op] || event.op;

            let detailsHtml = '';

            // Support both 'payload' (new) and 'context' (legacy) field names
            const eventData = event.payload || event.context || {};

            // Handle different event types
            if (event.op === 'INS' && eventData.data) {
                // Insert event - show redacted case data
                const redactedData = redactObject(eventData.data);
                detailsHtml = renderInsertDetails(redactedData);
            } else if (event.op === 'ALT') {
                // Update event - show changes with redaction
                if (eventData.changes) {
                    detailsHtml = renderChangeDetails(eventData.changes);
                } else if (event.target && event.target.field) {
                    detailsHtml = renderSingleFieldChange(event.target.field, eventData.old, eventData.new);
                }
            }

            // Frame info (source, actor)
            let frameHtml = '';
            if (event.frame) {
                const frameParts = [];
                if (event.frame.source) frameParts.push(`Source: ${event.frame.source}`);
                if (event.frame.actor) frameParts.push(`Actor: ${event.frame.actor}`);
                if (event.frame.version) frameParts.push(`v${event.frame.version}`);
                if (frameParts.length > 0) {
                    frameHtml = `<div class="event-detail-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                        <span class="detail-label">Frame:</span>
                        <span class="detail-value" style="color: #9ca3af; font-size: 12px;">${escapeHtml(frameParts.join(' | '))}</span>
                    </div>`;
                }
            }

            const entityId = event.entity_id || event.target?.id || 'N/A';

            return `
                <div class="event-item event-item-clickable" data-entity-id="${escapeHtml(entityId)}" onclick="openRecordModal('${escapeHtml(entityId)}')">
                    <div class="event-header">
                        <div class="event-header-left">
                            <span class="event-op op-${event.op}">${event.op}</span>
                            <span class="event-entity">${escapeHtml(entityId)}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="view-record-btn" onclick="event.stopPropagation(); openRecordModal('${escapeHtml(entityId)}')">
                                <span>üìã</span> View Record
                            </button>
                            <span class="event-time">${timestamp}</span>
                        </div>
                    </div>
                    <div class="event-meaning">${meaning}</div>
                    ${detailsHtml || frameHtml ? `<div class="event-details">${detailsHtml}${frameHtml}</div>` : ''}
                </div>
            `;
        }

        /**
         * Render insert event details
         */
        function renderInsertDetails(data) {
            // Define field mappings with display names and alternative field names
            const fieldConfig = [
                { display: 'Docket Number', keys: ['Docket_Number', 'docket_number'] },
                { display: 'File Date', keys: ['File_Date', 'file_date'] },
                { display: 'Status', keys: ['Status', 'status'] },
                { display: 'Plaintiff', keys: ['Plaintiff_Petitioner', 'plaintiff_petitioner', 'Plaintiff'] },
                { display: 'Defendant', keys: ['Defendant_Respondent', 'defendant_respondent', 'Defendant'] },
                { display: 'Attorney', keys: ['Attorney', 'attorney'] },
                { display: 'Address', keys: ['address_formatted', 'formatted_address', 'Address_1', 'address_1', 'address'] },
                { display: 'District', keys: ['council_district_number', 'council_district', 'District'] },
                { display: 'Office', keys: ['Office', 'office'] },
                { display: 'Description', keys: ['Description', 'description'] },
                { display: 'Judge', keys: ['judge', 'Judge'] },
                { display: 'Pleadings', keys: ['pleadings'], isArray: true },
                { display: 'Judgments', keys: ['judgments'], isArray: true }
            ];

            let html = '';

            for (const config of fieldConfig) {
                // Find the first matching key that has a value
                let value = null;
                for (const key of config.keys) {
                    if (data[key] !== undefined && data[key] !== null && data[key] !== '') {
                        value = data[key];
                        break;
                    }
                }

                if (value === null) continue;

                let displayValue;

                if (config.isArray && Array.isArray(value)) {
                    if (value.length === 0) {
                        displayValue = '<span style="color: #9ca3af;">None</span>';
                    } else {
                        displayValue = `${value.length} item${value.length !== 1 ? 's' : ''}`;
                    }
                } else if (isSensitiveField(config.keys[0])) {
                    displayValue = `<span class="redacted">${escapeHtml(String(value))}</span>`;
                } else {
                    displayValue = escapeHtml(String(value));
                }

                html += `<div class="event-detail-row">
                    <span class="detail-label">${escapeHtml(config.display)}:</span>
                    <span class="detail-value">${displayValue}</span>
                </div>`;
            }

            return html;
        }

        /**
         * Determine the type of change (added, modified, removed)
         */
        function getChangeType(oldVal, newVal) {
            const oldEmpty = oldVal === null || oldVal === undefined || oldVal === '';
            const newEmpty = newVal === null || newVal === undefined || newVal === '';

            if (oldEmpty && !newEmpty) return 'added';
            if (!oldEmpty && newEmpty) return 'removed';
            return 'modified';
        }

        /**
         * Render change details for ALT events (enhanced version)
         */
        function renderChangeDetails(changes) {
            let html = '<div class="changes-list">';

            for (const [field, change] of Object.entries(changes)) {
                const displayField = field.replace(/_/g, ' ');
                const changeType = getChangeType(change.old, change.new);
                let oldVal, newVal;

                if (isSensitiveField(field)) {
                    if (field.toLowerCase().includes('defendant') || field.toLowerCase().includes('tenant')) {
                        oldVal = scrambleName(change.old);
                        newVal = scrambleName(change.new);
                    } else if (field.toLowerCase().includes('address')) {
                        oldVal = redactAddress(change.old);
                        newVal = redactAddress(change.new);
                    } else {
                        oldVal = '[REDACTED]';
                        newVal = '[REDACTED]';
                    }

                    html += `<div class="change-item-enhanced">
                        <div class="change-field-header">
                            <span>${escapeHtml(displayField)}</span>
                            <span class="change-field-badge ${changeType}">${changeType}</span>
                        </div>
                        <div class="change-values">
                            <div class="change-value-box change-value-old">
                                <span class="redacted">${escapeHtml(oldVal)}</span>
                            </div>
                            <div class="change-arrow-box">‚Üí</div>
                            <div class="change-value-box change-value-new">
                                <span class="redacted">${escapeHtml(newVal)}</span>
                            </div>
                        </div>
                    </div>`;
                } else {
                    oldVal = change.old !== null && change.old !== undefined ? String(change.old) : '(empty)';
                    newVal = change.new !== null && change.new !== undefined ? String(change.new) : '(empty)';

                    html += `<div class="change-item-enhanced">
                        <div class="change-field-header">
                            <span>${escapeHtml(displayField)}</span>
                            <span class="change-field-badge ${changeType}">${changeType}</span>
                        </div>
                        <div class="change-values">
                            <div class="change-value-box change-value-old">${escapeHtml(oldVal)}</div>
                            <div class="change-arrow-box">‚Üí</div>
                            <div class="change-value-box change-value-new">${escapeHtml(newVal)}</div>
                        </div>
                    </div>`;
                }
            }

            html += '</div>';
            return html;
        }

        /**
         * Render single field change (enhanced version)
         */
        function renderSingleFieldChange(field, oldVal, newVal) {
            const displayField = field.replace(/_/g, ' ');
            const changeType = getChangeType(oldVal, newVal);
            let html = '<div class="changes-list">';

            if (isSensitiveField(field)) {
                html += `<div class="change-item-enhanced">
                    <div class="change-field-header">
                        <span>${escapeHtml(displayField)}</span>
                        <span class="change-field-badge ${changeType}">${changeType}</span>
                    </div>
                    <div class="change-values">
                        <div class="change-value-box change-value-old">
                            <span class="redacted">[REDACTED]</span>
                        </div>
                        <div class="change-arrow-box">‚Üí</div>
                        <div class="change-value-box change-value-new">
                            <span class="redacted">[REDACTED]</span>
                        </div>
                    </div>
                </div>`;
            } else {
                const oldDisplay = oldVal !== null && oldVal !== undefined ? String(oldVal) : '(empty)';
                const newDisplay = newVal !== null && newVal !== undefined ? String(newVal) : '(empty)';

                html += `<div class="change-item-enhanced">
                    <div class="change-field-header">
                        <span>${escapeHtml(displayField)}</span>
                        <span class="change-field-badge ${changeType}">${changeType}</span>
                    </div>
                    <div class="change-values">
                        <div class="change-value-box change-value-old">${escapeHtml(oldDisplay)}</div>
                        <div class="change-arrow-box">‚Üí</div>
                        <div class="change-value-box change-value-new">${escapeHtml(newDisplay)}</div>
                    </div>
                </div>`;
            }

            html += '</div>';
            return html;
        }

        // =============================================================================
        // MAIN FUNCTIONALITY
        // =============================================================================

        /**
         * Fetch and display events
         */
        async function loadEvents() {
            const container = document.getElementById('eventContainer');
            container.innerHTML = `<div class="loading-state">
                <div class="spinner"></div>
                <div>Loading events...</div>
            </div>`;

            document.getElementById('pagination').style.display = 'none';

            try {
                // Fetch events from EO system
                const events = await EOMigration.fetchEvents({
                    per_page: 1000 // Get up to 1000 events
                });

                allEvents = Array.isArray(events) ? events : (events.items || events.data || []);

                // Sort by timestamp descending (most recent first)
                allEvents.sort((a, b) => b.ts - a.ts);

                // Apply filters and render
                applyFilters();
                updateStats();

            } catch (error) {
                console.error('Failed to load events:', error);
                container.innerHTML = `<div class="empty-state">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Failed to Load Events</div>
                    <div>${escapeHtml(error.message)}</div>
                    <button class="btn btn-primary" style="margin-top: 16px;" onclick="loadEvents()">Try Again</button>
                </div>`;
            }
        }

        /**
         * Apply filters and update display
         */
        function applyFilters() {
            const opFilter = document.getElementById('opFilter').value;
            const entitySearch = document.getElementById('entitySearch').value.trim().toLowerCase();
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;

            filteredEvents = allEvents.filter(event => {
                // Operator filter
                if (opFilter && event.op !== opFilter) return false;

                // Entity search
                if (entitySearch) {
                    const entityId = (event.entity_id || event.target?.id || '').toLowerCase();
                    if (!entityId.includes(entitySearch)) return false;
                }

                // Date filters
                if (dateStart) {
                    const startTs = new Date(dateStart).getTime();
                    if (event.ts < startTs) return false;
                }
                if (dateEnd) {
                    const endTs = new Date(dateEnd).setHours(23, 59, 59, 999);
                    if (event.ts > endTs) return false;
                }

                return true;
            });

            currentPage = 1;
            renderEvents();
        }

        /**
         * Render filtered events with pagination
         */
        function renderEvents() {
            const container = document.getElementById('eventContainer');
            const pagination = document.getElementById('pagination');

            if (filteredEvents.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No Events Found</div>
                    <div>Try adjusting your filters or refreshing the data.</div>
                </div>`;
                pagination.style.display = 'none';
                document.getElementById('showingCount').textContent = '0';
                return;
            }

            // Calculate pagination
            const totalPages = Math.ceil(filteredEvents.length / EVENTS_PER_PAGE);
            const startIdx = (currentPage - 1) * EVENTS_PER_PAGE;
            const endIdx = Math.min(startIdx + EVENTS_PER_PAGE, filteredEvents.length);
            const pageEvents = filteredEvents.slice(startIdx, endIdx);

            // Render events
            container.innerHTML = pageEvents.map(renderEvent).join('');

            // Update pagination
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
            pagination.style.display = totalPages > 1 ? 'flex' : 'none';

            document.getElementById('showingCount').textContent =
                `${startIdx + 1}-${endIdx} of ${filteredEvents.length}`;
        }

        /**
         * Update statistics display
         */
        function updateStats() {
            const total = allEvents.length;
            const inserts = allEvents.filter(e => e.op === 'INS').length;
            const updates = allEvents.filter(e => e.op === 'ALT').length;
            const entities = new Set(allEvents.map(e => e.entity_id || e.target?.id)).size;

            document.getElementById('totalEvents').textContent = total.toLocaleString();
            document.getElementById('insertCount').textContent = inserts.toLocaleString();
            document.getElementById('updateCount').textContent = updates.toLocaleString();
            document.getElementById('entityCount').textContent = entities.toLocaleString();
        }

        // =============================================================================
        // RECORD MODAL FUNCTIONALITY
        // =============================================================================

        /**
         * Reconstruct the current state of an entity from its events
         */
        function reconstructState(entityId) {
            // Get all events for this entity, sorted by timestamp (oldest first)
            const entityEvents = allEvents
                .filter(e => (e.entity_id || e.target?.id) === entityId)
                .sort((a, b) => a.ts - b.ts);

            if (entityEvents.length === 0) {
                return { state: null, events: [] };
            }

            // Start with initial state from INS event
            let state = {};

            for (const event of entityEvents) {
                // Support both 'payload' (new) and 'context' (legacy) field names
                const eventData = event.payload || event.context || {};

                if (event.op === 'INS' && eventData.data) {
                    // Initial insert - set base state
                    state = { ...eventData.data };
                } else if (event.op === 'ALT') {
                    // Apply changes
                    if (eventData.changes) {
                        for (const [field, change] of Object.entries(eventData.changes)) {
                            state[field] = change.new;
                        }
                    } else if (event.target && event.target.field && eventData.new !== undefined) {
                        state[event.target.field] = eventData.new;
                    }
                }
            }

            return { state, events: entityEvents };
        }

        /**
         * Open the record modal for an entity
         */
        function openRecordModal(entityId) {
            const { state, events } = reconstructState(entityId);

            // Update modal title
            document.getElementById('recordModalTitle').textContent = entityId;
            document.getElementById('recordModalSubtitle').textContent =
                `${events.length} event${events.length !== 1 ? 's' : ''} recorded`;

            // Populate current state section
            renderStateGrid(state);

            // Populate timeline section
            renderEventTimeline(events);

            // Reset to first tab
            switchRecordTab('state');

            // Show modal
            document.getElementById('recordModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        /**
         * Close the record modal
         */
        function closeRecordModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('recordModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        /**
         * Switch between tabs in the record modal
         */
        function switchRecordTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.record-modal-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Update sections
            document.querySelectorAll('.record-modal-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(tabName + 'Section').classList.add('active');
        }

        /**
         * Render the current state grid
         */
        function renderStateGrid(state) {
            const grid = document.getElementById('stateGrid');

            if (!state || Object.keys(state).length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 32px; margin-bottom: 12px;">üì≠</div>
                        <div>No state data available for this record</div>
                    </div>
                `;
                return;
            }

            // Group fields by category
            const categories = {
                'Case Info': ['Docket_Number', 'docket_number', 'Case_Number', 'case_number', 'File_Date', 'file_date', 'Status', 'status', 'judge'],
                'Parties': ['Plaintiff_Petitioner', 'plaintiff_petitioner', 'Defendant_Respondent', 'defendant_respondent', 'Attorney', 'attorney', 'Defendant_Attorney'],
                'Location': ['Address_1', 'Address_2', 'address_1', 'address_2', 'city_state_zip', 'address_formatted', 'council_district', 'latitude', 'longitude'],
                'Judgment': ['judgment_for', 'judgment_date', 'judgment_type', 'Amount_Judgment', 'case_dismissed', 'dismissal_date'],
                'Service & Writ': ['service_date', 'writ_issued_date', 'writ_served_date', 'eviction_date', 'eviction_method', 'eviction_executed'],
                'Financial': ['Amount_Claimed', 'amount_claimed']
            };

            // Redact state before display
            const redactedState = redactObject(state);

            let html = '';

            for (const [category, fields] of Object.entries(categories)) {
                const categoryFields = fields.filter(f => redactedState[f] !== undefined && redactedState[f] !== null);

                if (categoryFields.length === 0) continue;

                html += `
                    <div class="state-card">
                        <div class="state-card-header">
                            <span>${getCategoryIcon(category)}</span>
                            <span>${category}</span>
                        </div>
                `;

                for (const field of categoryFields) {
                    const displayField = field.replace(/_/g, ' ');
                    let displayValue = redactedState[field];

                    // Format dates in Central Time
                    if (field.toLowerCase().includes('date') && displayValue) {
                        const formattedDate = formatDateToCentralTime(displayValue);
                        if (formattedDate) {
                            displayValue = formattedDate;
                        }
                    }

                    const isSensitive = isSensitiveField(field);

                    html += `
                        <div class="state-field">
                            <span class="state-field-label">${escapeHtml(displayField)}</span>
                            <span class="state-field-value ${isSensitive ? 'redacted' : ''}">${escapeHtml(String(displayValue))}</span>
                        </div>
                    `;
                }

                html += '</div>';
            }

            // Add any other fields not in categories
            const allCategoryFields = Object.values(categories).flat();
            const otherFields = Object.keys(redactedState).filter(f =>
                !allCategoryFields.includes(f) &&
                !f.startsWith('_') &&
                redactedState[f] !== null &&
                redactedState[f] !== undefined &&
                typeof redactedState[f] !== 'object'
            );

            if (otherFields.length > 0) {
                html += `
                    <div class="state-card">
                        <div class="state-card-header">
                            <span>üìé</span>
                            <span>Other Fields</span>
                        </div>
                `;

                for (const field of otherFields) {
                    const displayField = field.replace(/_/g, ' ');
                    const isSensitive = isSensitiveField(field);

                    html += `
                        <div class="state-field">
                            <span class="state-field-label">${escapeHtml(displayField)}</span>
                            <span class="state-field-value ${isSensitive ? 'redacted' : ''}">${escapeHtml(String(redactedState[field]))}</span>
                        </div>
                    `;
                }

                html += '</div>';
            }

            grid.innerHTML = html || `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6b7280;">
                    <div style="font-size: 32px; margin-bottom: 12px;">üì≠</div>
                    <div>No displayable data available</div>
                </div>
            `;
        }

        /**
         * Get icon for a category
         */
        function getCategoryIcon(category) {
            const icons = {
                'Case Info': 'üìã',
                'Parties': 'üë•',
                'Location': 'üìç',
                'Judgment': '‚öñÔ∏è',
                'Service & Writ': 'üìÑ',
                'Financial': 'üí∞'
            };
            return icons[category] || 'üìé';
        }

        /**
         * Render the event timeline for an entity
         */
        function renderEventTimeline(events) {
            const timeline = document.getElementById('eventTimeline');

            if (!events || events.length === 0) {
                timeline.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 32px; margin-bottom: 12px;">üì≠</div>
                        <div>No events found for this record</div>
                    </div>
                `;
                return;
            }

            // Sort events by timestamp descending (most recent first for timeline view)
            const sortedEvents = [...events].sort((a, b) => b.ts - a.ts);

            let html = '';

            for (const event of sortedEvents) {
                const timestamp = formatToCentralTime(event.ts);
                const meaning = OPERATOR_MEANINGS[event.op] || event.op;

                // Support both 'payload' (new) and 'context' (legacy) field names
                const eventData = event.payload || event.context || {};

                let changesHtml = '';

                if (event.op === 'ALT') {
                    if (eventData.changes) {
                        changesHtml = '<div class="timeline-changes">';
                        for (const [field, change] of Object.entries(eventData.changes)) {
                            const displayField = field.replace(/_/g, ' ');
                            let oldVal, newVal;

                            if (isSensitiveField(field)) {
                                oldVal = '[REDACTED]';
                                newVal = '[REDACTED]';
                            } else {
                                oldVal = change.old !== null && change.old !== undefined ? String(change.old) : '(empty)';
                                newVal = change.new !== null && change.new !== undefined ? String(change.new) : '(empty)';
                            }

                            changesHtml += `
                                <div class="timeline-change">
                                    <span class="timeline-change-field">${escapeHtml(displayField)}:</span>
                                    <span style="color: #991b1b; text-decoration: line-through;">${escapeHtml(oldVal)}</span>
                                    <span>‚Üí</span>
                                    <span style="color: #166534;">${escapeHtml(newVal)}</span>
                                </div>
                            `;
                        }
                        changesHtml += '</div>';
                    } else if (event.target && event.target.field && eventData.new !== undefined) {
                        const field = event.target.field;
                        const displayField = field.replace(/_/g, ' ');
                        let oldVal, newVal;

                        if (isSensitiveField(field)) {
                            oldVal = '[REDACTED]';
                            newVal = '[REDACTED]';
                        } else {
                            oldVal = eventData.old !== null && eventData.old !== undefined ? String(eventData.old) : '(empty)';
                            newVal = eventData.new !== null && eventData.new !== undefined ? String(eventData.new) : '(empty)';
                        }

                        changesHtml = `
                            <div class="timeline-changes">
                                <div class="timeline-change">
                                    <span class="timeline-change-field">${escapeHtml(displayField)}:</span>
                                    <span style="color: #991b1b; text-decoration: line-through;">${escapeHtml(oldVal)}</span>
                                    <span>‚Üí</span>
                                    <span style="color: #166534;">${escapeHtml(newVal)}</span>
                                </div>
                            </div>
                        `;
                    }
                } else if (event.op === 'INS' && eventData.data) {
                    const fieldCount = Object.keys(eventData.data).length;
                    changesHtml = `
                        <div class="timeline-changes">
                            <div class="timeline-change" style="color: #166534;">
                                Record created with ${fieldCount} field${fieldCount !== 1 ? 's' : ''}
                            </div>
                        </div>
                    `;
                }

                html += `
                    <div class="timeline-event op-${event.op}">
                        <div class="timeline-event-header">
                            <span class="timeline-event-op op-${event.op}">${event.op}</span>
                            <span class="timeline-event-time">${timestamp}</span>
                        </div>
                        <div class="timeline-event-desc">${meaning}</div>
                        ${changesHtml}
                    </div>
                `;
            }

            timeline.innerHTML = html;
        }

        /**
         * Handle Escape key to close modal
         */
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('recordModal').classList.contains('active')) {
                closeRecordModal();
            }
        });

        // =============================================================================
        // EVENT LISTENERS
        // =============================================================================

        document.addEventListener('DOMContentLoaded', function() {
            // Set last updated date in Central Time
            document.getElementById('last-updated').textContent = formatDateToCentralTime(new Date(), {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) + ' (CT)';

            // Load initial events
            loadEvents();

            // Filter change handlers
            document.getElementById('opFilter').addEventListener('change', applyFilters);
            document.getElementById('entitySearch').addEventListener('input', debounce(applyFilters, 300));
            document.getElementById('dateStart').addEventListener('change', applyFilters);
            document.getElementById('dateEnd').addEventListener('change', applyFilters);

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadEvents);

            // Pagination buttons
            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderEvents();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });

            document.getElementById('nextBtn').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredEvents.length / EVENTS_PER_PAGE);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderEvents();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
        });

        /**
         * Debounce utility
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
