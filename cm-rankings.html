<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eviction Rankings by Council District - Nashville</title>
    <link rel="icon" type="image/png" href="https://storage.googleapis.com/intelechia-content/im/eviction%20prevention%20logo.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary: #4f46e5;
            --secondary: #06b6d4;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f9fafb;
            min-height: 100vh;
        }

        .unofficial-banner {
            background: #fef3c7;
            border-bottom: 2px solid #f59e0b;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            color: #92400e;
        }

        header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 1.5rem;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
        }

        .subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-links a {
            color: #4f46e5;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .nav-links a:hover {
            text-decoration: underline;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .status-loading {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .data-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .grid-2 {
                grid-template-columns: 350px 1fr;
            }
        }

        /* District Selection */
        .district-selector {
            margin-bottom: 1.5rem;
        }

        .district-selector h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }

        .district-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .district-btn {
            aspect-ratio: 1;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #374151;
        }

        .district-btn:hover {
            border-color: var(--primary);
            background: #f0f0ff;
        }

        .district-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .district-btn.has-data {
            background: #dbeafe;
            border-color: #93c5fd;
        }

        .district-btn.has-data.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .district-btn.no-data {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* CM Info Card */
        .cm-card {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .cm-card .district-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .cm-card .name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .cm-card .contact-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .cm-card .contact-row a {
            color: #93c5fd;
            text-decoration: none;
        }

        .cm-card .contact-row a:hover {
            text-decoration: underline;
        }

        .cm-card .contact-row svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-card .value {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .stat-card .label {
            font-size: 0.75rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Rankings Table */
        .rankings-section h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .data-note {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: normal;
        }

        .rankings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .rankings-table th {
            background: #f9fafb;
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
        }

        .rankings-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
        }

        .rankings-table tr:hover {
            background: #f9fafb;
        }

        .rankings-table tr.selected {
            background: #dbeafe;
        }

        .rankings-table tr.selected:hover {
            background: #bfdbfe;
        }

        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .rank-1 { background: #fef3c7; color: #92400e; }
        .rank-2 { background: #e5e7eb; color: #374151; }
        .rank-3 { background: #fed7aa; color: #9a3412; }
        .rank-other { background: #f3f4f6; color: #6b7280; }

        .cm-name-cell {
            display: flex;
            flex-direction: column;
        }

        .cm-name-cell .name {
            font-weight: 600;
            color: #111827;
        }

        .cm-name-cell .district {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .bar-container {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .bar-fill.high { background: #ef4444; }
        .bar-fill.medium { background: #f59e0b; }
        .bar-fill.low { background: #10b981; }

        .percent-badge {
            font-weight: 600;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .percent-badge.high { background: #fee2e2; color: #991b1b; }
        .percent-badge.medium { background: #fef3c7; color: #92400e; }
        .percent-badge.low { background: #d1fae5; color: #065f46; }

        .table-scroll {
            max-height: 600px;
            overflow-y: auto;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .summary-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .summary-card .value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #111827;
        }

        .summary-card .label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .clickable-row {
            cursor: pointer;
        }

        /* Top Landlords Section */
        .top-landlords {
            margin-top: 1.5rem;
        }

        .top-landlords h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }

        .landlord-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .landlord-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .landlord-item .count {
            font-weight: 600;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .district-grid {
                grid-template-columns: repeat(5, 1fr);
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-btn:hover {
            border-color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .sort-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .disclaimer {
            background: #fff7ed;
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #9a3412;
        }

        /* Demographics Button */
        .demo-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0.6rem 1rem;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .demo-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .demo-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem 1rem;
        }

        .modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .modal {
            background: white;
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px 16px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .modal-header .subtitle {
            font-size: 0.85rem;
            opacity: 0.8;
            color: white;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: background 0.15s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .demo-section {
            margin-bottom: 1.5rem;
        }

        .demo-section:last-child {
            margin-bottom: 0;
        }

        .demo-section-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: #1e3a5f;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        @media (min-width: 500px) {
            .demo-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .demo-item {
            background: #f9fafb;
            border-radius: 8px;
            padding: 0.75rem;
        }

        .demo-item .label {
            font-size: 0.7rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 0.25rem;
        }

        .demo-item .value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #111827;
        }

        .demo-item .value.highlight {
            color: #dc2626;
        }

        .demo-item .value.positive {
            color: #059669;
        }

        .demo-item.full-width {
            grid-column: 1 / -1;
        }

        .modal-source {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            font-size: 0.75rem;
            color: #6b7280;
            text-align: center;
        }

        .modal-source a {
            color: #4f46e5;
        }

        .compare-county {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .compare-county .arrow-up {
            color: #dc2626;
        }

        .compare-county .arrow-down {
            color: #059669;
        }

        /* Modal Tabs */
        .modal-tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }

        .modal-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.15s;
        }

        .modal-tab:hover {
            color: #374151;
        }

        .modal-tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Evictions Table in Modal */
        .evictions-controls {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .evictions-controls label {
            font-size: 0.85rem;
            color: #374151;
            font-weight: 500;
        }

        .evictions-controls select {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
        }

        .evictions-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .evictions-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .evictions-table th {
            background: #f9fafb;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
        }

        .evictions-table td {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
        }

        .evictions-table tr:hover {
            background: #f9fafb;
        }

        .landlord-summary {
            margin-bottom: 1.5rem;
        }

        .landlord-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .landlord-table th {
            background: #f3f4f6;
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .landlord-table th:hover {
            background: #e5e7eb;
        }

        .landlord-table th.sorted-asc::after {
            content: ' ‚ñ≤';
            font-size: 0.7rem;
        }

        .landlord-table th.sorted-desc::after {
            content: ' ‚ñº';
            font-size: 0.7rem;
        }

        .landlord-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }

        .landlord-table tr:hover {
            background: #f9fafb;
        }

        .landlord-table .name-hidden {
            color: #9ca3af;
            font-style: italic;
        }

        /* Login Modal Styles */
        .login-modal {
            position: fixed;
            inset: 0;
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 100;
        }

        .login-modal.hidden {
            display: none;
        }

        .login-modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 400px;
            overflow: hidden;
        }

        .login-modal-header {
            background: #fef2f2;
            border-bottom: 1px solid #fecaca;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .login-modal-header h3 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #111827;
        }

        .login-modal-header .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            line-height: 1;
        }

        .login-modal-header .close-btn:hover {
            color: #111827;
        }

        .login-modal-body {
            padding: 1.5rem;
        }

        .login-notice {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            color: #92400e;
        }

        .login-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .login-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .login-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #dc2626;
        }

        .login-error.hidden {
            display: none;
        }

        .login-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .login-btn:hover {
            background: #b91c1c;
        }

        .header-login-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .header-login-btn.login {
            background: #dc2626;
            color: white;
            border: none;
        }

        .header-login-btn.login:hover {
            background: #b91c1c;
        }

        .header-login-btn.logout {
            background: white;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }

        .header-login-btn.logout:hover {
            border-color: #9ca3af;
            color: #374151;
        }

        .view-toggle-btns {
            display: flex;
            gap: 0.5rem;
        }

        .view-toggle-btns button {
            padding: 0.4rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .view-toggle-btns button.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .view-toggle-btns button:hover:not(.active) {
            border-color: #4f46e5;
        }
    </style>
</head>
<body>
    <!-- Unofficial Notice Banner -->
    <div class="unofficial-banner">
        ‚ö†Ô∏è UNOFFICIAL COMMUNITY PROJECT - Not affiliated with Metro Nashville or any government agency
    </div>

    <header>
        <div class="header-content">
            <div>
                <h1>Eviction Rankings by Council District</h1>
                <p class="subtitle">Eviction filings by Nashville Metro Council district</p>
            </div>
            <div class="nav-links">
                <a href="index.html">‚Üê Back to Eviction Tracker</a>
                <button id="loginBtn" class="header-login-btn login" onclick="showLoginModal()">Login to View Names</button>
                <button id="logoutBtn" class="header-login-btn logout hidden" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="statusMessage" class="status-message status-loading">
            ‚è≥ Loading council member data and eviction records...
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards" id="summaryCards" style="display: none;">
            <div class="summary-card">
                <div class="value" id="totalEvictions">-</div>
                <div class="label">Total Evictions</div>
            </div>
            <div class="summary-card">
                <div class="value" id="districtsWithData">-</div>
                <div class="label">Districts w/ Data</div>
            </div>
            <div class="summary-card">
                <div class="value" id="medianPerDistrict">-</div>
                <div class="label">Median (30 Days)</div>
            </div>
            <div class="summary-card">
                <div class="value" id="lastUpdated">-</div>
                <div class="label">Last Filing</div>
            </div>
        </div>

        <div class="disclaimer" id="disclaimer" style="display: none;">
            <strong>Note:</strong> Rankings are calculated relative to the <span id="dataDistrictCount">0</span> districts with available eviction data.
            Districts without eviction records are excluded from percentage calculations.
        </div>

        <div class="grid-2">
            <!-- Left Column: District Selection + CM Info -->
            <div>
                <div class="data-card">
                    <div class="district-selector">
                        <h3>Select District</h3>
                        <div class="district-grid" id="districtGrid">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- CM Info Card -->
                <div id="cmCard" style="display: none;">
                    <div class="cm-card">
                        <span class="district-badge" id="cmDistrict">District -</span>
                        <div class="name" id="cmName">-</div>
                        <div class="contact-row" id="cmPhone" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                            </svg>
                            <a href="#" id="cmPhoneLink">-</a>
                        </div>
                        <div class="contact-row" id="cmEmail" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            <a href="#" id="cmEmailLink">-</a>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="value" id="cmEvictions">-</div>
                                <div class="label">Eviction Filings</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="cmRank">-</div>
                                <div class="label">District Rank</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="cmPercent">-</div>
                                <div class="label">% of Total</div>
                            </div>
                        </div>

                        <div class="top-landlords" id="topLandlords" style="display: none;">
                            <h4>Top Filers in This District</h4>
                            <div class="landlord-list" id="landlordList">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <button class="demo-btn" onclick="openDemographicsModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            View District Demographics
                        </button>
                    </div>
                </div>

                <!-- Placeholder when no district selected -->
                <div class="data-card" id="noDistrictSelected">
                    <div class="empty-state">
                        <div class="icon">üëÜ</div>
                        <p>Select a district above to see the Council Member and eviction data</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">Blue districts have eviction data available</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Rankings Table -->
            <div class="data-card rankings-section">
                <h2>
                    District Rankings
                    <span class="data-note">(by eviction filings)</span>
                </h2>

                <div class="sort-options">
                    <span style="font-size: 0.85rem; color: #6b7280; margin-right: 0.5rem;">Sort by:</span>
                    <button class="filter-btn active" data-sort="filings" onclick="setSortOrder('filings')">Total Filings</button>
                    <button class="filter-btn" data-sort="percent" onclick="setSortOrder('percent')">% of Total</button>
                    <button class="filter-btn" data-sort="recent" onclick="setSortOrder('recent')">Most Recent</button>
                </div>

                <div class="table-scroll">
                    <table class="rankings-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Representative</th>
                                <th>Filings</th>
                                <th>% of Total</th>
                                <th>Activity</th>
                            </tr>
                        </thead>
                        <tbody id="rankingsBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem;">
                                    <div class="loading-spinner"></div>
                                    <p style="margin-top: 1rem; color: #6b7280;">Loading rankings...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <p style="text-align: center; font-size: 0.75rem; color: #9ca3af; margin-top: 2rem;">
            Council member data from <a href="https://www.nashville.gov/departments/council/council-members" target="_blank" style="color: #6b7280;">Nashville Metro Council</a>
            ‚Ä¢ Eviction data from public court records
            <br>
            District demographics from <a href="https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf?ct=1706286236" target="_blank" style="color: #6b7280;">Metropolitan Social Services Know Your Community 2023</a>
            (<a href="district-data.json" target="_blank" style="color: #6b7280;">JSON data</a>)
        </p>
    </div>

    <!-- Demographics Modal -->
    <div class="modal-overlay" id="demographicsModal" onclick="closeDemographicsModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <button class="modal-close" onclick="closeDemographicsModal()">&times;</button>
                <h2 id="modalTitle">District Demographics</h2>
                <p class="subtitle" id="modalSubtitle">Community Profile</p>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Council member data is loaded from local JSON file
        // Eviction data is loaded from localStorage or IndexedDB (set by main tracker page)

        let councilMembers = {};
        let evictionData = [];
        let districtStats = {};
        let selectedDistrict = null;
        let currentSort = 'filings';
        let districtsWithData = [];
        let districtDemographics = null;

        // IndexedDB helper for loading large data (mirrors index.html implementation)
        const evictionDB = {
            DB_NAME: 'evictionTrackerDB',
            DB_VERSION: 1,
            STORE_NAME: 'evictionData',

            async open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.STORE_NAME)) {
                            db.createObjectStore(this.STORE_NAME, { keyPath: 'id' });
                        }
                    };
                });
            },

            async load() {
                try {
                    const db = await this.open();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(this.STORE_NAME, 'readonly');
                        const store = tx.objectStore(this.STORE_NAME);
                        const request = store.get('evictionData');
                        request.onsuccess = () => {
                            db.close();
                            resolve(request.result || null);
                        };
                        request.onerror = () => {
                            db.close();
                            reject(request.error);
                        };
                    });
                } catch (e) {
                    console.error('IndexedDB load failed:', e);
                    return null;
                }
            }
        };

        // Decompress eviction data from compressed format
        function decompressEvictionData(compressed) {
            return compressed.map(r => ({
                Case_Number: r.id,
                District: r.d,
                File_Date: r.fd,
                Plaintiff_Petitioner: r.p
            }));
        }

        // Load district demographic data
        async function loadDistrictDemographics() {
            try {
                const response = await fetch('district-data.json');
                if (response.ok) {
                    districtDemographics = await response.json();
                }
            } catch (error) {
                console.error('Error loading district demographics:', error);
            }
        }

        // Load demographics on page load
        loadDistrictDemographics();

        let currentModalTab = 'demographics';
        let evictionsViewMode = 'landlords'; // 'landlords' or 'all'

        function openDemographicsModal() {
            if (!selectedDistrict) return;

            const modal = document.getElementById('demographicsModal');
            const cm = councilMembers[selectedDistrict];
            const stats = districtStats[selectedDistrict];
            const demo = districtDemographics?.districts?.[selectedDistrict];
            const county = districtDemographics?.county_totals;

            document.getElementById('modalTitle').textContent = `District ${selectedDistrict}`;
            document.getElementById('modalSubtitle').textContent = cm?.name ? `Rep. ${cm.name}` : 'Community Profile';

            // Build tabs
            let html = `
                <div class="modal-tabs">
                    <button class="modal-tab active" onclick="switchModalTab('demographics')">Demographics</button>
                    <button class="modal-tab" onclick="switchModalTab('evictions')">Evictions (${stats?.total || 0})</button>
                </div>
                <div id="demographicsTab" class="tab-content active">
            `;

            // Eviction Context Section - Key metric at the top
            const evictionCount = stats?.total || 0;
            const eviction30DayAvg = stats?.avg30Day || 0;
            const dataRangeDays = stats?.dataRangeDays || 0;
            const population = demo?.population || 0;
            // Pro-rate to full year if we have partial year data
            const annualizedCount = Math.round(evictionCount * globalDataRange.annualizationFactor);
            const isProRated = globalDataRange.days > 0 && globalDataRange.days < 365;
            const evictionRate = population > 0 ? ((annualizedCount / population) * 1000).toFixed(2) : 'N/A';
            const povertyRate = demo?.poverty?.pct_total_poverty || 0;
            const medianIncome = demo?.income?.median_household_income || 0;
            const countyMedianIncome = county?.median_household_income || 65348;
            const countyPovertyRate = county?.poverty_rate_percent || 15.0;
            const renterCostBurden = demo?.housing?.pct_renter_cost_burdened_35plus || 0;

            // Determine label based on data range
            const filingLabel = dataRangeDays <= 30
                ? `Eviction Filings (${dataRangeDays} day${dataRangeDays !== 1 ? 's' : ''})`
                : 'Eviction Filings (30-day avg)';

            // Format date range info
            const dateRangeInfo = globalDataRange.earliest && globalDataRange.latest
                ? `${globalDataRange.earliest.toLocaleDateString()} - ${globalDataRange.latest.toLocaleDateString()} (${globalDataRange.days} days)`
                : '';

            html += `
                <div class="demo-section">
                    <div class="demo-section-title">Eviction Context</div>
                    ${dateRangeInfo ? `<div class="demo-section-subtitle" style="font-size: 11px; color: #666; margin-bottom: 8px;">Data: ${dateRangeInfo}</div>` : ''}
                    <div class="demo-grid">
                        <div class="demo-item">
                            <div class="label">${filingLabel}</div>
                            <div class="value highlight">${eviction30DayAvg.toLocaleString()}</div>
                        </div>
                        <div class="demo-item">
                            <div class="label">Population</div>
                            <div class="value">${population.toLocaleString()}</div>
                        </div>
                        <div class="demo-item">
                            <div class="label">Evictions per 1,000${isProRated ? ' (annualized)' : ''}</div>
                            <div class="value highlight">${evictionRate}</div>
                        </div>
                        <div class="demo-item">
                            <div class="label">Poverty Rate</div>
                            <div class="value ${povertyRate > countyPovertyRate ? 'highlight' : ''}">${povertyRate}%</div>
                            <div class="compare-county">
                                ${povertyRate > countyPovertyRate
                                    ? `<span class="arrow-up">+${(povertyRate - countyPovertyRate).toFixed(1)}%</span> above county avg`
                                    : `<span class="arrow-down">${(countyPovertyRate - povertyRate).toFixed(1)}%</span> below county avg`}
                            </div>
                        </div>
                        <div class="demo-item">
                            <div class="label">Median Household Income</div>
                            <div class="value ${medianIncome < countyMedianIncome ? 'highlight' : 'positive'}">$${medianIncome.toLocaleString()}</div>
                            <div class="compare-county">
                                ${medianIncome < countyMedianIncome
                                    ? `<span class="arrow-up">$${(countyMedianIncome - medianIncome).toLocaleString()}</span> below county avg`
                                    : `<span class="arrow-down">$${(medianIncome - countyMedianIncome).toLocaleString()}</span> above county avg`}
                            </div>
                        </div>
                        <div class="demo-item">
                            <div class="label">Renters Cost-Burdened (35%+)</div>
                            <div class="value ${renterCostBurden > 35 ? 'highlight' : ''}">${renterCostBurden}%</div>
                        </div>
                    </div>
                </div>
            `;

            if (demo) {
                // Housing Section
                html += `
                    <div class="demo-section">
                        <div class="demo-section-title">Housing</div>
                        <div class="demo-grid">
                            <div class="demo-item">
                                <div class="label">Housing Units</div>
                                <div class="value">${demo.housing?.total_housing_units?.toLocaleString() || '-'}</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Occupied</div>
                                <div class="value">${demo.housing?.pct_occupied || '-'}%</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Median Home Value</div>
                                <div class="value">$${demo.housing?.median_owner_value?.toLocaleString() || '-'}</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Median Rent</div>
                                <div class="value">$${demo.housing?.median_monthly_rent?.toLocaleString() || '-'}</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Owners Cost-Burdened</div>
                                <div class="value">${demo.housing?.pct_owner_cost_burdened_35plus || '-'}%</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Renters Cost-Burdened</div>
                                <div class="value ${(demo.housing?.pct_renter_cost_burdened_35plus || 0) > 35 ? 'highlight' : ''}">${demo.housing?.pct_renter_cost_burdened_35plus || '-'}%</div>
                            </div>
                        </div>
                    </div>
                `;

                // Demographics Section
                html += `
                    <div class="demo-section">
                        <div class="demo-section-title">Demographics</div>
                        <div class="demo-grid">
                            <div class="demo-item">
                                <div class="label">Median Age</div>
                                <div class="value">${demo.median_age || '-'}</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Under 18</div>
                                <div class="value">${demo.age?.pct_under_18 || '-'}%</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">65 and Over</div>
                                <div class="value">${demo.age?.pct_65_and_over || '-'}%</div>
                            </div>
                        </div>
                    </div>
                `;

                // Race/Ethnicity
                html += `
                    <div class="demo-section">
                        <div class="demo-section-title">Race & Ethnicity</div>
                        <div class="demo-grid">
                            <div class="demo-item">
                                <div class="label">White</div>
                                <div class="value">${demo.race_ethnicity?.pct_white || '-'}%</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Black</div>
                                <div class="value">${demo.race_ethnicity?.pct_black || '-'}%</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Hispanic</div>
                                <div class="value">${demo.race_ethnicity?.pct_hispanic || '-'}%</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Asian</div>
                                <div class="value">${demo.race_ethnicity?.pct_asian || '-'}%</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Two or More</div>
                                <div class="value">${demo.race_ethnicity?.pct_two_or_more || '-'}%</div>
                            </div>
                        </div>
                    </div>
                `;

                // Poverty Section
                html += `
                    <div class="demo-section">
                        <div class="demo-section-title">Poverty Status</div>
                        <div class="demo-grid">
                            <div class="demo-item">
                                <div class="label">Total Poverty Rate</div>
                                <div class="value ${(demo.poverty?.pct_total_poverty || 0) > countyPovertyRate ? 'highlight' : ''}">${demo.poverty?.pct_total_poverty || '-'}%</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Child Poverty</div>
                                <div class="value ${(demo.poverty?.pct_child_poverty || 0) > 20 ? 'highlight' : ''}">${demo.poverty?.pct_child_poverty || '-'}%</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Senior Poverty</div>
                                <div class="value">${demo.poverty?.pct_senior_poverty || '-'}%</div>
                            </div>
                        </div>
                    </div>
                `;

                // Employment
                html += `
                    <div class="demo-section">
                        <div class="demo-section-title">Employment</div>
                        <div class="demo-grid">
                            <div class="demo-item">
                                <div class="label">Labor Force Participation</div>
                                <div class="value">${demo.employment?.labor_force_participation_rate || '-'}%</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Unemployment Rate</div>
                                <div class="value ${(demo.employment?.unemployment_rate || 0) > 6 ? 'highlight' : ''}">${demo.employment?.unemployment_rate || '-'}%</div>
                            </div>
                        </div>
                    </div>
                `;

                // Education
                html += `
                    <div class="demo-section">
                        <div class="demo-section-title">Educational Attainment (25+)</div>
                        <div class="demo-grid">
                            <div class="demo-item">
                                <div class="label">Less Than High School</div>
                                <div class="value">${demo.education?.pct_less_than_hs || '-'}%</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">High School Graduate</div>
                                <div class="value">${demo.education?.pct_hs_graduate || '-'}%</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Bachelor's Degree</div>
                                <div class="value">${demo.education?.pct_bachelors || '-'}%</div>
                            </div>
                            <div class="demo-item">
                                <div class="label">Graduate/Professional</div>
                                <div class="value">${demo.education?.pct_graduate_professional || '-'}%</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="demo-section">
                        <p style="color: #6b7280; text-align: center;">Demographic data not available for this district.</p>
                    </div>
                `;
            }

            // Source
            html += `
                <div class="modal-source">
                    Source: <a href="https://www.nashville.gov/sites/default/files/2024-01/Know-Your-Community-December-2023.pdf?ct=1706286236" target="_blank">Metropolitan Social Services Know Your Community 2023</a>
                    <br>Data: American Community Survey 2017-2021 5-Year Estimates
                </div>
            `;

            // Close demographics tab, open evictions tab
            html += `</div><div id="evictionsTab" class="tab-content">`;

            // Build evictions tab content
            html += buildEvictionsTab(selectedDistrict, stats);

            // Close evictions tab
            html += `</div>`;

            document.getElementById('modalBody').innerHTML = html;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            currentModalTab = 'demographics';
        }

        function buildEvictionsTab(district, stats) {
            // Get evictions for this district
            // Must match the same field priority as stats calculation
            const districtEvictions = evictionData.filter(record => {
                let recDistrict = null;
                // Check normalized District field first (from localStorage/decompressed data)
                if (record.District && typeof record.District === 'number' && record.District > 0) {
                    recDistrict = record.District;
                }
                // Fallback to raw field names
                else if (record.council_district_number && typeof record.council_district_number === 'number') {
                    recDistrict = record.council_district_number;
                } else if (record.council_district) {
                    const match = String(record.council_district).match(/(\d+)/);
                    if (match) recDistrict = parseInt(match[1]);
                }
                return recDistrict === district;
            });

            // Group by landlord
            const landlordGroups = {};
            districtEvictions.forEach(ev => {
                const landlord = ev.Plaintiff_Petitioner || ev.plaintiff_petitioner || ev.Plaintiff || 'Unknown';
                if (!landlordGroups[landlord]) {
                    landlordGroups[landlord] = { name: landlord, evictions: [] };
                }
                landlordGroups[landlord].evictions.push(ev);
            });

            // Sort landlords by total evictions
            const sortedLandlords = Object.values(landlordGroups).sort((a, b) => b.evictions.length - a.evictions.length);

            let html = `
                <div class="evictions-controls">
                    <label>View:</label>
                    <div class="view-toggle-btns">
                        <button class="active" onclick="setEvictionsView('landlords', ${district})">By Landlord</button>
                        <button onclick="setEvictionsView('all', ${district})">All Filings</button>
                    </div>
                </div>
                <div id="evictionsContent">
            `;

            // By Landlord view (default) - now as a sortable table
            html += `<div id="landlordView">`;
            if (sortedLandlords.length === 0) {
                html += `<p style="color: #6b7280; text-align: center; padding: 2rem;">No eviction filings in this district.</p>`;
            } else {
                html += `
                    <div class="landlord-summary">
                        <table class="landlord-table" id="landlordTable">
                            <thead>
                                <tr>
                                    <th data-sort="name" onclick="sortLandlordTable('name', ${district})">Landlord/Plaintiff</th>
                                    <th data-sort="filings" class="sorted-desc" onclick="sortLandlordTable('filings', ${district})">Filings</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Store data for sorting
                window.landlordTableData = sortedLandlords;
                window.currentLandlordSort = { field: 'filings', direction: 'desc' };

                sortedLandlords.slice(0, 50).forEach(landlord => {
                    const displayName = getDisplayName(landlord.name);
                    const nameClass = isLoggedIn ? '' : 'name-hidden';
                    html += `
                        <tr>
                            <td class="${nameClass}">${truncateLandlord(displayName, 40)}</td>
                            <td><strong>${landlord.evictions.length}</strong></td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                if (sortedLandlords.length > 50) {
                    html += `<p style="font-size: 0.8rem; color: #6b7280; text-align: center; margin-top: 0.5rem;">Showing top 50 of ${sortedLandlords.length} landlords</p>`;
                }
                if (!isLoggedIn) {
                    html += `<p style="font-size: 0.8rem; color: #9ca3af; text-align: center; margin-top: 0.5rem; font-style: italic;"><a href="#" onclick="showLoginModal(); return false;" style="color: #4f46e5;">Login</a> to view landlord names</p>`;
                }
            }
            html += `</div>`;

            // All filings view (hidden initially)
            html += `<div id="allFilingsView" style="display: none;">`;
            if (districtEvictions.length === 0) {
                html += `<p style="color: #6b7280; text-align: center; padding: 2rem;">No eviction filings in this district.</p>`;
            } else {
                html += `
                    <div class="evictions-table-container">
                        <table class="evictions-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Case #</th>
                                    <th>Landlord/Plaintiff</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                // Sort by date descending
                const sortedEvictions = [...districtEvictions].sort((a, b) => {
                    const dateA = new Date(a.File_Date || a.file_date || 0);
                    const dateB = new Date(b.File_Date || b.file_date || 0);
                    return dateB - dateA;
                });
                sortedEvictions.slice(0, 100).forEach(ev => {
                    const fileDate = ev.File_Date || ev.file_date;
                    const dateStr = fileDate ? new Date(fileDate).toLocaleDateString() : '-';
                    const caseNum = ev.Case_Number || ev.case_number || ev.CaseNumber || '-';
                    const plaintiff = ev.Plaintiff_Petitioner || ev.plaintiff_petitioner || ev.Plaintiff || '-';
                    const displayPlaintiff = getDisplayName(plaintiff);
                    const nameClass = isLoggedIn ? '' : 'name-hidden';
                    html += `
                        <tr>
                            <td>${dateStr}</td>
                            <td>${caseNum}</td>
                            <td class="${nameClass}">${truncateLandlord(displayPlaintiff, 35)}</td>
                        </tr>
                    `;
                });
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                if (districtEvictions.length > 100) {
                    html += `<p style="font-size: 0.8rem; color: #6b7280; text-align: center; margin-top: 0.5rem;">Showing 100 of ${districtEvictions.length} filings</p>`;
                }
                if (!isLoggedIn) {
                    html += `<p style="font-size: 0.8rem; color: #9ca3af; text-align: center; margin-top: 0.5rem; font-style: italic;"><a href="#" onclick="showLoginModal(); return false;" style="color: #4f46e5;">Login</a> to view landlord names</p>`;
                }
            }
            html += `</div>`;

            html += `</div>`; // Close evictionsContent

            return html;
        }

        function truncateLandlord(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function switchModalTab(tab) {
            currentModalTab = tab;
            document.querySelectorAll('.modal-tab').forEach(t => {
                t.classList.toggle('active', t.textContent.toLowerCase().includes(tab));
            });
            document.getElementById('demographicsTab').classList.toggle('active', tab === 'demographics');
            document.getElementById('evictionsTab').classList.toggle('active', tab === 'evictions');
        }

        function setEvictionsView(view, district) {
            evictionsViewMode = view;
            document.querySelectorAll('.view-toggle-btns button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(view === 'landlords' ? 'landlord' : 'all'));
            });
            document.getElementById('landlordView').style.display = view === 'landlords' ? 'block' : 'none';
            document.getElementById('allFilingsView').style.display = view === 'all' ? 'block' : 'none';
        }

        function closeDemographicsModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('demographicsModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDemographicsModal();
            }
        });

        async function loadAllData() {
            const statusEl = document.getElementById('statusMessage');
            console.group('üîÑ CM Rankings - Loading All Data');
            console.log('Timestamp:', new Date().toISOString());

            try {
                // Load council member data from local JSON file
                console.log('üì° Fetching council-members.json...');
                const cmResponse = await fetch('council-members.json');
                console.log('üì° Council Members Response:', {
                    status: cmResponse.status,
                    statusText: cmResponse.statusText,
                    ok: cmResponse.ok
                });
                if (!cmResponse.ok) throw new Error(`Failed to load council member data: ${cmResponse.status} ${cmResponse.statusText}`);
                const cmData = await cmResponse.json();
                console.log('‚úÖ Council members loaded:', {
                    hasDistricts: !!cmData.districts,
                    districtCount: Object.keys(cmData.districts || {}).length
                });

                // Load eviction data from cache (localStorage or IndexedDB, set by main tracker page)
                console.log('üíæ Checking cache for eviction data...');
                let evictions = null;
                const storageType = localStorage.getItem('evictionDataStorage');
                const storedTimestamp = localStorage.getItem('evictionDataTimestamp');

                console.log('üíæ Storage info:', {
                    storageType: storageType || 'unknown',
                    timestamp: storedTimestamp ? new Date(parseInt(storedTimestamp)).toISOString() : 'none',
                    ageMinutes: storedTimestamp ? Math.round((Date.now() - parseInt(storedTimestamp)) / 60000) : 'N/A'
                });

                // Try compressed localStorage first (new format)
                const compressedData = localStorage.getItem('evictionDataCompressed');
                if (compressedData) {
                    try {
                        const compressed = JSON.parse(compressedData);
                        evictions = decompressEvictionData(compressed);
                        console.log('‚úÖ Loaded compressed eviction data from localStorage:', {
                            recordCount: evictions?.length || 0,
                            sampleRecord: evictions?.[0]
                        });
                    } catch (e) {
                        console.error('‚ùå Failed to parse compressed localStorage data:', e.message);
                    }
                }

                // Try legacy uncompressed format
                if (!evictions) {
                    const legacyData = localStorage.getItem('evictionData');
                    if (legacyData) {
                        try {
                            evictions = JSON.parse(legacyData);
                            console.log('‚úÖ Loaded legacy eviction data from localStorage:', {
                                recordCount: evictions?.length || 0
                            });
                        } catch (e) {
                            console.error('‚ùå Failed to parse legacy localStorage data:', e.message);
                        }
                    }
                }

                // Try IndexedDB if localStorage didn't have data
                if (!evictions && storageType === 'indexedDB') {
                    console.log('üíæ Checking IndexedDB...');
                    const idbResult = await evictionDB.load();
                    if (idbResult?.data) {
                        evictions = decompressEvictionData(idbResult.data);
                        console.log('‚úÖ Loaded eviction data from IndexedDB:', {
                            recordCount: evictions?.length || 0
                        });
                    }
                }

                // If no cached data available, show message to visit main tracker first
                if (!evictions || evictions.length === 0) {
                    console.warn('‚ö†Ô∏è No eviction data available in cache');
                    console.groupEnd();
                    statusEl.innerHTML = '‚ö†Ô∏è No eviction data cached. Please <a href="index.html" style="color: #1e40af; text-decoration: underline;">visit the main Eviction Tracker</a> first to load the data.';
                    statusEl.className = 'status-message status-error';

                    // Still load council member data and show empty state
                    processCouncilMembersFromLocal(cmData);
                    generateDistrictButtons();
                    updateRankingsTable();
                    return;
                }

                // Process council member data from local JSON format
                processCouncilMembersFromLocal(cmData);

                // Process eviction data
                console.log('üîÑ Processing eviction data...');
                processEvictionData(evictions);

                // Log district stats
                console.log('üìä District stats computed:', districtStats);
                console.log('üìà Districts with data:', Object.keys(districtStats).length);

                // Update UI
                const recordsWithDistrict = Object.values(districtStats).reduce((sum, d) => sum + d.total, 0);
                console.log('‚úÖ Processing complete:', {
                    councilMembers: Object.keys(councilMembers).length,
                    totalEvictions: evictionData.length,
                    recordsWithDistrict
                });
                console.groupEnd();

                statusEl.textContent = `‚úì Loaded ${Object.keys(councilMembers).length} council members and ${evictionData.length} eviction records (${recordsWithDistrict} with district data)`;
                statusEl.className = 'status-message status-success';

                // Generate UI
                generateDistrictButtons();
                updateRankingsTable();
                updateSummaryCards();

                document.getElementById('summaryCards').style.display = 'grid';
                document.getElementById('disclaimer').style.display = 'block';

            } catch (error) {
                console.groupEnd();
                console.error('‚ùå Error loading data:', {
                    message: error.message,
                    name: error.name,
                    stack: error.stack
                });
                let errorMsg = error.message;
                statusEl.textContent = `‚úó Error: ${errorMsg}`;
                statusEl.className = 'status-message status-error';

                // Try to load fallback CM data so at least district buttons work
                loadFallbackCMData();
            }
        }

        function processCouncilMembersFromLocal(data) {
            // Process district council members from local JSON format
            if (data.districts) {
                Object.entries(data.districts).forEach(([district, member]) => {
                    const districtNum = parseInt(district);
                    if (!isNaN(districtNum) && districtNum >= 1 && districtNum <= 35) {
                        councilMembers[districtNum] = {
                            district: districtNum,
                            name: member.name,
                            phone: member.phone || '',
                            email: member.email || '',
                            title: `District ${districtNum}`
                        };
                    }
                });
            }
        }

        function processCouncilMembers(data) {
            data.forEach(record => {
                const district = record.district || record.District;
                if (!district) return;

                const member = {
                    district: district,
                    firstName: record.first_name || record.FirstName || record.councilrepfirst || '',
                    lastName: record.last_name || record.LastName || record.councilreplast || '',
                    phone: record.phone || record.Phone || '',
                    email: record.email || record.Email || '',
                    positionType: record.position_type || record.rep_type || 'District'
                };

                member.name = `${member.firstName} ${member.lastName}`.trim();
                member.title = member.positionType?.toLowerCase().includes('at-large')
                    ? `At-Large ${member.district}`
                    : `District ${member.district}`;

                // Store by district number
                const districtNum = parseInt(district);
                if (!isNaN(districtNum) && districtNum >= 1 && districtNum <= 35) {
                    councilMembers[districtNum] = member;
                }
            });
        }

        // Deduplicate records by docket number, keeping the most recent by File_Date
        function dedupeByDocketNumber(records) {
            const seen = new Map();

            for (const record of records) {
                const docketNumber = (record.Docket_Number || record.Case_Number || '').trim();

                // Skip records with empty docket numbers
                if (!docketNumber) {
                    continue;
                }

                if (!seen.has(docketNumber)) {
                    seen.set(docketNumber, record);
                } else {
                    // Keep the record with the more recent File_Date
                    const existing = seen.get(docketNumber);
                    const existingDate = new Date(existing.File_Date || existing.file_date || 0);
                    const currentDate = new Date(record.File_Date || record.file_date || 0);

                    if (currentDate > existingDate) {
                        seen.set(docketNumber, record);
                    }
                }
            }

            return Array.from(seen.values());
        }

        // Global date range tracking for 30-day average calculation and annualization
        let globalDataRange = { earliest: null, latest: null, days: 0, annualizationFactor: 1 };

        function processEvictionData(data) {
            console.group('üìä Processing Eviction Data for Districts');
            console.log('üì• Input records:', data?.length || 0);

            // Data from localStorage is already deduped, but dedupe again just in case
            evictionData = dedupeByDocketNumber(data);
            console.log('üî¢ After dedup:', evictionData.length);

            districtStats = {};
            globalDataRange = { earliest: null, latest: null, days: 0, annualizationFactor: 1 };

            // First pass: determine global date range
            evictionData.forEach(record => {
                const fileDate = record.File_Date || record.file_date;
                if (fileDate) {
                    const date = new Date(fileDate);
                    if (!globalDataRange.earliest || date < globalDataRange.earliest) {
                        globalDataRange.earliest = date;
                    }
                    if (!globalDataRange.latest || date > globalDataRange.latest) {
                        globalDataRange.latest = date;
                    }
                }
            });

            // Calculate the number of days in our data range and annualization factor
            const dataRangeDays = globalDataRange.earliest && globalDataRange.latest
                ? Math.ceil((globalDataRange.latest - globalDataRange.earliest) / (1000 * 60 * 60 * 24)) + 1
                : 0;
            globalDataRange.days = dataRangeDays;
            globalDataRange.annualizationFactor = dataRangeDays > 0 ? 365 / dataRangeDays : 1;

            console.log('üìÖ Date range:', {
                earliest: globalDataRange.earliest?.toISOString(),
                latest: globalDataRange.latest?.toISOString(),
                days: globalDataRange.days,
                annualizationFactor: globalDataRange.annualizationFactor.toFixed(2)
            });

            // Track district field sources for debugging
            let districtSources = { District: 0, council_district_number: 0, council_district: 0, none: 0 };

            // Calculate stats per district (only for records with valid district data)
            evictionData.forEach(record => {
                let district = null;

                // Check normalized District field first (from localStorage data)
                if (record.District && typeof record.District === 'number' && record.District > 0) {
                    district = record.District;
                    districtSources.District++;
                }
                // Fallback to raw field names
                else if (record.council_district_number && typeof record.council_district_number === 'number' && record.council_district_number > 0) {
                    district = record.council_district_number;
                    districtSources.council_district_number++;
                } else if (record.council_district) {
                    const match = String(record.council_district).match(/(\d+)/);
                    if (match) {
                        district = parseInt(match[1]);
                        districtSources.council_district++;
                    }
                }

                if (!district) {
                    districtSources.none++;
                }

                // Skip district stats for records without valid district, but don't filter them out
                if (!district || district < 1 || district > 35) {
                    return; // Skip for district stats only
                }

                if (!districtStats[district]) {
                    districtStats[district] = {
                        district: district,
                        total: 0,
                        lastFiling: null,
                        earliestFiling: null,
                        landlords: {}
                    };
                }

                districtStats[district].total++;

                // Track filing date
                const fileDate = record.File_Date || record.file_date;
                if (fileDate) {
                    const date = new Date(fileDate);
                    if (!districtStats[district].lastFiling || date > districtStats[district].lastFiling) {
                        districtStats[district].lastFiling = date;
                    }
                    if (!districtStats[district].earliestFiling || date < districtStats[district].earliestFiling) {
                        districtStats[district].earliestFiling = date;
                    }
                }

                // Track landlords (use normalized Plaintiff field from localStorage)
                const plaintiff = record.Plaintiff || record.Plaintiff_Petitioner || record.plaintiff_petitioner || '';
                if (plaintiff) {
                    districtStats[district].landlords[plaintiff] = (districtStats[district].landlords[plaintiff] || 0) + 1;
                }
            });

            // Calculate 30-day prorated value for each district
            Object.values(districtStats).forEach(stats => {
                const districtDays = stats.earliestFiling && stats.lastFiling
                    ? Math.ceil((stats.lastFiling - stats.earliestFiling) / (1000 * 60 * 60 * 24)) + 1
                    : 0;

                // Prorate to 30 days based on actual data period
                stats.avg30Day = districtDays > 0
                    ? Math.round((stats.total / districtDays) * 30)
                    : stats.total;
                stats.dataRangeDays = districtDays;
            });

            // Get list of districts with data
            districtsWithData = Object.keys(districtStats).map(d => parseInt(d)).sort((a, b) => a - b);

            document.getElementById('dataDistrictCount').textContent = districtsWithData.length;

            // Log final district processing stats
            console.log('üè∑Ô∏è District field sources:', districtSources);
            console.log('üìä Final district stats:', {
                districtsWithData: districtsWithData.length,
                districtsList: districtsWithData,
                totalRecordsAssigned: Object.values(districtStats).reduce((s, d) => s + d.total, 0)
            });
            console.groupEnd();
        }

        function generateDistrictButtons() {
            const grid = document.getElementById('districtGrid');
            grid.innerHTML = '';

            for (let i = 1; i <= 35; i++) {
                const btn = document.createElement('button');
                btn.className = 'district-btn';
                btn.textContent = i;
                btn.dataset.district = i;

                if (districtStats[i]) {
                    btn.classList.add('has-data');
                    btn.title = `District ${i}: ${districtStats[i].total} filings`;
                } else {
                    btn.classList.add('no-data');
                    btn.title = `District ${i}: No eviction data`;
                }

                btn.onclick = () => selectDistrict(i);
                grid.appendChild(btn);
            }
        }

        function selectDistrict(district) {
            selectedDistrict = district;

            // Update button states
            document.querySelectorAll('.district-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.district) === district);
            });

            // Update CM card
            const cm = councilMembers[district];
            const stats = districtStats[district];

            if (cm || stats) {
                document.getElementById('noDistrictSelected').style.display = 'none';
                document.getElementById('cmCard').style.display = 'block';

                document.getElementById('cmDistrict').textContent = `District ${district}`;
                document.getElementById('cmName').textContent = cm?.name || 'Council Member Info Not Available';

                if (cm?.phone) {
                    document.getElementById('cmPhone').style.display = 'flex';
                    document.getElementById('cmPhoneLink').textContent = cm.phone;
                    document.getElementById('cmPhoneLink').href = `tel:${cm.phone}`;
                } else {
                    document.getElementById('cmPhone').style.display = 'none';
                }

                if (cm?.email) {
                    document.getElementById('cmEmail').style.display = 'flex';
                    document.getElementById('cmEmailLink').textContent = cm.email;
                    document.getElementById('cmEmailLink').href = `mailto:${cm.email}`;
                } else {
                    document.getElementById('cmEmail').style.display = 'none';
                }

                // Stats
                const totalFilings = stats?.total || 0;
                const totalAllDistricts = Object.values(districtStats).reduce((sum, d) => sum + d.total, 0);
                const percent = totalAllDistricts > 0 ? ((totalFilings / totalAllDistricts) * 100).toFixed(1) : 0;

                document.getElementById('cmEvictions').textContent = totalFilings.toLocaleString();
                document.getElementById('cmPercent').textContent = `${percent}%`;

                // Calculate rank (only among districts with data)
                const sortedDistricts = Object.values(districtStats).sort((a, b) => b.total - a.total);
                const rank = sortedDistricts.findIndex(d => d.district === district) + 1;
                document.getElementById('cmRank').textContent = stats ? `#${rank} of ${districtsWithData.length}` : 'N/A';

                // Top landlords
                if (stats && Object.keys(stats.landlords).length > 0) {
                    document.getElementById('topLandlords').style.display = 'block';
                    const topLandlords = Object.entries(stats.landlords)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);

                    document.getElementById('landlordList').innerHTML = topLandlords.map(([name, count]) => `
                        <div class="landlord-item">
                            <span class="name">${truncate(name, 30)}</span>
                            <span class="count">${count}</span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('topLandlords').style.display = 'none';
                }
            } else {
                document.getElementById('cmCard').style.display = 'none';
                document.getElementById('noDistrictSelected').style.display = 'block';
            }

            // Highlight in table
            document.querySelectorAll('.rankings-table tbody tr').forEach(row => {
                row.classList.toggle('selected', row.dataset.district === String(district));
            });

            // Open the district details popup
            openDemographicsModal();
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function calculateMedian(values) {
            if (!values || values.length === 0) return 0;
            const sorted = [...values].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 !== 0
                ? sorted[mid]
                : Math.round((sorted[mid - 1] + sorted[mid]) / 2);
        }

        function updateRankingsTable() {
            const tbody = document.getElementById('rankingsBody');
            const totalFilings = Object.values(districtStats).reduce((sum, d) => sum + d.total, 0);

            if (districtsWithData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="icon">üìä</div>
                            <p>No eviction data available</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort districts based on current sort order
            let sortedData = Object.values(districtStats);

            switch (currentSort) {
                case 'filings':
                    sortedData.sort((a, b) => b.total - a.total);
                    break;
                case 'percent':
                    sortedData.sort((a, b) => b.total - a.total);
                    break;
                case 'recent':
                    sortedData.sort((a, b) => {
                        if (!a.lastFiling) return 1;
                        if (!b.lastFiling) return -1;
                        return b.lastFiling - a.lastFiling;
                    });
                    break;
            }

            const maxFilings = Math.max(...sortedData.map(d => d.total));

            tbody.innerHTML = sortedData.map((stats, idx) => {
                const rank = idx + 1;
                const cm = councilMembers[stats.district];
                const percent = totalFilings > 0 ? ((stats.total / totalFilings) * 100).toFixed(1) : 0;
                const barWidth = (stats.total / maxFilings) * 100;

                let rankClass = 'rank-other';
                if (rank === 1) rankClass = 'rank-1';
                else if (rank === 2) rankClass = 'rank-2';
                else if (rank === 3) rankClass = 'rank-3';

                let percentClass = 'low';
                if (percent > 10) percentClass = 'high';
                else if (percent > 5) percentClass = 'medium';

                let barClass = 'low';
                if (barWidth > 75) barClass = 'high';
                else if (barWidth > 40) barClass = 'medium';

                const isSelected = selectedDistrict === stats.district;

                return `
                    <tr class="clickable-row ${isSelected ? 'selected' : ''}" data-district="${stats.district}" onclick="selectDistrict(${stats.district})">
                        <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                        <td>
                            <div class="cm-name-cell">
                                <span class="name">${cm?.name || 'Unknown'}</span>
                                <span class="district">District ${stats.district}</span>
                            </div>
                        </td>
                        <td><strong>${stats.total.toLocaleString()}</strong></td>
                        <td><span class="percent-badge ${percentClass}">${percent}%</span></td>
                        <td>
                            <div class="bar-container">
                                <div class="bar-fill ${barClass}" style="width: ${barWidth}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateSummaryCards() {
            // Total from ALL eviction records
            const totalAllRecords = evictionData.length;

            // Calculate median of 30-day prorated values across districts
            const thirtyDayValues = Object.values(districtStats).map(d => d.avg30Day || 0);
            const medianPerDistrict = calculateMedian(thirtyDayValues);

            document.getElementById('totalEvictions').textContent = totalAllRecords.toLocaleString();
            document.getElementById('districtsWithData').textContent = `${districtsWithData.length}/35`;
            document.getElementById('medianPerDistrict').textContent = medianPerDistrict.toLocaleString();

            // Find most recent filing from all data
            let mostRecent = null;
            evictionData.forEach(record => {
                const fileDate = record.File_Date || record.file_date;
                if (fileDate) {
                    const date = new Date(fileDate);
                    if (!mostRecent || date > mostRecent) {
                        mostRecent = date;
                    }
                }
            });

            if (mostRecent) {
                document.getElementById('lastUpdated').textContent = mostRecent.toLocaleDateString();
            }
        }

        function setSortOrder(sort) {
            currentSort = sort;

            // Update button states
            document.querySelectorAll('.sort-options .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.sort === sort);
            });

            updateRankingsTable();
        }

        function loadFallbackCMData() {
            // Fallback council member data
            const fallbackMembers = [
                { district: 1, name: 'Joy Kimbrough', phone: '615-432-1301', email: 'district1@nashville.gov' },
                { district: 2, name: 'Kyonzt√© Toombs', phone: '615-432-1302', email: 'district2@nashville.gov' },
                { district: 3, name: 'Jennifer Gamble', phone: '615-432-1303', email: 'district3@nashville.gov' },
                { district: 4, name: 'Mike Cortese', phone: '615-432-1304', email: 'district4@nashville.gov' },
                { district: 5, name: 'Sean Parker', phone: '615-432-1305', email: 'district5@nashville.gov' },
                { district: 6, name: 'Clay Capp', phone: '615-432-1306', email: 'district6@nashville.gov' },
                { district: 7, name: 'Emily Benedict', phone: '615-432-1307', email: 'district7@nashville.gov' },
                { district: 8, name: 'Deont√© Harrell', phone: '615-432-1308', email: 'district8@nashville.gov' },
                { district: 9, name: 'Tonya Hancock', phone: '615-432-1309', email: 'district9@nashville.gov' },
                { district: 10, name: 'Jennifer Frensley Webb', phone: '615-432-1310', email: 'district10@nashville.gov' },
                { district: 11, name: 'Jeff Eslick', phone: '615-432-1311', email: 'district11@nashville.gov' },
                { district: 12, name: 'Erin Evans', phone: '615-432-1312', email: 'district12@nashville.gov' },
                { district: 13, name: 'Russ Bradford', phone: '615-432-1313', email: 'district13@nashville.gov' },
                { district: 14, name: 'Jordan Huffman', phone: '615-432-1314', email: 'district14@nashville.gov' },
                { district: 15, name: 'Jeff Gregg', phone: '615-432-1315', email: 'district15@nashville.gov' },
                { district: 16, name: 'Ginny Welsch', phone: '615-432-1316', email: 'district16@nashville.gov' },
                { district: 17, name: 'Terry Vo', phone: '615-432-1317', email: 'district17@nashville.gov' },
                { district: 18, name: 'Tom Cash', phone: '615-432-1318', email: 'district18@nashville.gov' },
                { district: 19, name: 'Jacob Kupin', phone: '615-432-1319', email: 'district19@nashville.gov' },
                { district: 20, name: 'Rollin Horton', phone: '615-432-1320', email: 'district20@nashville.gov' },
                { district: 21, name: 'Brandon Taylor', phone: '615-432-1321', email: 'district21@nashville.gov' },
                { district: 22, name: 'Sheri Weiner', phone: '615-432-1322', email: 'district22@nashville.gov' },
                { district: 23, name: 'Thom Druffel', phone: '615-432-1323', email: 'district23@nashville.gov' },
                { district: 24, name: 'Brenda Gadd', phone: '615-432-1324', email: 'district24@nashville.gov' },
                { district: 25, name: 'Jeff Preptit', phone: '615-432-1325', email: 'district25@nashville.gov' },
                { district: 26, name: 'Courtney Johnston', phone: '615-432-1326', email: 'district26@nashville.gov' },
                { district: 27, name: 'Robert Nash', phone: '615-432-1327', email: 'district27@nashville.gov' },
                { district: 28, name: 'David Benton', phone: '615-432-1328', email: 'district28@nashville.gov' },
                { district: 29, name: 'Tasha Ellis', phone: '615-432-1329', email: 'district29@nashville.gov' },
                { district: 30, name: 'Sandra Sepulveda', phone: '', email: 'district30@nashville.gov' },
                { district: 31, name: 'John Rutherford', phone: '615-432-1331', email: 'district31@nashville.gov' },
                { district: 32, name: 'Joy Styles', phone: '615-432-1332', email: 'district32@nashville.gov' },
                { district: 33, name: 'Antoinette Lee', phone: '615-432-1333', email: 'district33@nashville.gov' },
                { district: 34, name: 'Sandy Ewing', phone: '615-432-1334', email: 'district34@nashville.gov' },
                { district: 35, name: 'Jason Spain', phone: '615-432-1335', email: 'district35@nashville.gov' }
            ];

            fallbackMembers.forEach(m => {
                m.title = `District ${m.district}`;
                councilMembers[m.district] = m;
            });

            generateDistrictButtons();
            updateRankingsTable();
        }

        // Initialize on page load
        loadAllData();
    </script>

    <!-- Login Modal -->
    <div id="loginModal" class="login-modal hidden" onclick="if(event.target === this) hideLoginModal()">
        <div class="login-modal-content">
            <div class="login-modal-header">
                <div>
                    <p style="font-size: 0.75rem; font-weight: 600; color: #dc2626; text-transform: uppercase; letter-spacing: 0.05em;">Privacy Protected</p>
                    <h3>Login Required</h3>
                </div>
                <button class="close-btn" onclick="hideLoginModal()">&times;</button>
            </div>
            <div class="login-modal-body">
                <div class="login-notice">
                    <strong>Privacy Notice:</strong> Landlord/plaintiff names are protected. Authorized users can login to view full names.
                </div>
                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Password</label>
                <input type="password" id="loginPassword" class="login-input" placeholder="Enter access password" onkeypress="if(event.key === 'Enter') attemptLogin()">
                <div id="loginError" class="login-error hidden">Incorrect password. Please try again.</div>
                <button onclick="attemptLogin()" class="login-btn">Login</button>
            </div>
        </div>
    </div>

    <script>
        // Login system
        let isLoggedIn = false;
        const LOGIN_PASSWORD = 'HIAHR';

        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('loginPassword').focus();
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
        }

        function attemptLogin() {
            const password = document.getElementById('loginPassword').value;
            if (password.toUpperCase() === LOGIN_PASSWORD) {
                isLoggedIn = true;
                hideLoginModal();
                updateLoginButton();
                // Refresh modal if open to show real names
                if (selectedDistrict) {
                    openDemographicsModal();
                }
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            isLoggedIn = false;
            updateLoginButton();
            // Refresh modal if open to hide names
            if (selectedDistrict) {
                openDemographicsModal();
            }
        }

        function updateLoginButton() {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            if (isLoggedIn) {
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        // Scramble a name for privacy (consistent scrambling per name)
        function scrambleName(name) {
            if (!name) return '';
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = ((hash << 5) - hash) + name.charCodeAt(i);
                hash = hash & hash;
            }
            const firstNames = ['J.', 'M.', 'R.', 'S.', 'A.', 'D.', 'K.', 'T.', 'L.', 'C.'];
            const lastParts = ['***', '****', '*****', '******'];
            const firstIdx = Math.abs(hash) % firstNames.length;
            const lastIdx = Math.abs(hash >> 4) % lastParts.length;
            return `${firstNames[firstIdx]} ${lastParts[lastIdx]}`;
        }

        function getDisplayName(name) {
            if (isLoggedIn) return name;
            return scrambleName(name);
        }

        // Sorting function for landlord table
        function sortLandlordTable(field, district) {
            if (!window.landlordTableData) return;

            const currentSort = window.currentLandlordSort || { field: 'filings', direction: 'desc' };
            let direction = 'desc';

            if (currentSort.field === field) {
                direction = currentSort.direction === 'desc' ? 'asc' : 'desc';
            }

            window.currentLandlordSort = { field, direction };

            // Sort the data
            const sortedData = [...window.landlordTableData].sort((a, b) => {
                let valA, valB;
                switch (field) {
                    case 'name':
                        valA = a.name.toLowerCase();
                        valB = b.name.toLowerCase();
                        break;
                    case 'filings':
                        valA = a.evictions.length;
                        valB = b.evictions.length;
                        break;
                    default:
                        return 0;
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Update table headers
            const table = document.getElementById('landlordTable');
            if (!table) return;

            table.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.sort === field) {
                    th.classList.add(direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });

            // Update table body
            const tbody = table.querySelector('tbody');
            if (!tbody) return;

            let rowsHtml = '';
            sortedData.slice(0, 50).forEach(landlord => {
                const displayName = getDisplayName(landlord.name);
                const nameClass = isLoggedIn ? '' : 'name-hidden';
                rowsHtml += `
                    <tr>
                        <td class="${nameClass}">${truncateLandlord(displayName, 40)}</td>
                        <td><strong>${landlord.evictions.length}</strong></td>
                    </tr>
                `;
            });
            tbody.innerHTML = rowsHtml;
        }

        function truncateLandlord(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }
    </script>
</body>
</html>
