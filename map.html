<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eviction Time Map - Nashville</title>
    <link rel="icon" type="image/png" href="https://storage.googleapis.com/intelechia-content/im/eviction%20prevention%20logo.png">
    <link rel="stylesheet" href="dist/output.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Heat -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary: #4f46e5;
            --secondary: #06b6d4;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
            --bg-dark: #1e1e2e;
            --bg-panel: #2a2a3e;
            --text-primary: #e0e0e8;
            --text-muted: #8888a0;
            --border: #3a3a52;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        .unofficial-banner {
            background: #fef3c7;
            border-bottom: 2px solid #f59e0b;
            padding: 8px 16px;
            text-align: center;
            color: #92400e;
            font-size: 13px;
        }

        .unofficial-banner .banner-headline {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .unofficial-banner .banner-detail {
            font-size: 0.85em;
            font-weight: 400;
            line-height: 1.4;
        }

        /* Header */
        .header {
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 52px;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo { height: 32px; }

        .header h1 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-secondary {
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover { background: #333348; }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover { background: #4338ca; }

        /* Main layout */
        .main-container {
            display: flex;
            height: calc(100vh - 52px - 68px);
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 16px;
            z-index: 500;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-card {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Overlay controls */
        .overlay-section { display: flex; flex-direction: column; gap: 6px; }

        .overlay-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s;
        }

        .overlay-toggle:hover { border-color: var(--primary); }
        .overlay-toggle.active { border-color: var(--primary); background: rgba(79, 70, 229, 0.1); }

        .overlay-toggle input[type="checkbox"] { accent-color: var(--primary); }

        .filter-select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            background: var(--bg-dark);
            color: var(--text-primary);
        }

        .filter-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        /* Legend */
        .legend {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .legend-bar {
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(to right, #2563eb, #3b82f6, #fbbf24, #f97316, #ef4444, #991b1b);
        }

        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
        }

        /* District list */
        .district-list {
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .district-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.15s;
        }

        .district-item:hover { background: rgba(255,255,255,0.05); }
        .district-item.active { background: rgba(79, 70, 229, 0.15); }

        .district-count {
            font-weight: 600;
            color: var(--danger);
            font-size: 12px;
        }

        /* Map container */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #1a1a2e;
        }

        /* Time scrubber */
        .time-scrubber {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(30, 30, 46, 0.95) 30%);
            padding: 40px 24px 20px;
            z-index: 800;
        }

        .scrubber-inner {
            max-width: 900px;
            margin: 0 auto;
        }

        .scrubber-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .scrubber-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: background 0.2s;
        }

        .play-btn:hover { background: #4338ca; }

        .speed-select {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .current-date {
            font-size: 20px;
            font-weight: 700;
            color: white;
            font-variant-numeric: tabular-nums;
        }

        .date-range-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .scrubber-track {
            position: relative;
            height: 48px;
            cursor: pointer;
            user-select: none;
        }

        .scrubber-histogram {
            position: absolute;
            bottom: 16px;
            left: 0;
            right: 0;
            height: 32px;
            display: flex;
            align-items: flex-end;
            gap: 1px;
        }

        .histogram-bar {
            flex: 1;
            background: rgba(79, 70, 229, 0.3);
            border-radius: 2px 2px 0 0;
            min-height: 1px;
            transition: background 0.1s;
        }

        .histogram-bar.active {
            background: var(--primary);
        }

        .histogram-bar.past {
            background: rgba(79, 70, 229, 0.6);
        }

        .scrubber-slider {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: transparent;
            outline: none;
            z-index: 2;
        }

        .scrubber-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.8), 0 2px 8px rgba(0,0,0,0.4);
            cursor: pointer;
            border: 2px solid var(--primary);
        }

        .scrubber-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.8), 0 2px 8px rgba(0,0,0,0.4);
            cursor: pointer;
            border: 2px solid var(--primary);
        }

        .scrubber-dates {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Count badge on map */
        .time-count-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(30, 30, 46, 0.9);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            z-index: 800;
            text-align: center;
            backdrop-filter: blur(8px);
        }

        .time-count-badge .count {
            font-size: 28px;
            font-weight: 800;
            color: white;
        }

        .time-count-badge .label {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* View mode tabs */
        .view-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 3px;
            border: 1px solid var(--border);
        }

        .view-tab {
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-muted);
            transition: all 0.15s;
        }

        .view-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Loading */
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(30, 30, 46, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            margin-top: 16px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .loading-progress {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Popup styles */
        .leaflet-popup-content-wrapper {
            background: var(--bg-panel);
            color: var(--text-primary);
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .leaflet-popup-tip { background: var(--bg-panel); }

        .info-popup { padding: 4px; min-width: 220px; }
        .info-popup h3 { font-size: 14px; font-weight: 600; margin-bottom: 8px; }

        .info-popup .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 12px;
            border-bottom: 1px solid var(--border);
        }

        .info-popup .stat-row:last-child { border-bottom: none; }
        .info-popup .label { color: var(--text-muted); }
        .info-popup .value { font-weight: 600; }

        /* Demographic overlay legend */
        .demo-legend {
            position: absolute;
            bottom: 180px;
            right: 16px;
            background: rgba(30, 30, 46, 0.9);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            z-index: 800;
            display: none;
            backdrop-filter: blur(8px);
            min-width: 160px;
        }

        .demo-legend.visible { display: block; }

        .demo-legend h4 {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .demo-legend-bar {
            height: 10px;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .demo-legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Mobile sidebar */
        .mobile-menu-toggle {
            display: none;
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 999;
        }

        .sidebar-overlay.active { display: block; }

        .sidebar-close {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--bg-dark);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle { display: flex; align-items: center; justify-content: center; }
            .sidebar-close { display: flex; align-items: center; justify-content: center; }

            .sidebar {
                position: fixed;
                top: 0; left: 0;
                width: 300px;
                max-width: 85vw;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                padding-top: 50px;
            }

            .sidebar.open { transform: translateX(0); }
            .map-container { height: calc(100vh - 52px); }

            .time-scrubber { padding: 30px 12px 12px; }
            .current-date { font-size: 16px; }
        }

        /* Custom Leaflet dark tile styling */
        .leaflet-control-zoom a {
            background: var(--bg-panel) !important;
            color: var(--text-primary) !important;
            border-color: var(--border) !important;
        }

        .leaflet-control-attribution {
            background: rgba(30, 30, 46, 0.8) !important;
            color: var(--text-muted) !important;
            font-size: 10px !important;
        }

        .leaflet-control-attribution a { color: var(--primary) !important; }

        /* Cumulative toggle */
        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .mode-toggle label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .mode-toggle input { accent-color: var(--primary); }

        /* Scrollbar */
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-track { background: transparent; }
        .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .district-list::-webkit-scrollbar { width: 4px; }
        .district-list::-webkit-scrollbar-track { background: transparent; }
        .district-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    </style>
</head>
<body>
    <div class="unofficial-banner">
        <div class="banner-headline">⚠️ UNOFFICIAL COMMUNITY PROJECT - Not affiliated with Metro Nashville or any government agency</div>
        <div class="banner-detail">These numbers are built from an automated scraping bot and are not official. Figures may change as more data is gathered. For official numbers, Metro Nashville would need to publish this information in a standardized way.</div>
    </div>
    <header class="header">
        <div class="header-left">
            <button class="mobile-menu-toggle" onclick="toggleMobileSidebar()" aria-label="Open menu">&#9776;</button>
            <img src="https://storage.googleapis.com/intelechia-content/im/eviction%20prevention%20logo.png" alt="Logo" class="logo">
            <h1>Eviction Time Map</h1>
        </div>
        <div class="header-right">
            <div class="view-tabs">
                <button class="view-tab active" data-view="markers" onclick="setViewMode('markers')">Markers</button>
                <button class="view-tab" data-view="heat" onclick="setViewMode('heat')">Heatmap</button>
                <button class="view-tab" data-view="cluster" onclick="setViewMode('cluster')">Clusters</button>
            </div>
            <a href="index.html" class="btn btn-secondary">Dashboard</a>
        </div>
    </header>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileSidebar()"></div>

    <div class="main-container">
        <aside class="sidebar" id="sidebar">
            <button class="sidebar-close" onclick="closeMobileSidebar()">&#215;</button>

            <div>
                <div class="section-title">Visible Filings</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statVisible">--</div>
                        <div class="stat-label">Showing</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTotal">--</div>
                        <div class="stat-label">With Address</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statDistricts">--</div>
                        <div class="stat-label">Districts Hit</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statHotspot">--</div>
                        <div class="stat-label">Top District</div>
                    </div>
                </div>
            </div>

            <div class="overlay-section">
                <div class="section-title">District Overlay</div>
                <label class="overlay-toggle" id="districtToggle">
                    <input type="checkbox" id="showDistricts" checked onchange="toggleDistrictOverlay()">
                    <span>Council Districts</span>
                </label>
                <div>
                    <div class="filter-label">Demographic Choropleth</div>
                    <select class="filter-select" id="demoMetric" onchange="updateDemographicOverlay()">
                        <option value="none">None</option>
                        <option value="poverty">Poverty Rate</option>
                        <option value="income">Median Income</option>
                        <option value="renters">% Renters</option>
                        <option value="rent_burden">Rent Burdened (%)</option>
                        <option value="unemployment">Unemployment Rate</option>
                        <option value="pct_black">% Black Population</option>
                        <option value="pct_hispanic">% Hispanic Population</option>
                    </select>
                </div>
            </div>

            <div>
                <div class="section-title">Heat Legend</div>
                <div class="legend">
                    <div class="legend-bar"></div>
                    <div class="legend-labels">
                        <span>Low</span>
                        <span>Medium</span>
                        <span>High</span>
                        <span>Critical</span>
                    </div>
                </div>
            </div>

            <div>
                <div class="section-title">Districts by Filings</div>
                <div class="district-list" id="districtList"></div>
            </div>
        </aside>

        <div class="map-container">
            <div id="map"></div>

            <div class="time-count-badge" id="timeBadge">
                <div class="count" id="badgeCount">--</div>
                <div class="label" id="badgeLabel">filings visible</div>
            </div>

            <div class="demo-legend" id="demoLegend">
                <h4 id="demoLegendTitle">Overlay</h4>
                <div class="demo-legend-bar" id="demoLegendBar"></div>
                <div class="demo-legend-labels">
                    <span id="demoLegendMin">Low</span>
                    <span id="demoLegendMax">High</span>
                </div>
            </div>

            <!-- Time Scrubber -->
            <div class="time-scrubber">
                <div class="scrubber-inner">
                    <div class="scrubber-header">
                        <div class="scrubber-controls">
                            <button class="play-btn" id="playBtn" onclick="togglePlayback()">&#9654;</button>
                            <select class="speed-select" id="speedSelect" onchange="updateSpeed()">
                                <option value="200">Slow</option>
                                <option value="80" selected>Normal</option>
                                <option value="30">Fast</option>
                                <option value="10">Turbo</option>
                            </select>
                            <div class="mode-toggle">
                                <label>
                                    <input type="checkbox" id="cumulativeMode" checked onchange="onModeChange()">
                                    Cumulative
                                </label>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="current-date" id="currentDate">--</div>
                            <div class="date-range-label" id="dateRangeLabel">Loading data...</div>
                        </div>
                    </div>
                    <div class="scrubber-track" id="scrubberTrack">
                        <div class="scrubber-histogram" id="histogram"></div>
                        <input type="range" class="scrubber-slider" id="timeSlider" min="0" max="100" value="100" oninput="onSliderInput()">
                    </div>
                    <div class="scrubber-dates">
                        <span id="startDateLabel">--</span>
                        <span id="endDateLabel">--</span>
                    </div>
                </div>
            </div>

            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
                <div class="loading-text" id="loadingText">Loading eviction data...</div>
                <div class="loading-progress" id="loadingProgress"></div>
            </div>
        </div>
    </div>

    <!-- EO Migration for event sourcing -->
    <script src="eo-migration.js"></script>
    <!-- Eviction API client -->
    <script src="eviction-api.js"></script>

    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        const NASHVILLE_CENTER = [36.1627, -86.7816];
        const DEFAULT_ZOOM = 11;

        // =============================================
        // STATE
        // =============================================
        let map;
        let allRecords = [];          // All records with address info
        let visibleMarkers = [];      // Currently rendered Leaflet markers
        let heatLayer = null;
        let districtGeoLayer = null;
        let demoGeoLayer = null;
        let districtGeoJSON = null;
        let districtDemographics = {};

        // Time state
        let timeSlots = [];           // Array of { date, records[] }
        let minDate = null;
        let maxDate = null;
        let currentSlotIndex = 0;
        let isPlaying = false;
        let playInterval = null;
        let playSpeed = 80;

        // View mode
        let viewMode = 'markers';     // 'markers', 'heat', 'cluster'

        // Histogram bins
        const HISTOGRAM_BINS = 120;

        // District centroids for fallback rendering
        const DISTRICT_CENTROIDS = {
            1: [36.302, -86.787], 2: [36.255, -86.698], 3: [36.227, -86.620],
            4: [36.195, -86.655], 5: [36.175, -86.612], 6: [36.140, -86.595],
            7: [36.085, -86.620], 8: [36.240, -86.850], 9: [36.200, -86.830],
            10: [36.178, -86.805], 11: [36.152, -86.760], 12: [36.115, -86.810],
            13: [36.080, -86.780], 14: [36.050, -86.720], 15: [36.175, -86.775],
            16: [36.158, -86.795], 17: [36.135, -86.830], 18: [36.100, -86.865],
            19: [36.145, -86.880], 20: [36.185, -86.900], 21: [36.160, -86.762],
            22: [36.130, -86.765], 23: [36.105, -86.750], 24: [36.070, -86.815],
            25: [36.215, -86.700], 26: [36.192, -86.725], 27: [36.165, -86.695],
            28: [36.140, -86.670], 29: [36.110, -86.655], 30: [36.080, -86.680],
            31: [36.030, -86.870], 32: [36.015, -86.785], 33: [35.985, -86.720],
            34: [36.025, -86.660], 35: [36.055, -86.600]
        };

        // =============================================
        // INITIALIZATION
        // =============================================
        async function init() {
            initMap();
            updateLoadingText('Loading district boundaries...');
            await Promise.all([
                loadDistrictBoundaries(),
                loadDistrictDemographics()
            ]);

            updateLoadingText('Loading eviction records...');
            await loadEvictionData();

            processTimeData();
            renderDistrictOverlay();
            renderTimeline();
            updateDistrictList();

            // Start at the end (show all data)
            const slider = document.getElementById('timeSlider');
            slider.value = slider.max;
            currentSlotIndex = timeSlots.length - 1;
            renderAtCurrentTime();
            hideLoading();
        }

        function initMap() {
            map = L.map('map', {
                center: NASHVILLE_CENTER,
                zoom: DEFAULT_ZOOM,
                zoomControl: true,
                preferCanvas: true
            });

            // Dark tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
        }

        // =============================================
        // DATA LOADING
        // =============================================
        async function loadDistrictBoundaries() {
            try {
                const response = await fetch('council-districts.geojson');
                if (response.ok) {
                    districtGeoJSON = await response.json();
                    console.log('Loaded district GeoJSON:', districtGeoJSON.features?.length, 'features');
                    return;
                }
            } catch (e) {
                console.log('No local GeoJSON, using centroids for district labels');
            }
            districtGeoJSON = null;
        }

        async function loadDistrictDemographics() {
            try {
                const response = await fetch('district-data.json');
                const data = await response.json();
                districtDemographics = data.districts || {};
            } catch (e) {
                console.error('Failed to load district demographics:', e);
            }
        }

        async function loadEvictionData() {
            try {
                // Use EvictionAPI (current-state) for data with address info
                const records = await EvictionAPI.fetchAll((progress) => {
                    updateLoadingProgress(`Page ${progress.page}${progress.pageTotal ? '/' + progress.pageTotal : ''} - ${progress.fetched} records`);
                });

                console.log('Total records from API:', records.length);

                // Filter to only records with address/coordinate info
                allRecords = records.filter(r => {
                    const lat = parseFloat(r.latitude || r.lat);
                    const lng = parseFloat(r.longitude || r.lng || r.lon);
                    const hasCoords = !isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0;
                    const hasAddress = !!(r.address_formatted || r.formatted_address || r.Address_1 || r.address_1 || r.address);
                    return hasCoords || hasAddress;
                });

                // Normalize records for consistent access
                allRecords = allRecords.map(r => ({
                    ...r,
                    _lat: parseFloat(r.latitude || r.lat) || null,
                    _lng: parseFloat(r.longitude || r.lng || r.lon) || null,
                    _date: parseFileDate(r.File_Date || r.file_date || r.fileDate),
                    _address: r.address_formatted || r.formatted_address || r.Address_1 || r.address_1 || r.address || '',
                    _district: extractDistrict(r),
                    _plaintiff: r.Plaintiff_Petitioner || r.plaintiff_petitioner || r.plaintiff || '',
                    _docket: r.Docket_Number || r.docket_number || ''
                }));

                // Only keep records with valid coordinates
                allRecords = allRecords.filter(r => r._lat && r._lng);

                console.log('Records with coordinates:', allRecords.length);
                document.getElementById('statTotal').textContent = allRecords.length.toLocaleString();

            } catch (e) {
                console.error('Failed to load eviction data:', e);
                allRecords = [];
            }
        }

        function parseFileDate(dateStr) {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        }

        function extractDistrict(record) {
            if (record.council_district_number) {
                const num = parseInt(record.council_district_number);
                if (!isNaN(num) && num > 0 && num <= 35) return num;
            }
            if (record.council_district) {
                const match = String(record.council_district).match(/(\d+)/);
                if (match) {
                    const num = parseInt(match[1], 10);
                    if (num > 0 && num <= 35) return num;
                }
            }
            const fields = ['District', 'district', 'Council_District', 'Council_District_Number'];
            for (const field of fields) {
                if (record[field]) {
                    const val = record[field];
                    if (typeof val === 'number' && val > 0 && val <= 35) return val;
                    const match = String(val).match(/(\d+)/);
                    if (match) {
                        const num = parseInt(match[1], 10);
                        if (num > 0 && num <= 35) return num;
                    }
                }
            }
            return null;
        }

        // =============================================
        // TIME PROCESSING
        // =============================================
        function processTimeData() {
            // Sort all records by date
            const dated = allRecords.filter(r => r._date);
            dated.sort((a, b) => a._date - b._date);

            if (dated.length === 0) {
                console.warn('No dated records found');
                return;
            }

            minDate = dated[0]._date;
            maxDate = dated[dated.length - 1]._date;

            // Group by week for time slots
            const weekMs = 7 * 24 * 60 * 60 * 1000;
            const totalWeeks = Math.ceil((maxDate - minDate) / weekMs) + 1;

            // Build weekly slots
            timeSlots = [];
            for (let i = 0; i < totalWeeks; i++) {
                const slotStart = new Date(minDate.getTime() + i * weekMs);
                const slotEnd = new Date(slotStart.getTime() + weekMs);
                timeSlots.push({
                    date: slotStart,
                    dateEnd: slotEnd,
                    records: []
                });
            }

            // Assign records to slots
            for (const record of dated) {
                const weekIndex = Math.floor((record._date - minDate) / weekMs);
                const idx = Math.min(weekIndex, timeSlots.length - 1);
                timeSlots[idx].records.push(record);
            }

            // Also handle undated records - put them in the last slot
            const undated = allRecords.filter(r => !r._date);
            if (undated.length > 0 && timeSlots.length > 0) {
                timeSlots[timeSlots.length - 1].records.push(...undated);
            }

            // Update slider
            const slider = document.getElementById('timeSlider');
            slider.max = timeSlots.length - 1;
            slider.value = timeSlots.length - 1;
            currentSlotIndex = timeSlots.length - 1;

            // Date labels
            document.getElementById('startDateLabel').textContent = formatDate(minDate);
            document.getElementById('endDateLabel').textContent = formatDate(maxDate);
            document.getElementById('dateRangeLabel').textContent =
                `${formatDate(minDate)} - ${formatDate(maxDate)} (${totalWeeks} weeks)`;

            console.log('Time slots:', timeSlots.length, 'weeks');
        }

        function formatDate(d) {
            if (!d) return '--';
            return d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }

        function formatDateFull(d) {
            if (!d) return '--';
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // =============================================
        // TIMELINE HISTOGRAM
        // =============================================
        function renderTimeline() {
            const container = document.getElementById('histogram');
            container.innerHTML = '';

            if (timeSlots.length === 0) return;

            // Bin the time slots into histogram bins
            const binSize = Math.max(1, Math.ceil(timeSlots.length / HISTOGRAM_BINS));
            const bins = [];
            for (let i = 0; i < timeSlots.length; i += binSize) {
                const slice = timeSlots.slice(i, i + binSize);
                const count = slice.reduce((sum, s) => sum + s.records.length, 0);
                bins.push(count);
            }

            const maxBin = Math.max(...bins, 1);

            bins.forEach((count, i) => {
                const bar = document.createElement('div');
                bar.className = 'histogram-bar';
                bar.style.height = Math.max(1, (count / maxBin) * 100) + '%';
                bar.dataset.bin = i;
                container.appendChild(bar);
            });

            updateHistogramHighlight();
        }

        function updateHistogramHighlight() {
            const bars = document.querySelectorAll('.histogram-bar');
            if (bars.length === 0) return;

            const binSize = Math.max(1, Math.ceil(timeSlots.length / HISTOGRAM_BINS));
            const currentBin = Math.floor(currentSlotIndex / binSize);
            const isCumulative = document.getElementById('cumulativeMode').checked;

            bars.forEach((bar, i) => {
                bar.classList.remove('active', 'past');
                if (i === currentBin) {
                    bar.classList.add('active');
                } else if (isCumulative && i < currentBin) {
                    bar.classList.add('past');
                }
            });
        }

        // =============================================
        // MAP RENDERING
        // =============================================
        function getRecordsForCurrentTime() {
            if (timeSlots.length === 0) return allRecords;

            const isCumulative = document.getElementById('cumulativeMode').checked;

            if (isCumulative) {
                // All records up to current slot
                const records = [];
                for (let i = 0; i <= currentSlotIndex; i++) {
                    records.push(...timeSlots[i].records);
                }
                return records;
            } else {
                // Only current week's records
                return timeSlots[currentSlotIndex]?.records || [];
            }
        }

        function renderAtCurrentTime() {
            const records = getRecordsForCurrentTime();

            // Update date display
            if (timeSlots.length > 0 && timeSlots[currentSlotIndex]) {
                const slot = timeSlots[currentSlotIndex];
                document.getElementById('currentDate').textContent = formatDateFull(slot.date);
            }

            // Update stats
            updateStatsForRecords(records);
            updateHistogramHighlight();

            // Render based on view mode
            clearMapLayers();

            if (viewMode === 'heat') {
                renderHeatmap(records);
            } else if (viewMode === 'cluster') {
                renderClusters(records);
            } else {
                renderMarkers(records);
            }

            // Update badge
            document.getElementById('badgeCount').textContent = records.length.toLocaleString();
        }

        function clearMapLayers() {
            visibleMarkers.forEach(m => map.removeLayer(m));
            visibleMarkers = [];
            if (heatLayer) {
                map.removeLayer(heatLayer);
                heatLayer = null;
            }
        }

        function renderMarkers(records) {
            // Use canvas renderer for performance
            const maxMarkers = 5000;
            const renderRecords = records.length > maxMarkers
                ? records.slice(-maxMarkers) // Show most recent
                : records;

            renderRecords.forEach(r => {
                if (!r._lat || !r._lng) return;

                const marker = L.circleMarker([r._lat, r._lng], {
                    radius: 4,
                    fillColor: getMarkerColor(r),
                    fillOpacity: 0.7,
                    color: 'rgba(255,255,255,0.3)',
                    weight: 1
                });

                marker.bindPopup(createEvictionPopup(r));
                marker.addTo(map);
                visibleMarkers.push(marker);
            });

            if (records.length > maxMarkers) {
                document.getElementById('badgeLabel').textContent =
                    `of ${records.length.toLocaleString()} (showing ${maxMarkers.toLocaleString()})`;
            } else {
                document.getElementById('badgeLabel').textContent = 'filings visible';
            }
        }

        function renderHeatmap(records) {
            const points = records
                .filter(r => r._lat && r._lng)
                .map(r => [r._lat, r._lng, 0.6]);

            heatLayer = L.heatLayer(points, {
                radius: 20,
                blur: 15,
                maxZoom: 14,
                max: 1.0,
                gradient: {
                    0.1: '#2563eb',
                    0.3: '#3b82f6',
                    0.5: '#fbbf24',
                    0.7: '#f97316',
                    0.85: '#ef4444',
                    1.0: '#991b1b'
                }
            }).addTo(map);

            document.getElementById('badgeLabel').textContent = 'filings in heatmap';
        }

        function renderClusters(records) {
            // Simple grid-based clustering
            const gridSize = 0.01; // ~1km grid
            const clusters = new Map();

            records.forEach(r => {
                if (!r._lat || !r._lng) return;
                const key = `${Math.round(r._lat / gridSize)},${Math.round(r._lng / gridSize)}`;
                if (!clusters.has(key)) {
                    clusters.set(key, { lat: 0, lng: 0, count: 0, records: [] });
                }
                const c = clusters.get(key);
                c.lat += r._lat;
                c.lng += r._lng;
                c.count++;
                c.records.push(r);
            });

            const maxCluster = Math.max(...Array.from(clusters.values()).map(c => c.count), 1);

            clusters.forEach(c => {
                const lat = c.lat / c.count;
                const lng = c.lng / c.count;
                const radius = Math.max(8, Math.min(35, 8 + (c.count / maxCluster) * 27));

                const color = getClusterColor(c.count, maxCluster);

                const marker = L.circleMarker([lat, lng], {
                    radius: radius,
                    fillColor: color,
                    fillOpacity: 0.75,
                    color: 'rgba(255,255,255,0.4)',
                    weight: 2
                });

                // Cluster popup with summary
                const topPlaintiffs = getTopPlaintiffs(c.records, 3);
                marker.bindPopup(`
                    <div class="info-popup">
                        <h3>${c.count} Eviction${c.count > 1 ? 's' : ''}</h3>
                        <div class="stat-row">
                            <span class="label">Area</span>
                            <span class="value">${c.records[0]._address?.split(',')[1]?.trim() || 'Nashville'}</span>
                        </div>
                        ${topPlaintiffs.map(p => `
                            <div class="stat-row">
                                <span class="label">${p.name.substring(0, 25)}</span>
                                <span class="value">${p.count}</span>
                            </div>
                        `).join('')}
                    </div>
                `);

                // Show count label
                const tooltipContent = c.count >= 5 ? String(c.count) : '';
                if (tooltipContent) {
                    marker.bindTooltip(tooltipContent, {
                        permanent: true,
                        direction: 'center',
                        className: 'cluster-label'
                    });
                }

                marker.addTo(map);
                visibleMarkers.push(marker);
            });

            document.getElementById('badgeLabel').textContent = `filings in ${clusters.size} clusters`;
        }

        function getMarkerColor(record) {
            // Color by status
            const status = (record.Status || record.status || '').toLowerCase();
            if (status.includes('dismiss')) return '#10b981';
            if (status.includes('judgment') || status.includes('granted')) return '#ef4444';
            if (status.includes('active') || status.includes('pending')) return '#fbbf24';
            return '#6366f1';
        }

        function getClusterColor(count, max) {
            const ratio = count / max;
            if (ratio >= 0.8) return '#991b1b';
            if (ratio >= 0.6) return '#ef4444';
            if (ratio >= 0.4) return '#f97316';
            if (ratio >= 0.2) return '#fbbf24';
            return '#3b82f6';
        }

        function getTopPlaintiffs(records, n) {
            const counts = {};
            records.forEach(r => {
                const p = r._plaintiff || 'Unknown';
                counts[p] = (counts[p] || 0) + 1;
            });
            return Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, n)
                .map(([name, count]) => ({ name, count }));
        }

        function createEvictionPopup(r) {
            return `
                <div class="info-popup">
                    <h3>${r._docket || 'Eviction Filing'}</h3>
                    <div class="stat-row">
                        <span class="label">Address</span>
                        <span class="value">${r._address || 'N/A'}</span>
                    </div>
                    <div class="stat-row">
                        <span class="label">Filed</span>
                        <span class="value">${r._date ? formatDateFull(r._date) : 'N/A'}</span>
                    </div>
                    <div class="stat-row">
                        <span class="label">Plaintiff</span>
                        <span class="value">${(r._plaintiff || 'N/A').substring(0, 30)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="label">Status</span>
                        <span class="value">${r.Status || r.status || 'N/A'}</span>
                    </div>
                    <div class="stat-row">
                        <span class="label">District</span>
                        <span class="value">${r._district ? 'District ' + r._district : 'N/A'}</span>
                    </div>
                </div>
            `;
        }

        // =============================================
        // DISTRICT OVERLAY
        // =============================================
        function renderDistrictOverlay() {
            if (districtGeoLayer) {
                map.removeLayer(districtGeoLayer);
                districtGeoLayer = null;
            }

            if (!document.getElementById('showDistricts').checked) return;

            if (districtGeoJSON && districtGeoJSON.features) {
                districtGeoLayer = L.geoJSON(districtGeoJSON, {
                    style: {
                        fillColor: 'transparent',
                        fillOpacity: 0,
                        color: 'rgba(99, 102, 241, 0.5)',
                        weight: 2,
                        dashArray: '4 4'
                    },
                    onEachFeature: (feature, layer) => {
                        const d = feature.properties.district || feature.properties.DISTRICT || feature.properties.District;
                        const demo = districtDemographics[d] || {};
                        layer.bindPopup(createDistrictPopup(d, demo));

                        layer.on({
                            mouseover: (e) => {
                                e.target.setStyle({ weight: 3, color: 'rgba(99, 102, 241, 0.9)' });
                            },
                            mouseout: (e) => {
                                districtGeoLayer.resetStyle(e.target);
                            }
                        });
                    }
                }).addTo(map);
            } else {
                // Render district labels at centroids
                const labelGroup = L.layerGroup();
                Object.entries(DISTRICT_CENTROIDS).forEach(([d, [lat, lng]]) => {
                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'district-centroid-label',
                            html: `<div style="
                                background: rgba(99, 102, 241, 0.15);
                                border: 1px solid rgba(99, 102, 241, 0.4);
                                border-radius: 50%;
                                width: 28px;
                                height: 28px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 10px;
                                font-weight: 700;
                                color: rgba(165, 165, 210, 0.8);
                            ">${d}</div>`,
                            iconSize: [28, 28],
                            iconAnchor: [14, 14]
                        }),
                        interactive: true
                    });

                    const demo = districtDemographics[d] || {};
                    marker.bindPopup(createDistrictPopup(d, demo));
                    labelGroup.addLayer(marker);
                });
                districtGeoLayer = labelGroup.addTo(map);
            }
        }

        function createDistrictPopup(district, demo) {
            return `
                <div class="info-popup">
                    <h3>District ${district}</h3>
                    ${demo.population ? `
                    <div class="stat-row">
                        <span class="label">Population</span>
                        <span class="value">${demo.population.toLocaleString()}</span>
                    </div>` : ''}
                    ${demo.income?.median_household_income ? `
                    <div class="stat-row">
                        <span class="label">Median Income</span>
                        <span class="value">$${demo.income.median_household_income.toLocaleString()}</span>
                    </div>` : ''}
                    ${demo.poverty?.pct_total_poverty != null ? `
                    <div class="stat-row">
                        <span class="label">Poverty Rate</span>
                        <span class="value">${demo.poverty.pct_total_poverty}%</span>
                    </div>` : ''}
                    ${demo.housing?.pct_renters != null ? `
                    <div class="stat-row">
                        <span class="label">% Renters</span>
                        <span class="value">${demo.housing.pct_renters}%</span>
                    </div>` : ''}
                    ${demo.housing?.estimated_renters ? `
                    <div class="stat-row">
                        <span class="label">Renter Households</span>
                        <span class="value">${demo.housing.estimated_renters.toLocaleString()}</span>
                    </div>` : ''}
                    ${demo.race_ethnicity?.pct_black != null ? `
                    <div class="stat-row">
                        <span class="label">% Black</span>
                        <span class="value">${demo.race_ethnicity.pct_black}%</span>
                    </div>` : ''}
                    ${demo.race_ethnicity?.pct_hispanic != null ? `
                    <div class="stat-row">
                        <span class="label">% Hispanic</span>
                        <span class="value">${demo.race_ethnicity.pct_hispanic}%</span>
                    </div>` : ''}
                    ${demo.employment?.unemployment_rate != null ? `
                    <div class="stat-row">
                        <span class="label">Unemployment</span>
                        <span class="value">${demo.employment.unemployment_rate}%</span>
                    </div>` : ''}
                    ${demo.housing?.pct_renter_cost_burdened_35plus != null ? `
                    <div class="stat-row">
                        <span class="label">Rent Burdened</span>
                        <span class="value">${demo.housing.pct_renter_cost_burdened_35plus}%</span>
                    </div>` : ''}
                </div>
            `;
        }

        // =============================================
        // DEMOGRAPHIC CHOROPLETH OVERLAY
        // =============================================
        function updateDemographicOverlay() {
            if (demoGeoLayer) {
                map.removeLayer(demoGeoLayer);
                demoGeoLayer = null;
            }

            const metric = document.getElementById('demoMetric').value;
            const legend = document.getElementById('demoLegend');

            if (metric === 'none') {
                legend.classList.remove('visible');
                return;
            }

            // Extract values for all districts
            const values = {};
            const metricConfig = getDemoMetricConfig(metric);

            Object.entries(districtDemographics).forEach(([d, demo]) => {
                const val = metricConfig.extract(demo);
                if (val != null && !isNaN(val)) {
                    values[d] = val;
                }
            });

            const allVals = Object.values(values);
            if (allVals.length === 0) return;

            const minVal = Math.min(...allVals);
            const maxVal = Math.max(...allVals);

            // Update legend
            legend.classList.add('visible');
            document.getElementById('demoLegendTitle').textContent = metricConfig.label;
            document.getElementById('demoLegendBar').style.background = metricConfig.gradient;
            document.getElementById('demoLegendMin').textContent = metricConfig.format(minVal);
            document.getElementById('demoLegendMax').textContent = metricConfig.format(maxVal);

            if (districtGeoJSON && districtGeoJSON.features) {
                // Render GeoJSON choropleth
                demoGeoLayer = L.geoJSON(districtGeoJSON, {
                    style: (feature) => {
                        const d = feature.properties.district || feature.properties.DISTRICT || feature.properties.District;
                        const val = values[d];
                        const color = val != null
                            ? metricConfig.colorScale(val, minVal, maxVal)
                            : 'transparent';
                        return {
                            fillColor: color,
                            fillOpacity: 0.45,
                            color: 'rgba(255,255,255,0.2)',
                            weight: 1
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const d = feature.properties.district || feature.properties.DISTRICT || feature.properties.District;
                        const val = values[d];
                        if (val != null) {
                            layer.bindTooltip(`D${d}: ${metricConfig.format(val)}`, {
                                sticky: true,
                                className: 'demo-tooltip'
                            });
                        }
                    }
                }).addTo(map);
            } else {
                // Render circles at centroids with demographic color
                const group = L.layerGroup();
                Object.entries(DISTRICT_CENTROIDS).forEach(([d, [lat, lng]]) => {
                    const val = values[d];
                    if (val == null) return;

                    const color = metricConfig.colorScale(val, minVal, maxVal);
                    const marker = L.circleMarker([lat, lng], {
                        radius: 22,
                        fillColor: color,
                        fillOpacity: 0.4,
                        color: 'rgba(255,255,255,0.15)',
                        weight: 1
                    });

                    marker.bindTooltip(`D${d}: ${metricConfig.format(val)}`, { sticky: true });
                    group.addLayer(marker);
                });
                demoGeoLayer = group.addTo(map);
            }
        }

        function getDemoMetricConfig(metric) {
            const configs = {
                poverty: {
                    label: 'Poverty Rate',
                    extract: (d) => d.poverty?.pct_total_poverty,
                    format: (v) => v.toFixed(1) + '%',
                    gradient: 'linear-gradient(to right, #2563eb, #fbbf24, #ef4444)',
                    colorScale: (v, min, max) => interpolateColor(v, min, max, '#2563eb', '#fbbf24', '#ef4444')
                },
                income: {
                    label: 'Median Income',
                    extract: (d) => d.income?.median_household_income,
                    format: (v) => '$' + Math.round(v).toLocaleString(),
                    gradient: 'linear-gradient(to right, #ef4444, #fbbf24, #10b981)',
                    colorScale: (v, min, max) => interpolateColor(v, min, max, '#ef4444', '#fbbf24', '#10b981')
                },
                renters: {
                    label: '% Renters',
                    extract: (d) => d.housing?.pct_renters,
                    format: (v) => v.toFixed(1) + '%',
                    gradient: 'linear-gradient(to right, #10b981, #fbbf24, #ef4444)',
                    colorScale: (v, min, max) => interpolateColor(v, min, max, '#10b981', '#fbbf24', '#ef4444')
                },
                rent_burden: {
                    label: 'Rent Burdened (35%+ Income)',
                    extract: (d) => d.housing?.pct_renter_cost_burdened_35plus,
                    format: (v) => v.toFixed(1) + '%',
                    gradient: 'linear-gradient(to right, #2563eb, #fbbf24, #ef4444)',
                    colorScale: (v, min, max) => interpolateColor(v, min, max, '#2563eb', '#fbbf24', '#ef4444')
                },
                unemployment: {
                    label: 'Unemployment Rate',
                    extract: (d) => d.employment?.unemployment_rate,
                    format: (v) => v.toFixed(1) + '%',
                    gradient: 'linear-gradient(to right, #10b981, #fbbf24, #ef4444)',
                    colorScale: (v, min, max) => interpolateColor(v, min, max, '#10b981', '#fbbf24', '#ef4444')
                },
                pct_black: {
                    label: '% Black Population',
                    extract: (d) => d.race_ethnicity?.pct_black,
                    format: (v) => v.toFixed(1) + '%',
                    gradient: 'linear-gradient(to right, #6366f1, #a78bfa, #c084fc)',
                    colorScale: (v, min, max) => interpolateColor(v, min, max, '#6366f1', '#a78bfa', '#c084fc')
                },
                pct_hispanic: {
                    label: '% Hispanic Population',
                    extract: (d) => d.race_ethnicity?.pct_hispanic,
                    format: (v) => v.toFixed(1) + '%',
                    gradient: 'linear-gradient(to right, #06b6d4, #22d3ee, #67e8f9)',
                    colorScale: (v, min, max) => interpolateColor(v, min, max, '#06b6d4', '#22d3ee', '#67e8f9')
                }
            };
            return configs[metric];
        }

        function interpolateColor(value, min, max, colorLow, colorMid, colorHigh) {
            const ratio = max === min ? 0.5 : (value - min) / (max - min);

            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : [0, 0, 0];
            }

            function rgbToHex(r, g, b) {
                return '#' + [r, g, b].map(x => Math.round(x).toString(16).padStart(2, '0')).join('');
            }

            const low = hexToRgb(colorLow);
            const mid = hexToRgb(colorMid);
            const high = hexToRgb(colorHigh);

            let r, g, b;
            if (ratio <= 0.5) {
                const t = ratio * 2;
                r = low[0] + (mid[0] - low[0]) * t;
                g = low[1] + (mid[1] - low[1]) * t;
                b = low[2] + (mid[2] - low[2]) * t;
            } else {
                const t = (ratio - 0.5) * 2;
                r = mid[0] + (high[0] - mid[0]) * t;
                g = mid[1] + (high[1] - mid[1]) * t;
                b = mid[2] + (high[2] - mid[2]) * t;
            }

            return rgbToHex(r, g, b);
        }

        // =============================================
        // STATS & DISTRICT LIST
        // =============================================
        function updateStatsForRecords(records) {
            // Count by district
            const districtCounts = {};
            records.forEach(r => {
                if (r._district) {
                    districtCounts[r._district] = (districtCounts[r._district] || 0) + 1;
                }
            });

            const districtsHit = Object.keys(districtCounts).length;
            let topDistrict = '--';
            let topCount = 0;
            Object.entries(districtCounts).forEach(([d, c]) => {
                if (c > topCount) { topCount = c; topDistrict = d; }
            });

            document.getElementById('statVisible').textContent = records.length.toLocaleString();
            document.getElementById('statDistricts').textContent = districtsHit;
            document.getElementById('statHotspot').textContent = topDistrict !== '--' ? 'D' + topDistrict : '--';

            // Update district list
            updateDistrictListCounts(districtCounts);
        }

        function updateDistrictList() {
            // Initial district list - will be updated when time changes
            const districtCounts = {};
            allRecords.forEach(r => {
                if (r._district) {
                    districtCounts[r._district] = (districtCounts[r._district] || 0) + 1;
                }
            });
            updateDistrictListCounts(districtCounts);
        }

        function updateDistrictListCounts(districtCounts) {
            const listEl = document.getElementById('districtList');
            const sorted = Object.entries(districtCounts).sort((a, b) => b[1] - a[1]);

            listEl.innerHTML = sorted.map(([district, count]) => `
                <div class="district-item" data-district="${district}" onclick="focusDistrict(${district})">
                    <span>District ${district}</span>
                    <span class="district-count">${count.toLocaleString()}</span>
                </div>
            `).join('');
        }

        function focusDistrict(district) {
            const centroid = DISTRICT_CENTROIDS[district];
            if (centroid) {
                map.setView(centroid, 13);
            }
            // Highlight in list
            document.querySelectorAll('.district-item').forEach(el => {
                el.classList.toggle('active', el.dataset.district == district);
            });
        }

        // =============================================
        // TIME SCRUBBER CONTROLS
        // =============================================
        function onSliderInput() {
            const slider = document.getElementById('timeSlider');
            currentSlotIndex = parseInt(slider.value);
            renderAtCurrentTime();
        }

        function togglePlayback() {
            if (isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            isPlaying = true;
            document.getElementById('playBtn').innerHTML = '&#9646;&#9646;';

            // If at the end, start from beginning
            if (currentSlotIndex >= timeSlots.length - 1) {
                currentSlotIndex = 0;
                document.getElementById('timeSlider').value = 0;
            }

            playInterval = setInterval(() => {
                currentSlotIndex++;
                if (currentSlotIndex >= timeSlots.length) {
                    stopPlayback();
                    return;
                }
                document.getElementById('timeSlider').value = currentSlotIndex;
                renderAtCurrentTime();
            }, playSpeed);
        }

        function stopPlayback() {
            isPlaying = false;
            document.getElementById('playBtn').innerHTML = '&#9654;';
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }

        function updateSpeed() {
            playSpeed = parseInt(document.getElementById('speedSelect').value);
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        }

        function onModeChange() {
            renderAtCurrentTime();
        }

        // =============================================
        // VIEW MODE
        // =============================================
        function setViewMode(mode) {
            viewMode = mode;
            document.querySelectorAll('.view-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.view === mode);
            });
            renderAtCurrentTime();
        }

        // =============================================
        // OVERLAY TOGGLES
        // =============================================
        function toggleDistrictOverlay() {
            renderDistrictOverlay();
        }

        // =============================================
        // MOBILE
        // =============================================
        function toggleMobileSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function closeMobileSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }

        // =============================================
        // LOADING
        // =============================================
        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function updateLoadingProgress(text) {
            document.getElementById('loadingProgress').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // =============================================
        // START
        // =============================================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
